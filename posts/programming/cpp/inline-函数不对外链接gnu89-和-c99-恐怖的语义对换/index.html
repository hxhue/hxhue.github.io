<!doctype html><html lang=zh-CN data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.143.1"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="inline 函数不对外链接？gnu89 和 c99 恐怖的语义对换！"><meta itemprop=description content="个人博客，主要是零散的笔记。"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://hxhue.github.io/imgs/371907.jpg"><meta itemprop=keywords content="c,cpp"><link type=text/css rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css><link rel=stylesheet href=/css/main.min.bea76f574a755574e17d42bea39502a74ca3ca4db65807b8c82d3e26dcec8420.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><link rel=stylesheet type=text/css href=/css/style.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/github-markdown-css@5.3.0/github-markdown-dark.css><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js></script><script>MathJax={tex:{displayMath:[["$$","$$"],["\\[","\\]"]],inlineMath:[["$","$"],["\\(","\\)"]]},svg:{fontCache:"global"}}</script><script type=module>
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: false });
  mermaid.mermaidAPI.initialize();
  window.mermaid = mermaid;
</script><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":false,"isPage":true,"path":"inline-%E5%87%BD%E6%95%B0%E4%B8%8D%E5%AF%B9%E5%A4%96%E9%93%BE%E6%8E%A5gnu89-%E5%92%8C-c99-%E6%81%90%E6%80%96%E7%9A%84%E8%AF%AD%E4%B9%89%E5%AF%B9%E6%8D%A2","permalink":"https://hxhue.github.io/posts/programming/cpp/inline-%E5%87%BD%E6%95%B0%E4%B8%8D%E5%AF%B9%E5%A4%96%E9%93%BE%E6%8E%A5gnu89-%E5%92%8C-c99-%E6%81%90%E6%80%96%E7%9A%84%E8%AF%AD%E4%B9%89%E5%AF%B9%E6%8D%A2/","title":"inline 函数不对外链接？gnu89 和 c99 恐怖的语义对换！","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>inline 函数不对外链接？gnu89 和 c99 恐怖的语义对换！ - Bluegill</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>Bluegill</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description></p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about/ class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档</a></li><li class="menu-item menu-item-categories"><a href=/categories/ class=hvr-icon-pulse rel=section><i class="fa fa-th hvr-icon"></i>分类</a></li><li class="menu-item menu-item-tags"><a href=/tags/ class=hvr-icon-pulse rel=section><i class="fa fa-hashtag hvr-icon"></i>标签</a></li><li class="menu-item menu-item-daily"><a href=/daily/ class=hvr-icon-pulse rel=section><i class="fa fa-newspaper hvr-icon"></i>随笔</a></li><li class="menu-item menu-item-discovery"><a href=https://rift-fear-f2c.notion.site/2025-1e354a33cfb1802c841bdf29f2f3dab3 class=hvr-icon-pulse rel=section><i class="fa fa-compass hvr-icon"></i>发现</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#经过>经过</a></li><li><a href=#tldr>TL;DR</a></li><li><a href=#尝试解释c-中内联函数按需生成>尝试解释：C++ 中内联函数按需生成</a></li><li><a href=#c-外部链接的内联函数--变量是什么意思>C++ 外部链接的内联函数 / 变量是什么意思？</a></li><li><a href=#inline-变量是否按需生成c-和-c-不同>inline 变量是否按需生成（C 和 C++ 不同）</a></li><li><a href=#inline-函数没用到就不会生成>inline 函数没用到就不会生成</a></li><li><a href=#inline-函数是否可以对外链接c-和-c-不同>inline 函数是否可以对外链接（C 和 C++ 不同）</a></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=🤖 src=/imgs/371907.jpg><p class=site-author-name itemprop=name>🤖</p><div class=site-description itemprop=description>个人博客，主要是零散的笔记。</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>433</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>12</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>86</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/hxhue title="Github → https://github.com/hxhue" rel=noopener target=_blank><i class="fab fa-github fa-fw"></i>
Github
</a></span><span class=links-of-social-item><a href=/rss.xml title="RSS 订阅 → /rss.xml" rel=noopener target=_blank><i class="fa fa-rss fa-fw"></i>
RSS 订阅</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://shuai.guru/ title=https://shuai.guru/ target=_blank>shuai.guru</a></li></ul></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://hxhue.github.io/posts/programming/cpp/inline-%E5%87%BD%E6%95%B0%E4%B8%8D%E5%AF%B9%E5%A4%96%E9%93%BE%E6%8E%A5gnu89-%E5%92%8C-c99-%E6%81%90%E6%80%96%E7%9A%84%E8%AF%AD%E4%B9%89%E5%AF%B9%E6%8D%A2/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/371907.jpg"><meta itemprop=name content="🤖"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="🤖"><meta itemprop=description content="个人博客，主要是零散的笔记。"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="inline 函数不对外链接？gnu89 和 c99 恐怖的语义对换！"><meta itemprop=description content="经过

遇到过一个坑：为共享库写函数，但是又需要从头文件隐藏实现时，不要将函数声明为内联。否则编译器会认为它未被使用并忽略它，链接的时候就找不到这个函数。"></span><header class=post-header><h1 class=post-title itemprop="name headline">inline 函数不对外链接？gnu89 和 c99 恐怖的语义对换！</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2024-04-25 00:00:00 +0800 CST" itemprop="dateCreated datePublished" datetime="2024-04-25 00:00:00 +0800 CST">2024-04-25
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar-check"></i>
</span><span class=post-meta-item-text title=更新于>更新于：
</span><time title=修改时间：2025-03-18T00:00:00+08:00 itemprop=dateModified datetime=2025-03-18T00:00:00+08:00>2025-03-18</time></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="far fa-file-word"></i>
</span><span class=post-meta-item-text>字数：</span>
<span>3740</span>
</span><span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="far fa-clock"></i>
</span><span class=post-meta-item-text>阅读：&ap;</span>
<span>8分钟</span></span></div></div></header><div class=post-body itemprop=articleBody><h1 id=经过>经过
<a class=header-anchor href=#%e7%bb%8f%e8%bf%87></a></h1><p>遇到过一个坑：为共享库写函数，但是又需要从头文件隐藏实现时，不要将函数声明为内联。否则编译器会认为它未被使用并忽略它，链接的时候就找不到这个函数。</p><p>项目使用的语言是 C++。</p><h1 id=tldr>TL;DR
<a class=header-anchor href=#tldr></a></h1><p>其实只是不会主动生成函数定义罢了，不是不能对外链接。除非调用处看到的声明带有 <code>inline</code> 关键字，从而尝试在其所在的翻译单元中寻找。</p><h1 id=尝试解释c-中内联函数按需生成>尝试解释：C++ 中内联函数按需生成
<a class=header-anchor href=#%e5%b0%9d%e8%af%95%e8%a7%a3%e9%87%8ac-%e4%b8%ad%e5%86%85%e8%81%94%e5%87%bd%e6%95%b0%e6%8c%89%e9%9c%80%e7%94%9f%e6%88%90></a></h1><p><a href=https://zh.cppreference.com/w/cpp/language/inline title=https://zh.cppreference.com/w/cpp/language/inline rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://zh.cppreference.com/w/cpp/language/inline<i class="fa fa-external-link-alt"></i></a> 中有一句：</p><blockquote><p>内联函数或变量 (C++17 起) 的定义必须在访问它的翻译单元中可达（不一定要在访问点前）。</p></blockquote><h1 id=c-外部链接的内联函数--变量是什么意思>C++ 外部链接的内联函数 / 变量是什么意思？
<a class=header-anchor href=#c-%e5%a4%96%e9%83%a8%e9%93%be%e6%8e%a5%e7%9a%84%e5%86%85%e8%81%94%e5%87%bd%e6%95%b0--%e5%8f%98%e9%87%8f%e6%98%af%e4%bb%80%e4%b9%88%e6%84%8f%e6%80%9d></a></h1><p>文档中有这句话：</p><blockquote><p>Inline const variables at namespace scope have <a href=https://en.cppreference.com/w/cpp/language/storage_duration#external_linkage title="external linkage" rel="noopener external nofollow noreferrer" target=_blank class=exturl>external linkage<i class="fa fa-external-link-alt"></i></a> by default (<mark>unlike the non-inline non-volatile const-qualified variables</mark>).</p></blockquote><p>证实后半句：</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#586e75>// main.cc
</span></span></span><span style=display:flex><span><span style=color:#586e75></span><span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;iostream&gt;</span><span style=color:#719e07>
</span></span></span><span style=display:flex><span><span style=color:#719e07></span>
</span></span><span style=display:flex><span><span style=color:#719e07>const</span> <span style=color:#dc322f>int</span> a <span style=color:#719e07>=</span> <span style=color:#2aa198>3</span>;
</span></span><span style=display:flex><span><span style=color:#dc322f>void</span> <span style=color:#268bd2>f</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#dc322f>int</span> <span style=color:#268bd2>main</span>() {
</span></span><span style=display:flex><span>  f();
</span></span><span style=display:flex><span>  printf(<span style=color:#2aa198>&#34;lalala</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75>// linkme.cc
</span></span></span><span style=display:flex><span><span style=color:#586e75></span><span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;cstdio&gt;</span><span style=color:#719e07>
</span></span></span><span style=display:flex><span><span style=color:#719e07></span><span style=color:#719e07>extern</span> <span style=color:#dc322f>int</span> a;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#dc322f>void</span> <span style=color:#268bd2>f</span>() { printf(<span style=color:#2aa198>&#34;a=%d</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>&#34;</span>, a); }
</span></span></code></pre></div><p>以上代码 linkme.cc 是无法成功链接 <code>a</code> 的。但是把 <code>const</code> 去掉了就可以。</p><p><mark>这很怪</mark>：</p><ol><li>全局变量可以对外链接。</li><li><u>全局常量（非 inline、非 volatile）不能对外链接</u>。</li><li>全局 inline 常量可以对外链接。</li></ol><p>还有这一句话：</p><blockquote><p>An inline function or variable (since C++17) with <a href=https://en.cppreference.com/w/cpp/language/storage_duration#external_linkage title="external linkage" rel="noopener external nofollow noreferrer" target=_blank class=exturl>external linkage<i class="fa fa-external-link-alt"></i></a> (e.g. not declared <code>static</code>)&mldr;</p></blockquote><p>C++ 是允许不同翻译单元中出现同一 <code>inline</code> 函数或者变量的，但是它们的地址在每个翻译单元中都相同、声明在每个翻译单元中都必须标记 <code>inline</code>（在 gcc 12.2 上做测试，有个源文件没有标 <code>inline</code> 也没有报错）、同时定义也应该相同（如果不同则程序非良构，但编译器不需要报错），这样才能保证多处定义可以合并。</p><h1 id=inline-变量是否按需生成c-和-c-不同>inline 变量是否按需生成（C 和 C++ 不同）
<a class=header-anchor href=#inline-%e5%8f%98%e9%87%8f%e6%98%af%e5%90%a6%e6%8c%89%e9%9c%80%e7%94%9f%e6%88%90c-%e5%92%8c-c-%e4%b8%8d%e5%90%8c></a></h1><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>eric@debian:~/linkage$ <span style=color:#b58900>echo</span> <span style=color:#2aa198>&#39;inline int a = 6;&#39;</span> &gt; inline.cc
</span></span><span style=display:flex><span>eric@debian:~/linkage$ <span style=color:#b58900>echo</span> <span style=color:#2aa198>&#39;inline int a = 6;&#39;</span> &gt; inline.c
</span></span><span style=display:flex><span>eric@debian:~/linkage$ <span style=color:#b58900>echo</span> <span style=color:#2aa198>&#39;int a = 6;&#39;</span>        &gt; outofline.cc
</span></span><span style=display:flex><span>eric@debian:~/linkage$ gcc -c inline.c -o inline.c.o
</span></span><span style=display:flex><span>inline.c:1:12: warning: variable ‘a’ declared ‘inline’
</span></span><span style=display:flex><span>    <span style=color:#2aa198>1</span> | inline int <span style=color:#268bd2>a</span> <span style=color:#719e07>=</span> 6;
</span></span><span style=display:flex><span>      |            ^
</span></span><span style=display:flex><span>eric@debian:~/linkage$ gcc -c inline.cc -o inline.cc.o
</span></span><span style=display:flex><span>eric@debian:~/linkage$ gcc -c outofline.cc
</span></span><span style=display:flex><span>eric@debian:~/linkage$ ls -alh
</span></span><span style=display:flex><span>total 32K
</span></span><span style=display:flex><span>drwxr-xr-x  <span style=color:#2aa198>2</span> eric eric 4.0K Jul <span style=color:#2aa198>22</span> 16:14 .
</span></span><span style=display:flex><span>drwx------ <span style=color:#2aa198>10</span> eric eric 4.0K Jul <span style=color:#2aa198>22</span> 16:07 ..
</span></span><span style=display:flex><span>-rw-r--r--  <span style=color:#2aa198>1</span> eric eric   <span style=color:#2aa198>18</span> Jul <span style=color:#2aa198>22</span> 16:13 inline.c
</span></span><span style=display:flex><span>-rw-r--r--  <span style=color:#2aa198>1</span> eric eric   <span style=color:#2aa198>18</span> Jul <span style=color:#2aa198>22</span> 16:13 inline.cc
</span></span><span style=display:flex><span>-rw-r--r--  <span style=color:#2aa198>1</span> eric eric  <span style=color:#2aa198>800</span> Jul <span style=color:#2aa198>22</span> 16:14 inline.cc.o
</span></span><span style=display:flex><span>-rw-r--r--  <span style=color:#2aa198>1</span> eric eric  <span style=color:#2aa198>840</span> Jul <span style=color:#2aa198>22</span> 16:14 inline.c.o
</span></span><span style=display:flex><span>-rw-r--r--  <span style=color:#2aa198>1</span> eric eric   <span style=color:#2aa198>11</span> Jul <span style=color:#2aa198>22</span> 16:13 outofline.cc
</span></span><span style=display:flex><span>-rw-r--r--  <span style=color:#2aa198>1</span> eric eric  <span style=color:#2aa198>840</span> Jul <span style=color:#2aa198>22</span> 16:14 outofline.o
</span></span></code></pre></div><p>可以发现在 C 语言中给 a 变量加了 inline 但没有使用到，编译器给了警告（在 C++ 中没有）。还发现 inline.cc.o 和 inline.c.o 的大小不同！</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>eric@debian:~/linkage$ readelf -s inline.c.o | grep OBJECT
</span></span><span style=display:flex><span>     2: <span style=color:#2aa198>0000000000000000</span>     <span style=color:#2aa198>4</span> OBJECT  GLOBAL DEFAULT    <span style=color:#2aa198>2</span> a
</span></span><span style=display:flex><span>eric@debian:~/linkage$ readelf -s inline.cc.o | grep OBJECT
</span></span><span style=display:flex><span>eric@debian:~/linkage$ readelf -s outofline.o | grep OBJECT
</span></span><span style=display:flex><span>     2: <span style=color:#2aa198>0000000000000000</span>     <span style=color:#2aa198>4</span> OBJECT  GLOBAL DEFAULT    <span style=color:#2aa198>2</span> a
</span></span></code></pre></div><p>上面的测试也说明在 C++ 中，没有被使用到的 inline 变量是真的被优化掉了，连符号表中都找不到。</p><p>结论：<u>C 语言中 inline 变量总是生成（我测试时候语言标准估计是 C99）。C++ 中 inline 变量按需生成</u>。看符号表就知道了，如果生成了就是可以对外链接的。</p><h1 id=inline-函数没用到就不会生成>inline 函数没用到就不会生成
<a class=header-anchor href=#inline-%e5%87%bd%e6%95%b0%e6%b2%a1%e7%94%a8%e5%88%b0%e5%b0%b1%e4%b8%8d%e4%bc%9a%e7%94%9f%e6%88%90></a></h1><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>eric@debian:~/tlpi/linkage$ <span style=color:#b58900>echo</span> <span style=color:#2aa198>&#39;inline int f(int x) { return x; }&#39;</span> &gt; inline.cc
</span></span><span style=display:flex><span>eric@debian:~/tlpi/linkage$ <span style=color:#b58900>echo</span> <span style=color:#2aa198>&#39;inline int f(int x) { return x; }&#39;</span> &gt; inline.c
</span></span><span style=display:flex><span>eric@debian:~/tlpi/linkage$ <span style=color:#b58900>echo</span> <span style=color:#2aa198>&#39;int f(int x) { return x; }&#39;</span> &gt; outofline.cc
</span></span><span style=display:flex><span>eric@debian:~/tlpi/linkage$ gcc -c inline.c -o inline.c.o
</span></span><span style=display:flex><span>eric@debian:~/tlpi/linkage$ gcc -c inline.cc -o inline.cc.o
</span></span><span style=display:flex><span>eric@debian:~/tlpi/linkage$ gcc -c outofline.cc
</span></span><span style=display:flex><span>eric@debian:~/tlpi/linkage$ ls -alh
</span></span><span style=display:flex><span>total 32K
</span></span><span style=display:flex><span>drwxr-xr-x <span style=color:#2aa198>2</span> eric eric 4.0K Jul <span style=color:#2aa198>22</span> 16:27 .
</span></span><span style=display:flex><span>drwxr-xr-x <span style=color:#2aa198>9</span> eric eric 4.0K Jul <span style=color:#2aa198>22</span> 16:24 ..
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#2aa198>1</span> eric eric   <span style=color:#2aa198>34</span> Jul <span style=color:#2aa198>22</span> 16:26 inline.c
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#2aa198>1</span> eric eric   <span style=color:#2aa198>34</span> Jul <span style=color:#2aa198>22</span> 16:26 inline.cc
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#2aa198>1</span> eric eric  <span style=color:#2aa198>800</span> Jul <span style=color:#2aa198>22</span> 16:27 inline.cc.o
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#2aa198>1</span> eric eric  <span style=color:#2aa198>800</span> Jul <span style=color:#2aa198>22</span> 16:27 inline.c.o
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#2aa198>1</span> eric eric   <span style=color:#2aa198>27</span> Jul <span style=color:#2aa198>22</span> 16:27 outofline.cc
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#2aa198>1</span> eric eric 1.1K Jul <span style=color:#2aa198>22</span> 16:27 outofline.o
</span></span></code></pre></div><p>可以发现 outofline.o 和 inline.c.o 或者 inline.cc.o 二点大小不同。果然 outofline.o 的符号表中有函数 <code>f()</code>（名字重整后为 <code>_Z1fi</code>：</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>eric@debian:~/tlpi/linkage$ readelf -s outofline.o
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Symbol table <span style=color:#2aa198>&#39;.symtab&#39;</span> contains <span style=color:#2aa198>4</span> entries:
</span></span><span style=display:flex><span>   Num:    Value          Size Type    Bind   Vis      Ndx Name
</span></span><span style=display:flex><span>     0: <span style=color:#2aa198>0000000000000000</span>     <span style=color:#2aa198>0</span> NOTYPE  LOCAL  DEFAULT  UND
</span></span><span style=display:flex><span>     1: <span style=color:#2aa198>0000000000000000</span>     <span style=color:#2aa198>0</span> FILE    LOCAL  DEFAULT  ABS outofline.cc
</span></span><span style=display:flex><span>     2: <span style=color:#2aa198>0000000000000000</span>     <span style=color:#2aa198>0</span> SECTION LOCAL  DEFAULT    <span style=color:#2aa198>1</span> .text
</span></span><span style=display:flex><span>     3: <span style=color:#2aa198>0000000000000000</span>    <span style=color:#2aa198>12</span> FUNC    GLOBAL DEFAULT    <span style=color:#2aa198>1</span> _Z1fi
</span></span><span style=display:flex><span>eric@debian:~/tlpi/linkage$ readelf -s inline.cc.o
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Symbol table <span style=color:#2aa198>&#39;.symtab&#39;</span> contains <span style=color:#2aa198>2</span> entries:
</span></span><span style=display:flex><span>   Num:    Value          Size Type    Bind   Vis      Ndx Name
</span></span><span style=display:flex><span>     0: <span style=color:#2aa198>0000000000000000</span>     <span style=color:#2aa198>0</span> NOTYPE  LOCAL  DEFAULT  UND
</span></span><span style=display:flex><span>     1: <span style=color:#2aa198>0000000000000000</span>     <span style=color:#2aa198>0</span> FILE    LOCAL  DEFAULT  ABS inline.cc
</span></span></code></pre></div><p>再试试 C 语言，没有把函数 <code>f()</code> 内联时果然也生成了代码：</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>eric@debian:~/tlpi/linkage$ <span style=color:#b58900>echo</span> <span style=color:#2aa198>&#39;int f(int x) { return x; }&#39;</span> &gt; outofline.c
</span></span><span style=display:flex><span>eric@debian:~/tlpi/linkage$ gcc -c outofline.c
</span></span><span style=display:flex><span>eric@debian:~/tlpi/linkage$ readelf -s outofline.o
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Symbol table <span style=color:#2aa198>&#39;.symtab&#39;</span> contains <span style=color:#2aa198>4</span> entries:
</span></span><span style=display:flex><span>   Num:    Value          Size Type    Bind   Vis      Ndx Name
</span></span><span style=display:flex><span>     0: <span style=color:#2aa198>0000000000000000</span>     <span style=color:#2aa198>0</span> NOTYPE  LOCAL  DEFAULT  UND
</span></span><span style=display:flex><span>     1: <span style=color:#2aa198>0000000000000000</span>     <span style=color:#2aa198>0</span> FILE    LOCAL  DEFAULT  ABS outofline.c
</span></span><span style=display:flex><span>     2: <span style=color:#2aa198>0000000000000000</span>     <span style=color:#2aa198>0</span> SECTION LOCAL  DEFAULT    <span style=color:#2aa198>1</span> .text
</span></span><span style=display:flex><span>     3: <span style=color:#2aa198>0000000000000000</span>    <span style=color:#2aa198>12</span> FUNC    GLOBAL DEFAULT    <span style=color:#2aa198>1</span> f
</span></span></code></pre></div><p>结论：<u>inline 函数没用到就不会生成</u>。</p><h1 id=inline-函数是否可以对外链接c-和-c-不同>inline 函数是否可以对外链接（C 和 C++ 不同）
<a class=header-anchor href=#inline-%e5%87%bd%e6%95%b0%e6%98%af%e5%90%a6%e5%8f%af%e4%bb%a5%e5%af%b9%e5%a4%96%e9%93%be%e6%8e%a5c-%e5%92%8c-c-%e4%b8%8d%e5%90%8c></a></h1><p>函数 <code>f()</code> 是 inline 函数，但是 <code>g()</code> 是非 inline 的，所以 <code>g()</code> 的代码一定会生成，同时还会迫使 <code>f()</code> 的代码生成。</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c data-lang=c><span style=display:flex><span>eric@debian:<span style=color:#719e07>~/</span>tlpi<span style=color:#719e07>/</span>linkage$ vim <span style=color:#268bd2>inline</span>.c
</span></span><span style=display:flex><span>eric@debian:<span style=color:#719e07>~/</span>tlpi<span style=color:#719e07>/</span>linkage$ cat <span style=color:#268bd2>inline</span>.c
</span></span><span style=display:flex><span><span style=color:#268bd2>inline</span> <span style=color:#dc322f>int</span> <span style=color:#268bd2>f</span>(<span style=color:#dc322f>int</span> x) { <span style=color:#719e07>return</span> x; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#dc322f>int</span> <span style=color:#268bd2>g</span>(<span style=color:#dc322f>int</span> x) { <span style=color:#719e07>return</span> <span style=color:#268bd2>f</span>(x); }
</span></span><span style=display:flex><span>eric@debian:<span style=color:#719e07>~/</span>tlpi<span style=color:#719e07>/</span>linkage$ cat <span style=color:#268bd2>inline</span>.c <span style=color:#719e07>&gt;</span> <span style=color:#268bd2>inline</span>.cc
</span></span><span style=display:flex><span>eric@debian:<span style=color:#719e07>~/</span>tlpi<span style=color:#719e07>/</span>linkage$ gcc <span style=color:#719e07>-</span>c <span style=color:#268bd2>inline</span>.cc <span style=color:#719e07>-</span>o <span style=color:#268bd2>inline</span>.cc.o
</span></span><span style=display:flex><span>eric@debian:<span style=color:#719e07>~/</span>tlpi<span style=color:#719e07>/</span>linkage$ gcc <span style=color:#719e07>-</span>c <span style=color:#268bd2>inline</span>.c <span style=color:#719e07>-</span>o <span style=color:#268bd2>inline</span>.c.o
</span></span><span style=display:flex><span>eric@debian:<span style=color:#719e07>~/</span>tlpi<span style=color:#719e07>/</span>linkage$ readelf <span style=color:#719e07>-</span>s <span style=color:#268bd2>inline</span>.c.o
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Symbol table &#39;.symtab&#39; contains <span style=color:#2aa198>5</span> entries:
</span></span><span style=display:flex><span>   Num:    Value          Size Type    Bind   Vis      Ndx Name
</span></span><span style=display:flex><span>     <span style=color:#2aa198>0</span><span style=color:#719e07>:</span> <span style=color:#2aa198>0000000000000000</span>     <span style=color:#2aa198>0</span> NOTYPE  LOCAL  DEFAULT  UND
</span></span><span style=display:flex><span>     <span style=color:#2aa198>1</span><span style=color:#719e07>:</span> <span style=color:#2aa198>0000000000000000</span>     <span style=color:#2aa198>0</span> FILE    LOCAL  DEFAULT  ABS <span style=color:#268bd2>inline</span>.c
</span></span><span style=display:flex><span>     <span style=color:#2aa198>2</span><span style=color:#719e07>:</span> <span style=color:#2aa198>0000000000000000</span>     <span style=color:#2aa198>0</span> SECTION LOCAL  DEFAULT    <span style=color:#2aa198>1</span> .text
</span></span><span style=display:flex><span>     <span style=color:#2aa198>3</span><span style=color:#719e07>:</span> <span style=color:#2aa198>0000000000000000</span>    <span style=color:#2aa198>23</span> FUNC    GLOBAL DEFAULT    <span style=color:#2aa198>1</span> g
</span></span><span style=display:flex><span>     <span style=color:#2aa198>4</span><span style=color:#719e07>:</span> <span style=color:#2aa198>0000000000000000</span>     <span style=color:#2aa198>0</span> NOTYPE  GLOBAL DEFAULT  UND f
</span></span><span style=display:flex><span>eric@debian:<span style=color:#719e07>~/</span>tlpi<span style=color:#719e07>/</span>linkage$ readelf <span style=color:#719e07>-</span>s <span style=color:#268bd2>inline</span>.cc.o
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Symbol table &#39;.symtab&#39; contains <span style=color:#2aa198>6</span> entries:
</span></span><span style=display:flex><span>   Num:    Value          Size Type    Bind   Vis      Ndx Name
</span></span><span style=display:flex><span>     <span style=color:#2aa198>0</span><span style=color:#719e07>:</span> <span style=color:#2aa198>0000000000000000</span>     <span style=color:#2aa198>0</span> NOTYPE  LOCAL  DEFAULT  UND
</span></span><span style=display:flex><span>     <span style=color:#2aa198>1</span><span style=color:#719e07>:</span> <span style=color:#2aa198>0000000000000000</span>     <span style=color:#2aa198>0</span> FILE    LOCAL  DEFAULT  ABS <span style=color:#268bd2>inline</span>.cc
</span></span><span style=display:flex><span>     <span style=color:#2aa198>2</span><span style=color:#719e07>:</span> <span style=color:#2aa198>0000000000000000</span>     <span style=color:#2aa198>0</span> SECTION LOCAL  DEFAULT    <span style=color:#2aa198>2</span> .text
</span></span><span style=display:flex><span>     <span style=color:#2aa198>3</span><span style=color:#719e07>:</span> <span style=color:#2aa198>0000000000000000</span>     <span style=color:#2aa198>0</span> SECTION LOCAL  DEFAULT    <span style=color:#2aa198>6</span> .text._Z1fi
</span></span><span style=display:flex><span>     <span style=color:#2aa198>4</span><span style=color:#719e07>:</span> <span style=color:#2aa198>0000000000000000</span>    <span style=color:#2aa198>12</span> FUNC    WEAK   DEFAULT    <span style=color:#2aa198>6</span> _Z1fi
</span></span><span style=display:flex><span>     <span style=color:#2aa198>5</span><span style=color:#719e07>:</span> <span style=color:#2aa198>0000000000000000</span>    <span style=color:#2aa198>23</span> FUNC    GLOBAL DEFAULT    <span style=color:#2aa198>2</span> _Z1gi
</span></span></code></pre></div><p>从这个结果看来 C 语言中 inline 函数是不对外链接的（Type=NOTYPE、Ndx=UND），但是 C++ 中 inline 函数是对外链接的（Type=FUNC、Ndx=6），只是绑定类型为 WEAK（如果有多个弱引用链接器会选一个、如果有强引用链接器会忽略弱引用）。</p><p>在 C++ 中果然是可以成功链接 <code>f</code> 的：</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#586e75># 注意 -xc++ 一定要放在最后，不然目标文件 inline.cc.o 也会被当成 C++ 源码处理从而失败</span>
</span></span><span style=display:flex><span>gcc inline.cc.o -o a.cc.out -xc++ &lt;<span style=color:#719e07>(</span><span style=color:#b58900>echo</span> <span style=color:#2aa198>&#39;int f(int); int main() { return f(0); }&#39;</span><span style=color:#719e07>)</span>
</span></span></code></pre></div><p><mark>在 C 语言的那个测试就比较怪了，内联的 <code>f()</code> 函数代码在用到的情况下也根本就没有生成</mark>！用 <code>objdump -D inline.c.o</code> 只能看到 g() 函数的代码。</p><p>根据 Stack Overflow 问题 <a href=https://stackoverflow.com/a/216546/ title=what-does-extern-inline-do rel="noopener external nofollow noreferrer" target=_blank class=exturl>what-does-extern-inline-do<i class="fa fa-external-link-alt"></i></a>，GNU89、GNU99/C99 和 C++ 中 inline 关键字的行为不同。我又尝试了不同的 C 语言版本：</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>eric@debian:~/tlpi/linkage$ gcc -std<span style=color:#719e07>=</span>c99 -c inline.c -o inline.c.o
</span></span><span style=display:flex><span>eric@debian:~/tlpi/linkage$ readelf -s inline.c.o
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Symbol table <span style=color:#2aa198>&#39;.symtab&#39;</span> contains <span style=color:#2aa198>5</span> entries:
</span></span><span style=display:flex><span>   Num:    Value          Size Type    Bind   Vis      Ndx Name
</span></span><span style=display:flex><span>     0: <span style=color:#2aa198>0000000000000000</span>     <span style=color:#2aa198>0</span> NOTYPE  LOCAL  DEFAULT  UND
</span></span><span style=display:flex><span>     1: <span style=color:#2aa198>0000000000000000</span>     <span style=color:#2aa198>0</span> FILE    LOCAL  DEFAULT  ABS inline.c
</span></span><span style=display:flex><span>     2: <span style=color:#2aa198>0000000000000000</span>     <span style=color:#2aa198>0</span> SECTION LOCAL  DEFAULT    <span style=color:#2aa198>1</span> .text
</span></span><span style=display:flex><span>     3: <span style=color:#2aa198>0000000000000000</span>    <span style=color:#2aa198>23</span> FUNC    GLOBAL DEFAULT    <span style=color:#2aa198>1</span> g
</span></span><span style=display:flex><span>     4: <span style=color:#2aa198>0000000000000000</span>     <span style=color:#2aa198>0</span> NOTYPE  GLOBAL DEFAULT  UND f
</span></span><span style=display:flex><span>eric@debian:~/tlpi/linkage$ gcc -std<span style=color:#719e07>=</span>gnu99 -c inline.c -o inline.c.o
</span></span><span style=display:flex><span>eric@debian:~/tlpi/linkage$ readelf -s inline.c.o
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Symbol table <span style=color:#2aa198>&#39;.symtab&#39;</span> contains <span style=color:#2aa198>5</span> entries:
</span></span><span style=display:flex><span>   Num:    Value          Size Type    Bind   Vis      Ndx Name
</span></span><span style=display:flex><span>     0: <span style=color:#2aa198>0000000000000000</span>     <span style=color:#2aa198>0</span> NOTYPE  LOCAL  DEFAULT  UND
</span></span><span style=display:flex><span>     1: <span style=color:#2aa198>0000000000000000</span>     <span style=color:#2aa198>0</span> FILE    LOCAL  DEFAULT  ABS inline.c
</span></span><span style=display:flex><span>     2: <span style=color:#2aa198>0000000000000000</span>     <span style=color:#2aa198>0</span> SECTION LOCAL  DEFAULT    <span style=color:#2aa198>1</span> .text
</span></span><span style=display:flex><span>     3: <span style=color:#2aa198>0000000000000000</span>    <span style=color:#2aa198>23</span> FUNC    GLOBAL DEFAULT    <span style=color:#2aa198>1</span> g
</span></span><span style=display:flex><span>     4: <span style=color:#2aa198>0000000000000000</span>     <span style=color:#2aa198>0</span> NOTYPE  GLOBAL DEFAULT  UND f
</span></span><span style=display:flex><span>eric@debian:~/tlpi/linkage$ gcc -std<span style=color:#719e07>=</span>gnu89 -c inline.c -o inline.c.o
</span></span><span style=display:flex><span>eric@debian:~/tlpi/linkage$ readelf -s inline.c.o
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Symbol table <span style=color:#2aa198>&#39;.symtab&#39;</span> contains <span style=color:#2aa198>5</span> entries:
</span></span><span style=display:flex><span>   Num:    Value          Size Type    Bind   Vis      Ndx Name
</span></span><span style=display:flex><span>     0: <span style=color:#2aa198>0000000000000000</span>     <span style=color:#2aa198>0</span> NOTYPE  LOCAL  DEFAULT  UND
</span></span><span style=display:flex><span>     1: <span style=color:#2aa198>0000000000000000</span>     <span style=color:#2aa198>0</span> FILE    LOCAL  DEFAULT  ABS inline.c
</span></span><span style=display:flex><span>     2: <span style=color:#2aa198>0000000000000000</span>     <span style=color:#2aa198>0</span> SECTION LOCAL  DEFAULT    <span style=color:#2aa198>1</span> .text
</span></span><span style=display:flex><span>     3: <span style=color:#2aa198>0000000000000000</span>    <span style=color:#2aa198>12</span> FUNC    GLOBAL DEFAULT    <span style=color:#2aa198>1</span> f
</span></span><span style=display:flex><span>     4: 000000000000000c    <span style=color:#2aa198>23</span> FUNC    GLOBAL DEFAULT    <span style=color:#2aa198>1</span> g
</span></span></code></pre></div><p>发现在 gnu89 的时候，<code>f()</code> 函数被生成了，再把目标文件拿去链接成可执行文件也是可以成功的。在 C99 的时候，<code>inline</code>（不是 <code>static inline</code> / <code>extern inline</code>）有点像声明了。而且不同版本之间语义发生了变化，理解起来非常棘手。</p><p>根据 <a href=https://stackoverflow.com/a/77852086/ title=https://stackoverflow.com/a/77852086/ rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://stackoverflow.com/a/77852086/<i class="fa fa-external-link-alt"></i></a> ，C99 中的函数被标记为 inline（没有 <code>static</code> / <code>extern</code>） 时，编译器可以内联也可以不内联这个函数，<strong>如果编译器选择不内联，则目标代码若需要调用这个函数，会直接使用这个函数符号，但并不生成它的代码</strong>。即：<strong>C99 函数有 inline 没 static 会阻止当前翻译单元中独立生成该函数</strong>！因此必须在其他文件中有一个此函数定义。（这似乎提供了一种机制，在内联 / 不内联的时候可以使用两份略微不同的代码定义？）在 C++ 中，inline 函数代码总是生成在每个翻译单元中，并由链接器负责丢弃重复的定义。</p><hr><p>2025/3/8 <a href=https://gcc.gnu.org/onlinedocs/gcc/Inline.html title=https://gcc.gnu.org/onlinedocs/gcc/Inline.html rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://gcc.gnu.org/onlinedocs/gcc/Inline.html<i class="fa fa-external-link-alt"></i></a> GCC 的文档也提供了一些信息，在 <em>The remainder of this section is specific to GNU C90 inlining.</em> <strong>C89 和 C90 是一回事</strong>。这句话的下面：</p><blockquote><p>这一段说的是 <code>inline</code>，光是 <code>inline</code> 不能防止违反 ODR，也就是说 C90 的 <code>inline</code> 生成定义且对外链接。<strong>When an inline function is not static, then the compiler must assume that there may be calls from other source files</strong>; since a global symbol can be defined only once in any program, the function must not be defined in the other source files, so the calls therein cannot be integrated. <strong>Therefore, a non-static inline function is always compiled on its own in the usual fashion</strong>.</p><p>这一段开始说的是 <code>extern inline</code>，在本文件能找到定义则有内联的可能，但是如果不内联则会直接调用函数且不生成其定义。和 <code>inline</code> 相比 <code>extern inline</code> 不会生成定义所以没有对外链接的问题。If you specify both inline and extern in the function definition, then the definition is used only for inlining. In no case is the function compiled on its own, not even if you refer to its address explicitly. Such an address becomes an external reference, as if you had only declared the function, and had not defined it.</p><p>This combination of inline and extern has almost the effect of a macro. The way to use it is to put a function definition in a header file with these keywords, and put another copy of the definition (lacking inline and extern) in a library file. The definition in the header file causes most calls to the function to be inlined. If any uses of the function remain, they refer to the single copy in the library.</p></blockquote><p>看下面的代码，在 gnu89 中 inline 关键字生成了代码，也就是说对外链接、不能防止违反 ODR！</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>➜  inline cat lib.c 
</span></span><span style=display:flex><span>inline int f<span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>    <span style=color:#719e07>return</span> 0;
</span></span><span style=display:flex><span><span style=color:#719e07>}</span>                                                                                                              
</span></span><span style=display:flex><span>➜  inline cat main.c 
</span></span><span style=display:flex><span>int f<span style=color:#719e07>()</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>int main<span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>    <span style=color:#719e07>return</span> f<span style=color:#719e07>()</span>;
</span></span><span style=display:flex><span><span style=color:#719e07>}</span>
</span></span><span style=display:flex><span>➜  inline gcc -std<span style=color:#719e07>=</span>gnu89 -o lib.o -c lib.c <span style=color:#719e07>&amp;&amp;</span> gcc -o main main.c lib.o <span style=color:#719e07>&amp;&amp;</span> ./main
</span></span><span style=display:flex><span>➜  inline gcc -std<span style=color:#719e07>=</span>c99 -o lib.o -c lib.c <span style=color:#719e07>&amp;&amp;</span> gcc -o main main.c lib.o <span style=color:#719e07>&amp;&amp;</span> ./main
</span></span><span style=display:flex><span>/usr/bin/ld: /tmp/cc7ODays.o: in <span style=color:#719e07>function</span> <span style=color:#586e75>`</span>main<span style=color:#2aa198>&#39;:
</span></span></span><span style=display:flex><span><span style=color:#2aa198>main.c:(.text+0xe): undefined reference to `f&#39;</span>
</span></span><span style=display:flex><span>collect2: error: ld returned <span style=color:#2aa198>1</span> <span style=color:#b58900>exit</span> status
</span></span><span style=display:flex><span>➜  inline gcc -std<span style=color:#719e07>=</span>gnu99 -o lib.o -c lib.c <span style=color:#719e07>&amp;&amp;</span> gcc -o main main.c lib.o <span style=color:#719e07>&amp;&amp;</span> ./main
</span></span><span style=display:flex><span>/usr/bin/ld: /tmp/ccPN2lZj.o: in <span style=color:#719e07>function</span> <span style=color:#586e75>`</span>main<span style=color:#2aa198>&#39;:
</span></span></span><span style=display:flex><span><span style=color:#2aa198>main.c:(.text+0xe): undefined reference to `f&#39;</span>
</span></span><span style=display:flex><span>collect2: error: ld returned <span style=color:#2aa198>1</span> <span style=color:#b58900>exit</span> status
</span></span></code></pre></div><p><code>inline</code> 出现于 GNU 方言、C99、C++ 中。在 C99 之前的版本中如果不用方言（比如有 <code>-ansi</code> 或者 <code>-std</code>）就没有 <code>inline</code> 关键字，这个时候可以用 <code>__inline__</code>。亲测 <code>-std=gnu89</code> 可以用 <code>inline</code> 但是 <code>-std=c89</code> 不能。</p><p>观察：</p><ul><li>gnu89 <code>extern inline</code> = C99 <code>inline</code>，绝不生成函数定义。gnu89 <code>inline</code> = C99 <code>extern inline</code>，生成函数定义且对外链接 😅。</li><li>gnu89 <code>static inline</code> = C99 <code>static inline</code>，函数符号是 <code>LOCAL</code> 的。</li><li>C++ 只要带有 <code>inline</code>（除了普通 <code>inline</code> 也包括 <code>static inline</code> 和 <code>extern inline</code>）就不会主动生成函数，除非本翻译单元有对此函数的调用。所以 C++ <code>static inline</code> 和 gnu89/C99 的 <code>static inline</code> 还是有点微小的区别，不过都能防止 ODR。</li><li>C 语言中，<code>static inline</code> 不会主动生成函数，除非本翻译单元有对此函数的调用。</li><li>C++ <code>extern inline</code> 和 <code>inline</code> 效果一样，<strong>如果函数被用到</strong>则会创建符号定义，但是被标记为 <code>WEAK</code>，可以对外链接，也不怕重复（会从多个版本中选择一个）。</li></ul><p>对于 inline 函数的结论：</p><ol><li>在 C 语言中因为版本语义变化的问题，建议使用 <code>static inline</code> 来处理需要在头文件中包含函数定义的情况（防止 ODR）。</li><li>在 C++ 中函数使用 <code>inline</code> 即可。在用模板写 traits 的时候可能会用到 <code>static inline</code>。<ul><li>一方面，<code>static</code> 不对外链接意味着可以不必生成函数的代码，是个很好的内联提示。</li><li>另一方面，<code>inline</code> 函数被用到时还是会在每个目标文件中生成定义，而且对外链接。C++17 又要求 <code>inline</code> 变量 / 函数在其翻译单元内能找到定义，那还不如一步到位写成 <code>static inline</code> 了？倒也不是，因为生成的符号是 weak，链接的时候只选择一个定义，<strong>有助于减少链接后的文件体积</strong>。</li><li>大家都写 <code>inline</code> 可能是因为效果其实差不多，少写个关键字。</li></ul></li></ol><hr><p>关于 inline 变量：</p><ol><li><strong>对于 C++ 变量来说，<code>inline</code> 好处更大</strong>，能实现在类中直接定义 <code>static</code> 变量和在头文件中包含非 <code>const</code> 的全局变量（C++17 之后才能使用 inline variables）。对于函数来说作用不明显。<a href="https://www.bilibili.com/video/BV1wwQBYmEBV/?share_source=copy_web&amp;vd_source=2772e196cf84bbcdd0033756d77bfcce" title="B 站评论区" rel="noopener external nofollow noreferrer" target=_blank class=exturl>B 站评论区<i class="fa fa-external-link-alt"></i></a> 提醒了我。
<img src=/assets/Pasted%20image%2020250318092540.webp></li><li>对于 C++ 变量来说，extern inline 并不等于 inline：<code>error: odr-used inline variable 'x' is not defined</code>，好像是用不了。<code>static inline</code> 和 <code>static</code> 的表现相似，会生成 bss 段或者 data 段的 local 变量（从 nm 看分别为 b 和 d 标志；如果是需要函数来初始化的也会放在 bss）。<code>inline</code> 生成的是 undefined local 变量（从 nm 看为 u）。</li><li><a href=http://en.cppreference.com/w/c/language/inline title="Cppreference 的文档" rel="noopener external nofollow noreferrer" target=_blank class=exturl>Cppreference 的文档<i class="fa fa-external-link-alt"></i></a> 里面没有 C 语言 inline 变量的信息，在 compiler explorer 中测试发现可以定义 inline 变量，但效果和不加 inline 效果一样，看似是被忽略了。</li></ol></div><footer class=post-footer><div class=post-tags><a href=/tags/c>c
</a><a href=/tags/cpp>cpp</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/posts/programming/cuda/cudaDeviceSynchronize-%E5%92%8C-cudaStreamSynchronize/ rel=next title="cudaDeviceSynchronize 和 cudaStreamSynchronize"><i class="fa fa-chevron-left"></i> cudaDeviceSynchronize 和 cudaStreamSynchronize</a></div><div class="post-nav-prev post-nav-item"><a href=/posts/systems/Linux/gitlab/gitlab-jh-%E5%92%8C-gitlab-ce-%E7%9A%84%E5%8C%BA%E5%88%AB%E4%BB%A5%E5%8F%8A%E5%8D%9A%E5%AE%A2%E5%86%85%E5%AE%B9%E5%A3%B0%E6%98%8E/ rel=prev title="gitlab-jh 和 gitlab-ce 的区别以及博客内容声明">gitlab-jh 和 gitlab-ce 的区别以及博客内容声明
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2023 - 2025
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>🤖</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.143.1 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.5.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div></div></footer><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js defer></script><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":false,"save":"manual"},"copybtn":true,"darkmode":false,"hostname":"https://hxhue.github.io/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":false,"transition":{"collheader":"fadeInLeft","menu_item":"fadeInDown","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":false,"plugin":"waline"},"views":{"enable":false,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"cdnjs","router":"https://cdnjs.cloudflare.com/ajax/libs"},"version":"4.5.3"}</script><script type=text/javascript src=/js/main.min.37ba8b54f9d4d784d08028c45eea93b5d4e13eda8ee7fb0d2edd6f3fac66cfd2.js defer></script></body></html>