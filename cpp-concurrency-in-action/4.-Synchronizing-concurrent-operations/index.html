<!doctype html><html lang=zh-CN data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.143.1"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="4. Synchronizing concurrent operations"><meta itemprop=description content="ä¸ªäººåšå®¢ï¼Œä¸»è¦æ˜¯é›¶æ•£çš„ç¬”è®°ã€‚"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://hxhue.github.io/imgs/371907.jpg"><meta itemprop=keywords content="cpp,cpp-concurrency-in-action"><link type=text/css rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css><link rel=stylesheet href=/css/main.min.bea76f574a755574e17d42bea39502a74ca3ca4db65807b8c82d3e26dcec8420.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ æˆ‘å¯æ˜¯æœ‰åº•çº¿çš„å“Ÿ ~"}</style><link rel=stylesheet type=text/css href=/css/style.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/github-markdown-css@5.3.0/github-markdown-dark.css><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js></script><script>MathJax={tex:{displayMath:[["$$","$$"],["\\[","\\]"]],inlineMath:[["$","$"],["\\(","\\)"]]},svg:{fontCache:"global"}}</script><script type=module>
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: false });
  mermaid.mermaidAPI.initialize();
  window.mermaid = mermaid;
</script><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":false,"isPage":true,"path":"4.-Synchronizing-concurrent-operations","permalink":"https://hxhue.github.io/cpp-concurrency-in-action/4.-Synchronizing-concurrent-operations/","title":"4. Synchronizing concurrent operations","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>4. Synchronizing concurrent operations - Bluegill</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>Bluegill</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description></p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>é¦–é¡µ</a></li><li class="menu-item menu-item-about"><a href=/about/ class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>å…³äº</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>å½’æ¡£</a></li><li class="menu-item menu-item-categories"><a href=/categories/ class=hvr-icon-pulse rel=section><i class="fa fa-th hvr-icon"></i>åˆ†ç±»</a></li><li class="menu-item menu-item-tags"><a href=/tags/ class=hvr-icon-pulse rel=section><i class="fa fa-hashtag hvr-icon"></i>æ ‡ç­¾</a></li><li class="menu-item menu-item-daily"><a href=/daily/ class=hvr-icon-pulse rel=section><i class="fa fa-newspaper hvr-icon"></i>éšç¬”</a></li><li class="menu-item menu-item-discovery"><a href=https://rift-fear-f2c.notion.site/2025-1e354a33cfb1802c841bdf29f2f3dab3 class=hvr-icon-pulse rel=section><i class="fa fa-compass hvr-icon"></i>å‘ç°</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>æœç´¢</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=æœç´¢... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>æ–‡ç« ç›®å½•</li><li class=sidebar-nav-overview>ç«™ç‚¹æ¦‚è§ˆ</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#æ¡ä»¶å˜é‡>æ¡ä»¶å˜é‡</a></li><li><a href=#æ¡ˆä¾‹çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—>æ¡ˆä¾‹ï¼šçº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—</a></li><li><a href=#æœªæ¥future>æœªæ¥ï¼ˆFutureï¼‰</a><ul><li><a href=#stdasync><code>std::async</code></a></li><li><a href=#stdpackaged_task><code>std::packaged_task</code></a></li><li><a href=#stdpromise><code>std::promise</code></a></li><li><a href=#stdshared_future><code>std::shared_future</code></a></li></ul></li><li><a href=#ç­‰å¾…ä¸€æ®µæ—¶é—´>ç­‰å¾…ä¸€æ®µæ—¶é—´</a><ul><li><a href=#stdchrono-api><code>std::chrono</code> API</a></li><li><a href=#wait_for-å’Œ-wait_until><code>wait_for</code> å’Œ <code>wait_until</code></a></li></ul></li><li><a href=#æ¡ˆä¾‹parallel_quick_sort>æ¡ˆä¾‹ï¼š<code>parallel_quick_sort</code></a></li><li><a href=#æ¡ˆä¾‹ç”¨è‡ªåŠ¨çŠ¶æ€æœºæ€æƒ³å®ç°-atm-ç±»>æ¡ˆä¾‹ï¼šç”¨è‡ªåŠ¨çŠ¶æ€æœºæ€æƒ³å®ç° ATM ç±»</a></li><li><a href=#concurrency-ts-ä¸­çš„-stdexperimentalfuture>Concurrency TS ä¸­çš„ `std::experimental::future</a></li><li><a href=#ç­‰å¾…ä¸€ç»„-futures>ç­‰å¾…ä¸€ç»„ futures</a></li><li><a href=#stdlatch-å’Œ-stdbarrier><code>std::latch</code> å’Œ <code>std::barrier</code></a><ul><li><a href=#stdlatch><code>std::latch</code></a></li><li><a href=#stdbarrier><code>std::barrier</code></a><ul><li><a href=#æ„é€ å‡½æ•°>æ„é€ å‡½æ•°</a></li><li><a href=#æˆå‘˜å‡½æ•°>æˆå‘˜å‡½æ•°</a></li><li><a href=#-arrive-å’Œ-wait>âœ¨ <code>arrive()</code> å’Œ <code>wait()</code></a></li><li><a href=#-completion-å‡½æ•°>âœ¨ completion å‡½æ•°</a></li></ul></li><li><a href=#stdexperimentalflex_barrier><code>std::experimental::flex_barrier</code></a></li></ul></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=ğŸ¤– src=/imgs/371907.jpg><p class=site-author-name itemprop=name>ğŸ¤–</p><div class=site-description itemprop=description>ä¸ªäººåšå®¢ï¼Œä¸»è¦æ˜¯é›¶æ•£çš„ç¬”è®°ã€‚</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>433</span>
<span class=site-state-item-name>æ—¥å¿—</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>12</span>
<span class=site-state-item-name>åˆ†ç±»</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>86</span>
<span class=site-state-item-name>æ ‡ç­¾</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/hxhue title="Github â†’ https://github.com/hxhue" rel=noopener target=_blank><i class="fab fa-github fa-fw"></i>
Github
</a></span><span class=links-of-social-item><a href=/rss.xml title="RSS è®¢é˜… â†’ /rss.xml" rel=noopener target=_blank><i class="fa fa-rss fa-fw"></i>
RSS è®¢é˜…</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=å…±äº«çŸ¥è¯†><img src=/imgs/cc/big/by_nc_sa.svg alt=å…±äº«çŸ¥è¯†></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
å‹æƒ…é“¾æ¥</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://shuai.guru/ title=https://shuai.guru/ target=_blank>shuai.guru</a></li></ul></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=toggle-theme class=button title=æ·±æµ…æ¨¡å¼åˆ‡æ¢><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=è¿”å›é¡¶éƒ¨><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://hxhue.github.io/cpp-concurrency-in-action/4.-Synchronizing-concurrent-operations/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/371907.jpg"><meta itemprop=name content="ğŸ¤–"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="ğŸ¤–"><meta itemprop=description content="ä¸ªäººåšå®¢ï¼Œä¸»è¦æ˜¯é›¶æ•£çš„ç¬”è®°ã€‚"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="4. Synchronizing concurrent operations"><meta itemprop=description content="è¿™ä¸€ç« ä¸»è¦è®²çº¿ç¨‹ä¹‹é—´çš„åŒæ­¥å’Œä¿¡æ¯ä¼ é€’ï¼ŒåŒ…æ‹¬æ¡ä»¶å˜é‡ï¼ˆcondition variableï¼‰ã€futuresã€latches/barriesã€‚
æ¡ä»¶å˜é‡

å¤´æ–‡ä»¶æ˜¯ <condition_variable>ã€‚åŒ…å« std::condition_variable å’Œ std::condition_variable_anyã€‚å‰è€…åªèƒ½åœ¨ std::mutex ä¸Šä½¿ç”¨ï¼Œåè€…å¯ä»¥åœ¨æ‰€æœ‰æ»¡è¶³ BasicLockableï¼ˆlock() + unlock()ï¼Œä¸éœ€è¦ try_lock()ï¼‰çš„ç±»å‹ä¸Šä½¿ç”¨ã€‚å¦‚æœåªéœ€è¦ä½¿ç”¨ std::mutexï¼Œé‚£ä¹ˆå°±ç”¨å‰è€…ï¼Œå¼€é”€å¯èƒ½ä¼šæ¯”åè€…å°ä¸€ç‚¹ã€‚"></span><header class=post-header><h1 class=post-title itemprop="name headline">4. Synchronizing concurrent operations</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=å‘è¡¨äº>å‘è¡¨äºï¼š
</span><time title="åˆ›å»ºæ—¶é—´ï¼š2024-10-02 00:00:00 +0800 CST" itemprop="dateCreated datePublished" datetime="2024-10-02 00:00:00 +0800 CST">2024-10-02
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar-check"></i>
</span><span class=post-meta-item-text title=æ›´æ–°äº>æ›´æ–°äºï¼š
</span><time title=ä¿®æ”¹æ—¶é—´ï¼š2025-01-31T00:00:00+08:00 itemprop=dateModified datetime=2025-01-31T00:00:00+08:00>2025-01-31</time>
</span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i>
</span><span class=post-meta-item-text title=åˆ†ç±»äº>åˆ†ç±»äºï¼š
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/cpp-concurrency-in-action itemprop=url rel=index><span itemprop=name>cpp-concurrency-in-action</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=å­—æ•°><span class=post-meta-item-icon><i class="far fa-file-word"></i>
</span><span class=post-meta-item-text>å­—æ•°ï¼š</span>
<span>4769</span>
</span><span class=post-meta-item title=é˜…è¯»><span class=post-meta-item-icon><i class="far fa-clock"></i>
</span><span class=post-meta-item-text>é˜…è¯»ï¼š&ap;</span>
<span>10åˆ†é’Ÿ</span></span></div></div></header><div class=post-body itemprop=articleBody><p>è¿™ä¸€ç« ä¸»è¦è®²çº¿ç¨‹ä¹‹é—´çš„åŒæ­¥å’Œä¿¡æ¯ä¼ é€’ï¼ŒåŒ…æ‹¬æ¡ä»¶å˜é‡ï¼ˆcondition variableï¼‰ã€futuresã€latches/barriesã€‚</p><h1 id=æ¡ä»¶å˜é‡>æ¡ä»¶å˜é‡
<a class=header-anchor href=#%e6%9d%a1%e4%bb%b6%e5%8f%98%e9%87%8f></a></h1><p>å¤´æ–‡ä»¶æ˜¯ <code>&lt;condition_variable></code>ã€‚åŒ…å« <code>std::condition_variable</code> å’Œ <code>std::condition_variable_any</code>ã€‚å‰è€…åªèƒ½åœ¨ <code>std::mutex</code> ä¸Šä½¿ç”¨ï¼Œåè€…å¯ä»¥åœ¨æ‰€æœ‰æ»¡è¶³ BasicLockableï¼ˆ<code>lock()</code> + <code>unlock()</code>ï¼Œä¸éœ€è¦ <code>try_lock()</code>ï¼‰çš„ç±»å‹ä¸Šä½¿ç”¨ã€‚å¦‚æœåªéœ€è¦ä½¿ç”¨ <code>std::mutex</code>ï¼Œé‚£ä¹ˆå°±ç”¨å‰è€…ï¼Œå¼€é”€å¯èƒ½ä¼šæ¯”åè€…å°ä¸€ç‚¹ã€‚</p><div class="markdown-alert markdown-alert-tip"><p class=markdown-alert-title><svg class="octicon octicon-light-bulb mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M8 1.5c-2.363.0-4 1.69-4 3.75.0.984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75.0 01-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456.0 00-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863.0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751.0 01-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304.0-2.06-1.637-3.75-4-3.75zM5.75 12h4.5a.75.75.0 010 1.5h-4.5a.75.75.0 010-1.5zM6 15.25a.75.75.0 01.75-.75h2.5a.75.75.0 010 1.5h-2.5A.75.75.0 016 15.25z"/></svg>Tip</p><p>æ¥å£åªæœ‰ä¸€å¤„åŒºåˆ«ï¼š<code>std::condition_variable</code> å¯ä»¥è·å– native handleï¼Œè€Œ <code>std::condition_variable_any</code> ä¸èƒ½ã€‚</p></div><p>æ¡ä»¶å˜é‡å¯ä»¥ç”¨æ¥åè°ƒç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´çš„å…³ç³»ã€‚</p><p>å…¸å‹æ“ä½œæµç¨‹ï¼š</p><ol><li>å…ˆç”¨ <code>std::unique_lock</code> è·å¾—é”ã€‚</li><li>ç„¶åç”¨æ¡ä»¶å˜é‡æ¥ç­‰å¾…é”ã€‚è¿™ä¸ªè¿‡ç¨‹éœ€è¦ä¸€ä¸ª predï¼ˆç”¨æ¥æ£€æŸ¥æ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼‰ï¼Œå¦‚æœæ¡ä»¶å·²ç»æ»¡è¶³åˆ™ä¼šç›´æ¥è¿”å›ï¼›å¦åˆ™é‡Šæ”¾é”å¹¶é™·å…¥ä¼‘çœ ï¼Œç›´åˆ°è‡ªå‘å”¤é†’ï¼ˆspurious wakeï¼‰æˆ–è€…è¢«é€šçŸ¥ï¼ˆnotifyï¼‰ã€‚</li></ol><p>ä½¿ç”¨æ–¹æ³•å¯ä»¥å‚è€ƒ <a href=https://en.cppreference.com/w/cpp/thread/condition_variable title=https://en.cppreference.com/w/cpp/thread/condition_variable rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://en.cppreference.com/w/cpp/thread/condition_variable<i class="fa fa-external-link-alt"></i></a> ã€‚</p><p>ä¹‹æ‰€ä»¥ä¸ç”¨ <code>std::lock_guard</code> æ˜¯å› ä¸ºæ¡ä»¶å˜é‡çš„ç­‰å¾…å¯¹è±¡å¿…é¡»æ˜¯å¯è§£é”çš„ã€‚è€Œ <code>std::unique_lock</code> åˆæ¯”ç›´æ¥å¯¹ <code>std::mutex</code> æ“ä½œå®‰å…¨ã€‚</p><h1 id=æ¡ˆä¾‹çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—>æ¡ˆä¾‹ï¼šçº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—
<a class=header-anchor href=#%e6%a1%88%e4%be%8b%e7%ba%bf%e7%a8%8b%e5%ae%89%e5%85%a8%e7%9a%84%e9%98%9f%e5%88%97></a></h1><p>å’Œç¬¬ 3 ç« ä¸­çº¿ç¨‹å®‰å…¨æ ˆä¸€æ ·ï¼Œä¹¦ä¸Šè¿˜æ˜¯æä¾›äº†ä¸¤ç§é‡è½½ï¼Œä¸€ç§ç”¨ä¼ å‡ºå‚æ•°æ¥è¿”å›ç»“æœï¼Œä¸€ç§è¿”å›å…±äº«æŒ‡é’ˆã€‚åŒæ—¶ï¼Œç”±äºé˜Ÿåˆ—å¸¸å¸¸ç”¨æ¥åè°ƒæ¶ˆè´¹è€…å’Œç”Ÿäº§è€…ä¹‹é—´çš„å…³ç³»ï¼Œå› æ­¤åˆæœ‰é˜»å¡ç­‰å¾…å’Œè½®è¯¢ä¸¤ä¸ªç‰ˆæœ¬ã€‚</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#dc322f>bool</span> <span style=color:#268bd2>try_pop</span>(T <span style=color:#719e07>&amp;</span>value);
</span></span><span style=display:flex><span>std<span style=color:#719e07>::</span>shared_ptr<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> try_pop(); <span style=color:#586e75>// å¦‚æœå¤±è´¥å°±è¿”å›ç©ºæŒ‡é’ˆ
</span></span></span><span style=display:flex><span><span style=color:#586e75></span><span style=color:#dc322f>void</span> <span style=color:#268bd2>wait_and_pop</span>(T <span style=color:#719e07>&amp;</span>value);
</span></span><span style=display:flex><span>std<span style=color:#719e07>::</span>shared_ptr<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> wait_and_pop();
</span></span></code></pre></div><p>å¦‚æœç”Ÿäº§è€…å®Œæˆäº†ç”Ÿäº§ï¼Œé‚£ä¹ˆå¯ä»¥ç”¨ <code>notify_one</code> æ¥é€šçŸ¥ä¸€ä¸ªæ¶ˆè´¹è€…ã€‚å¦‚æœæ˜¯ä¸€ä¸ªçº¿ç¨‹å®Œæˆåˆå§‹åŒ–æ“ä½œï¼Œå…¶ä»–æ‰€æœ‰çº¿ç¨‹éƒ½èƒ½æ¥è¯»å–ç»“æœï¼Œé‚£ä¹ˆå¯ä»¥ç”¨ <code>notify_all</code> æ¥é€šçŸ¥ã€‚</p><h1 id=æœªæ¥future>æœªæ¥ï¼ˆFutureï¼‰
<a class=header-anchor href=#%e6%9c%aa%e6%9d%a5future></a></h1><p>å¦‚æœæ¡ä»¶å˜é‡åªéœ€è¦ç­‰å¾…ä¸€æ¬¡ï¼Œé‚£ä¹ˆç”¨ <code>std::future</code> å¯èƒ½ä¼šæ›´åŠ åˆé€‚ï¼Œå®ƒ<strong>è¡¨ç¤ºä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡çš„ç»“æœ</strong>ã€‚æ¯”è¾ƒï¼š<code>std::future</code> æ˜¯ä¸€æ¬¡æ€§çš„ã€è€Œä¸”å¯ä»¥æºå¸¦æ•°æ®ï¼ˆå¦‚æœä¸æºå¸¦æ•°æ®ï¼Œæ¨¡æ¿å‚æ•°å°±æ˜¯ <code>void</code>ï¼‰ã€‚<code>std::condition_variable</code> æ˜¯å¯ä»¥é‡å¤ä½¿ç”¨çš„ï¼Œæœ¬èº«ä¸èƒ½æºå¸¦æ•°æ®ã€‚</p><p>C++ æä¾›äº†ä¸¤ç§ futuresï¼š<code>std::future</code> å’Œ <code>std::shared_future</code>ã€‚</p><h2 id=stdasync><code>std::async</code>
<a class=header-anchor href=#stdasync></a></h2><p>ç”¨ <code>std::async</code> åˆ›å»ºä»»åŠ¡æ˜¯è·å– future çš„ä¸€ç§æ–¹å¼ã€‚åœ¨ <code>&lt;future></code> å¤´æ–‡ä»¶ä¸­ï¼ŒC++ è¿˜æä¾›äº† <code>std::async</code> å‡½æ•°æ¨¡æ¿ã€‚<code>std::async</code> çš„å¯åŠ¨å‚æ•°å¯ä»¥æ˜¯ <code>std::launch::async</code> æˆ–è€… <code>std::launch::deferred</code>ï¼Œæˆ–è€…ä¸¤è€…éƒ½å¯ï¼ˆé»˜è®¤ï¼‰ã€‚å¦‚æœå¯åŠ¨è¢«å»¶è¿Ÿï¼Œåˆ™è®¡ç®—åªä¼šåœ¨ç­‰å¾…æˆ–è·å–ç»“æœæ—¶æ‰å¼€å§‹è®¡ç®—ã€‚</p><p><img src=/cpp-concurrency-in-action/assets/Pasted%20image%2020241002234941.webp></p><h2 id=stdpackaged_task><code>std::packaged_task</code>
<a class=header-anchor href=#stdpackaged_task></a></h2><p>å¯ä»¥å’Œçº¿ç¨‹æ± ç»“åˆä½¿ç”¨ã€‚</p><p><code>std::packaged_task</code> çš„æ¨¡æ¿å‚æ•°çš„å«ä¹‰å’Œ <code>std::function</code> éå¸¸ç›¸ä¼¼ã€‚ä¸åŒä¹‹å¤„æ˜¯ <code>std::function</code> æ˜¯åŒæ­¥è°ƒç”¨ï¼Œï¼ˆåªæœ‰ï¼‰è°ƒç”¨è€…å¯ä»¥è·å–ä»»åŠ¡çš„ç»“æœï¼Œè€Œ <code>std::package_task&lt;></code> é€šè¿‡æš´éœ²å‡ºä¸€ä¸ª <code>std::future</code>ï¼Œå°†è®¡ç®—å’Œè·å–ç»“æœçš„è¿‡ç¨‹åˆ†å¼€ï¼Œä»è€Œè®¡ç®—å¯ä»¥å¼‚æ­¥è¿›è¡Œã€‚</p><p><code>std::packaged_task</code> åªèƒ½è¢«æˆåŠŸè°ƒç”¨ä¸€æ¬¡ï¼Œåç»­çš„è°ƒç”¨å°†æŠ›å‡º <a href=https://en.cppreference.com/w/cpp/thread/future_error title=std::future_error rel="noopener external nofollow noreferrer" target=_blank class=exturl><code>std::future_error</code><i class="fa fa-external-link-alt"></i></a> å¼‚å¸¸ã€‚è€Œ <code>std::function</code> åˆ™å¯ä»¥å¤šæ¬¡è°ƒç”¨ã€‚</p><p>æ„Ÿè§‰ <code>std::async</code> ä¹Ÿæ˜¯å¯ä»¥ç”¨ <code>std::packaged_task</code> æ¥å®ç°çš„ï¼Œå‰è€…å¼ºè°ƒæäº¤ä»»åŠ¡çš„åŠŸèƒ½ï¼Œåè€…åªæ˜¯è¡¨ç¤ºä»»åŠ¡è¿™ä¸ªå®ä½“ã€‚</p><p><a href=https://en.cppreference.com/w/cpp/thread/packaged_task title="æ¥è‡ª cppreference çš„ä¾‹å­" rel="noopener external nofollow noreferrer" target=_blank class=exturl>æ¥è‡ª cppreference çš„ä¾‹å­<i class="fa fa-external-link-alt"></i></a>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;cmath&gt;</span><span style=color:#719e07>
</span></span></span><span style=display:flex><span><span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;functional&gt;</span><span style=color:#719e07>
</span></span></span><span style=display:flex><span><span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;future&gt;</span><span style=color:#719e07>
</span></span></span><span style=display:flex><span><span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;iostream&gt;</span><span style=color:#719e07>
</span></span></span><span style=display:flex><span><span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;thread&gt;</span><span style=color:#719e07>
</span></span></span><span style=display:flex><span><span style=color:#719e07></span>
</span></span><span style=display:flex><span><span style=color:#586e75>// unique function to avoid disambiguating the std::pow overload set
</span></span></span><span style=display:flex><span><span style=color:#586e75></span><span style=color:#dc322f>int</span> <span style=color:#268bd2>f</span>(<span style=color:#dc322f>int</span> x, <span style=color:#dc322f>int</span> y) { <span style=color:#719e07>return</span> std<span style=color:#719e07>::</span>pow(x, y); }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#dc322f>void</span> <span style=color:#268bd2>task_thread</span>() {
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span>packaged_task<span style=color:#719e07>&lt;</span><span style=color:#dc322f>int</span>(<span style=color:#dc322f>int</span>, <span style=color:#dc322f>int</span>)<span style=color:#719e07>&gt;</span> task(f);
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span>future<span style=color:#719e07>&lt;</span><span style=color:#dc322f>int</span><span style=color:#719e07>&gt;</span> result <span style=color:#719e07>=</span> task.get_future();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span><span style=color:#268bd2>thread</span> task_td(std<span style=color:#719e07>::</span>move(task), <span style=color:#2aa198>2</span>, <span style=color:#2aa198>10</span>);
</span></span><span style=display:flex><span>    task_td.join(); <span style=color:#586e75>// è¿™é‡Œ detach ä¹Ÿæ²¡æœ‰å…³ç³»ï¼Œå› ä¸ºä¸‹é¢ result.get() ä¼šåŒæ­¥
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span>cout <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;task_thread:</span><span style=color:#cb4b16>\t</span><span style=color:#2aa198>&#34;</span> <span style=color:#719e07>&lt;&lt;</span> result.get() <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#39;\n&#39;</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#dc322f>int</span> <span style=color:#268bd2>main</span>() { task_thread(); }
</span></span></code></pre></div><h2 id=stdpromise><code>std::promise</code>
<a class=header-anchor href=#stdpromise></a></h2><p>ä» <code>std::async</code> åˆ° <code>std::packaged_task</code>ï¼Œå†åˆ° <code>std::promise</code>ï¼Œå®ƒä»¬å®ç°çš„åŠŸèƒ½è¶Šæ¥è¶ŠåŸºç¡€ã€‚<code>std::promise</code> è§£å†³äº† <code>std::packaged_task</code> çš„å±€é™æ€§ï¼šæœ‰æ—¶å€™è·å–ç»“æœçš„è¿‡ç¨‹å¹¶ä¸èƒ½ç”¨ä¸€ä¸ªå‡½æ•°æ¥ç®€å•è¡¨è¾¾ã€‚</p><p>å°±åƒ <code>std::packaged_task</code> ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ <code>get_future()</code> æ¥ä» <code>std::promise</code> ä¸Šè·å– futureï¼Œç”Ÿäº§è€…ç”¨ <code>set_value</code> è®¾ç½®ç»“æœã€‚<code>std::promise</code> è¿˜æœ‰è®¾ç½®å¼‚å¸¸çš„åŠŸèƒ½ï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#586e75>// 1
</span></span></span><span style=display:flex><span><span style=color:#586e75></span><span style=color:#719e07>extern</span> std<span style=color:#719e07>::</span>promise<span style=color:#719e07>&lt;</span><span style=color:#dc322f>double</span><span style=color:#719e07>&gt;</span> some_promise;
</span></span><span style=display:flex><span><span style=color:#719e07>try</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    some_promise.set_value(calculate_value());
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#719e07>catch</span>(...)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    some_promise.set_exception(std<span style=color:#719e07>::</span>current_exception());
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75>// 2
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>some_promise.set_exception(std<span style=color:#719e07>::</span>make_exception_ptr(std<span style=color:#719e07>::</span>logic_error(<span style=color:#2aa198>&#34;foo &#34;</span>)));
</span></span></code></pre></div><p>å¦‚æœ <code>std::promise</code> è¢«ææ„ï¼Œä½†æ˜¯æ²¡æœ‰è¢«è°ƒç”¨è¿‡ <code>set_value()</code> æˆ–è€… <code>set_exception()</code>ï¼Œé‚£ä¹ˆå°±ä¼šå­˜å‚¨ä¸€ä¸ªå¸¦æœ‰ <code>std::future_errc::broken_promise</code> é”™è¯¯ç çš„ <code>std::future_error</code> å¼‚å¸¸ã€‚</p><p><code>std::promise</code> è¿˜æœ‰ <a href=https://en.cppreference.com/w/cpp/thread/promise/set_value_at_thread_exit title=set_value_at_thread_exit() rel="noopener external nofollow noreferrer" target=_blank class=exturl><code>set_value_at_thread_exit()</code><i class="fa fa-external-link-alt"></i></a> å’Œ <a href=https://en.cppreference.com/w/cpp/thread/promise/set_exception_at_thread_exit title=set_exception_at_thread_exit rel="noopener external nofollow noreferrer" target=_blank class=exturl><code>set_exception_at_thread_exit</code><i class="fa fa-external-link-alt"></i></a> æ–¹æ³•ï¼Œå¯ä»¥é˜²æ­¢é—æ¼èµ‹å€¼ã€‚</p><h2 id=stdshared_future><code>std::shared_future</code>
<a class=header-anchor href=#stdshared_future></a></h2><p><code>std::future</code> æ²¡æœ‰è€ƒè™‘å¤šä¸ªæ¶ˆè´¹è€…ä¹‹é—´çš„æ•°æ®ç«äº‰ï¼Œæ‰€ä»¥åªèƒ½è¢«ä¸€ä¸ªæ¶ˆè´¹è€…ä½¿ç”¨ï¼Œè€Œä¸”æ˜¯ move-only çš„ç±»å‹ï¼›è€Œ <code>std::shared_future</code> å¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹è€…ä½¿ç”¨ï¼Œæ˜¯ copyable çš„ç±»å‹ã€‚ä¸è¿‡ï¼Œ<strong>ä¸åŒçº¿ç¨‹åº”è¯¥è·å– <code>std::shared_future</code> çš„å‰¯æœ¬ï¼Œè€Œä¸æ˜¯ä½¿ç”¨åŒä¸€ä¸ªå¼•ç”¨ï¼Œæ‰èƒ½é¿å…æ•°æ®ç«äº‰</strong>ã€‚<a href=https://en.cppreference.com/w/cpp/thread/shared_future title=Cppreference rel="noopener external nofollow noreferrer" target=_blank class=exturl>Cppreference<i class="fa fa-external-link-alt"></i></a> ä¸Šç»™äº†ä¸€ä¸ªå‰æï¼š</p><blockquote><p>Access to the same shared state from multiple threads is safe if each thread does it through its own copy of aÂ <code>shared_future</code>Â object.</p></blockquote><p><a href=https://stackoverflow.com/a/73835675/ title=https://stackoverflow.com/a/73835675/ rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://stackoverflow.com/a/73835675/<i class="fa fa-external-link-alt"></i></a> æœ‰æ›´è¯¦ç»†çš„è§£é‡Šï¼š<code>std::future</code> ä¸Šçš„ç­‰å¾…ä¹Ÿæ˜¯å®‰å…¨çš„ï¼Œä½†æ˜¯ <code>get()</code> ä¸æ˜¯ã€‚<code>std::future</code> çš„ <code>get()</code> å¯¹éå¼•ç”¨ç±»å‹è¿”å›çš„æ˜¯å€¼ç±»å‹ï¼Œç»“æœè¢«å–èµ°ä¹‹åå°±æ²¡æœ‰äº†ã€‚å°è¯•å¯¹ä¸€ä¸ªç»“æœå–å¤šæ¬¡ä¼šæŠ¥é”™ <code>std::future_error: No associated state</code>ï¼Œå°±ç®—å–èµ°ç»“æœä¹‹åæƒ³è¦å†è°ƒç”¨ <code>set_value()</code> ä¹Ÿä¼šæŠ¥é”™ <code>std::future_error: Promise already satisfied</code>ã€‚</p><p>è€Œ <code>std::shared_future</code> çš„ <code>get()</code> å¯¹éå¼•ç”¨ç±»å‹è¿”å›å¸¸é‡å¼•ç”¨ï¼Œåªè¦æœ‰ä¸€ä¸ªæ¶ˆè´¹è€…è¿˜æŒæœ‰å¯¹ç»“æœçš„å¼•ç”¨ï¼Œé‚£ä¹ˆç»“æœå°±ä¸ä¼šè¢«é”€æ¯ï¼ˆå°±åƒ <code>std::shared_ptr</code> é‚£æ ·ï¼‰ã€‚å› æ­¤åœ¨ <code>std::shared_future</code> ä¸Šå¯ä»¥å¤šæ¬¡è°ƒç”¨ <code>share()</code>ã€‚<a href=https://godbolt.org/z/Td37Y96hf title="Compiler Explorer ä¸Šçš„ä¾‹å­" rel="noopener external nofollow noreferrer" target=_blank class=exturl>Compiler Explorer ä¸Šçš„ä¾‹å­<i class="fa fa-external-link-alt"></i></a>ã€‚</p><div class="markdown-alert markdown-alert-note"><p class=markdown-alert-title><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1116 0A8 8 0 010 8zm8-6.5a6.5 6.5.0 100 13 6.5 6.5.0 000-13zM6.5 7.75A.75.75.0 017.25 7h1a.75.75.0 01.75.75v2.75h.25a.75.75.0 010 1.5h-2a.75.75.0 010-1.5h.25v-2h-.25a.75.75.0 01-.75-.75zM8 6a1 1 0 110-2 1 1 0 010 2z"/></svg>Note</p><p>å¯¹äºå¼•ç”¨ç±»å‹ï¼Œ<code>std::future</code> å’Œ <code>std::shared_future</code> éƒ½æ˜¯è¿”å›å¼•ç”¨ç±»å‹æœ¬èº«ã€‚</p></div><p>æˆ‘ä»¬éœ€è¦ä» <code>std::future</code> ä¸­åˆ›å»º <code>std::shared_future</code>ï¼Œè¦ä¹ˆä¼ å…¥å³å€¼ï¼ˆäº¡å€¼æˆ–è€…çº¯å³å€¼ï¼‰æ¥æ„å»ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#586e75>// 1
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>std<span style=color:#719e07>::</span>promise<span style=color:#719e07>&lt;</span><span style=color:#dc322f>int</span><span style=color:#719e07>&gt;</span> p;
</span></span><span style=display:flex><span>std<span style=color:#719e07>::</span>future<span style=color:#719e07>&lt;</span><span style=color:#dc322f>int</span><span style=color:#719e07>&gt;</span> f(p.get_future());
</span></span><span style=display:flex><span>assert(f.valid());                        
</span></span><span style=display:flex><span>std<span style=color:#719e07>::</span>shared_future<span style=color:#719e07>&lt;</span><span style=color:#dc322f>int</span><span style=color:#719e07>&gt;</span> sf(std<span style=color:#719e07>::</span>move(f));
</span></span><span style=display:flex><span>assert(<span style=color:#719e07>!</span>f.valid());                       
</span></span><span style=display:flex><span>assert(sf.valid())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75>// 2
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>std<span style=color:#719e07>::</span>promise<span style=color:#719e07>&lt;</span>std<span style=color:#719e07>::</span>string<span style=color:#719e07>&gt;</span> p;
</span></span><span style=display:flex><span>std<span style=color:#719e07>::</span>shared_future<span style=color:#719e07>&lt;</span>std<span style=color:#719e07>::</span>string<span style=color:#719e07>&gt;</span> sf(p.get_future());
</span></span></code></pre></div><p>è¦ä¹ˆè°ƒç”¨ <code>std::future</code> çš„ <code>.shared()</code> æ–¹æ³•ï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#719e07>auto</span> sf <span style=color:#719e07>=</span> p.get_future().share();
</span></span></code></pre></div><h1 id=ç­‰å¾…ä¸€æ®µæ—¶é—´>ç­‰å¾…ä¸€æ®µæ—¶é—´
<a class=header-anchor href=#%e7%ad%89%e5%be%85%e4%b8%80%e6%ae%b5%e6%97%b6%e9%97%b4></a></h1><p>ä¹‹å‰ä»‹ç»çš„ç­‰å¾…å‡½æ•°éƒ½åªèƒ½æ°¸ä¹…ç­‰å¾…ï¼Œä¸èƒ½æŒ‡å®šç­‰å¾…çš„æ—¶é—´ã€‚è¿™ä¸ªå°èŠ‚è¿˜ä»‹ç»äº†ä¸€äº› <code>std::chrono</code> ä¸­çš„ APIã€‚</p><h2 id=stdchrono-api><code>std::chrono</code> API
<a class=header-anchor href=#stdchrono-api></a></h2><p>æ—¶é’Ÿï¼š</p><ul><li><code>std::chrono::steady_clock</code></li><li><code>std::chrono::system_clock</code> ä¸æ˜¯ç¨³å®šçš„ï¼Œå› ä¸ºæ—¶é—´å¯ä»¥è®¾å®šã€‚å…¶ time_point å¯ä»¥å’Œ <code>std::time_t</code> é€šè¿‡ <code>to_time_t</code> å’Œ <code>from_time_t</code> ç›¸äº’è½¬æ¢ã€‚</li><li><code>std::chrono::high_resolution_clock</code></li></ul><p>æ—¶é—´ï¼š</p><p><code>std::chrono::duration&lt;></code> çš„æ¨¡æ¿å‚æ•°æ˜¯è¡¨ç¤ºç±»å‹ï¼ˆæ¯”å¦‚ doubleï¼‰å’Œ ratioï¼ˆå•ä½æ˜¯ç§’ï¼‰ã€‚</p><p>åœ¨ <code>std::chrono</code> ä¸­æœ‰å¾ˆå¤šæ—¶é—´å•ä½çš„å®šä¹‰ï¼š<code>nanoseconds</code>, <code>microseconds</code>, <code>milliseconds</code>, <code>seconds</code>, <code>minutes</code>, <code>hours</code> ç­‰ã€‚åœ¨ <code>std</code> ä¸­æœ‰å¾ˆå¤š SI æ¯”ä¾‹çš„å®šä¹‰ï¼š<code>std::atto</code>ï¼ˆ1e-18ï¼‰ã€<code>std::exa</code>ï¼ˆ1e18ï¼‰ç­‰ï¼Œè§ <a href=https://en.cppreference.com/w/cpp/numeric/ratio/ratio title=https://en.cppreference.com/w/cpp/numeric/ratio/ratio rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://en.cppreference.com/w/cpp/numeric/ratio/ratio<i class="fa fa-external-link-alt"></i></a> ã€‚å°¤å…¶æ˜¯è¦æ³¨æ„ <code>std::milli</code>ã€<code>std::micro</code>ã€<code>std::nano</code> è¿™äº›æ˜¯ SI æ¯”ä¾‹ï¼Œè€Œä¸æ˜¯æ—¶é—´å•ä½ã€‚</p><p>ç”¨å­—é¢é‡åç¼€æ“ä½œç¬¦æ›´æ–¹ä¾¿åœ°è¡¨ç¤ºæ—¶é—´ï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#719e07>using</span> <span style=color:#719e07>namespace</span> std<span style=color:#719e07>::</span>chrono_literals;
</span></span><span style=display:flex><span><span style=color:#719e07>auto</span> one_day<span style=color:#719e07>=</span><span style=color:#2aa198>24</span>h;
</span></span><span style=display:flex><span><span style=color:#719e07>auto</span> half_an_hour<span style=color:#719e07>=</span><span style=color:#2aa198>30</span>min;
</span></span><span style=display:flex><span><span style=color:#719e07>auto</span> max_time_between_messages<span style=color:#719e07>=</span><span style=color:#2aa198>30</span>ms;
</span></span></code></pre></div><p>ä»ä¸€ä¸ªæ—¶é—´å•ä½è½¬æ¢åˆ°å¦å¤–ä¸€ä¸ªæ—¶é—´å•ä½ç”¨ <code>std::chrono::duration_cast</code>ã€‚æ­¤å¤–ï¼Œduration è¿˜æ”¯æŒç®—æœ¯è¿ç®—ï¼</p><p>æ—¶åˆ»ï¼ˆæ—¶é—´ç‚¹ï¼‰ï¼š</p><p><code>std::chrono::time_point&lt;></code>ã€‚æ—¶é—´ç‚¹çš„å€¼æ˜¯ç›¸å…³æ—¶é’Ÿçš„çºªå…ƒï¼ˆepochï¼‰ã€‚</p><blockquote><p>Although you canâ€™t find out when the epoch is, you can get the <code>time_since_epoch()</code> for a given time_point. This member function returns a duration value specifying the length of time since the clock epoch to that particular time point.</p></blockquote><h2 id=wait_for-å’Œ-wait_until><code>wait_for</code> å’Œ <code>wait_until</code>
<a class=header-anchor href=#wait_for-%e5%92%8c-wait_until></a></h2><p><code>wait_for</code> é…åˆæ—¶é—´ï¼Œ<code>wait_util</code> é…åˆæ—¶åˆ»ã€‚å¾ˆå¤šæ—¶å€™ <code>wait_until</code> æ¯” <code>wait_for</code> æ›´åˆé€‚ï¼Œæ¯”å¦‚åœ¨å¾ªç¯ä¸­ç­‰å¾…æ¡ä»¶å˜é‡ä½†æ˜¯åˆä¸ä¼  predicate çš„æ—¶å€™ï¼Œç”±äºè™šå‡å”¤é†’çš„å­˜åœ¨ï¼Œ<code>wait_*</code> å¯èƒ½ä¼šè¢«è°ƒç”¨å¤šæ¬¡ï¼Œé‚£ä¹ˆ <code>wait_until</code> èƒ½æ›´åŠ å‡†ç¡®åœ°è¡¨ç¤ºæ—¶é—´ï¼Œè€Œä¸æ˜¯ï¼ˆå¯èƒ½ï¼‰æ°¸è¿œæ— æ³•ç¦»å¼€å¾ªç¯ã€‚ï¼ˆæ‰€ä»¥ç”¨æ¡ä»¶å˜é‡è¿˜æ˜¯ä¼  predicate æ¯”è¾ƒå¥½ã€‚ï¼‰</p><h1 id=æ¡ˆä¾‹parallel_quick_sort>æ¡ˆä¾‹ï¼š<code>parallel_quick_sort</code>
<a class=header-anchor href=#%e6%a1%88%e4%be%8bparallel_quick_sort></a></h1><p>ä¹¦ä¸­ä½¿ç”¨ <code>std::list</code> çš„ <code>splice()</code> æ“ä½œã€<code>std::partition</code> æ“ä½œå’Œ <code>std::async</code> æ“ä½œæ¥å®ç°äº†ä¸€ä¸ªå¹¶è¡Œçš„å¿«é€Ÿæ’åºç®—æ³•ã€‚è¿™ä¸ªå¿«é€Ÿæ’åºç®—æ³•éµå¾ªå‡½æ•°å¼ç¼–ç¨‹çš„æ€æƒ³ï¼Œåªå¯¹è¾“å…¥åšæ›´æ”¹ï¼Œå¹¶å°†ç»“æœä»¥è¿”å›å€¼çš„å½¢å¼ä½“ç°ã€‚æ¯æ¬¡æ‰¾åˆ° pivot çš„æ—¶å€™éƒ½ç”¨ <code>std::async</code> åˆ›å»ºä¸€ä¸ªæ–°çš„ä»»åŠ¡ã€‚ç°åœ¨åªæœ‰å­åŒºé—´æ˜¯å¹¶è¡Œçš„ï¼Œåˆ†åŒºè¿‡ç¨‹æœ¬èº«ä¸æ˜¯å¹¶è¡Œçš„ã€‚</p><p>åœ¨é»˜è®¤ç­–ç•¥ä¸‹ï¼Œ<code>std::async</code> ä¸ä¸€å®šæ¯æ¬¡éƒ½è¦åˆ›å»ºæ–°çš„çº¿ç¨‹ï¼Œæ˜¯å¦åˆ›å»ºæ–°çš„çº¿ç¨‹ç”±åº“çš„å®ç°å†³å®šã€‚</p><h1 id=æ¡ˆä¾‹ç”¨è‡ªåŠ¨çŠ¶æ€æœºæ€æƒ³å®ç°-atm-ç±»>æ¡ˆä¾‹ï¼šç”¨è‡ªåŠ¨çŠ¶æ€æœºæ€æƒ³å®ç° ATM ç±»
<a class=header-anchor href=#%e6%a1%88%e4%be%8b%e7%94%a8%e8%87%aa%e5%8a%a8%e7%8a%b6%e6%80%81%e6%9c%ba%e6%80%9d%e6%83%b3%e5%ae%9e%e7%8e%b0-atm-%e7%b1%bb></a></h1><p>ä¹¦é‡Œå‰é¢è®²äº† FPï¼Œè¿™é‡Œå®ç° ATM åˆ™æ˜¯ä¸ºäº†ä½“ç° CSP çš„æ€æƒ³ã€‚è¿™ä»½ä»£ç å¾ˆæœ‰æ„æ€ï¼Œé€šè¿‡ä¸€ä¸ªæŒ‡å‘æˆå‘˜å‡½æ•°çš„æŒ‡é’ˆæ¥è½¬ç§»çŠ¶æ€ï¼Œæ¯”è®¾ç½®æšä¸¾é‡ï¼Œç„¶åç”¨ switch æ¥è·³è½¬è¦æ˜¾å¾—æ›´åŠ ä¼˜é›…ã€‚</p><p><img src=/cpp-concurrency-in-action/assets/Pasted%20image%2020241130004610.webp width=600></p><p>è¿™ç§ç¼–ç¨‹èŒƒå¼åˆè¢«å«åšæ¼”å‘˜æ¨¡å‹ï¼ˆActor Modelï¼‰ï¼Œæ¯ä¸ªçº¿ç¨‹å……å½“ä¸€ä¸ªè§’è‰²ï¼Œæ‰§è¡Œä¸åŒçš„ä»»åŠ¡ã€‚</p><h1 id=concurrency-ts-ä¸­çš„-stdexperimentalfuture>Concurrency TS ä¸­çš„ `std::experimental::future
<a class=header-anchor href=#concurrency-ts-%e4%b8%ad%e7%9a%84-stdexperimentalfuture></a></h1><p><strong>å¢åŠ äº†å»¶ç»­ï¼ˆcontinuationï¼‰çš„æ¦‚å¿µï¼Œå¯ä»¥ç”¨ <code>then</code> å‡½æ•°æ¥ç»„ç»‡ futuresï¼ˆJavaã€Javascript éƒ½æœ‰ç±»ä¼¼çš„å‡½æ•°ï¼‰ã€‚ä½†æ˜¯è¿™ä¸ªææ¡ˆè¢«åºŸå¼ƒï¼Œå¹¶è¢«ï¼ˆè¢«è®¤ä¸ºæ›´å¥½çš„ï¼‰ executors æ¥ä»£æ›¿</strong>ï¼Œåè€…è¢«åŒ…å«åœ¨ C++26 ä¸­ã€‚</p><p><code>std::experimental::shared_future</code> ä¹Ÿå¯ä»¥ç”¨ <code>then</code>ï¼Œè€Œä¸”å¯ç”¨å¤šæ¬¡ã€‚</p><blockquote><p>The difference here is that <code>std::experimental::shared_future</code> objects can have more than one continuation, and the continuation parameter is a <code>std::experimental:: shared_future</code> rather than a <code>std::experimental::future</code>.</p></blockquote><h1 id=ç­‰å¾…ä¸€ç»„-futures>ç­‰å¾…ä¸€ç»„ futures
<a class=header-anchor href=#%e7%ad%89%e5%be%85%e4%b8%80%e7%bb%84-futures></a></h1><p>å¦‚æœæœ‰ä¸€ç»„ futures éœ€è¦ç­‰å¾…ï¼Œè€Œä¸”ç­‰å¾…çš„è¿‡ç¨‹æ˜¯ç”±å½“å‰æ¥å£çš„ä½¿ç”¨æ–¹æ¥è¿›è¡Œçš„ï¼Œé‚£ä¹ˆå¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„ futureï¼Œå¹¶ä¸”åœ¨è¿™ä¸ª future é‡Œé¢ç­‰å¾…ä¹‹å‰çš„æ‰€æœ‰ futuresã€‚</p><p><img src=/cpp-concurrency-in-action/assets/Pasted%20image%2020241208151603.webp></p><p>æˆ‘è®¤ä¸ºè¿™é‡Œå¯ä»¥æ·»åŠ ä¸€ä¸ª <code>std::launch::deferred</code> æ ‡è®°ï¼Œè¿™æ ·å°±ä¸å¿…ä¸ºâ€œç­‰å¾…â€è¿™ä¸ªè¿‡ç¨‹åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹äº†ã€‚</p><p>åœ¨ Concurrency TS ä¸­æœ‰ <a href=https://en.cppreference.com/w/cpp/experimental/when_all title=std::experimental::when_all rel="noopener external nofollow noreferrer" target=_blank class=exturl><code>std::experimental::when_all</code><i class="fa fa-external-link-alt"></i></a>ï¼ˆè¿”å›ä¸€ç»„ futuresï¼‰ å’Œ <a href=https://en.cppreference.com/w/cpp/experimental/when_any title=std::experimental::when_any rel="noopener external nofollow noreferrer" target=_blank class=exturl><code>std::experimental::when_any</code><i class="fa fa-external-link-alt"></i></a>ï¼ˆè¿”å›ä¸€ä¸ª <code>match_any_result</code>ï¼Œå®ƒåŒ…å«åŸæ¥çš„ futures å’Œé¦–å…ˆå¯ç”¨çš„ future çš„ä¸‹æ ‡ï¼‰ï¼Œå®ƒä»¬åˆ†åˆ«åˆ›å»ºåœ¨ futures éƒ½å¯ç”¨æ—¶å¯ç”¨çš„æ–° futureï¼Œå’Œè‡³å°‘æœ‰ä¸€ä¸ªå¯ç”¨å°±å¯ç”¨çš„æ–° futureã€‚<strong>å‰è€…ï¼ˆ<code>when_all</code>ï¼‰å¯ä»¥ç”±ä¸Šé¢æˆªå›¾çš„ä»£ç æ¥æ¨¡æ‹Ÿ</strong>ã€‚åè€…åœ¨ä¹¦ä¸Šæ²¡æœ‰ç»™å‡ºæ¨¡æ‹Ÿçš„ä»£ç ã€‚</p><h1 id=stdlatch-å’Œ-stdbarrier><code>std::latch</code> å’Œ <code>std::barrier</code>
<a class=header-anchor href=#stdlatch-%e5%92%8c-stdbarrier></a></h1><p>å†™ä¹¦æ—¶è¿™ä¸¤ä¸ªç±»è¿˜åœ¨ Concurrency TS ä¸­ï¼Œç°åœ¨è¿™ä¸¤ä¸ªç±»å·²ç»åŠ å…¥ C++20 ä¸­ã€‚</p><h2 id=stdlatch><code>std::latch</code>
<a class=header-anchor href=#stdlatch></a></h2><p><code>std::latch</code> æ¨¡å‹æ¯”è¾ƒç®€å•ï¼Œåªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼Œä¸€æ—¦è®¡æ•°é™ä½ï¼ˆ<code>count_down()</code>ï¼‰åˆ° 0ï¼Œå°±æ°¸è¿œä¿æŒåœ¨ ready çŠ¶æ€ï¼ˆåœ¨ Concurrency TS ä¸­å¯ä»¥ç”¨ <code>is_ready()</code> æŸ¥è¯¢ï¼Œè€Œåœ¨ C++20 ä¸­æœ‰ <code>try_wait()</code> æ–¹æ³•æ¥æŸ¥è¯¢ï¼‰ã€‚</p><h2 id=stdbarrier><code>std::barrier</code>
<a class=header-anchor href=#stdbarrier></a></h2><p>C++20 çš„ <code>std::barrier</code> æ˜¯ç»“åˆäº† Concurrency TS ä¸­ <code>barrier</code> å’Œ <code>flex_barrier</code> ç‰¹æ€§çš„ç±»ã€‚å®ƒæ˜¯ä¸€ä¸ªæ¨¡æ¿ç±»ï¼Œä½†æ˜¯ <code>std::experimental::barrier</code> å’Œ <code>std::experimental::flex_barrier</code> ä¸æ˜¯ã€‚</p><div class="markdown-alert markdown-alert-note"><p class=markdown-alert-title><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1116 0A8 8 0 010 8zm8-6.5a6.5 6.5.0 100 13 6.5 6.5.0 000-13zM6.5 7.75A.75.75.0 017.25 7h1a.75.75.0 01.75.75v2.75h.25a.75.75.0 010 1.5h-2a.75.75.0 010-1.5h.25v-2h-.25a.75.75.0 01-.75-.75zM8 6a1 1 0 110-2 1 1 0 010 2z"/></svg>Note</p><p><code>std::experimental::flex_barrier</code> æ¥å— completion å‡½æ•°ï¼Œä½†æ˜¯å±…ç„¶ä¸æ˜¯ç±»æ¨¡æ¿ï¼Œåº”è¯¥æ˜¯æœ‰ç±»å‹æ“¦é™¤ã€‚</p></div><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#719e07>template</span><span style=color:#719e07>&lt;</span> <span style=color:#719e07>class</span> <span style=color:#268bd2>CompletionFunction</span> <span style=color:#719e07>=</span> <span style=color:#586e75>/* ... */</span> <span style=color:#719e07>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#719e07>class</span> <span style=color:#268bd2>barrier</span>;
</span></span></code></pre></div><p>æ¥ä¸‹æ¥çš„å†…å®¹ä¼šç›´æ¥ä»‹ç» <code>std::barrier</code>ï¼Œå¹¶æŒ‡å‡ºå®ƒå’Œ <code>std::experimental::barrier</code> çš„åŒºåˆ«ã€‚</p><p><code>std::barrier</code> å’Œ <code>std::string</code> ä¸ä¸€æ ·ï¼Œ<code>std::string</code> æ˜¯ <code>std::basic_string</code> çš„ç‰¹åŒ–ï¼Œæ˜¯ä¸€ä¸ªå…·ä½“çš„ç±»ï¼Œè€Œ <code>std::barrier</code> æ˜¯ä¸€ä¸ªç±»æ¨¡æ¿ï¼Œè™½ç„¶åœ¨å®šä¹‰æ—¶å¯ä»¥åˆ©ç”¨ CTADï¼Œæ˜¾å¾—å’Œæ™®é€šç±»æ²¡æœ‰åŒºåˆ«ï¼Œä½†æ˜¯åœ¨å£°æ˜æ—¶å¿…é¡»ä½“ç°å®ƒæ˜¯æ¨¡æ¿ç±»ã€‚</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-diff data-lang=diff><span style=display:flex><span>    #include &lt;barrier&gt;
</span></span><span style=display:flex><span>    struct Foo {
</span></span><span style=display:flex><span><span style=color:#dc322f>-       std::barrier b;   // âŒ
</span></span></span><span style=display:flex><span><span style=color:#dc322f></span><span style=color:#719e07>+       std::barrier&lt;&gt; b; // âœ”
</span></span></span><span style=display:flex><span><span style=color:#719e07></span>    };
</span></span></code></pre></div><p>å®ƒè¿˜æœ‰ä¸ªé™æ€å¸¸é‡å‡½æ•°æ˜¯ <a href=https://en.cppreference.com/w/cpp/thread/barrier/max title=max rel="noopener external nofollow noreferrer" target=_blank class=exturl><code>max</code><i class="fa fa-external-link-alt"></i></a>ï¼Œè¡¨ç¤ºå½“å‰å®ç°ä¸­å…è®¸çš„æœ€å¤§åˆå§‹å€¼ã€‚åœ¨ <a href=https://godbolt.org/z/an3nE6qPY title=æˆ‘çš„ä¸€ä¸ªæµ‹è¯• rel="noopener external nofollow noreferrer" target=_blank class=exturl>æˆ‘çš„ä¸€ä¸ªæµ‹è¯•<i class="fa fa-external-link-alt"></i></a> ä¸­è¿”å› 64 ä½æœ‰ç¬¦å·æ•°çš„æœ€å¤§å€¼ï¼ˆä¸ä»£è¡¨æ¯ä¸ªå¹³å°éƒ½æ˜¯è¿™æ ·ï¼‰ã€‚</p><p>å¾ˆå¸¸è§çš„ä¸€ä¸ª barrier çš„ä½¿ç”¨åœºæ™¯æ˜¯ç”¨ CUDA ä¸­çš„ <code>__syncthreads()</code> å®Œæˆå—å†…çš„åŒæ­¥ã€‚</p><h3 id=æ„é€ å‡½æ•°>æ„é€ å‡½æ•°
<a class=header-anchor href=#%e6%9e%84%e9%80%a0%e5%87%bd%e6%95%b0></a></h3><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#719e07>constexpr</span> <span style=color:#719e07>explicit</span> <span style=color:#268bd2>barrier</span>( std<span style=color:#719e07>::</span>ptrdiff_t expected,
</span></span><span style=display:flex><span>                            CompletionFunction f <span style=color:#719e07>=</span> CompletionFunction());
</span></span><span style=display:flex><span>barrier( <span style=color:#719e07>const</span> barrier<span style=color:#719e07>&amp;</span> ) <span style=color:#719e07>=</span> <span style=color:#719e07>delete</span>;
</span></span></code></pre></div><p>ç¬¬äºŒä¸ªæ„é€ å‡½æ•°çš„å£°æ˜æ ‡å¿—ç€æ‹·è´æ„é€ å‡½æ•°ã€ç§»åŠ¨æ„é€ å‡½æ•° / èµ‹å€¼æ“ä½œç¬¦çš„åˆ é™¤ã€‚å¯ä»¥å‚è€ƒ
<a href=/posts/programming/cpp/C++-Rule-of-3-5-0/ title="C++ - Rule of 3, 5, 0">C++ - Rule of 3, 5, 0</a>ã€‚</p><h3 id=æˆå‘˜å‡½æ•°>æˆå‘˜å‡½æ•°
<a class=header-anchor href=#%e6%88%90%e5%91%98%e5%87%bd%e6%95%b0></a></h3><p><a href=https://en.cppreference.com/w/cpp/thread/barrier/barrier title=std::barrier rel="noopener external nofollow noreferrer" target=_blank class=exturl><code>std::barrier</code><i class="fa fa-external-link-alt"></i></a> å¯ä»¥åå¤ä½¿ç”¨ï¼Œä¸€ç»„çº¿ç¨‹å¿…é¡»è¦ä¸€èµ·æ¥åˆ°ç­‰å¾…ç‚¹æ‰èƒ½é€šè¿‡ï¼Œéƒ½é€šè¿‡ç­‰å¾…ç‚¹ä¹‹åè®¡æ•°å™¨å°±ä¼šé‡ç½®ã€‚æ¯ä¸€è½®å«åš <em>barrier phase</em>ã€‚å…¶è®¾è®¡æ€æƒ³æ˜¯ï¼šåªæœ‰åœ¨åŒæ­¥ç»„ä¸­çš„çº¿ç¨‹æ‰èƒ½ä½¿ç”¨ <code>arrive()</code> æ¥å‡å°‘è®¡æ•°ï¼Œè€Œä¸”åœ¨æ¯ä¸ª phase åªèƒ½ <code>arrive</code> ä¸€æ¬¡ã€‚å®ƒæœ‰ä»¥ä¸‹å‡ ä¸ªæ–¹æ³•ï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-txt data-lang=txt><span style=display:flex><span>arrive         : è®¡æ•°å‡ 1ï¼Œè¿”å› arrival_token
</span></span><span style=display:flex><span>wait           : åœ¨åŒæ­¥ç‚¹ï¼ˆphase synchronization pointï¼‰ç­‰å¾…è®¡æ•°å½’é›¶ï¼Œéœ€è¦ arrival_token ä½œä¸ºå‚æ•°
</span></span><span style=display:flex><span>arrive_and_wait: è®¡æ•°å‡ 1ï¼Œå¹¶ä¸”åœ¨åŒæ­¥ç‚¹ç­‰å¾…è®¡æ•°å½’é›¶
</span></span><span style=display:flex><span>arrive_and_drop: è®¡æ•°å‡ 1ï¼Œå¹¶ä¸”é€€å‡ºåŒæ­¥ç»„
</span></span></code></pre></div><p><code>std::barrier</code> æœ‰ä¸€ä¸ªåˆ é™¤äº†çš„ <code>operator=</code>ï¼Œè¿™ä¹Ÿæ ‡å¿—ç€å…¶æ— æ³•æ‹·è´èµ‹å€¼ã€‚ï¼ˆæ³¨æ„ï¼šç¦ç”¨æ‹·è´æ„é€ å¹¶ä¸ä¼šç¦ç”¨æ‹·è´èµ‹å€¼ï¼Œä¸¤è€…éœ€è¦åˆ†åˆ«ç¦ç”¨ã€‚ï¼‰</p><h3 id=-arrive-å’Œ-wait>âœ¨ <code>arrive()</code> å’Œ <code>wait()</code>
<a class=header-anchor href=#-arrive-%e5%92%8c-wait></a></h3><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸æƒ³é˜»å¡å…¶ä»–çº¿ç¨‹ç»§ç»­å‰è¿›ï¼Œå¯ä»¥ä½¿ç”¨ <code>arrive</code> è€Œä¸æ˜¯ <code>arrive_and_wait</code>ï¼Œä½†æ˜¯æ¥ä¸‹æ¥è¦ç”¨ <code>wait</code> åŒæ­¥ï¼ŒåŒæ—¶è¦ä¼ å…¥ä¹‹å‰ <code>arrive</code> è¿”å›çš„ <code>arrival_token</code>ã€‚å‚è€ƒ <a href=https://stackoverflow.com/questions/72213987/how-to-use-c-stdbarrier-arrival-token title=https://stackoverflow.com/questions/72213987/how-to-use-c-stdbarrier-arrival-token rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://stackoverflow.com/questions/72213987/how-to-use-c-stdbarrier-arrival-token<i class="fa fa-external-link-alt"></i></a> ã€‚<strong><code>arrive()</code> å’Œ <code>wait()</code> æ˜¯ <code>std::barrier</code> ç›¸æ¯” <code>std::experimental::barrier</code> å¤šå‡ºçš„ä¸¤ä¸ªå‡½æ•°ã€‚</strong></p><h3 id=-completion-å‡½æ•°>âœ¨ completion å‡½æ•°
<a class=header-anchor href=#-completion-%e5%87%bd%e6%95%b0></a></h3><p>å’Œåªèƒ½æŒ‡å®šçº¿ç¨‹æ•°é‡çš„ <a href=https://en.cppreference.com/w/cpp/experimental/barrier/barrier title=std::experiment::barrier rel="noopener external nofollow noreferrer" target=_blank class=exturl><code>std::experiment::barrier</code><i class="fa fa-external-link-alt"></i></a> ç›¸æ¯”ï¼Œ<strong><code>std::barrier</code> è¿˜å¯ä»¥æŒ‡å®š completion å‡½æ•°</strong>ï¼Œè¿™ä¸ªå‡½æ•°åœ¨æ‰€æœ‰çº¿ç¨‹è¾¾åˆ°åŒæ­¥ç‚¹æ—¶è¿è¡Œï¼Œè€Œä¸”åªä¼šè¢«ä¸€ä¸ªçº¿ç¨‹è¿è¡Œã€‚ä» <a href=https://godbolt.org/z/1hMKKqve5 title=https://godbolt.org/z/1hMKKqve5 rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://godbolt.org/z/1hMKKqve5<i class="fa fa-external-link-alt"></i></a> çš„ç»“æœæ¥çœ‹ï¼Œåº”è¯¥æ˜¯è¢«æœ€åä¸€ä¸ªåˆ°è¾¾åŒæ­¥ç‚¹çš„çº¿ç¨‹è¿è¡Œã€‚å¦‚æœæ²¡æœ‰çº¿ç¨‹è°ƒç”¨ <code>wait()</code>ï¼Œé‚£ä¹ˆ completion å‡½æ•°æ˜¯å¦è¢«è°ƒç”¨æ˜¯å®ç°å®šä¹‰çš„ï¼š</p><blockquote><p>A barrierÂ <em>phase</em>Â consists of the following steps:</p><ol><li>TheÂ <em>expected count</em>Â is decremented by each call toÂ <a href=https://en.cppreference.com/w/cpp/thread/barrier/arrive title=arrive rel="noopener external nofollow noreferrer" target=_blank class=exturl><code>arrive</code><i class="fa fa-external-link-alt"></i></a>Â orÂ <a href=https://en.cppreference.com/w/cpp/thread/barrier/arrive_and_drop title=arrive_and_drop rel="noopener external nofollow noreferrer" target=_blank class=exturl><code>arrive_and_drop</code><i class="fa fa-external-link-alt"></i></a>.</li><li>When the expected count reaches zero, theÂ <em>phase completion step</em>Â is run, meaning that theÂ <a href=https://en.cppreference.com/w/cpp/thread/barrier#Data_members title=_completion_ rel="noopener external nofollow noreferrer" target=_blank class=exturl><code>_completion_</code><i class="fa fa-external-link-alt"></i></a>Â is invoked, and all threads blocked on the phase synchronization point are unblocked. The end of the completion stepÂ <a href=https://en.cppreference.com/w/cpp/atomic/memory_order#Strongly_happens-before title="strongly happens-before" rel="noopener external nofollow noreferrer" target=_blank class=exturl>strongly happens-before<i class="fa fa-external-link-alt"></i></a>Â all calls that were unblocked by the completion step return.<br>Exactly once after the expected count reaches zero, <mark>a thread executes the completion step during its call toÂ <a href=https://en.cppreference.com/w/cpp/thread/barrier/arrive title=arrive rel="noopener external nofollow noreferrer" target=_blank class=exturl><code>arrive</code><i class="fa fa-external-link-alt"></i></a>,Â <a href=https://en.cppreference.com/w/cpp/thread/barrier/arrive_and_drop title=arrive_and_drop rel="noopener external nofollow noreferrer" target=_blank class=exturl><code>arrive_and_drop</code><i class="fa fa-external-link-alt"></i></a>, orÂ <a href=https://en.cppreference.com/w/cpp/thread/barrier/wait title=wait rel="noopener external nofollow noreferrer" target=_blank class=exturl><code>wait</code><i class="fa fa-external-link-alt"></i></a></mark>, <mark>except that it is implementation-defined whether the step executes if no thread callsÂ <a href=https://en.cppreference.com/w/cpp/thread/barrier/wait title=wait rel="noopener external nofollow noreferrer" target=_blank class=exturl><code>wait</code><i class="fa fa-external-link-alt"></i></a></mark>.</li><li>When the completion step finishes, the expected count is reset to the value specified at construction less the number of calls toÂ <a href=https://en.cppreference.com/w/cpp/thread/barrier/arrive_and_drop title=arrive_and_drop rel="noopener external nofollow noreferrer" target=_blank class=exturl><code>arrive_and_drop</code><i class="fa fa-external-link-alt"></i></a>Â since, and the nextÂ <em>barrier phase</em>Â begins.</li></ol></blockquote><p>ä¸Šè¿°å¼•ç”¨ä¹Ÿè¡¨æ˜æœ€åä¸€ä¸ªåˆ°è¾¾çš„çº¿ç¨‹ä¼šåœ¨è°ƒç”¨ <code>arrive</code> ç­‰æ–¹æ³•çš„æ—¶å€™æ¥æ‰§è¡Œ completion å‡½æ•°ã€‚</p><p>Completion å‡½æ•°å¯ä»¥ç®€åŒ–å¾ˆå¤šä»£ç é€»è¾‘ï¼Œç‰¹åˆ«æ˜¯æ¯ä¸€è½®éœ€è¦æ¸…ç†å·¥ä½œæ—¶ã€‚å¦‚æœæ²¡æœ‰ completion å‡½æ•°ï¼Œè€Œæ˜¯ç”± 0 å·çº¿ç¨‹å®Œæˆæ¸…ç†å·¥ä½œï¼Œä¸ºäº†é˜²æ­¢å…¶ä»–çº¿ç¨‹åœ¨æ¸…ç†å·¥ä½œå®Œæˆä¹‹å‰è¿›å…¥ä¸‹ä¸€è½®å·¥ä½œï¼Œéœ€è¦å¢åŠ ä¸€ä¸ªåŒæ­¥ç‚¹â€”â€”åœ¨ç¬¬äºŒä¸ªåŒæ­¥ç‚¹åªæœ‰ 0 å·çº¿ç¨‹åœ¨å®Œæˆæ¸…ç†å·¥ä½œï¼Œå…¶ä»–çº¿ç¨‹é˜»å¡ç­‰å¾…ã€‚ä¸€æ–¹é¢æ˜¯é€»è¾‘ä»£ç ä¼šæ˜¾å¾—å¤æ‚ï¼Œå¦ä¸€æ–¹é¢æ˜¯<strong>å…¶ä»–çº¿ç¨‹åˆšè¢«å”¤é†’åˆè¦å†æ¬¡è¿›å…¥ç¡çœ çŠ¶æ€ç­‰å¾…æ¸…ç†å·¥ä½œå®Œæˆ</strong>ã€‚</p><h2 id=stdexperimentalflex_barrier><code>std::experimental::flex_barrier</code>
<a class=header-anchor href=#stdexperimentalflex_barrier></a></h2><p>Concurrency TS ä¸­è¿˜æœ‰ä¸€ä¸ª <code>flex_barrier</code>ï¼Œä½†æ˜¯æ²¡æœ‰è¿›å…¥ C++20ã€‚è¿™ä¸ªç±»å¯ä»¥éšæ—¶ä¿®æ”¹åŒæ­¥ç»„ä¸­çš„çº¿ç¨‹æ•°é‡ï¼Œè¿˜å¯ä»¥æŒ‡å®šæ‰€æœ‰çº¿ç¨‹åˆ°è¾¾åŒæ­¥ç‚¹æ—¶è¦è¿è¡Œçš„ completion å‡½æ•°ï¼ˆ<code>std::experiment::barrier</code> æ²¡æœ‰è¿™ä¸ªåŠŸèƒ½ï¼Œä½†æ˜¯ <code>std::barrier</code> æœ‰ï¼‰ã€‚<code>flex_barrier</code> å¯ä»¥é€šè¿‡ completion å‡½æ•°çš„è¿”å›å€¼æ¥ä¿®æ”¹ä¸‹ä¸€è½®åŒæ­¥ç»„ä¸­çš„çº¿ç¨‹æ•°é‡ï¼Œ-1 è¡¨ç¤ºä¸æ”¹å˜ï¼Œéè´Ÿè¡¨ç¤ºä¸‹ä¸€è½®åŒæ­¥ç»„ä¸­çš„çº¿ç¨‹æ•°é‡ï¼Œè¿™ä¸ªç‰¹æ€§æ˜¯ <code>std::barrier</code> ä¸å…·å¤‡çš„ã€‚</p></div><footer class=post-footer><div class=post-tags><a href=/tags/cpp>cpp
</a><a href=/tags/cpp-concurrency-in-action>cpp-concurrency-in-action</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/cpp-concurrency-in-action/5.-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80%E6%A0%87%E5%87%86%E5%8E%9F%E5%AD%90%E7%B1%BB%E5%9E%8B%E8%87%AA%E6%97%8B%E9%94%81/ rel=next title="5. å†…å­˜æ¨¡å‹åŸºç¡€ã€æ ‡å‡†åŸå­ç±»å‹ã€è‡ªæ—‹é”"><i class="fa fa-chevron-left"></i> 5. å†…å­˜æ¨¡å‹åŸºç¡€ã€æ ‡å‡†åŸå­ç±»å‹ã€è‡ªæ—‹é”</a></div><div class="post-nav-prev post-nav-item"><a href=/cpp-concurrency-in-action/3.-Sharing-data-between-threads/ rel=prev title="3. Sharing data between threads">3. Sharing data between threads
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2023 - 2025
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>ğŸ¤–</span></div><div class=powered-by>ç”± <a href=https://gohugo.io title=0.143.1 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.5.3 target=_blank>Hugo NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨</div></div></footer><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js defer></script><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":false,"save":"manual"},"copybtn":true,"darkmode":false,"hostname":"https://hxhue.github.io/","i18n":{"ds_day":" å¤©å‰","ds_days":" å¤© ","ds_hour":" å°æ—¶å‰","ds_hours":" å°æ—¶ ","ds_just":"åˆšåˆš","ds_min":" åˆ†é’Ÿå‰","ds_mins":" åˆ†é’Ÿ","ds_month":" ä¸ªæœˆå‰","ds_years":" å¹´ ","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","placeholder":"æœç´¢..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":false,"transition":{"collheader":"fadeInLeft","menu_item":"fadeInDown","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":false,"plugin":"waline"},"views":{"enable":false,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"cdnjs","router":"https://cdnjs.cloudflare.com/ajax/libs"},"version":"4.5.3"}</script><script type=text/javascript src=/js/main.min.37ba8b54f9d4d784d08028c45eea93b5d4e13eda8ee7fb0d2edd6f3fac66cfd2.js defer></script></body></html>