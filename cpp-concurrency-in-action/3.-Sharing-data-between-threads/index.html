<!doctype html><html lang=zh-CN data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.143.1"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="3. Sharing data between threads"><meta itemprop=description content="ä¸ªäººåšå®¢ï¼Œä¸»è¦æ˜¯é›¶æ•£çš„ç¬”è®°ã€‚"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://hxhue.github.io/imgs/371907.jpg"><meta itemprop=keywords content="cpp,cpp-concurrency-in-action"><link type=text/css rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css><link rel=stylesheet href=/css/main.min.bea76f574a755574e17d42bea39502a74ca3ca4db65807b8c82d3e26dcec8420.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ æˆ‘å¯æ˜¯æœ‰åº•çº¿çš„å“Ÿ ~"}</style><link rel=stylesheet type=text/css href=/css/style.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/github-markdown-css@5.3.0/github-markdown-dark.css><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js></script><script>MathJax={tex:{displayMath:[["$$","$$"],["\\[","\\]"]],inlineMath:[["$","$"],["\\(","\\)"]]},svg:{fontCache:"global"}}</script><script type=module>
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: false });
  mermaid.mermaidAPI.initialize();
  window.mermaid = mermaid;
</script><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":false,"isPage":true,"path":"3.-Sharing-data-between-threads","permalink":"https://hxhue.github.io/cpp-concurrency-in-action/3.-Sharing-data-between-threads/","title":"3. Sharing data between threads","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>3. Sharing data between threads - Bluegill</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>Bluegill</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description></p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>é¦–é¡µ</a></li><li class="menu-item menu-item-about"><a href=/about/ class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>å…³äº</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>å½’æ¡£</a></li><li class="menu-item menu-item-categories"><a href=/categories/ class=hvr-icon-pulse rel=section><i class="fa fa-th hvr-icon"></i>åˆ†ç±»</a></li><li class="menu-item menu-item-tags"><a href=/tags/ class=hvr-icon-pulse rel=section><i class="fa fa-hashtag hvr-icon"></i>æ ‡ç­¾</a></li><li class="menu-item menu-item-daily"><a href=/daily/ class=hvr-icon-pulse rel=section><i class="fa fa-newspaper hvr-icon"></i>éšç¬”</a></li><li class="menu-item menu-item-discovery"><a href=https://rift-fear-f2c.notion.site/2025-1e354a33cfb1802c841bdf29f2f3dab3 class=hvr-icon-pulse rel=section><i class="fa fa-compass hvr-icon"></i>å‘ç°</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>æœç´¢</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=æœç´¢... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>æ–‡ç« ç›®å½•</li><li class=sidebar-nav-overview>ç«™ç‚¹æ¦‚è§ˆ</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#ä¸‰ç§é¿å…ç«äº‰æƒ…å†µçš„åŠæ³•>ä¸‰ç§é¿å…ç«äº‰æƒ…å†µçš„åŠæ³•</a></li><li><a href=#ä½¿ç”¨äº’æ–¥é‡ä¿æŠ¤ä¸´ç•ŒåŒº>ä½¿ç”¨äº’æ–¥é‡ä¿æŠ¤ä¸´ç•ŒåŒº</a></li><li><a href=#æ¡ˆä¾‹å®ç°çº¿ç¨‹å®‰å…¨çš„æ ˆtop-å’Œ-pop-çš„åŸå­åŒ–>æ¡ˆä¾‹ï¼šå®ç°çº¿ç¨‹å®‰å…¨çš„æ ˆï¼ˆ<code>top()</code> å’Œ <code>pop()</code> çš„åŸå­åŒ–ï¼‰</a><ul><li><a href=#è§£å†³æ–¹æ¡ˆ-1ç”¨è¾“å‡ºå‚æ•°è¿”å›ç»“æœ>è§£å†³æ–¹æ¡ˆ 1ï¼šç”¨è¾“å‡ºå‚æ•°è¿”å›ç»“æœ</a></li><li><a href=#è§£å†³æ–¹æ¡ˆ-2è¿”å›æŒ‡é’ˆ>è§£å†³æ–¹æ¡ˆ 2ï¼šè¿”å›æŒ‡é’ˆ</a></li><li><a href=#è§£å†³æ–¹æ¡ˆ-3é™åˆ¶å®¹å™¨å…ƒç´ ç±»å‹>è§£å†³æ–¹æ¡ˆ 3ï¼šé™åˆ¶å®¹å™¨å…ƒç´ ç±»å‹</a></li></ul></li><li><a href=#é¿å…æ­»é”>é¿å…æ­»é”</a><ul><li><a href=#ä¸€æ¬¡æ€§è·å–å¤šä¸ªé”stdlockstdscoped_lock>ä¸€æ¬¡æ€§è·å–å¤šä¸ªé”ï¼ˆ<code>std::lock</code>ã€<code>std::scoped_lock</code>ï¼‰</a></li><li><a href=#åˆ†æ­¥éª¤è·å–é”>åˆ†æ­¥éª¤è·å–é”</a></li><li><a href=#å…¶ä»–å½¢å¼çš„æ­»é”>å…¶ä»–å½¢å¼çš„æ­»é”</a></li><li><a href=#é¿å…åµŒå¥—é”>é¿å…åµŒå¥—é”</a></li></ul></li><li><a href=#æ¡ˆä¾‹å®ç°å±‚æ¬¡é”>æ¡ˆä¾‹ï¼šå®ç°å±‚æ¬¡é”</a></li><li><a href=#stdunique_lock><code>std::unique_lock</code></a><ul><li><a href=#ä¸‰ç§æ¨¡å¼ç»§æ‰¿é”ç«‹å³é”å»¶è¿Ÿé”æ–°>ä¸‰ç§æ¨¡å¼ï¼šç»§æ‰¿é”ã€ç«‹å³é”ã€å»¶è¿Ÿé”ï¼ˆæ–°ï¼‰</a></li><li><a href=#api-è®¾è®¡>API è®¾è®¡</a></li><li><a href=#å¼€é”€>å¼€é”€</a></li></ul></li><li><a href=#åœ¨åˆå§‹åŒ–æ—¶ä¿æŠ¤æ•°æ®>åœ¨åˆå§‹åŒ–æ—¶ä¿æŠ¤æ•°æ®</a><ul><li><a href=#åŒéªŒé”>åŒéªŒé”ï¼ˆâŒï¼‰</a></li><li><a href=#stdcall_once><code>std::call_once</code></a></li><li><a href=#åˆ©ç”¨å‡½æ•°ä¸­é™æ€æˆå‘˜çš„åˆå§‹åŒ–>åˆ©ç”¨å‡½æ•°ä¸­é™æ€æˆå‘˜çš„åˆå§‹åŒ–</a></li></ul></li><li><a href=#å…±äº«é”>å…±äº«é”</a></li><li><a href=#é€’å½’é”stdrecursive_lock>é€’å½’é”ï¼ˆ<code>std::recursive_lock</code>ï¼‰</a></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=ğŸ¤– src=/imgs/371907.jpg><p class=site-author-name itemprop=name>ğŸ¤–</p><div class=site-description itemprop=description>ä¸ªäººåšå®¢ï¼Œä¸»è¦æ˜¯é›¶æ•£çš„ç¬”è®°ã€‚</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>433</span>
<span class=site-state-item-name>æ—¥å¿—</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>12</span>
<span class=site-state-item-name>åˆ†ç±»</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>86</span>
<span class=site-state-item-name>æ ‡ç­¾</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/hxhue title="Github â†’ https://github.com/hxhue" rel=noopener target=_blank><i class="fab fa-github fa-fw"></i>
Github
</a></span><span class=links-of-social-item><a href=/rss.xml title="RSS è®¢é˜… â†’ /rss.xml" rel=noopener target=_blank><i class="fa fa-rss fa-fw"></i>
RSS è®¢é˜…</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=å…±äº«çŸ¥è¯†><img src=/imgs/cc/big/by_nc_sa.svg alt=å…±äº«çŸ¥è¯†></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
å‹æƒ…é“¾æ¥</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://shuai.guru/ title=https://shuai.guru/ target=_blank>shuai.guru</a></li></ul></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=toggle-theme class=button title=æ·±æµ…æ¨¡å¼åˆ‡æ¢><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=è¿”å›é¡¶éƒ¨><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://hxhue.github.io/cpp-concurrency-in-action/3.-Sharing-data-between-threads/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/371907.jpg"><meta itemprop=name content="ğŸ¤–"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="ğŸ¤–"><meta itemprop=description content="ä¸ªäººåšå®¢ï¼Œä¸»è¦æ˜¯é›¶æ•£çš„ç¬”è®°ã€‚"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="3. Sharing data between threads"><meta itemprop=description content="ä¸‰ç§é¿å…ç«äº‰æƒ…å†µçš„åŠæ³•


ä¸Šé”ã€‚
æ— é”ç¼–ç¨‹ã€‚é€šå¸¸é€šè¿‡ä¿®æ”¹æ•°æ®ç»“æ„å’Œ invariantsï¼ˆæ•°æ®ç»“æ„è¦ä¿æŒçš„çº¦æŸï¼‰æ¥å®Œæˆã€‚
äº‹åŠ¡ï¼ˆsoftware transactional memory, STMï¼‰ã€‚

ä½¿ç”¨äº’æ–¥é‡ä¿æŠ¤ä¸´ç•ŒåŒº

std::lock_guardï¼ˆå¯ä»¥ç”¨ CTADï¼‰å’Œ std::mutex APIã€‚C++11 é™¤äº† std::mutex ä¹‹å¤–è¿˜æœ‰ std::timed_mutexã€std::recursive_mutexã€std::recursive_timed_mutexã€‚"></span><header class=post-header><h1 class=post-title itemprop="name headline">3. Sharing data between threads</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=å‘è¡¨äº>å‘è¡¨äºï¼š
</span><time title="åˆ›å»ºæ—¶é—´ï¼š2024-09-29 00:00:00 +0800 CST" itemprop="dateCreated datePublished" datetime="2024-09-29 00:00:00 +0800 CST">2024-09-29
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar-check"></i>
</span><span class=post-meta-item-text title=æ›´æ–°äº>æ›´æ–°äºï¼š
</span><time title=ä¿®æ”¹æ—¶é—´ï¼š2025-01-24T00:00:00+08:00 itemprop=dateModified datetime=2025-01-24T00:00:00+08:00>2025-01-24</time>
</span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i>
</span><span class=post-meta-item-text title=åˆ†ç±»äº>åˆ†ç±»äºï¼š
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/cpp-concurrency-in-action itemprop=url rel=index><span itemprop=name>cpp-concurrency-in-action</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=å­—æ•°><span class=post-meta-item-icon><i class="far fa-file-word"></i>
</span><span class=post-meta-item-text>å­—æ•°ï¼š</span>
<span>4581</span>
</span><span class=post-meta-item title=é˜…è¯»><span class=post-meta-item-icon><i class="far fa-clock"></i>
</span><span class=post-meta-item-text>é˜…è¯»ï¼š&ap;</span>
<span>10åˆ†é’Ÿ</span></span></div></div></header><div class=post-body itemprop=articleBody><h1 id=ä¸‰ç§é¿å…ç«äº‰æƒ…å†µçš„åŠæ³•>ä¸‰ç§é¿å…ç«äº‰æƒ…å†µçš„åŠæ³•
<a class=header-anchor href=#%e4%b8%89%e7%a7%8d%e9%81%bf%e5%85%8d%e7%ab%9e%e4%ba%89%e6%83%85%e5%86%b5%e7%9a%84%e5%8a%9e%e6%b3%95></a></h1><ol><li>ä¸Šé”ã€‚</li><li>æ— é”ç¼–ç¨‹ã€‚é€šå¸¸é€šè¿‡ä¿®æ”¹æ•°æ®ç»“æ„å’Œ invariantsï¼ˆæ•°æ®ç»“æ„è¦ä¿æŒçš„çº¦æŸï¼‰æ¥å®Œæˆã€‚</li><li>äº‹åŠ¡ï¼ˆsoftware transactional memory, STMï¼‰ã€‚</li></ol><h1 id=ä½¿ç”¨äº’æ–¥é‡ä¿æŠ¤ä¸´ç•ŒåŒº>ä½¿ç”¨äº’æ–¥é‡ä¿æŠ¤ä¸´ç•ŒåŒº
<a class=header-anchor href=#%e4%bd%bf%e7%94%a8%e4%ba%92%e6%96%a5%e9%87%8f%e4%bf%9d%e6%8a%a4%e4%b8%b4%e7%95%8c%e5%8c%ba></a></h1><p><code>std::lock_guard</code>ï¼ˆå¯ä»¥ç”¨ CTADï¼‰å’Œ <code>std::mutex</code> APIã€‚C++11 é™¤äº† <code>std::mutex</code> ä¹‹å¤–è¿˜æœ‰ <code>std::timed_mutex</code>ã€<code>std::recursive_mutex</code>ã€<code>std::recursive_timed_mutex</code>ã€‚</p><p>ä¸è¦æŠŠå—ä¿æŠ¤æ•°æ®çš„å¼•ç”¨ä¼ å‡ºé”çš„ä¿æŠ¤èŒƒå›´å¤–ï¼Œå°¤å…¶æ˜¯è¦æ³¨æ„ä¸è¦æŠŠå®ƒçš„å¼•ç”¨ä¼ å…¥åˆ°æ¥å†ä¸æ˜çš„å…¶ä»–å‡½æ•°ä¸­ã€‚</p><h1 id=æ¡ˆä¾‹å®ç°çº¿ç¨‹å®‰å…¨çš„æ ˆtop-å’Œ-pop-çš„åŸå­åŒ–>æ¡ˆä¾‹ï¼šå®ç°çº¿ç¨‹å®‰å…¨çš„æ ˆï¼ˆ<code>top()</code> å’Œ <code>pop()</code> çš„åŸå­åŒ–ï¼‰
<a class=header-anchor href=#%e6%a1%88%e4%be%8b%e5%ae%9e%e7%8e%b0%e7%ba%bf%e7%a8%8b%e5%ae%89%e5%85%a8%e7%9a%84%e6%a0%88top-%e5%92%8c-pop-%e7%9a%84%e5%8e%9f%e5%ad%90%e5%8c%96></a></h1><p>æ¥å£è®¾è®¡ä¸Šçš„é—®é¢˜ï¼šæ ˆçš„ API ä¸­ <code>empty()</code> å’Œå…¶ä»–æ–¹æ³•å„è‡ªåŸå­æ˜¯ä¸å¤Ÿçš„ï¼Œå› ä¸º <code>empty()</code> çš„ç»“æœåœ¨ä¸‹ä¸€ä¸ªæ–¹æ³•è¿è¡Œæ—¶ä¸ä¸€å®šè¿˜èƒ½æˆç«‹ã€‚</p><p>æˆ‘ä»¬ä¹Ÿå¯èƒ½æƒ³æŠŠ <code>pop()</code> å’Œ <code>top()</code> ä¸¤ä¸ªå‡½æ•°ç»“åˆï¼Œå°†å®ƒä»¬åˆå¹¶æˆä¸€ä¸ªåŸå­åŒ–çš„åŠŸèƒ½ï¼Œä½†åˆä¼šé‡åˆ°å¼‚å¸¸å®‰å…¨çš„é—®é¢˜ï¼ˆ<strong>å…ƒç´ çš„æ„é€ å‡½æ•°æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œè¢« pop çš„æ•°æ®ä¼šä¸¢å¤±</strong>ï¼‰ã€‚</p><h2 id=è§£å†³æ–¹æ¡ˆ-1ç”¨è¾“å‡ºå‚æ•°è¿”å›ç»“æœ>è§£å†³æ–¹æ¡ˆ 1ï¼šç”¨è¾“å‡ºå‚æ•°è¿”å›ç»“æœ
<a class=header-anchor href=#%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-1%e7%94%a8%e8%be%93%e5%87%ba%e5%8f%82%e6%95%b0%e8%bf%94%e5%9b%9e%e7%bb%93%e6%9e%9c></a></h2><p><code>pop()</code> ä¸è¿”å›å€¼ï¼Œè€Œæ˜¯å°†å€¼å­˜åœ¨å¼•ç”¨ä¸­ã€‚è¿™è¦æ±‚ç”¨æˆ·æå‰åˆ†é…å¥½ç©ºé—´ï¼Œè€Œä¸”åœ¨æˆåŠŸå°†å€¼èµ‹å€¼å‡ºå»ä¹‹å‰ï¼Œæ ˆå¯ä»¥ä¸ç”¨èˆå¼ƒæ•°æ®ã€‚è¿™ä¿è¯äº†å¤±è´¥æ—¶æ ˆä¸­çš„æ•°æ®ä¸ä¸¢å¤±ã€‚</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span>std<span style=color:#719e07>::</span>vector<span style=color:#719e07>&lt;</span><span style=color:#dc322f>int</span><span style=color:#719e07>&gt;</span> result;
</span></span><span style=display:flex><span>some_stack.pop(result);
</span></span></code></pre></div><p>ç¼ºç‚¹ï¼šç”¨æˆ·è¦æå‰åˆ†é…ç©ºé—´ã€å…ƒç´ ç±»å‹è¦æ”¯æŒèµ‹å€¼æ“ä½œç¬¦ï¼ˆå¾ˆå¤šç±»å¯èƒ½æ²¡æœ‰å®ç°ï¼‰ã€å…ƒç´ ç±»å‹è¦æ”¯æŒé»˜è®¤æ„é€ æˆ–è€…èƒ½æå‰çŸ¥é“ç”¨æ¥æ„é€ å…ƒç´ çš„å‚æ•°ã€‚</p><h2 id=è§£å†³æ–¹æ¡ˆ-2è¿”å›æŒ‡é’ˆ>è§£å†³æ–¹æ¡ˆ 2ï¼šè¿”å›æŒ‡é’ˆ
<a class=header-anchor href=#%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-2%e8%bf%94%e5%9b%9e%e6%8c%87%e9%92%88></a></h2><p>è¿”å›æŒ‡é’ˆï¼Œå› ä¸ºæŒ‡é’ˆçš„å¤åˆ¶æ˜¯ä¸ä¼šå¯¼è‡´å¼‚å¸¸çš„ã€‚Java å°±èƒ½é‡‡ç”¨è¿™ç§æ–¹æ¡ˆã€‚</p><p>æ™ºèƒ½æŒ‡é’ˆåœ¨è¡Œä¸ºä¸Šå’ŒæŒ‡é’ˆéå¸¸ç›¸ä¼¼ï¼Œå…¶ä¸­çš„å…±äº«æŒ‡é’ˆåœ¨æ‹·è´æ—¶ä¹Ÿä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæ‰€ä»¥ä¹¦ä¸Šç»™äº†ä¸€ä¸ªå…±äº«æŒ‡é’ˆçš„ä¾‹å­ã€‚ï¼ˆç”¨ <code>std::unique_ptr&lt;></code> ä¸ä¹Ÿå¯ä»¥å—ï¼Ÿï¼‰</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span>std<span style=color:#719e07>::</span>shared_ptr<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> pop() {
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span>lock_guard<span style=color:#719e07>&lt;</span>std<span style=color:#719e07>::</span>mutex<span style=color:#719e07>&gt;</span> lock(m);
</span></span><span style=display:flex><span>    <span style=color:#719e07>if</span>(data.empty()) <span style=color:#719e07>throw</span> empty_stack();    
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span>shared_ptr<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> <span style=color:#719e07>const</span> res(std<span style=color:#719e07>::</span>make_shared<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span>(data.top())); <span style=color:#586e75>// A
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    data.pop();                                          
</span></span><span style=display:flex><span>    <span style=color:#719e07>return</span> res;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>A å¤„å¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå› ä¸ºè¦å¤åˆ¶æ„é€ æ ˆé¡¶å…ƒç´ ï¼Œä½†æ˜¯å°±ç®—æŠ›å‡ºå¼‚å¸¸ä¹Ÿæ˜¯å®‰å…¨çš„ï¼Œå› ä¸ºæ•°æ®è¿˜åœ¨æ ˆä¸Šæ²¡æœ‰ä¸¢å¤±ã€‚æœ€åè¿”å› <code>res</code> æ—¶åˆå› ä¸ºå…±äº«æŒ‡é’ˆæ˜¯æˆ‘ä»¬å·²çŸ¥çš„å¤åˆ¶æ„é€ ä¸ä¼šå¤±è´¥çš„ç±»å‹ï¼Œæ‰€ä»¥ä¿è¯äº†å®‰å…¨ã€‚</p><p>ç¼ºç‚¹ï¼šè¦æ±‚å…ƒç´ èƒ½å¤Ÿå¤åˆ¶æ„é€ ã€‚</p><div class="markdown-alert markdown-alert-note"><p class=markdown-alert-title><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1116 0A8 8 0 010 8zm8-6.5a6.5 6.5.0 100 13 6.5 6.5.0 000-13zM6.5 7.75A.75.75.0 017.25 7h1a.75.75.0 01.75.75v2.75h.25a.75.75.0 010 1.5h-2a.75.75.0 010-1.5h.25v-2h-.25a.75.75.0 01-.75-.75zM8 6a1 1 0 110-2 1 1 0 010 2z"/></svg>Note</p><p>å…ƒç´ èƒ½å¤åˆ¶æ„é€ æ˜¯å¦æ˜¯ä¸€ä¸ªå¿…è¦æ¡ä»¶ï¼Ÿ</p><p>æŠŠå…ƒç´ å¤åˆ¶è€Œä¸æ˜¯ç§»åŠ¨ï¼Œæ„å‘³ç€åœ¨ç¡®ä¿æ“ä½œèƒ½æˆåŠŸå®Œæˆä¹‹å‰ï¼Œæ•°æ®ä¸ä¼šä¸¢å¤±ã€‚å¦‚æœç§»åŠ¨æ„é€ å‡½æ•°æŠ›å‡ºäº†å¼‚å¸¸ï¼Œè€Œä¸”æ²¡æœ‰æ­£ç¡®æ¢å¤è¢«ç§»åŠ¨æ–¹æ•°æ®ï¼Œé‚£ä¹ˆæ•°æ®å°±ä¸¢å¤±äº†ã€‚å°½ç®¡æˆ‘ä»¬å¸Œæœ›ç§»åŠ¨æ„é€ å‡½æ•°åœ¨æŠ›å‡ºå¼‚å¸¸æ—¶èƒ½å¤åŸä¹‹å‰çš„æ•°æ®ï¼ˆå¦‚æœä¸æŠ›å‡ºå¼‚å¸¸å°±æ›´å¥½äº†ï¼‰ï¼Œä½†è¿™å¹¶ä¸æ€»æ˜¯å¯èƒ½çš„ã€‚</p></div><div class="markdown-alert markdown-alert-note"><p class=markdown-alert-title><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1116 0A8 8 0 010 8zm8-6.5a6.5 6.5.0 100 13 6.5 6.5.0 000-13zM6.5 7.75A.75.75.0 017.25 7h1a.75.75.0 01.75.75v2.75h.25a.75.75.0 010 1.5h-2a.75.75.0 010-1.5h.25v-2h-.25a.75.75.0 01-.75-.75zM8 6a1 1 0 110-2 1 1 0 010 2z"/></svg>Note</p><p>æˆ‘è®¤ä¸ºæœ‰ NRVO æ—¶ï¼ŒA å¤„åº”è¯¥ä¹Ÿå¯ä»¥æ¢æˆç›´æ¥è¿”å›å…ƒç´ æœ¬èº«ï¼Œè€Œä¸å¿…è£…åˆ°æ™ºèƒ½æŒ‡é’ˆä¸­ã€‚ä¸è¿‡ NRVO è™½ç„¶è¢«å¹¿æ³›å®ç°ï¼Œå´å¹¶æ²¡æœ‰ç”±è¯­è¨€ä¿è¯ã€‚ä½œè€…å†™è¿™æœ¬ä¹¦çš„æ—¶å€™ï¼Œæ˜¯ä¸æ˜¯ NRVO æ²¡æœ‰æ™®åŠå‘¢ï¼Ÿ</p></div><h2 id=è§£å†³æ–¹æ¡ˆ-3é™åˆ¶å®¹å™¨å…ƒç´ ç±»å‹>è§£å†³æ–¹æ¡ˆ 3ï¼šé™åˆ¶å®¹å™¨å…ƒç´ ç±»å‹
<a class=header-anchor href=#%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88-3%e9%99%90%e5%88%b6%e5%ae%b9%e5%99%a8%e5%85%83%e7%b4%a0%e7%b1%bb%e5%9e%8b></a></h2><p>ç¦æ­¢ä¸èƒ½æ»¡è¶³ <code>std::is_nothrow_copy_constructible_v&lt;T></code> çš„ç±»å‹ T è¢«ä½¿ç”¨ã€‚ä½†æ˜¯è¿™æ ·ä¼šå¤§å¤§å‡å°‘å®¹å™¨çš„é€‚ç”¨èŒƒå›´ï¼Œå› æ­¤è¿™ä¸ªæ–¹æ¡ˆä¸å¤ªå¥½ã€‚</p><h1 id=é¿å…æ­»é”>é¿å…æ­»é”
<a class=header-anchor href=#%e9%81%bf%e5%85%8d%e6%ad%bb%e9%94%81></a></h1><p>æ ¸å¿ƒæ˜¯<strong>æŒ‰ç…§é¡ºåºé”å®š</strong>ã€‚</p><p>è‡ªå·±æŒ‰é¡ºåºé”å®šæœ‰ä»€ä¹ˆé£é™©ï¼šå¦‚æœè¦äº¤æ¢çš„å¯¹è±¡ä¸­åŒ…å«é”ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸çŸ¥é“è°ä¼šè¢«ä½œä¸º <code>swap</code> çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä¹Ÿä¸çŸ¥é“å¦‚ä½•èƒ½ä¿è¯ä¸Šé”é¡ºåºã€‚ï¼ˆå¯ä»¥è€ƒè™‘æŒ‰ç…§äº’æ–¥é‡çš„åœ°å€æ¥é”å®šï¼Ÿå› ä¸ºäº’æ–¥é‡å¿…é¡»å…·æœ‰åœ°å€ç¨³å®šæ€§æ‰èƒ½å·¥ä½œã€‚ï¼‰</p><h2 id=ä¸€æ¬¡æ€§è·å–å¤šä¸ªé”stdlockstdscoped_lock>ä¸€æ¬¡æ€§è·å–å¤šä¸ªé”ï¼ˆ<code>std::lock</code>ã€<code>std::scoped_lock</code>ï¼‰
<a class=header-anchor href=#%e4%b8%80%e6%ac%a1%e6%80%a7%e8%8e%b7%e5%8f%96%e5%a4%9a%e4%b8%aa%e9%94%81stdlockstdscoped_lock></a></h2><p>å¯ä»¥ç”¨ <code>std::lock</code> åŒæ—¶é”å®šå¤šä¸ªäº’æ–¥é‡ï¼Œç„¶åç”¨ <code>std::lock_guard</code> çš„ <code>std::adopt_lock</code> é€‰é¡¹æ¥ç»§æ‰¿é”ã€‚</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#719e07>friend</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>swap</span>(X <span style=color:#719e07>&amp;</span>lhs, X <span style=color:#719e07>&amp;</span>rhs) {
</span></span><span style=display:flex><span>    <span style=color:#719e07>if</span> (<span style=color:#719e07>&amp;</span>lhs <span style=color:#719e07>==</span> <span style=color:#719e07>&amp;</span>rhs) {
</span></span><span style=display:flex><span>        <span style=color:#719e07>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span>lock(lhs.m, rhs.m);
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span>lock_guard<span style=color:#719e07>&lt;</span>std<span style=color:#719e07>::</span>mutex<span style=color:#719e07>&gt;</span> lock_a(lhs.m, std<span style=color:#719e07>::</span>adopt_lock);
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span>lock_guard<span style=color:#719e07>&lt;</span>std<span style=color:#719e07>::</span>mutex<span style=color:#719e07>&gt;</span> lock_b(rhs.m, std<span style=color:#719e07>::</span>adopt_lock);
</span></span><span style=display:flex><span>    swap(lhs.some_detail, rhs.some_detail);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>C++17 çš„ <code>std::scoped_lock</code> å¯ä»¥ç›´æ¥åœ¨æ„é€ å‡½æ•°ä¸­ä¸€æ­¥å®Œæˆè¿™ä¸ªæ“ä½œã€‚</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#dc322f>void</span> <span style=color:#268bd2>swap</span>(X <span style=color:#719e07>&amp;</span>lhs, X <span style=color:#719e07>&amp;</span>rhs) {
</span></span><span style=display:flex><span>    <span style=color:#719e07>if</span> (<span style=color:#719e07>&amp;</span>lhs <span style=color:#719e07>==</span> <span style=color:#719e07>&amp;</span>rhs) {
</span></span><span style=display:flex><span>        <span style=color:#719e07>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span>scoped_lock guard(lhs.m, rhs.m); <span style=color:#586e75>// CTAD
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    swap(lhs.some_detail, rhs.some_detail);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=åˆ†æ­¥éª¤è·å–é”>åˆ†æ­¥éª¤è·å–é”
<a class=header-anchor href=#%e5%88%86%e6%ad%a5%e9%aa%a4%e8%8e%b7%e5%8f%96%e9%94%81></a></h2><p>åªèƒ½è®¾å®šä¸€äº›è·å–é”çš„è§„åˆ™ï¼Œç„¶åæ¯ä¸ªè·å–é”çš„çº¿ç¨‹ç›¸äº’åè°ƒã€‚</p><h2 id=å…¶ä»–å½¢å¼çš„æ­»é”>å…¶ä»–å½¢å¼çš„æ­»é”
<a class=header-anchor href=#%e5%85%b6%e4%bb%96%e5%bd%a2%e5%bc%8f%e7%9a%84%e6%ad%bb%e9%94%81></a></h2><p>æ­»é”ä¸ä»…é™äºäº’æ–¥é‡ã€‚çº¿ç¨‹ä¹‹é—´ç›¸äº’ç­‰å¾…éƒ½ä¼šå¯¼è‡´æ­»é”ï¼Œæ¯”å¦‚<strong>çº¿ç¨‹ä¹‹é—´ç”¨ <code>std::thread</code> çš„ <code>join()</code> æ–¹æ³•ç›¸äº’ç­‰å¾…å¯¹æ–¹ç»“æŸ</strong>ã€‚</p><h2 id=é¿å…åµŒå¥—é”>é¿å…åµŒå¥—é”
<a class=header-anchor href=#%e9%81%bf%e5%85%8d%e5%b5%8c%e5%a5%97%e9%94%81></a></h2><p>å°½é‡é¿å…åœ¨å·²ç»è·å–é”çš„æƒ…å†µä¸‹å»è·å–åˆ«çš„é”ã€‚å°¤å…¶æ˜¯è°ƒç”¨æœªçŸ¥çš„å…¶ä»–å‡½æ•°æ—¶ï¼Œè¢«è°ƒç”¨å‡½æ•°å¯èƒ½è¿˜ä¼šå°è¯•ä¸Šé”ã€‚</p><h1 id=æ¡ˆä¾‹å®ç°å±‚æ¬¡é”>æ¡ˆä¾‹ï¼šå®ç°å±‚æ¬¡é”
<a class=header-anchor href=#%e6%a1%88%e4%be%8b%e5%ae%9e%e7%8e%b0%e5%b1%82%e6%ac%a1%e9%94%81></a></h1><p>å±‚æ¬¡é”ï¼ˆhierarchical mutexï¼‰çš„å®šä¹‰ï¼šæ¯ä¸ªé”åœ¨å®šä¹‰æ—¶å¸¦æœ‰ä¸€ä¸ªç­‰çº§ï¼Œè§„å®šåœ¨æŒæœ‰é”æ—¶ï¼Œåªèƒ½å†æ¬¡é”å®šç­‰çº§æ›´ä½çš„é”ï¼Œä¸èƒ½é”å®šç­‰çº§ç›¸åŒæˆ–æ›´é«˜çš„é”ã€‚å› æ­¤ï¼Œç­‰çº§åªèƒ½é€šè¿‡é‡Šæ”¾é”è€Œæé«˜ã€‚è¿™æ ·çš„çº¦æŸä½¿å¾—å¤šä¸ªçº¿ç¨‹ä¹‹é—´å¯ä»¥æŒ‰é¡ºåºä¸Šé”å¤šä¸ªäº’æ–¥é‡ï¼Œä»è€Œé¿å…æ­»é”ã€‚</p><p>ä¸ºäº†å®ç°å±‚æ¬¡é”ï¼Œæ¯ä¸ªçº¿ç¨‹éœ€è¦ä¿å­˜å±€éƒ¨çš„ä¿¡æ¯ï¼Œè¿™å¯ä»¥ç”¨ <code>thread_local</code> å˜é‡å®ç°ã€‚ç”±äºçº¿ç¨‹æœ¬åœ°å˜é‡åªç”±ä¸€ä¸ªçº¿ç¨‹è¯»å–ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨ä¸€ä¸ªç®€å•çš„æ•´æ•°å€¼ï¼Œè€Œä¸å¿…ä½¿ç”¨åŸå­å˜é‡ã€‚ä¹¦ä¸Šå¯¹è¿™ä¸ªå˜é‡çš„å®šä¹‰å¦‚ä¸‹ã€‚ä¸€å¼€å§‹å°±å°†å…¶è®¾ç½®ä¸º <code>unsigned long</code> ç±»å‹çš„æœ€å¤§å€¼ï¼Œå°±å¥½åƒå·²ç»è·å–äº†ä¸€ä¸ªå…·æœ‰è¯¥ç­‰çº§çš„é”ä¸€æ ·ã€‚</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#719e07>thread_local</span> <span style=color:#dc322f>unsigned</span> <span style=color:#dc322f>long</span> 
</span></span><span style=display:flex><span>  hierarchical_mutex<span style=color:#719e07>::</span>this_thread_hierarchy_value(ULONG_MAX);
</span></span></code></pre></div><p>æ¥ä¸‹æ¥ï¼Œä¸ºäº†èƒ½ä½¿ç”¨æ ‡å‡†åº“æä¾›çš„é€šç”¨æ–¹æ³•ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸ºå±‚æ¬¡é”å®ç° <code>lock()</code>ã€<code>unlock()</code>ã€<code>try_lock()</code> ç­‰æ–¹æ³•ã€‚</p><h1 id=stdunique_lock><code>std::unique_lock</code>
<a class=header-anchor href=#stdunique_lock></a></h1><p><code>std::unique_lock</code> èƒ½æ¯” <code>std::lock_guard</code> æä¾›æ›´å¤šçµæ´»æ€§ã€‚</p><h2 id=ä¸‰ç§æ¨¡å¼ç»§æ‰¿é”ç«‹å³é”å»¶è¿Ÿé”æ–°>ä¸‰ç§æ¨¡å¼ï¼šç»§æ‰¿é”ã€ç«‹å³é”ã€å»¶è¿Ÿé”ï¼ˆæ–°ï¼‰
<a class=header-anchor href=#%e4%b8%89%e7%a7%8d%e6%a8%a1%e5%bc%8f%e7%bb%a7%e6%89%bf%e9%94%81%e7%ab%8b%e5%8d%b3%e9%94%81%e5%bb%b6%e8%bf%9f%e9%94%81%e6%96%b0></a></h2><p><code>std::lock_guard</code> è¦ä¹ˆåŠ  <code>std::adopt_lock</code> æ¥æ¥å—å·²é”å®šçš„é”ï¼Œè¦ä¹ˆç«‹å³é”å®šã€‚è€Œ <code>std::unique_lock</code> é™¤äº†è¿™ä¸¤ç§æ¨¡å¼ä¹‹å¤–ï¼Œè¿˜èƒ½åŠ  <code>std::defer_lock</code> æ¥å»¶è¿Ÿé”å®šã€‚ç”±äº <code>std::unique_lock</code> æä¾›äº†ç±»ä¼¼ <code>std::mutex</code> çš„æ¥å£ï¼Œæ‰€ä»¥å¯ä»¥å°†äº’æ–¥é‡åŒ…è£…åœ¨å…¶ä¸­ï¼Œç„¶åä½¿ç”¨é€šç”¨çš„é”å®šæ–¹æ³•ã€‚</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#719e07>friend</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>swap</span>(X <span style=color:#719e07>&amp;</span>lhs, X <span style=color:#719e07>&amp;</span>rhs) {
</span></span><span style=display:flex><span>    <span style=color:#719e07>if</span> (<span style=color:#719e07>&amp;</span>lhs <span style=color:#719e07>==</span> <span style=color:#719e07>&amp;</span>rhs) {
</span></span><span style=display:flex><span>        <span style=color:#719e07>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span>unique_lock<span style=color:#719e07>&lt;</span>std<span style=color:#719e07>::</span>mutex<span style=color:#719e07>&gt;</span> lock_a(lhs.m, std<span style=color:#719e07>::</span>defer_lock);
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span>unique_lock<span style=color:#719e07>&lt;</span>std<span style=color:#719e07>::</span>mutex<span style=color:#719e07>&gt;</span> lock_b(rhs.m, std<span style=color:#719e07>::</span>defer_lock);
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span>lock(lock_a, lock_b);
</span></span><span style=display:flex><span>    swap(lhs.some_detail, rhs.some_detail);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>åœ¨ä¸Šé¢è¿™ä¸ªä¾‹å­é‡Œé¢ï¼Œ<code>std::unique_lock</code> åªæ˜¯ä¸ºäº† RAII å­˜åœ¨çš„ï¼Œé”å®šåˆ™æ˜¯ç”± <code>std::lock()</code> å®Œæˆã€‚ä½œä¸ºå¯¹æ¯”ï¼Œ<code>std::scoped_lock</code> å°±æ²¡æœ‰å®ç°ç±»ä¼¼ <code>std::mutex</code> çš„æ¥å£ã€‚</p><p><code>std::unique_lock</code> çš„ <code>owns_lock()</code> æ–¹æ³•å¯ä»¥ç”¨æ¥æ£€æŸ¥å½“å‰æ˜¯å¦å·²ç»è·å–äº†é”ï¼Œ<code>mutex()</code> æ–¹æ³•å¯ä»¥è·å–ä¸€ä¸ªæŒ‡å‘ç®¡ç†çš„ mutex çš„æŒ‡é’ˆã€‚</p><h2 id=api-è®¾è®¡>API è®¾è®¡
<a class=header-anchor href=#api-%e8%ae%be%e8%ae%a1></a></h2><ul><li><code>std::unique_lock</code> åŒ…è£… <code>std::mutex</code> å–ä»£ç›´æ¥æ“ä½œ <code>std::mutex</code>ã€‚</li><li><code>std::scoped_lock</code> å–ä»£ <code>std::lock</code>ã€‚<ul><li>ä¹‹å‰ <code>std::lock</code> å¹¶ä¸æ˜¯ RAII çš„ï¼Œæ‰€ä»¥è¿˜éœ€è¦ç”¨ <code>std::lock_guard</code> æ¥é…åˆä½¿ç”¨ï¼Œæ¯”è¾ƒéº»çƒ¦ã€‚</li><li><code>std::scoped_lock</code> è¡Œä¸ºä¸Šæ›´åƒ <code>std::lock_guard</code> ä¸€ç‚¹ã€‚ä½†æ˜¯ä»å‘½åä¸Šæˆ‘è§‰å¾—è®¾è®¡è€…æ˜¯æƒ³è¦ç”¨å®ƒæ¥å–ä»£ <code>std::lock</code>ã€‚</li></ul></li><li>è¿™é‡Œè¯´çš„â€œå–ä»£â€éƒ½æ˜¯æŒ‡çš„åœ¨æŸäº›åœºæ™¯ä¸‹å–ä»£ï¼Œå¹¶ä¸æ˜¯è¯´å‰ç»§è€…å°±å®Œå…¨ä¸è¢«éœ€è¦äº†ã€‚</li></ul><p>å¯ä»¥ç±»æ¯”ä¸€ä¸‹ <code>std::unique_ptr</code>ã€‚</p><div class=highlight><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR
    raw_ptr[T *] --&gt; u_ptr[&#34;std::unique_ptr&amp;ltT&amp;gt (RAII)&#34;]
    A[std::mutex] --&gt; B[&#34;std::unique_lock (RAII)&#34;]
    C[std::lockï¼ˆå‡½æ•°ï¼‰] --&gt; D[&#34;std::scoped_lock (RAII)&#34;]
    A1[std::shared_mutex] --&gt; B1[&#34;std::shared_lock (RAIIï¼Œåé¢è®²)&#34;]</code></pre></div><p>æ­¤å¤–ï¼Œäº’æ–¥é‡çš„æ­£ç¡®ä½¿ç”¨è¦æ±‚åœ°å€ç¨³å®šï¼Œ<code>std::unique_lock</code> è™½ç„¶å¯ä»¥å®ç°å’Œ <code>std::unique_ptr</code> ç±»ä¼¼çš„èµ„æºé‡Šæ”¾åŠŸèƒ½ï¼Œå´ä¸å¯èƒ½è„±ç¦»äº’æ–¥é‡å•ç‹¬ä½¿ç”¨ï¼Œç›¸åï¼Œ<code>std::unique_ptr</code> æ˜¯å¯ä»¥å®Œå…¨ä»£æ›¿è£¸æŒ‡é’ˆå•ç‹¬ä½¿ç”¨çš„ã€‚</p><p>åœ¨å¯ç§»åŠ¨æ€§ä¸Šï¼Œ<code>std::unique_lock</code> å¯ç§»åŠ¨ã€ä¸å¯å¤åˆ¶ã€‚<code>std::lock_guard</code> å’Œ <code>std::scoped_lock</code> éƒ½ä¸å¯ç§»åŠ¨ã€ä¸å¯å¤åˆ¶ï¼Œå› ä¸ºå®ƒä»¬éƒ½æœ‰ç”¨æˆ·æä¾›çš„ææ„å‡½æ•°ï¼ˆç§»åŠ¨æ„é€  / èµ‹å€¼ä¼šè¢«åˆ é™¤ï¼‰ï¼Œè¿˜æ˜¾å¼ç¦ç”¨äº†æ‹·è´æ„é€  / èµ‹å€¼ã€‚<strong><code>std::unique_lock</code> çš„æ„é€ å‡½æ•°æ˜¯å°†å…¶å’Œäº’æ–¥é‡å…³è”èµ·æ¥çš„å”¯ä¸€æ–¹å¼ï¼Œå¦‚æœå·²ç»é»˜è®¤æ„é€ äº† <code>std::unique_lock</code>ï¼Œåªèƒ½å°†æ–°çš„ <code>std::unique_lock</code> ç§»åŠ¨èµ‹å€¼ç»™å®ƒ</strong>ã€‚</p><p><strong>ç”±äºå¯ä»¥ç§»åŠ¨ï¼Œ<code>std::unique_lock</code> å¯ä»¥å®ç°é”çš„è½¬è®©</strong>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span>std<span style=color:#719e07>::</span>unique_lock<span style=color:#719e07>&lt;</span>std<span style=color:#719e07>::</span>mutex<span style=color:#719e07>&gt;</span> get_lock() {
</span></span><span style=display:flex><span>    <span style=color:#719e07>extern</span> std<span style=color:#719e07>::</span>mutex some_mutex;
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span>unique_lock<span style=color:#719e07>&lt;</span>std<span style=color:#719e07>::</span>mutex<span style=color:#719e07>&gt;</span> lk(some_mutex);
</span></span><span style=display:flex><span>    prepare_data();
</span></span><span style=display:flex><span>    <span style=color:#719e07>return</span> lk;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>é”çš„è½¬è®©çš„æ„ä¹‰åœ¨äºï¼šå…ˆé‡Šæ”¾é”ï¼Œå†åœ¨å…¶ä»–å‡½æ•°ä¸­è·å–é”æ˜¯ä¸å®‰å…¨çš„ã€‚è½¬è®©é”ä¿è¯äº†é”ä¸€ç›´è¢«å½“å‰çº¿ç¨‹æŒæœ‰ã€‚</p><div class="markdown-alert markdown-alert-note"><p class=markdown-alert-title><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1116 0A8 8 0 010 8zm8-6.5a6.5 6.5.0 100 13 6.5 6.5.0 000-13zM6.5 7.75A.75.75.0 017.25 7h1a.75.75.0 01.75.75v2.75h.25a.75.75.0 010 1.5h-2a.75.75.0 010-1.5h.25v-2h-.25a.75.75.0 01-.75-.75zM8 6a1 1 0 110-2 1 1 0 010 2z"/></svg>Note</p><p>å¦‚æœæœ‰å‡ ä¸ªå‡½æ•°éœ€è¦åœ¨æŒæœ‰é”çš„æƒ…å†µä¸‹è¿›è¡Œæ“ä½œï¼Œè€Œè¿™å‡ ä¸ªå‡½æ•°åˆå¯èƒ½å‘ç”Ÿç›¸äº’è°ƒç”¨ï¼Œæ˜¯å¦å¯ä»¥æŠŠ <code>std::unique_lock</code> æ—¢ä½œä¸ºå‚æ•°ï¼Œåˆä½œä¸ºè¿”å›å€¼ï¼Œåœ¨å¤šä¸ªå‡½æ•°è°ƒç”¨ä¸­ä¸æ–­æµè½¬ï¼Ÿ</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#719e07>using</span> Lock <span style=color:#719e07>=</span> std<span style=color:#719e07>::</span>unique_lock<span style=color:#719e07>&lt;</span>std<span style=color:#719e07>::</span>mutex<span style=color:#719e07>&gt;</span>;
</span></span><span style=display:flex><span><span style=color:#719e07>auto</span> <span style=color:#268bd2>borrow_lock</span>(Lock) <span style=color:#719e07>-&gt;</span> Lock <span style=color:#586e75>/* prvalue */</span>;
</span></span><span style=display:flex><span>Lock lk;
</span></span><span style=display:flex><span><span style=color:#586e75>/* initialize lk */</span>
</span></span><span style=display:flex><span>lk <span style=color:#719e07>=</span> borrow_lock(std<span style=color:#719e07>::</span>move(lk));
</span></span></code></pre></div><p>æ„Ÿè§‰è¿™æ ·çš„è®¾è®¡æŒºç³Ÿç³•ï¼Ÿä¸å¦‚å†™ä¸ªåŒ…è£…å‡½æ•°ï¼Œè·å–é”ä¹‹åå†è¿›è¡Œè¿™äº›é€’å½’æ“ä½œã€‚</p></div><h2 id=å¼€é”€>å¼€é”€
<a class=header-anchor href=#%e5%bc%80%e9%94%80></a></h2><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#719e07>static_assert</span>(<span style=color:#719e07>sizeof</span>(std<span style=color:#719e07>::</span>lock_guard<span style=color:#719e07>&lt;</span>std<span style=color:#719e07>::</span>mutex<span style=color:#719e07>&gt;</span>) <span style=color:#719e07>==</span> <span style=color:#719e07>sizeof</span>(intptr_t));
</span></span><span style=display:flex><span><span style=color:#719e07>static_assert</span>(<span style=color:#719e07>sizeof</span>(std<span style=color:#719e07>::</span>unique_lock<span style=color:#719e07>&lt;</span>std<span style=color:#719e07>::</span>mutex<span style=color:#719e07>&gt;</span>) <span style=color:#719e07>==</span> <span style=color:#719e07>sizeof</span>(intptr_t) <span style=color:#719e07>*</span> <span style=color:#2aa198>2</span>);
</span></span></code></pre></div><p>åœ¨æˆ‘è¿™è¾¹çœ‹ <code>std::lock_guard&lt;std::mutex></code> å ç”¨ 8 å­—èŠ‚ç”¨æ¥æ”¾æŒ‡é’ˆã€‚<code>std::unique_lock&lt;std::mutex></code> å ç”¨ 16 å­—èŠ‚ç”¨æ¥æ”¾ä¸€ä¸ªæŒ‡é’ˆå’Œä¸€ä¸ª bool æ ‡è®°ï¼Œå…¶ä¸­åŒ…å« 7 ä¸ªå­—èŠ‚çš„ paddingã€‚</p><h1 id=åœ¨åˆå§‹åŒ–æ—¶ä¿æŠ¤æ•°æ®>åœ¨åˆå§‹åŒ–æ—¶ä¿æŠ¤æ•°æ®
<a class=header-anchor href=#%e5%9c%a8%e5%88%9d%e5%a7%8b%e5%8c%96%e6%97%b6%e4%bf%9d%e6%8a%a4%e6%95%b0%e6%8d%ae></a></h1><p>ä¹‹å‰æåˆ°çš„éƒ½æ˜¯åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ä¿æŠ¤æ•°æ®ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸€äº›æ“ä½œä»…éœ€è¦åœ¨åˆå§‹åŒ–æ—¶ä¿æŠ¤æ•°æ®ï¼ˆè¿™æ—¶ä½¿ç”¨äº’æ–¥é‡å¯èƒ½æœ‰ç‚¹å¤§æå°ç”¨ï¼‰ã€‚ä¸€ä¸ªä¾‹å­ï¼šæ‡’åˆå§‹åŒ–ã€‚</p><h2 id=åŒéªŒé”>åŒéªŒé”ï¼ˆâŒï¼‰
<a class=header-anchor href=#%e5%8f%8c%e9%aa%8c%e9%94%81></a></h2><p>å…ˆè¯´ä¸€ç§å¸¸è§ patternï¼šdouble-checked lockingï¼ˆåŒéªŒé”ï¼‰ã€‚å…ˆæ£€æŸ¥æŒ‡é’ˆæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºå°±ä»£è¡¨è¦åˆå§‹åŒ–ã€‚å…ˆä¸Šé”ï¼Œå†æ£€æŸ¥æŒ‡é’ˆæ˜¯å¦è¿˜æ˜¯ç©ºï¼Œå¦‚æœè¿˜æ˜¯ç©ºåˆ™åº”è¯¥ç”±æœ¬çº¿ç¨‹åˆå§‹åŒ–ã€‚</p><p>ä¸€æ®µé”™è¯¯ä»£ç ï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#dc322f>void</span> <span style=color:#268bd2>undefined_behaviour_with_double_checked_locking</span>() {
</span></span><span style=display:flex><span>    <span style=color:#719e07>if</span> (<span style=color:#719e07>!</span>resource_ptr) {
</span></span><span style=display:flex><span>        std<span style=color:#719e07>::</span>lock_guard<span style=color:#719e07>&lt;</span>std<span style=color:#719e07>::</span>mutex<span style=color:#719e07>&gt;</span> lk(resource_mutex);
</span></span><span style=display:flex><span>        <span style=color:#719e07>if</span> (<span style=color:#719e07>!</span>resource_ptr) {
</span></span><span style=display:flex><span>            resource_ptr.reset(<span style=color:#719e07>new</span> some_resource);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    resource_ptr<span style=color:#719e07>-&gt;</span>do_something();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>åœ¨ä¸Šé”ä¹‹å‰å°±æ£€æŸ¥æŒ‡é’ˆæ˜¯å¦ä¸ºç©ºï¼Œè¿™å®‰å…¨å—ï¼Ÿ</p><ol><li>åœ¨ Java çš„å†…å­˜æ¨¡å‹ä¸­ï¼Œè¿™æ ·çš„è¯»å–åº”è¯¥æ˜¯å¯ä»¥åšåˆ°å®‰å…¨çš„ï¼ˆå¯¹è±¡å¯ä»¥ GCï¼ŒæŒ‡é’ˆç”¨ <code>volatile</code> æ ‡è¯†ï¼Œ<a href=https://stackoverflow.com/a/7367168/ title="Java çš„å†…å­˜æ¨¡å‹ä¸­ volatile æœ‰ä¸€å®šçš„åŒæ­¥ä½œç”¨" rel="noopener external nofollow noreferrer" target=_blank class=exturl>Java çš„å†…å­˜æ¨¡å‹ä¸­ <code>volatile</code> æœ‰ä¸€å®šçš„åŒæ­¥ä½œç”¨<i class="fa fa-external-link-alt"></i></a>ï¼‰ï¼Œä½†æ˜¯åœ¨ C++ çš„å†…å­˜æ¨¡å‹ä¸­ï¼Œç”±äºç¼ºä¹åŒæ­¥ï¼Œä¸èƒ½ä¿è¯å…¶ä»–çº¿ç¨‹å¯¹æŒ‡é’ˆçš„è®¾ç½®è¢«å½“å‰çº¿ç¨‹çš„è¯»å¯è§ã€‚</li><li>å¦ä¸€æ–¹é¢ï¼ŒæŒ‡é’ˆçš„è¯»å†™æ˜¯å¦æ˜¯åŸå­çš„å¹¶æ²¡æœ‰åœ¨è¯­è¨€æ ‡å‡†ä¸­è§„å®šï¼Œè€Œæ˜¯å–å†³äºå¹³å°ï¼ˆArm ä¸Šæ˜¯å¼±å†…å­˜åºï¼›x86 æ˜¯å¼ºå†…å­˜åºï¼Œ32 ä½è¯»å†™æ˜¯åŸå­çš„ã€64 ä½è¯»å†™åœ¨å¯¹é½åˆ° 8 å­—èŠ‚æ•´å€æ•°åœ°å€ä¸Šæ—¶æ˜¯åŸå­çš„ï¼Œå‚è€ƒ <a href=https://qr.ae/p2545l title=https://qr.ae/p2545l rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://qr.ae/p2545l<i class="fa fa-external-link-alt"></i></a> ï¼‰ã€‚è¿™é‡Œçš„æŒ‡é’ˆä»¥æ™ºèƒ½æŒ‡é’ˆçš„å½¢å¼å‡ºç°ï¼Œæ™ºèƒ½æŒ‡é’ˆä¸æ˜¯ç®€å•çš„å¯¹è±¡ï¼Œå°±æ›´ä¸èƒ½ä¿è¯æ“ä½œçš„åŸå­æ€§äº†ã€‚</li><li>å°±ç®—ä½¿ç”¨ <code>std::atomic</code> è§£å†³äº† 1 çš„é—®é¢˜ï¼Œ<code>std::atomic&lt;std::shared_ptr&lt;>></code> ä¹Ÿä¸æ˜¯æ— é”çš„ï¼Œè§£å†³ä¸äº†é—®é¢˜ 2ã€‚</li></ol><h2 id=stdcall_once><code>std::call_once</code>
<a class=header-anchor href=#stdcall_once></a></h2><p>è¦ç‚¹ï¼š</p><ol><li>ä¹Ÿåœ¨ <code>&lt;mutex></code> å¤´æ–‡ä»¶ä¸‹ã€‚</li><li><code>std::once_flag</code> ä¸èƒ½è¢«ç§»åŠ¨ã€‚</li><li>å¦‚æœ <code>std::call_once</code> è°ƒç”¨çš„å‡½æ•°å¯¹è±¡æŠ›å‡ºäº†å¼‚å¸¸ï¼Œè€Œä¸æ˜¯æ­£å¸¸è¿”å›ï¼Œé‚£ä¹ˆ <code>std::once_flag</code> ä¸ä¼šè¢«è®¾ç½®ï¼Œæ¥ä¸‹æ¥çš„ <code>std::call_once</code> è¿˜ä¼šç»§ç»­å°è¯•è°ƒç”¨å‡½æ•°ã€‚</li><li>å¦‚æœè¿˜æ²¡æœ‰ä»»ä½•ä¸€ä¸ª <code>std::call_once</code> å°† <code>std::once_flag</code> è®¾ç½®ï¼Œé‚£ä¹ˆåç»­çš„ <code>std::call_once</code> éƒ½ä¼š <a href=https://stackoverflow.com/a/43055483/ title=é˜»å¡ rel="noopener external nofollow noreferrer" target=_blank class=exturl><strong>é˜»å¡</strong><i class="fa fa-external-link-alt"></i></a> è‡³æ­£åœ¨æ‰§è¡Œçš„ <code>std::call_once</code> æœ‰ä¸€ä¸ªç»“æœï¼ˆæˆåŠŸæˆ–å¤±è´¥ï¼‰ã€‚</li></ol><p>ä¸ºæ­¤ï¼Œ<code>std::once_flag</code> éœ€è¦åŒºåˆ†ï¼šè°ƒç”¨å®Œæˆã€æ­£åœ¨è¢«å…¶ä»–çº¿ç¨‹è°ƒç”¨ä¸­ã€å¯ä»¥è°ƒç”¨ä¸‰ç§çŠ¶æ€ã€‚</p><p>åŒæ­¥è§„åˆ™ï¼š</p><blockquote><p>AllÂ <em>active</em>Â calls on the sameÂ flagÂ form a single total order consisting of zero or moreÂ <em>exceptional</em>Â calls, followed by oneÂ <em>returning</em>Â call. The end of eachÂ <em>active</em>Â call synchronizes-with the nextÂ <strong><em>active</em></strong>Â call in that order.</p><p>The return from theÂ <em>returning</em>Â call synchronizes-with the returns from allÂ <strong><em>passive</em></strong>Â calls on the sameÂ flag.</p></blockquote><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;chrono&gt;</span><span style=color:#719e07>
</span></span></span><span style=display:flex><span><span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;mutex&gt;</span><span style=color:#719e07>
</span></span></span><span style=display:flex><span><span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;thread&gt;</span><span style=color:#719e07>
</span></span></span><span style=display:flex><span><span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;cstdio&gt;</span><span style=color:#719e07>
</span></span></span><span style=display:flex><span><span style=color:#719e07></span>
</span></span><span style=display:flex><span><span style=color:#719e07>auto</span> once <span style=color:#719e07>=</span> std<span style=color:#719e07>::</span>once_flag{};
</span></span><span style=display:flex><span><span style=color:#719e07>auto</span> foo <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#dc322f>int</span> <span style=color:#268bd2>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#719e07>auto</span> th <span style=color:#719e07>=</span> std<span style=color:#719e07>::</span><span style=color:#268bd2>thread</span>([] {
</span></span><span style=display:flex><span>        std<span style=color:#719e07>::</span>this_thread<span style=color:#719e07>::</span>sleep_for(<span style=color:#2aa198>100</span> <span style=color:#719e07>*</span> std<span style=color:#719e07>::</span>chrono<span style=color:#719e07>::</span>milliseconds());
</span></span><span style=display:flex><span>        <span style=color:#586e75>// t=100ms
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>        std<span style=color:#719e07>::</span>call_once(once, [] {
</span></span><span style=display:flex><span>            foo <span style=color:#719e07>=</span> <span style=color:#2aa198>66</span>;
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>        printf(<span style=color:#2aa198>&#34;th: foo = %d</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>&#34;</span>, foo);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    <span style=color:#586e75>// Probably before th.
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#586e75>// t=0
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    std<span style=color:#719e07>::</span>call_once(once, [] {
</span></span><span style=display:flex><span>        std<span style=color:#719e07>::</span>this_thread<span style=color:#719e07>::</span>sleep_for(<span style=color:#2aa198>200</span> <span style=color:#719e07>*</span> std<span style=color:#719e07>::</span>chrono<span style=color:#719e07>::</span>milliseconds());
</span></span><span style=display:flex><span>        <span style=color:#586e75>// t=200ms
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>        printf(<span style=color:#2aa198>&#34;foo = %d</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>&#34;</span>, foo);
</span></span><span style=display:flex><span>        foo <span style=color:#719e07>=</span> <span style=color:#2aa198>54</span>;
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    th.join();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#586e75>// Output:
</span></span></span><span style=display:flex><span><span style=color:#586e75>// foo = 0
</span></span></span><span style=display:flex><span><span style=color:#586e75>// th: foo = 54
</span></span></span></code></pre></div><p>ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå°½ç®¡ th ä¸­çš„ <code>std::call_once</code> åœ¨ t=100ms æ—¶å·²ç»å¼€å§‹äº†ï¼Œä½†å› ä¸ºä¸»çº¿ç¨‹ä¸­çš„ <code>std::call_once</code> è¿˜æ²¡æœ‰è¿”å›ï¼Œæ‰€ä»¥å°±ä¸€ç›´ç­‰ç€ã€‚æœ€å th èƒ½çœ‹åˆ°ä¸»çº¿ç¨‹è®¾ç½®çš„ <code>foo = 54</code> çš„å€¼ã€‚</p><p>æ¥ä¸‹æ¥å°è¯•åœ¨ä¸»çº¿ç¨‹çš„ <code>std::call_once</code> ä¸­å¼•å‘å¼‚å¸¸ï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;chrono&gt;</span><span style=color:#719e07>
</span></span></span><span style=display:flex><span><span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;cstdio&gt;</span><span style=color:#719e07>
</span></span></span><span style=display:flex><span><span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;mutex&gt;</span><span style=color:#719e07>
</span></span></span><span style=display:flex><span><span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;thread&gt;</span><span style=color:#719e07>
</span></span></span><span style=display:flex><span><span style=color:#719e07></span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#719e07>auto</span> once <span style=color:#719e07>=</span> std<span style=color:#719e07>::</span>once_flag{};
</span></span><span style=display:flex><span><span style=color:#719e07>auto</span> foo <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#dc322f>int</span> <span style=color:#268bd2>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#719e07>auto</span> th <span style=color:#719e07>=</span> std<span style=color:#719e07>::</span><span style=color:#268bd2>thread</span>([] {
</span></span><span style=display:flex><span>        std<span style=color:#719e07>::</span>this_thread<span style=color:#719e07>::</span>sleep_for(<span style=color:#2aa198>100</span> <span style=color:#719e07>*</span> std<span style=color:#719e07>::</span>chrono<span style=color:#719e07>::</span>milliseconds());
</span></span><span style=display:flex><span>        <span style=color:#586e75>// t=100ms
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>        std<span style=color:#719e07>::</span>call_once(once, [] {
</span></span><span style=display:flex><span>            foo <span style=color:#719e07>=</span> <span style=color:#2aa198>66</span>;
</span></span><span style=display:flex><span>            printf(<span style=color:#2aa198>&#34;th: call_once() returns</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>&#34;</span>);
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>        printf(<span style=color:#2aa198>&#34;th: foo = %d</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>&#34;</span>, foo);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    <span style=color:#586e75>// Probably before th.
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#586e75>// t=0
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#719e07>try</span> {
</span></span><span style=display:flex><span>        std<span style=color:#719e07>::</span>call_once(once, [] {
</span></span><span style=display:flex><span>            std<span style=color:#719e07>::</span>this_thread<span style=color:#719e07>::</span>sleep_for(<span style=color:#2aa198>200</span> <span style=color:#719e07>*</span> std<span style=color:#719e07>::</span>chrono<span style=color:#719e07>::</span>milliseconds());
</span></span><span style=display:flex><span>            <span style=color:#586e75>// t=200ms
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>            printf(<span style=color:#2aa198>&#34;main: call_once() will throw</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#719e07>struct</span> <span style=color:#268bd2>SomeError</span> {};
</span></span><span style=display:flex><span>            <span style=color:#719e07>throw</span> SomeError{};
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    } <span style=color:#719e07>catch</span> (...) {
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    th.join();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#586e75>// main: call_once() will throw
</span></span></span><span style=display:flex><span><span style=color:#586e75>// th: call_once() returns
</span></span></span><span style=display:flex><span><span style=color:#586e75>// th: foo = 66
</span></span></span></code></pre></div><p>ä»ç»“æœæ¥çœ‹ï¼Œth ä¸­çš„ <code>std::call_once</code> ç­‰åˆ°ä¸»çº¿ç¨‹è°ƒç”¨çš„å‡½æ•°å¯¹è±¡æŠ›å‡ºäº†å¼‚å¸¸åæ‰å¼€å§‹æ‰§è¡Œå¯¹åº”çš„å‡½æ•°å¯¹è±¡ã€‚ï¼ˆMSYS2 çš„ gcc ä¼¼ä¹æœ‰ bugï¼Œä¸Šé¢ä»£ç ä¼šæ­»é”ï¼Œè€Œä¸” cppreference ä¸­ <a href=https://en.cppreference.com/w/cpp/thread/call_once title="call_once çš„ç¤ºä¾‹ä»£ç " rel="noopener external nofollow noreferrer" target=_blank class=exturl>call_once çš„ç¤ºä¾‹ä»£ç <i class="fa fa-external-link-alt"></i></a> ä¹Ÿä¼šæ­»é”ã€‚åœ¨ Linux ä¸Šå°±æ²¡äº‹ã€‚ï¼‰</p><h2 id=åˆ©ç”¨å‡½æ•°ä¸­é™æ€æˆå‘˜çš„åˆå§‹åŒ–>åˆ©ç”¨å‡½æ•°ä¸­é™æ€æˆå‘˜çš„åˆå§‹åŒ–
<a class=header-anchor href=#%e5%88%a9%e7%94%a8%e5%87%bd%e6%95%b0%e4%b8%ad%e9%9d%99%e6%80%81%e6%88%90%e5%91%98%e7%9a%84%e5%88%9d%e5%a7%8b%e5%8c%96></a></h2><blockquote><p>The initialization of such a variable (a local variable declared with <code>static</code>) is defined to occur the first time control passes through its declaration.</p></blockquote><p>å±€éƒ¨é™æ€æ•°æ®åœ¨ç¬¬ä¸€æ¬¡è¿è¡Œåˆ°è¿™é‡Œæ—¶æ‰ä¼šåˆå§‹åŒ–ã€‚åœ¨ C++11 ä¹‹å‰å¯èƒ½ä¼šè¢«å¤šä¸ªçº¿ç¨‹åˆå§‹åŒ–ï¼Œä½†æ˜¯ <strong>C++11 è§„å®šè¿™æ ·çš„æ•°æ®åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹åˆå§‹åŒ–</strong>ã€‚</p><p>å°†è¦åˆå§‹åŒ–çš„å¯¹è±¡åŒ…è£…æˆéœ€è¦ä»ä¸€ä¸ªå‡½æ•°è·å–å¼•ç”¨ï¼ˆæˆ–æŒ‡é’ˆï¼‰çš„å½¢å¼ï¼Œè€Œè¿™ä¸ªå‡½æ•°åˆè¿”å›å…¶ä¸­é™æ€æ•°æ®çš„å¼•ç”¨ï¼ˆæˆ–æŒ‡é’ˆï¼‰ï¼Œè¿™æ ·ä¹Ÿèƒ½è¾¾åˆ°æ‡’åˆå§‹åŒ–æ•ˆæœã€‚è¿™ç§æ–¹æ³•é€šå¸¸è¢«ç”¨äºè¦æ‡’åŠ è½½çš„å…¨å±€å•ä¾‹ã€‚</p><p>Cppreference ä¸Šé¢è¯´ï¼š</p><blockquote><p>Initialization ofÂ <a href=https://en.cppreference.com/w/cpp/language/storage_duration#Static_local_variables title="function-local statics" rel="noopener external nofollow noreferrer" target=_blank class=exturl>function-local statics<i class="fa fa-external-link-alt"></i></a>Â is guaranteed to occur only once even when called from multiple threads, and may be more efficient than the equivalent code usingÂ <code>std::call_once</code>.</p></blockquote><p>è¿™æ„å‘³ç€åœ¨èƒ½ä½¿ç”¨å‡½æ•°ä¸­å±€éƒ¨é™æ€æˆå‘˜çš„æƒ…å†µä¸‹ï¼Œåº”è¯¥ä¼˜å…ˆä½¿ç”¨å®ƒã€‚</p><h1 id=å…±äº«é”>å…±äº«é”
<a class=header-anchor href=#%e5%85%b1%e4%ba%ab%e9%94%81></a></h1><p>å®é™…ä¸Šæ˜¯è¯»å†™é”ã€‚Cppreference ä¸Šçš„ <a href=https://en.cppreference.com/w/cpp/header/shared_mutex title="shared_mutex é¡µé¢" rel="noopener external nofollow noreferrer" target=_blank class=exturl>shared_mutex é¡µé¢<i class="fa fa-external-link-alt"></i></a> ä¸­æŒ‡å‡ºäº† <code>&lt;shared_mutex></code> å¤´æ–‡ä»¶åœ¨ C++14 ä¸­å¢åŠ ï¼ŒåŒ…å«ï¼š</p><ul><li><code>std::shared_timed_mutex</code>ï¼ˆC++14ï¼‰</li><li><code>std::shared_lock</code>ï¼ˆC++14ï¼‰</li><li><code>std::shared_mutex</code>ï¼ˆC++17ï¼‰</li></ul><p>å¯ä»¥ç”¨ç»™ <code>std::mutex</code> ä¸Šé”çš„æ–¹å¼æ¥ä¸Šé” <code>std::shared_mutex</code>ï¼Œè¿™æ ·ä¸Šçš„é”å°±æ˜¯äº’æ–¥é”ï¼ˆexclusive lockï¼‰ã€‚å¦‚æœæƒ³è¦ä¸Šå…±äº«é”ï¼Œå°±éœ€è¦ç”¨ <code>std::shared_lock</code>ï¼Œè¿™ä¸ª RAII ç±»æ¨¡æ¿å®ç°çš„åŠŸèƒ½å’Œ <code>std::unique_lock</code> ç›¸ä¼¼ã€‚<code>std::shared_lock</code> æ»¡è¶³ Lockableï¼›å¦‚æœäº’æ–¥é‡ç±»å‹æ»¡è¶³ SharedTimedLockableï¼Œ<code>std::shared_lock</code> è¿˜æ»¡è¶³ TimedLockableã€‚ï¼ˆä¸æ»¡è¶³çš„è¯è¶…æ—¶ç›¸å…³çš„æ–¹æ³•ä¹Ÿä¸ä¼šè¢«åˆ é™¤ï¼Œä½†éƒ½æ˜¯ UBï¼ï¼‰</p><div class="markdown-alert markdown-alert-note"><p class=markdown-alert-title><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1116 0A8 8 0 010 8zm8-6.5a6.5 6.5.0 100 13 6.5 6.5.0 000-13zM6.5 7.75A.75.75.0 017.25 7h1a.75.75.0 01.75.75v2.75h.25a.75.75.0 010 1.5h-2a.75.75.0 010-1.5h.25v-2h-.25a.75.75.0 01-.75-.75zM8 6a1 1 0 110-2 1 1 0 010 2z"/></svg>Note</p><p>çœ‹èµ·æ¥å¦‚æœæƒ³è¦ç”¨æˆ–äº’æ–¥æˆ–å…±äº«çš„æ–¹å¼ä¸€æ¬¡é”å®šå¤šä¸ªäº’æ–¥é‡ï¼Œå°±éœ€è¦æŠŠè¦å…±äº«çš„äº’æ–¥é‡å…ˆä»¥ä¸è·å¾—é”çš„æ–¹å¼åŒ…åœ¨ <code>std::shared_lock</code> ä¸­ï¼Œç„¶åç”¨ <code>std::scoped_lock</code> é”å®šã€‚</p></div><h1 id=é€’å½’é”stdrecursive_lock>é€’å½’é”ï¼ˆ<code>std::recursive_lock</code>ï¼‰
<a class=header-anchor href=#%e9%80%92%e5%bd%92%e9%94%81stdrecursive_lock></a></h1><blockquote><p>Most of the time, if you think you want a recursive mutex, you probably need to change your design instead.</p></blockquote></div><footer class=post-footer><div class=post-tags><a href=/tags/cpp>cpp
</a><a href=/tags/cpp-concurrency-in-action>cpp-concurrency-in-action</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/cpp-concurrency-in-action/4.-Synchronizing-concurrent-operations/ rel=next title="4. Synchronizing concurrent operations"><i class="fa fa-chevron-left"></i> 4. Synchronizing concurrent operations</a></div><div class="post-nav-prev post-nav-item"><a href=/cpp-concurrency-in-action/2.-Managing-threads/ rel=prev title="2. Managing threads">2. Managing threads
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2023 - 2025
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>ğŸ¤–</span></div><div class=powered-by>ç”± <a href=https://gohugo.io title=0.143.1 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.5.3 target=_blank>Hugo NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨</div></div></footer><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js defer></script><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":false,"save":"manual"},"copybtn":true,"darkmode":false,"hostname":"https://hxhue.github.io/","i18n":{"ds_day":" å¤©å‰","ds_days":" å¤© ","ds_hour":" å°æ—¶å‰","ds_hours":" å°æ—¶ ","ds_just":"åˆšåˆš","ds_min":" åˆ†é’Ÿå‰","ds_mins":" åˆ†é’Ÿ","ds_month":" ä¸ªæœˆå‰","ds_years":" å¹´ ","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","placeholder":"æœç´¢..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":false,"transition":{"collheader":"fadeInLeft","menu_item":"fadeInDown","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":false,"plugin":"waline"},"views":{"enable":false,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"cdnjs","router":"https://cdnjs.cloudflare.com/ajax/libs"},"version":"4.5.3"}</script><script type=text/javascript src=/js/main.min.37ba8b54f9d4d784d08028c45eea93b5d4e13eda8ee7fb0d2edd6f3fac66cfd2.js defer></script></body></html>