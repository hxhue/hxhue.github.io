<!doctype html><html lang=zh-CN data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.143.1"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="9. Advanced thread management"><meta itemprop=description content="ä¸ªäººåšå®¢ï¼Œä¸»è¦æ˜¯é›¶æ•£çš„ç¬”è®°ã€‚"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://hxhue.github.io/imgs/371907.jpg"><meta itemprop=keywords content="cpp,cpp-concurrency-in-action"><link type=text/css rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css><link rel=stylesheet href=/css/main.min.bea76f574a755574e17d42bea39502a74ca3ca4db65807b8c82d3e26dcec8420.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ æˆ‘å¯æ˜¯æœ‰åº•çº¿çš„å“Ÿ ~"}</style><link rel=stylesheet type=text/css href=/css/style.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/github-markdown-css@5.3.0/github-markdown-dark.css><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js></script><script>MathJax={tex:{displayMath:[["$$","$$"],["\\[","\\]"]],inlineMath:[["$","$"],["\\(","\\)"]]},svg:{fontCache:"global"}}</script><script type=module>
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: false });
  mermaid.mermaidAPI.initialize();
  window.mermaid = mermaid;
</script><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":false,"isPage":true,"path":"9.-Advanced-thread-management","permalink":"https://hxhue.github.io/cpp-concurrency-in-action/9.-Advanced-thread-management/","title":"9. Advanced thread management","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>9. Advanced thread management - Bluegill</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>Bluegill</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description></p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>é¦–é¡µ</a></li><li class="menu-item menu-item-about"><a href=/about/ class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>å…³äº</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>å½’æ¡£</a></li><li class="menu-item menu-item-categories"><a href=/categories/ class=hvr-icon-pulse rel=section><i class="fa fa-th hvr-icon"></i>åˆ†ç±»</a></li><li class="menu-item menu-item-tags"><a href=/tags/ class=hvr-icon-pulse rel=section><i class="fa fa-hashtag hvr-icon"></i>æ ‡ç­¾</a></li><li class="menu-item menu-item-daily"><a href=/daily/ class=hvr-icon-pulse rel=section><i class="fa fa-newspaper hvr-icon"></i>éšç¬”</a></li><li class="menu-item menu-item-discovery"><a href=https://rift-fear-f2c.notion.site/2025-1e354a33cfb1802c841bdf29f2f3dab3 class=hvr-icon-pulse rel=section><i class="fa fa-compass hvr-icon"></i>å‘ç°</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>æœç´¢</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=æœç´¢... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>æ–‡ç« ç›®å½•</li><li class=sidebar-nav-overview>ç«™ç‚¹æ¦‚è§ˆ</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#çº¿ç¨‹æ± >çº¿ç¨‹æ± </a><ul><li><a href=#å®ç°å¯ä»¥-submit-ä»»åŠ¡å¹¶è·å–-future-çš„çº¿ç¨‹æ± >å®ç°å¯ä»¥ submit ä»»åŠ¡å¹¶è·å– future çš„çº¿ç¨‹æ± </a></li><li><a href=#ä¿®å¤-quicksort-å·¥ä½œçº¿ç¨‹çš„æ­»é”>ä¿®å¤ quicksort å·¥ä½œçº¿ç¨‹çš„æ­»é”</a></li><li><a href=#ç”¨æœ¬åœ°é˜Ÿåˆ—å‡å°‘å•ä¸€å…¨å±€é˜Ÿåˆ—è´Ÿæ‹…>ç”¨æœ¬åœ°é˜Ÿåˆ—å‡å°‘å•ä¸€å…¨å±€é˜Ÿåˆ—è´Ÿæ‹…</a></li><li><a href=#å·¥ä½œçªƒå–>å·¥ä½œçªƒå–</a></li></ul></li><li><a href=#å¯ä¸­æ–­çº¿ç¨‹>å¯ä¸­æ–­çº¿ç¨‹</a><ul><li><a href=#æ‰‹åŠ¨æ·»åŠ ä¸­æ–­ç‚¹å®ç°å¯ä¸­æ–­çš„çº¿ç¨‹>æ‰‹åŠ¨æ·»åŠ ä¸­æ–­ç‚¹å®ç°å¯ä¸­æ–­çš„çº¿ç¨‹</a></li><li><a href=#ä¸­æ–­é˜»å¡ç­‰å¾…>ä¸­æ–­é˜»å¡ç­‰å¾…</a><ul><li><a href=#stdcondition_variable><code>std::condition_variable</code></a></li><li><a href=#stdcondition_variable_any><code>std::condition_variable_any</code></a></li><li><a href=#æ”¹å†™å…¶ä»–é˜»å¡ç­‰å¾…>æ”¹å†™å…¶ä»–é˜»å¡ç­‰å¾…</a></li></ul></li><li><a href=#å¼‚å¸¸å¤„ç†>å¼‚å¸¸å¤„ç†</a></li><li><a href=#åœ¨ç¨‹åºé€€å‡ºæ—¶ä¸­æ–­åå°çº¿ç¨‹>åœ¨ç¨‹åºé€€å‡ºæ—¶ä¸­æ–­åå°çº¿ç¨‹</a></li></ul></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=ğŸ¤– src=/imgs/371907.jpg><p class=site-author-name itemprop=name>ğŸ¤–</p><div class=site-description itemprop=description>ä¸ªäººåšå®¢ï¼Œä¸»è¦æ˜¯é›¶æ•£çš„ç¬”è®°ã€‚</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>433</span>
<span class=site-state-item-name>æ—¥å¿—</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>12</span>
<span class=site-state-item-name>åˆ†ç±»</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>86</span>
<span class=site-state-item-name>æ ‡ç­¾</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/hxhue title="Github â†’ https://github.com/hxhue" rel=noopener target=_blank><i class="fab fa-github fa-fw"></i>
Github
</a></span><span class=links-of-social-item><a href=/rss.xml title="RSS è®¢é˜… â†’ /rss.xml" rel=noopener target=_blank><i class="fa fa-rss fa-fw"></i>
RSS è®¢é˜…</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=å…±äº«çŸ¥è¯†><img src=/imgs/cc/big/by_nc_sa.svg alt=å…±äº«çŸ¥è¯†></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
å‹æƒ…é“¾æ¥</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://shuai.guru/ title=https://shuai.guru/ target=_blank>shuai.guru</a></li></ul></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=toggle-theme class=button title=æ·±æµ…æ¨¡å¼åˆ‡æ¢><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=è¿”å›é¡¶éƒ¨><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://hxhue.github.io/cpp-concurrency-in-action/9.-Advanced-thread-management/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/371907.jpg"><meta itemprop=name content="ğŸ¤–"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="ğŸ¤–"><meta itemprop=description content="ä¸ªäººåšå®¢ï¼Œä¸»è¦æ˜¯é›¶æ•£çš„ç¬”è®°ã€‚"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="9. Advanced thread management"><meta itemprop=description content="çº¿ç¨‹æ± 

å®ç°å¯ä»¥ submit ä»»åŠ¡å¹¶è·å– future çš„çº¿ç¨‹æ± 

æœ‰äº† std::future å°±èƒ½å¯¹æäº¤çš„ä»»åŠ¡åšç­‰å¾…ã€‚
çº¿ç¨‹æ± åˆå§‹åŒ–æ—¶å°±åˆ›å»ºæŒ‡å®šæ•°é‡çš„å·¥ä½œçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹çš„ä»»åŠ¡å°±æ˜¯åœ¨å¾ªç¯ä¸­ä»çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—ä¸Šè·å–ä»»åŠ¡å¹¶è¿è¡Œã€‚æ¯ä¸ªä»»åŠ¡çš„ç±»å‹æ˜¯ std::packaged_task<result_type()> taskï¼Œæ¯æ¬¡æœ‰å·¥ä½œè¦æäº¤éƒ½ä¼šåŒ…è£…åˆ° std::packaged_taskï¼Œå·¥ä½œçš„æäº¤è€…å› è€Œå¯ä»¥è·å– std::futureã€‚"></span><header class=post-header><h1 class=post-title itemprop="name headline">9. Advanced thread management</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=å‘è¡¨äº>å‘è¡¨äºï¼š
</span><time title="åˆ›å»ºæ—¶é—´ï¼š2025-01-18 00:00:00 +0800 CST" itemprop="dateCreated datePublished" datetime="2025-01-18 00:00:00 +0800 CST">2025-01-18
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar-check"></i>
</span><span class=post-meta-item-text title=æ›´æ–°äº>æ›´æ–°äºï¼š
</span><time title=ä¿®æ”¹æ—¶é—´ï¼š2025-03-04T00:00:00+08:00 itemprop=dateModified datetime=2025-03-04T00:00:00+08:00>2025-03-04</time>
</span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i>
</span><span class=post-meta-item-text title=åˆ†ç±»äº>åˆ†ç±»äºï¼š
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/cpp-concurrency-in-action itemprop=url rel=index><span itemprop=name>cpp-concurrency-in-action</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=å­—æ•°><span class=post-meta-item-icon><i class="far fa-file-word"></i>
</span><span class=post-meta-item-text>å­—æ•°ï¼š</span>
<span>2610</span>
</span><span class=post-meta-item title=é˜…è¯»><span class=post-meta-item-icon><i class="far fa-clock"></i>
</span><span class=post-meta-item-text>é˜…è¯»ï¼š&ap;</span>
<span>6åˆ†é’Ÿ</span></span></div></div></header><div class=post-body itemprop=articleBody><h1 id=çº¿ç¨‹æ± >çº¿ç¨‹æ± 
<a class=header-anchor href=#%e7%ba%bf%e7%a8%8b%e6%b1%a0></a></h1><h2 id=å®ç°å¯ä»¥-submit-ä»»åŠ¡å¹¶è·å–-future-çš„çº¿ç¨‹æ± >å®ç°å¯ä»¥ submit ä»»åŠ¡å¹¶è·å– future çš„çº¿ç¨‹æ± 
<a class=header-anchor href=#%e5%ae%9e%e7%8e%b0%e5%8f%af%e4%bb%a5-submit-%e4%bb%bb%e5%8a%a1%e5%b9%b6%e8%8e%b7%e5%8f%96-future-%e7%9a%84%e7%ba%bf%e7%a8%8b%e6%b1%a0></a></h2><p>æœ‰äº† <code>std::future</code> å°±èƒ½å¯¹æäº¤çš„ä»»åŠ¡åšç­‰å¾…ã€‚</p><p>çº¿ç¨‹æ± åˆå§‹åŒ–æ—¶å°±åˆ›å»ºæŒ‡å®šæ•°é‡çš„å·¥ä½œçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹çš„ä»»åŠ¡å°±æ˜¯åœ¨å¾ªç¯ä¸­ä»çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—ä¸Šè·å–ä»»åŠ¡å¹¶è¿è¡Œã€‚æ¯ä¸ªä»»åŠ¡çš„ç±»å‹æ˜¯ <code>std::packaged_task&lt;result_type()> task</code>ï¼Œæ¯æ¬¡æœ‰å·¥ä½œè¦æäº¤éƒ½ä¼šåŒ…è£…åˆ° <code>std::packaged_task</code>ï¼Œå·¥ä½œçš„æäº¤è€…å› è€Œå¯ä»¥è·å– <code>std::future</code>ã€‚</p><p>ç”±äº C++23 æ‰å¼•å…¥ <code>std::move_only_function&lt;></code>ï¼Œä¹¦ä¸Šå®ç°äº†ä¸€ä¸ªç®€å•çš„æ›¿ä»£ã€‚</p><h2 id=ä¿®å¤-quicksort-å·¥ä½œçº¿ç¨‹çš„æ­»é”>ä¿®å¤ quicksort å·¥ä½œçº¿ç¨‹çš„æ­»é”
<a class=header-anchor href=#%e4%bf%ae%e5%a4%8d-quicksort-%e5%b7%a5%e4%bd%9c%e7%ba%bf%e7%a8%8b%e7%9a%84%e6%ad%bb%e9%94%81></a></h2><p>ä¹¦ä¸Šç»™äº†ä¸€ä¸ª quicksort çš„ä¾‹å­ï¼ŒæŒ‡å‡ºåˆ’åˆ†å®Œæˆæ—¶ï¼Œæœ¬çº¿ç¨‹å…ˆé€’å½’åšå®Œ <code>new_higher</code> æ®µçš„å·¥ä½œï¼Œå†å»ç­‰å¾… <code>new_lower</code> æ®µçš„å·¥ä½œçš„ futureã€‚è¿™ä¸ªå®ç°ä¸­çº¿ç¨‹æ± ä¸­å·¥ä½œçº¿ç¨‹æ•°é‡æ˜¯å›ºå®šçš„ï¼Œå¦‚æœæ‰€æœ‰å·¥ä½œçº¿ç¨‹éƒ½éœ€è¦ç­‰å¾… futureï¼Œé‚£ä¹ˆå°±æ²¡æœ‰å‰©ä½™çš„å·¥ä½œçº¿ç¨‹å»çœŸæ­£æ¨è¿›ä»»åŠ¡äº†ï¼<strong>æœ‰é™çº¿ç¨‹æ•°</strong> + <strong>çº¿ç¨‹ç­‰å¾…å°šæœªæ’é˜Ÿçš„ä»»åŠ¡</strong> = æ­»é”ã€‚</p><p>è§£å†³æ–¹æ¡ˆæ˜¯è®©çº¿ç¨‹åœ¨ç­‰å¾…æœŸé—´ä¸è¦ä¼‘çœ ï¼Œè€Œæ˜¯ä¸»åŠ¨å¤„ç†å…¶ä»–ä»»åŠ¡ï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#719e07>while</span> (new_lower.wait_for(std<span style=color:#719e07>::</span>chrono<span style=color:#719e07>::</span>seconds(<span style=color:#2aa198>0</span>)) <span style=color:#719e07>==</span> std<span style=color:#719e07>::</span>future_status<span style=color:#719e07>::</span>timeout) {
</span></span><span style=display:flex><span>    pool.run_pending_task();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä¸ºæ­¤ï¼Œéœ€è¦å®ç° <code>run_pending_task()</code>ï¼Œå®ƒå¼€æ”¾äº†<strong>çº¿ç¨‹æ± å¤–</strong>æ‰§è¡Œçº¿ç¨‹æ± ä»»åŠ¡é˜Ÿåˆ—ä¸­ä»»åŠ¡çš„æ¥å£ï¼Œé¿å…å…¶ä»–çº¿ç¨‹åšæ— æ„ä¹‰çš„ç­‰å¾…ã€‚</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#dc322f>void</span> thread_pool<span style=color:#719e07>::</span>run_pending_task() {
</span></span><span style=display:flex><span>    function_wrapper task;
</span></span><span style=display:flex><span>    <span style=color:#719e07>if</span> (work_queue.try_pop(task)) {
</span></span><span style=display:flex><span>        task();
</span></span><span style=display:flex><span>    } <span style=color:#719e07>else</span> {
</span></span><span style=display:flex><span>        std<span style=color:#719e07>::</span>this_thread<span style=color:#719e07>::</span>yield();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=ç”¨æœ¬åœ°é˜Ÿåˆ—å‡å°‘å•ä¸€å…¨å±€é˜Ÿåˆ—è´Ÿæ‹…>ç”¨æœ¬åœ°é˜Ÿåˆ—å‡å°‘å•ä¸€å…¨å±€é˜Ÿåˆ—è´Ÿæ‹…
<a class=header-anchor href=#%e7%94%a8%e6%9c%ac%e5%9c%b0%e9%98%9f%e5%88%97%e5%87%8f%e5%b0%91%e5%8d%95%e4%b8%80%e5%85%a8%e5%b1%80%e9%98%9f%e5%88%97%e8%b4%9f%e6%8b%85></a></h2><p>ä¸ºæ¯ä¸ªå·¥ä½œçº¿ç¨‹åˆ›å»ºä¸€ä¸ªæœ¬åœ°é˜Ÿåˆ—ï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#719e07>class</span> <span style=color:#268bd2>thread_pool</span> {
</span></span><span style=display:flex><span>    threadsafe_queue<span style=color:#719e07>&lt;</span>function_wrapper<span style=color:#719e07>&gt;</span> pool_work_queue;
</span></span><span style=display:flex><span>    <span style=color:#719e07>typedef</span> std<span style=color:#719e07>::</span>queue<span style=color:#719e07>&lt;</span>function_wrapper<span style=color:#719e07>&gt;</span> local_queue_type;
</span></span><span style=display:flex><span>    <span style=color:#719e07>static</span> <span style=color:#719e07>thread_local</span> std<span style=color:#719e07>::</span>unique_ptr<span style=color:#719e07>&lt;</span>local_queue_type<span style=color:#719e07>&gt;</span> local_work_queue;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>void</span> <span style=color:#268bd2>worker_thread</span>() {
</span></span><span style=display:flex><span>        local_work_queue.reset(<span style=color:#719e07>new</span> local_queue_type);
</span></span><span style=display:flex><span>        <span style=color:#719e07>while</span> (<span style=color:#719e07>!</span>done) {
</span></span><span style=display:flex><span>            run_pending_task();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#586e75>// ...
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>};
</span></span></code></pre></div><p>ç±»å‹é€‰æ‹© <code>std::unique_ptr&lt;local_queue_type></code>ï¼Œå¯ä»¥é¿å…ä¸ºéå·¥ä½œçº¿ç¨‹åˆ›å»ºé˜Ÿåˆ—ï¼Œå‡å°‘ä¸å¿…è¦çš„å¼€é”€ã€‚å› ä¸ºæœ¬åœ°é˜Ÿåˆ—åªç”±çº¿ç¨‹æœ¬èº«è®¿é—®ï¼Œæ‰€ä»¥ä¸éœ€è¦åšåŒæ­¥ã€‚</p><p>ç°åœ¨ï¼Œæ¯æ¬¡æ‰§è¡Œä»»åŠ¡æ—¶ï¼ˆ<code>run_pending_task</code>ï¼‰ï¼Œå…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨æœ¬åœ°é˜Ÿåˆ—ï¼ˆå¦‚æœå­˜åœ¨è¯´æ˜æ˜¯å·¥ä½œçº¿ç¨‹ï¼‰ï¼Œè‹¥å­˜åœ¨åˆ™ä»å…¶ä¸­è·å–ä»»åŠ¡ï¼Œä¸å­˜åœ¨æœ¬åœ°é˜Ÿåˆ—æˆ–è€…æ²¡èƒ½è·å–åˆ°ä»»åŠ¡æ—¶ä»å…¨å±€é˜Ÿåˆ—ä¸Šè·å–ä»»åŠ¡ã€‚ä¹‹æ‰€ä»¥è¦â€œæ˜¯å¦å­˜åœ¨æœ¬åœ°é˜Ÿåˆ—â€ï¼Œæ˜¯å› ä¸º <code>run_pending_task()</code> è¿™ä¸ªæ¥å£ä¹Ÿå¼€æ”¾ç»™äº†çº¿ç¨‹æ± å¤–é¢ï¼Œä½¿å¾—å…¶ä»–çº¿ç¨‹å¯ä»¥ååŠ©å¤„ç†çº¿ç¨‹æ± å†…çš„ä»»åŠ¡ã€‚</p><p>å‡½æ•° <code>submit()</code> ä¹Ÿè¦åšä¿®æ”¹ï¼Œç°åœ¨å¦‚æœæœ‰æœ¬åœ°é˜Ÿåˆ—ï¼Œå°±ä¼˜å…ˆå°†ä»»åŠ¡æ·»åŠ åˆ°æœ¬åœ°é˜Ÿåˆ—ä¸Šé¢å»ã€‚è¿™ä¼šå¸¦æ¥é—®é¢˜ï¼šå¦‚æœ <code>submit()</code> ä¸ä¿®æ”¹ï¼Œé‚£ä¹ˆæ²¡æœ‰ä»»åŠ¡ä¼šè¢«åŠ å…¥åˆ°çº¿ç¨‹æœ¬åœ°é˜Ÿåˆ—ä¸­å»ï¼Œè¿™ä¸ªé˜Ÿåˆ—å½¢åŒè™šè®¾ï¼›å¦‚æœ <code>submit()</code> ä¿®æ”¹äº†ï¼Œé‚£ä¹ˆé€’å½’ä»»åŠ¡å®¹æ˜“é‡åˆ°å­ä»»åŠ¡å †ç§¯çš„æƒ…å†µã€‚è¿™ä¸ªé—®é¢˜åœ¨æ¥ä¸‹æ¥è¢«è§£å†³ã€‚</p><h2 id=å·¥ä½œçªƒå–>å·¥ä½œçªƒå–
<a class=header-anchor href=#%e5%b7%a5%e4%bd%9c%e7%aa%83%e5%8f%96></a></h2><p>æœ‰äº›ä»»åŠ¡æ˜¯é€’å½’è¿›è¡Œçš„ï¼Œæ¯”å¦‚ä¹¦ä¸Šçš„ quicksort å¹¶è¡Œå®ç°ã€‚å¦‚æœå·¥ä½œçº¿ç¨‹ä½¿ç”¨æœ¬åœ°é˜Ÿåˆ—ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šå‡ºç°ä¸€ä¸ªçº¿ç¨‹å †ç§¯å¤§é‡ä»»åŠ¡ï¼Œå…¶ä»–çº¿ç¨‹ä¸èƒ½å¤„ç†ä»»åŠ¡çš„æƒ…å†µã€‚</p><p>å·¥ä½œçªƒå–å…è®¸çº¿ç¨‹åœ¨æœ¬åœ°å’Œå…¨å±€é˜Ÿåˆ—ä¸Šå‡æ— ä»»åŠ¡æ—¶ï¼Œä»åˆ«çš„çº¿ç¨‹çš„æœ¬åœ°é˜Ÿåˆ—ä¸­çªƒå–ä»»åŠ¡ã€‚ä¸€æ–¹é¢æ˜¯è¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå¯ä»¥ç”¨ mutex ä¿æŠ¤ï¼›å¦ä¸€æ–¹é¢æ˜¯å°½é‡é¿å…å’Œæœ¬åœ°é˜Ÿåˆ—çš„æ‰€æœ‰è€…å‘ç”Ÿå†²çªï¼Œå› æ­¤å¯ä»¥æŠŠ queue æ”¹æˆ dequeï¼Œé˜Ÿåˆ—æ‰€æœ‰è€…åœ¨ front ç«¯æ“ä½œï¼Œä»»åŠ¡çªƒå–è€…ä» back ç«¯æ“ä½œã€‚æ‰§è¡Œå·¥ä½œçš„é€»è¾‘å˜æˆï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#dc322f>void</span> <span style=color:#268bd2>run_pending_task</span>() {
</span></span><span style=display:flex><span>    task_type task;
</span></span><span style=display:flex><span>    <span style=color:#719e07>if</span> (pop_task_from_local_queue(task) <span style=color:#719e07>||</span>
</span></span><span style=display:flex><span>        pop_task_from_pool_queue(task) <span style=color:#719e07>||</span>
</span></span><span style=display:flex><span>        pop_task_from_other_thread_queue(task)) {
</span></span><span style=display:flex><span>        task();
</span></span><span style=display:flex><span>    } <span style=color:#719e07>else</span> {
</span></span><span style=display:flex><span>        std<span style=color:#719e07>::</span>this_thread<span style=color:#719e07>::</span>yield();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å’Œä¹¦é‡Œç»™çš„ hazard pointer çš„å®ç°ç±»ä¼¼ï¼Œ<code>thread_pool</code> ç±»åŒ…å«ä¸€ä¸ªå·¥ä½œé˜Ÿåˆ—æ•°ç»„ï¼Œè¿™æ ·æ¯ä¸ªçº¿ç¨‹å°±èƒ½çœ‹åˆ°å…¶ä»–æ‰€æœ‰å·¥ä½œçº¿ç¨‹çš„å·¥ä½œé˜Ÿåˆ—å¹¶å°è¯•åœ¨ä¸Šé¢çªƒå–å·¥ä½œã€‚çªƒå–å·¥ä½œçš„ä»£ç å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#dc322f>bool</span> <span style=color:#268bd2>pop_task_from_other_thread_queue</span>(task_type<span style=color:#719e07>&amp;</span> task) {
</span></span><span style=display:flex><span>    <span style=color:#719e07>for</span> (<span style=color:#dc322f>unsigned</span> i <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>; i <span style=color:#719e07>&lt;</span> queues.size(); <span style=color:#719e07>++</span>i) {
</span></span><span style=display:flex><span>        <span style=color:#dc322f>unsigned</span> <span style=color:#719e07>const</span> index <span style=color:#719e07>=</span> (my_index <span style=color:#719e07>+</span> i <span style=color:#719e07>+</span> <span style=color:#2aa198>1</span>) <span style=color:#719e07>%</span> queues.size();
</span></span><span style=display:flex><span>        <span style=color:#719e07>if</span> (queues[index]<span style=color:#719e07>-&gt;</span>try_steal(task)) {
</span></span><span style=display:flex><span>            <span style=color:#719e07>return</span> <span style=color:#b58900>true</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#719e07>return</span> <span style=color:#b58900>false</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æ¯ä¸ªçº¿ç¨‹ä» i + 1 çš„ä½ç½®å¼€å§‹çªƒå–å·¥ä½œï¼Œè¿™æ ·å¯ä»¥é˜²æ­¢çªƒå–å·¥ä½œæ—¶æ€»æ˜¯ä» 0 å·çº¿ç¨‹çš„å·¥ä½œé˜Ÿåˆ—å¼€å§‹ï¼Œå‡å°‘äº†ç«äº‰ï¼ˆcontentionï¼‰ï¼ŒåŒæ—¶ä½¿å¾—å·¥ä½œåˆ†å¸ƒå¾—æ›´åŠ å‡åŒ€ã€‚</p><h1 id=å¯ä¸­æ–­çº¿ç¨‹>å¯ä¸­æ–­çº¿ç¨‹
<a class=header-anchor href=#%e5%8f%af%e4%b8%ad%e6%96%ad%e7%ba%bf%e7%a8%8b></a></h1><h2 id=æ‰‹åŠ¨æ·»åŠ ä¸­æ–­ç‚¹å®ç°å¯ä¸­æ–­çš„çº¿ç¨‹>æ‰‹åŠ¨æ·»åŠ ä¸­æ–­ç‚¹å®ç°å¯ä¸­æ–­çš„çº¿ç¨‹
<a class=header-anchor href=#%e6%89%8b%e5%8a%a8%e6%b7%bb%e5%8a%a0%e4%b8%ad%e6%96%ad%e7%82%b9%e5%ae%9e%e7%8e%b0%e5%8f%af%e4%b8%ad%e6%96%ad%e7%9a%84%e7%ba%bf%e7%a8%8b></a></h2><p>æ¯ä¸ªå·¥ä½œçº¿ç¨‹å…³è”ä¸€ä¸ª token / flagï¼Œä¸»åŠ¨é€‚æ—¶è°ƒç”¨ <code>interruption_point()</code> æ£€æŸ¥æ˜¯å¦éœ€è¦ä¸­æ–­ï¼Œ<strong>è¿™å’Œ pthread åº“é‡Œé¢ç”¨ <code>pthread_testcancel()</code> ä¸»åŠ¨æä¾›å–æ¶ˆç‚¹ä¸€æ ·</strong>ï¼ˆå°½ç®¡è®¸å¤šç³»ç»Ÿè°ƒç”¨éƒ½æ˜¯å–æ¶ˆç‚¹ï¼‰ã€‚</p><p>ä¹¦ä¸Šå°†è¿™ä¸ª flag æ”¾åœ¨äº† <code>thread_local</code> å˜é‡é‡Œé¢ï¼Œä½†æ˜¯æˆ‘è§‰å¾—å¯ä»¥æ”¾åœ¨ thread çš„æ ˆé‡Œé¢ï¼ˆåœ¨ <code>p.set_value</code> çš„å‰é¢ï¼‰ï¼Œè¿™æ ·å¯ä»¥é¿å…ä¸æ˜¯ç”± <code>interruptible_thread</code> åˆ›å»ºçš„çº¿ç¨‹ä¹Ÿæ‰¿æ‹…ä¸€ä¸ªçº¿ç¨‹æœ¬åœ° flag çš„å­˜å‚¨å¼€é”€ã€‚</p><p><img src=/cpp-concurrency-in-action/assets/Pasted%20image%2020250122120835.webp width=600></p><p><code>interruption_point()</code> çš„å®ç°æ˜¯ï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#dc322f>void</span> <span style=color:#268bd2>interruption_point</span>() {
</span></span><span style=display:flex><span>    <span style=color:#719e07>if</span> (this_thread_interrupt_flag.is_set()) {
</span></span><span style=display:flex><span>        <span style=color:#719e07>throw</span> thread_interrupted();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿™ä¸ªå¼‚å¸¸è°æ¥å¤„ç†å‘¢ï¼Ÿä¸å¤„ç†çš„è¯ C++ è¿è¡Œæ—¶ä¼šè°ƒç”¨ <code>std::terminate</code>ã€‚æˆ‘ä¸ªäººè®¤ä¸ºåœ¨ä¸Šå›¾ä¸­çš„ç¬¬ â‘¢ æ­¥ï¼Œåˆ›å»º <code>internal_thread</code> çš„ lambda ä¸­å°±å¯ä»¥å¯¹è¿™ä¸ªå¼‚å¸¸åšæ•è·ã€‚<mark>ä¹¦ä¸ŠæŠŠå¼‚å¸¸å¤„ç†æ”¾åœ¨äº†æ¯”è¾ƒåé¢çš„åœ°æ–¹</mark>ã€‚</p><p>ä¹¦ä¸Šä¹Ÿæ²¡æœ‰å¤„ç†çº¿ç¨‹çš„ join å’Œ detachï¼Œå› æ­¤æœ€å¥½è¿˜æ˜¯ä½¿ç”¨ C++20 åŠ å…¥çš„ <code>std::jthread</code>ï¼Œé™¤äº†èƒ½è‡ªåŠ¨ join ä¹‹å¤–ï¼Œè¿˜èƒ½ä½¿ç”¨é…å¥—çš„ <a href=https://en.cppreference.com/w/cpp/thread/stop_token title=stop_token rel="noopener external nofollow noreferrer" target=_blank class=exturl><code>stop_token</code><i class="fa fa-external-link-alt"></i></a>ã€‚</p><blockquote><p>The destructor of <code>jthread</code> calls <code>request_stop()</code> and <code>join()</code>.ï¼ˆå¦‚æœ joinable æ‰ä¼šè°ƒç”¨è¿™ä¸¤ä¸ªå‡½æ•°ã€‚ï¼‰</p></blockquote><h2 id=ä¸­æ–­é˜»å¡ç­‰å¾…>ä¸­æ–­é˜»å¡ç­‰å¾…
<a class=header-anchor href=#%e4%b8%ad%e6%96%ad%e9%98%bb%e5%a1%9e%e7%ad%89%e5%be%85></a></h2><p>çº¿ç¨‹å¦‚æœæœ‰äº›è°ƒç”¨æ˜¯é˜»å¡çš„ï¼Œé‚£ä¹ˆå¯èƒ½ä¸€ç›´ä¼‘çœ ä¸‹å»ï¼Œå°±ä¸ä¼šæ—¶ä¸æ—¶è°ƒç”¨ <code>interruption_point()</code> äº†ï¼Œè¿™å¯¼è‡´çº¿ç¨‹æ— æ³•è¢«ä¸­æ–­ã€‚ä¸ºæ­¤ï¼Œæ‰€æœ‰é˜»å¡ç­‰å¾…éœ€è¦æ›¿æ¢æˆä¸€ä¸ªé€‚æ—¶è°ƒç”¨ <code>interruptible_wait()</code> çš„ç­‰å¾…æ–¹å¼ï¼Œä¹¦ä¸­å°†å…¶å‘½åä¸º <code>interruptible_wait()</code>ã€‚</p><h3 id=stdcondition_variable><code>std::condition_variable</code>
<a class=header-anchor href=#stdcondition_variable></a></h3><p><img src=/cpp-concurrency-in-action/assets/Pasted%20image%2020250122155229.webp width=650></p><p>ä¸Šé¢å®ç°çš„é”™è¯¯åŸå› æœ‰ï¼š</p><ol><li>æ²¡æœ‰ç”¨ RAII å¤„ç†å¼‚å¸¸ã€‚</li><li>æ•°æ®ç«äº‰ï¼šå¦‚æœåœ¨æ³¨å†Œç¯å¢ƒå˜é‡çš„é€šçŸ¥ä¹‹å‰ï¼Œå°±æœ‰å…¶ä»–çº¿ç¨‹å‘èµ·äº†é€šçŸ¥ï¼Œé‚£ä¹ˆæœ¬çº¿ç¨‹ä¼šé”™è¿‡è¿™ä¸€æ¬¡é€šçŸ¥ï¼Œå¹¶ä¸”åœ¨ <code>cv.wait(lk)</code> ä¸Šæ°¸è¿œé˜»å¡ä¸‹å»ã€‚è¿™ä¸ªå’Œ TLPI ä¹¦ä¸­è§£é‡Šä¸ºä»€ä¹ˆ <code>sigwaitinfo</code> ä¸èƒ½è¢« <code>sigprocmask</code> + <code>pause</code> å–ä»£ä¸€æ ·ã€‚</li></ol><p>ä¸ºäº†å¤„ç†å¼‚å¸¸é—®é¢˜ï¼Œä¹¦ä¸Šæä¾›äº†ä¸€ä¸ªåœ¨ææ„æ—¶è°ƒç”¨ <code>clear_condition_variable</code> çš„ guard ç±»ã€‚ä¸ºäº†å¤„ç†æ•°æ®ç«äº‰é—®é¢˜ï¼Œä¹¦ä¸Šå°†æ— é™ç­‰å¾…æ”¹æˆäº†åªç­‰å¾…æœ€å¤š 1msã€‚</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#dc322f>void</span> <span style=color:#268bd2>interruptible_wait</span>(std<span style=color:#719e07>::</span>condition_variable<span style=color:#719e07>&amp;</span> cv, std<span style=color:#719e07>::</span>unique_lock<span style=color:#719e07>&lt;</span>std<span style=color:#719e07>::</span>mutex<span style=color:#719e07>&gt;&amp;</span> lk) {
</span></span><span style=display:flex><span>    interruption_point();
</span></span><span style=display:flex><span>    this_thread_interrupt_flag.set_condition_variable(cv);
</span></span><span style=display:flex><span>    interrupt_flag<span style=color:#719e07>::</span>clear_cv_on_destruct guard;
</span></span><span style=display:flex><span>    interruption_point();
</span></span><span style=display:flex><span>    cv.wait_for(lk, std<span style=color:#719e07>::</span>chrono<span style=color:#719e07>::</span>milliseconds(<span style=color:#2aa198>1</span>));
</span></span><span style=display:flex><span>    interruption_point();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å…¶ä»–çº¿ç¨‹å¦‚æœæƒ³è¦ä¸­æ–­å½“å‰çº¿ç¨‹ï¼Œä¸ä»…è¦è®¾ç½®ä¸­æ–­ flagï¼Œè¿˜è¦å¯¹çº¿ç¨‹å½“å‰æ­£åœ¨ç­‰å¾…çš„æ¡ä»¶å˜é‡åšé€šçŸ¥ï¼ˆè°ƒç”¨ <code>notify_all()</code>)ã€‚å› æ­¤æ¯æ¬¡å·¥ä½œçº¿ç¨‹è¦åœ¨æŸä¸ªæ¡ä»¶å˜é‡ä¸Šåšç­‰å¾…å‰ï¼Œéƒ½è¦å°†è¦ç­‰å¾…çš„æ¡ä»¶å˜é‡å…ˆå…³è”åˆ°è‡ªå·±çš„ flag ä¸Šï¼Œä»¥ä¾¿å…¶ä»–çº¿ç¨‹å‘èµ·é€šçŸ¥ã€‚å·¥ä½œçº¿ç¨‹å…³è”å’Œè§£é™¤å…³è”æ¡ä»¶å˜é‡çš„åŒæ—¶ï¼Œå…¶ä»–çº¿ç¨‹å¯èƒ½ä¼šé€šè¿‡ flag å‘èµ·å¯¹å…³è”æ¡ä»¶å˜é‡çš„é€šçŸ¥ï¼Œå› æ­¤éœ€è¦å¢åŠ ä¸€ä¸ª mutex æ¥é˜²æ­¢æ•°æ®ç«äº‰ã€‚æœ€åè¿™ä¸ª flag ç±»å‹çš„è¢«è®¾è®¡ä¸ºåŒ…å«ä»¥ä¸‹æ•°æ®ï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#719e07>class</span> <span style=color:#268bd2>interrupt_flag</span> {
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span>atomic<span style=color:#719e07>&lt;</span><span style=color:#dc322f>bool</span><span style=color:#719e07>&gt;</span> flag;
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span>condition_variable<span style=color:#719e07>*</span> thread_cond;
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span>mutex set_clear_mutex;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h3 id=stdcondition_variable_any><code>std::condition_variable_any</code>
<a class=header-anchor href=#stdcondition_variable_any></a></h3><p>ä¸Šä¸€å°èŠ‚æ˜¯ä½¿ç”¨ <code>std::condition_variable&</code> + <code>std::unique_lock&lt;std::mutex>&</code> æ¥å®ç°çš„ç­‰å¾…ï¼Œä¹¦ä¸Šæ¥ä¸‹æ¥è®²å¯ä»¥ç”¨ <code>std::condition_variable_any&</code> + <code>Lockable&</code> å®ç°ç­‰å¾…ï¼Œè¿‡ç¨‹æ˜¯å·®ä¸å¤šçš„ã€‚</p><p>ä¹¦ä¸Šè¿˜æåˆ°äº†æ—¢ç„¶ç°åœ¨å¯ä»¥åœ¨ <code>std::condition_variable_any</code> ä¸Šè°ƒç”¨ <code>wait</code>ï¼Œé‚£ä¹ˆå¯ä»¥å†™ä¸€ä¸ªåŒ…è£…äº†å¾ˆå¤šé€»è¾‘çš„ <code>custom_lock</code> ç±»å‹ï¼Œå®ƒåœ¨ <code>lock()</code> å’Œ <code>unlock()</code> çš„å¤šä¸ªç¯èŠ‚æ‰§è¡Œç­‰ä»·çš„æ“ä½œã€‚æˆ‘ä¸ªäººè§‰å¾—è¿™æ ·åšåè€Œæ›´åŠ å¤æ‚äº†ï¼Œä»£ç ä¹Ÿä¸å¥½é˜…è¯»ã€‚</p><h3 id=æ”¹å†™å…¶ä»–é˜»å¡ç­‰å¾…>æ”¹å†™å…¶ä»–é˜»å¡ç­‰å¾…
<a class=header-anchor href=#%e6%94%b9%e5%86%99%e5%85%b6%e4%bb%96%e9%98%bb%e5%a1%9e%e7%ad%89%e5%be%85></a></h3><p>å…¶ä»–é˜»å¡ç­‰å¾…ä¹Ÿè¦ç›¸åº”åœ°æ”¹æˆåœ¨å¾ªç¯ä¸­ç­‰å¾…ä¸€æ®µæ—¶é—´ä¹‹åå”¤é†’æ£€æŸ¥æ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼Œæ¯”å¦‚å¯¹äº <code>std::future</code> çš„ç­‰å¾…ï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#719e07>template</span><span style=color:#719e07>&lt;</span><span style=color:#719e07>typename</span> T<span style=color:#719e07>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#dc322f>void</span> interruptible_wait(std<span style=color:#719e07>::</span>future<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;&amp;</span> uf) {
</span></span><span style=display:flex><span>    <span style=color:#719e07>while</span> (<span style=color:#719e07>!</span>this_thread_interrupt_flag.is_set()) {
</span></span><span style=display:flex><span>        <span style=color:#719e07>if</span> (uf.wait_for(std<span style=color:#719e07>::</span>chrono<span style=color:#719e07>::</span>milliseconds(<span style=color:#2aa198>1</span>)) <span style=color:#719e07>==</span> std<span style=color:#719e07>::</span>future_status<span style=color:#719e07>::</span>ready)
</span></span><span style=display:flex><span>            <span style=color:#719e07>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    interruption_point();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=å¼‚å¸¸å¤„ç†>å¼‚å¸¸å¤„ç†
<a class=header-anchor href=#%e5%bc%82%e5%b8%b8%e5%a4%84%e7%90%86></a></h2><p>ä¹‹å‰åœ¨å®ç°å¯ä¸­æ–­çº¿ç¨‹çš„æ—¶å€™ï¼Œ<code>interruption_point()</code> åœ¨å‘ç°ä¸­æ–­çš„æ—¶å€™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¦‚æœè¿™ä¸ªå¼‚å¸¸ä¸è¢«å¤„ç†ï¼Œé‚£ä¹ˆ <code>std::terminate</code> ä¼šå¯¼è‡´ç¨‹åºç»ˆæ­¢ã€‚å¯ä»¥é€šè¿‡åŒ…è£…ç”¨æˆ·æä¾›çš„å¯åŠ¨å‡½æ•°æ¥å¤„ç†å¼‚å¸¸ï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span>internal_thread <span style=color:#719e07>=</span> std<span style=color:#719e07>::</span><span style=color:#268bd2>thread</span>([f, <span style=color:#719e07>&amp;</span>p] {
</span></span><span style=display:flex><span>    p.set_value(<span style=color:#719e07>&amp;</span>this_thread_interrupt_flag);
</span></span><span style=display:flex><span>    <span style=color:#719e07>try</span> {
</span></span><span style=display:flex><span>        f();
</span></span><span style=display:flex><span>    } <span style=color:#719e07>catch</span> (thread_interrupted <span style=color:#719e07>const</span><span style=color:#719e07>&amp;</span>) {
</span></span><span style=display:flex><span>        <span style=color:#586e75>// TODO: store the exception in future
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    }
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>è¿™æ ·æ— è®ºå¦‚ä½•éƒ½ä¸ä¼šæœ‰æœªå¤„ç†çš„å¼‚å¸¸ã€‚åœ¨å¼‚å¸¸è¢«æ•è·åæˆ‘ä»¬å¯ä»¥ä¸º future è®¾ç½®å¥½å¼‚å¸¸ä¿¡æ¯ã€‚</p><p>æ­¤å¤–ï¼Œå·¥ä½œå‡½æ•° <code>f()</code> å†…éƒ¨ä¹Ÿå¯ä»¥å¯¹ä¸­æ–­å¼‚å¸¸åšæ£€æŸ¥ï¼Œå¹¶åšå¥½å–„åå·¥ä½œã€‚</p><h2 id=åœ¨ç¨‹åºé€€å‡ºæ—¶ä¸­æ–­åå°çº¿ç¨‹>åœ¨ç¨‹åºé€€å‡ºæ—¶ä¸­æ–­åå°çº¿ç¨‹
<a class=header-anchor href=#%e5%9c%a8%e7%a8%8b%e5%ba%8f%e9%80%80%e5%87%ba%e6%97%b6%e4%b8%ad%e6%96%ad%e5%90%8e%e5%8f%b0%e7%ba%bf%e7%a8%8b></a></h2><p>ä»¥ä¸‹ä¸ºä¹¦ä¸­å†…å®¹çš„ä¸€éƒ¨åˆ†çš„æ‘˜å½•ï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#dc322f>int</span> <span style=color:#268bd2>main</span>() {
</span></span><span style=display:flex><span>    start_background_processing();
</span></span><span style=display:flex><span>    process_gui_until_exit();
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span>unique_lock<span style=color:#719e07>&lt;</span>std<span style=color:#719e07>::</span>mutex<span style=color:#719e07>&gt;</span> lk(config_mutex);
</span></span><span style=display:flex><span>    <span style=color:#719e07>for</span> (<span style=color:#dc322f>unsigned</span> i <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>; i <span style=color:#719e07>&lt;</span> background_threads.size(); <span style=color:#719e07>++</span>i) {
</span></span><span style=display:flex><span>        background_threads[i].interrupt();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#719e07>for</span> (<span style=color:#dc322f>unsigned</span> i <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>; i <span style=color:#719e07>&lt;</span> background_threads.size(); <span style=color:#719e07>++</span>i) {
</span></span><span style=display:flex><span>        background_threads[i].join();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿™å…¶å®ä¹Ÿæ˜¯ <a href=https://en.cppreference.com/w/cpp/thread/stop_token title="std::jthread çš„è¡Œä¸º" rel="noopener external nofollow noreferrer" target=_blank class=exturl><code>std::jthread</code> çš„è¡Œä¸º<i class="fa fa-external-link-alt"></i></a>ï¼Œå®ƒåœ¨é€€å‡ºæ—¶æ£€æŸ¥çº¿ç¨‹æ˜¯å¦ joinableï¼Œè‹¥æ˜¯åˆ™è°ƒç”¨ <code>request_stop()</code> å’Œ <code>join()</code>ã€‚</p></div><footer class=post-footer><div class=post-tags><a href=/tags/cpp>cpp
</a><a href=/tags/cpp-concurrency-in-action>cpp-concurrency-in-action</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/cpp-concurrency-in-action/11.-%E6%B5%8B%E8%AF%95%E5%92%8C%E8%B0%83%E8%AF%95%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%BA%94%E7%94%A8/ rel=next title="11. æµ‹è¯•å’Œè°ƒè¯•å¤šçº¿ç¨‹åº”ç”¨"><i class="fa fa-chevron-left"></i> 11. æµ‹è¯•å’Œè°ƒè¯•å¤šçº¿ç¨‹åº”ç”¨</a></div><div class="post-nav-prev post-nav-item"><a href=/cpp-concurrency-in-action/8.-Designing-concurrent-code/ rel=prev title="8. Designing concurrent code">8. Designing concurrent code
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2023 - 2025
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>ğŸ¤–</span></div><div class=powered-by>ç”± <a href=https://gohugo.io title=0.143.1 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.5.3 target=_blank>Hugo NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨</div></div></footer><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js defer></script><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":false,"save":"manual"},"copybtn":true,"darkmode":false,"hostname":"https://hxhue.github.io/","i18n":{"ds_day":" å¤©å‰","ds_days":" å¤© ","ds_hour":" å°æ—¶å‰","ds_hours":" å°æ—¶ ","ds_just":"åˆšåˆš","ds_min":" åˆ†é’Ÿå‰","ds_mins":" åˆ†é’Ÿ","ds_month":" ä¸ªæœˆå‰","ds_years":" å¹´ ","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","placeholder":"æœç´¢..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":false,"transition":{"collheader":"fadeInLeft","menu_item":"fadeInDown","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":false,"plugin":"waline"},"views":{"enable":false,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"cdnjs","router":"https://cdnjs.cloudflare.com/ajax/libs"},"version":"4.5.3"}</script><script type=text/javascript src=/js/main.min.37ba8b54f9d4d784d08028c45eea93b5d4e13eda8ee7fb0d2edd6f3fac66cfd2.js defer></script></body></html>