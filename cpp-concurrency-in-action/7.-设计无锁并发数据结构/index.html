<!doctype html><html lang=zh-CN data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.143.1"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="7. è®¾è®¡æ— é”å¹¶å‘æ•°æ®ç»“æ„"><meta itemprop=description content="ä¸ªäººåšå®¢ï¼Œä¸»è¦æ˜¯é›¶æ•£çš„ç¬”è®°ã€‚"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://hxhue.github.io/imgs/371907.jpg"><meta itemprop=keywords content="cpp,cpp-concurrency-in-action"><link type=text/css rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css><link rel=stylesheet href=/css/main.min.bea76f574a755574e17d42bea39502a74ca3ca4db65807b8c82d3e26dcec8420.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ æˆ‘å¯æ˜¯æœ‰åº•çº¿çš„å“Ÿ ~"}</style><link rel=stylesheet type=text/css href=/css/style.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/github-markdown-css@5.3.0/github-markdown-dark.css><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js></script><script>MathJax={tex:{displayMath:[["$$","$$"],["\\[","\\]"]],inlineMath:[["$","$"],["\\(","\\)"]]},svg:{fontCache:"global"}}</script><script type=module>
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: false });
  mermaid.mermaidAPI.initialize();
  window.mermaid = mermaid;
</script><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":false,"isPage":true,"path":"7.-%E8%AE%BE%E8%AE%A1%E6%97%A0%E9%94%81%E5%B9%B6%E5%8F%91%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84","permalink":"https://hxhue.github.io/cpp-concurrency-in-action/7.-%E8%AE%BE%E8%AE%A1%E6%97%A0%E9%94%81%E5%B9%B6%E5%8F%91%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/","title":"7. è®¾è®¡æ— é”å¹¶å‘æ•°æ®ç»“æ„","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>7. è®¾è®¡æ— é”å¹¶å‘æ•°æ®ç»“æ„ - Bluegill</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>Bluegill</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description></p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>é¦–é¡µ</a></li><li class="menu-item menu-item-about"><a href=/about/ class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>å…³äº</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>å½’æ¡£</a></li><li class="menu-item menu-item-categories"><a href=/categories/ class=hvr-icon-pulse rel=section><i class="fa fa-th hvr-icon"></i>åˆ†ç±»</a></li><li class="menu-item menu-item-tags"><a href=/tags/ class=hvr-icon-pulse rel=section><i class="fa fa-hashtag hvr-icon"></i>æ ‡ç­¾</a></li><li class="menu-item menu-item-daily"><a href=/daily/ class=hvr-icon-pulse rel=section><i class="fa fa-newspaper hvr-icon"></i>éšç¬”</a></li><li class="menu-item menu-item-discovery"><a href=https://rift-fear-f2c.notion.site/2025-1e354a33cfb1802c841bdf29f2f3dab3 class=hvr-icon-pulse rel=section><i class="fa fa-compass hvr-icon"></i>å‘ç°</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>æœç´¢</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=æœç´¢... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>æ–‡ç« ç›®å½•</li><li class=sidebar-nav-overview>ç«™ç‚¹æ¦‚è§ˆ</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#éé˜»å¡æ•°æ®ç»“æ„çš„åˆ†ç±»>éé˜»å¡æ•°æ®ç»“æ„çš„åˆ†ç±»</a></li><li><a href=#æ— é”çš„çº¿ç¨‹å®‰å…¨æ ˆ>æ— é”çš„çº¿ç¨‹å®‰å…¨æ ˆ</a><ul><li><a href=#push-å’Œ-pop-æ“ä½œ><code>push()</code> å’Œ <code>pop()</code> æ“ä½œ</a></li><li><a href=#è‡ªè¡Œå®ç°åƒåœ¾å›æ”¶>è‡ªè¡Œå®ç°åƒåœ¾å›æ”¶</a><ul><li><a href=#å›æ”¶é“¾è¡¨--pop-è®¿é—®è®¡æ•°>å›æ”¶é“¾è¡¨ + <code>pop()</code> è®¿é—®è®¡æ•°</a></li><li><a href=#hazard-pointers>Hazard pointers</a><ul><li><a href=#æ€è·¯>æ€è·¯</a></li><li><a href=#å®ç°>å®ç°</a></li></ul></li></ul></li><li><a href=#å¼•ç”¨è®¡æ•°>å¼•ç”¨è®¡æ•°</a><ul><li><a href=#stdshared_ptrt-ä¸Šçš„åŸå­æ“ä½œ><code>std::shared_ptr&lt;T></code> ä¸Šçš„åŸå­æ“ä½œ</a></li><li><a href=#åˆ†è£‚å¼•ç”¨è®¡æ•°>åˆ†è£‚å¼•ç”¨è®¡æ•°</a></li></ul></li><li><a href=#ä»¥åˆ†è£‚å¼•ç”¨è®¡æ•°ä¸ºä¾‹è€ƒè™‘å†…å­˜åºè¦æ±‚>ä»¥åˆ†è£‚å¼•ç”¨è®¡æ•°ä¸ºä¾‹ï¼Œè€ƒè™‘å†…å­˜åºè¦æ±‚</a></li><li><a href=#æ¯”è¾ƒè¿™å‡ ç§å¤„ç†å†…å­˜å®‰å…¨é—®é¢˜çš„æ–¹å¼>æ¯”è¾ƒè¿™å‡ ç§å¤„ç†å†…å­˜å®‰å…¨é—®é¢˜çš„æ–¹å¼</a></li></ul></li><li><a href=#æ— é”çš„çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—>æ— é”çš„çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—</a><ul><li><a href=#æ–°å¢-tail-ç»“ç‚¹>æ–°å¢ <code>tail</code> ç»“ç‚¹</a></li><li><a href=#å¤–éƒ¨è®¡æ•°å™¨çš„è®¡æ•°å™¨>å¤–éƒ¨è®¡æ•°å™¨çš„è®¡æ•°å™¨</a></li><li><a href=#pop><code>pop()</code></a></li><li><a href=#push><code>push()</code></a></li><li><a href=#é¿å…-push-ä¸­çš„å¿™ç­‰å¾…>é¿å… <code>push()</code> ä¸­çš„å¿™ç­‰å¾…</a></li></ul></li><li><a href=#aba-é—®é¢˜>ABA é—®é¢˜</a></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=ğŸ¤– src=/imgs/371907.jpg><p class=site-author-name itemprop=name>ğŸ¤–</p><div class=site-description itemprop=description>ä¸ªäººåšå®¢ï¼Œä¸»è¦æ˜¯é›¶æ•£çš„ç¬”è®°ã€‚</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>433</span>
<span class=site-state-item-name>æ—¥å¿—</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>12</span>
<span class=site-state-item-name>åˆ†ç±»</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>86</span>
<span class=site-state-item-name>æ ‡ç­¾</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/hxhue title="Github â†’ https://github.com/hxhue" rel=noopener target=_blank><i class="fab fa-github fa-fw"></i>
Github
</a></span><span class=links-of-social-item><a href=/rss.xml title="RSS è®¢é˜… â†’ /rss.xml" rel=noopener target=_blank><i class="fa fa-rss fa-fw"></i>
RSS è®¢é˜…</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=å…±äº«çŸ¥è¯†><img src=/imgs/cc/big/by_nc_sa.svg alt=å…±äº«çŸ¥è¯†></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
å‹æƒ…é“¾æ¥</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://shuai.guru/ title=https://shuai.guru/ target=_blank>shuai.guru</a></li></ul></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=toggle-theme class=button title=æ·±æµ…æ¨¡å¼åˆ‡æ¢><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=è¿”å›é¡¶éƒ¨><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://hxhue.github.io/cpp-concurrency-in-action/7.-%E8%AE%BE%E8%AE%A1%E6%97%A0%E9%94%81%E5%B9%B6%E5%8F%91%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/371907.jpg"><meta itemprop=name content="ğŸ¤–"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="ğŸ¤–"><meta itemprop=description content="ä¸ªäººåšå®¢ï¼Œä¸»è¦æ˜¯é›¶æ•£çš„ç¬”è®°ã€‚"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="7. è®¾è®¡æ— é”å¹¶å‘æ•°æ®ç»“æ„"><meta itemprop=description content="éé˜»å¡æ•°æ®ç»“æ„çš„åˆ†ç±»

ä¹¦ä¸Šç»™å‡ºäº†ä¸€ä¸ªç”¨ std::atomic_flag å®ç°è‡ªæ—‹é”çš„ä»£ç ç‰‡æ®µï¼š
class spinlock_mutex {
    std::atomic_flag flag;

public:
    spinlock_mutex() : flag(ATOMIC_FLAG_INIT) {}

    void lock() {
        while (flag.test_and_set(std::memory_order_acquire));
    }

    void unlock() {
        flag.clear(std::memory_order_release);
    }
};
è‡ªæ—‹é”æ˜¯ä¸€ä¸ª nonblocking çš„ä¾‹å­ï¼ˆä¹¦ä¸Šè®¤ä¸ºå®ƒæ²¡æœ‰ä»»ä½•é˜»å¡è°ƒç”¨ï¼Œå› æ­¤æ˜¯éé˜»å¡çš„ï¼‰ï¼Œä½†æ˜¯å´ä¸æ˜¯ lock-free çš„ã€‚"></span><header class=post-header><h1 class=post-title itemprop="name headline">7. è®¾è®¡æ— é”å¹¶å‘æ•°æ®ç»“æ„</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=å‘è¡¨äº>å‘è¡¨äºï¼š
</span><time title="åˆ›å»ºæ—¶é—´ï¼š2025-01-02 00:00:00 +0800 CST" itemprop="dateCreated datePublished" datetime="2025-01-02 00:00:00 +0800 CST">2025-01-02
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar-check"></i>
</span><span class=post-meta-item-text title=æ›´æ–°äº>æ›´æ–°äºï¼š
</span><time title=ä¿®æ”¹æ—¶é—´ï¼š2025-03-10T00:00:00+08:00 itemprop=dateModified datetime=2025-03-10T00:00:00+08:00>2025-03-10</time>
</span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i>
</span><span class=post-meta-item-text title=åˆ†ç±»äº>åˆ†ç±»äºï¼š
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/cpp-concurrency-in-action itemprop=url rel=index><span itemprop=name>cpp-concurrency-in-action</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=å­—æ•°><span class=post-meta-item-icon><i class="far fa-file-word"></i>
</span><span class=post-meta-item-text>å­—æ•°ï¼š</span>
<span>9372</span>
</span><span class=post-meta-item title=é˜…è¯»><span class=post-meta-item-icon><i class="far fa-clock"></i>
</span><span class=post-meta-item-text>é˜…è¯»ï¼š&ap;</span>
<span>19åˆ†é’Ÿ</span></span></div></div></header><div class=post-body itemprop=articleBody><h1 id=éé˜»å¡æ•°æ®ç»“æ„çš„åˆ†ç±»>éé˜»å¡æ•°æ®ç»“æ„çš„åˆ†ç±»
<a class=header-anchor href=#%e9%9d%9e%e9%98%bb%e5%a1%9e%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%e7%9a%84%e5%88%86%e7%b1%bb></a></h1><p>ä¹¦ä¸Šç»™å‡ºäº†ä¸€ä¸ªç”¨ <code>std::atomic_flag</code> å®ç°è‡ªæ—‹é”çš„ä»£ç ç‰‡æ®µï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#719e07>class</span> <span style=color:#268bd2>spinlock_mutex</span> {
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span>atomic_flag flag;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#719e07>public</span><span style=color:#719e07>:</span>
</span></span><span style=display:flex><span>    spinlock_mutex() <span style=color:#719e07>:</span> flag(ATOMIC_FLAG_INIT) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>void</span> <span style=color:#268bd2>lock</span>() {
</span></span><span style=display:flex><span>        <span style=color:#719e07>while</span> (flag.test_and_set(std<span style=color:#719e07>::</span>memory_order_acquire));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>void</span> <span style=color:#268bd2>unlock</span>() {
</span></span><span style=display:flex><span>        flag.clear(std<span style=color:#719e07>::</span>memory_order_release);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>è‡ªæ—‹é”æ˜¯ä¸€ä¸ª nonblocking çš„ä¾‹å­ï¼ˆä¹¦ä¸Šè®¤ä¸ºå®ƒæ²¡æœ‰ä»»ä½•é˜»å¡è°ƒç”¨ï¼Œå› æ­¤æ˜¯éé˜»å¡çš„ï¼‰ï¼Œä½†æ˜¯å´ä¸æ˜¯ lock-free çš„ã€‚</p><p>ä¹¦ä¸Šç»™å‡ºäº†ä¸‹é¢å‡ ç±»æ•°æ®ç»“æ„ï¼š</p><ol><li>Obstruction-freeï¼šå¦‚æœå…¶ä»–çº¿ç¨‹éƒ½è¢«æš‚åœäº†ï¼Œé‚£ä¹ˆä»»ä½•ä¸€ä¸ªé€‰å®šçš„çº¿ç¨‹éƒ½èƒ½åœ¨ä¸€å®šæ­¥æ•°å†…å®Œæˆæ“ä½œã€‚</li><li>Lock-freeï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶åœ¨è¿›è¡Œæ“ä½œï¼Œæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½åœ¨ä¸€å®šæ­¥æ•°å†…å®Œæˆæ“ä½œã€‚å¸¸è§çš„èŒƒå¼æ˜¯åœ¨å¾ªç¯ä¸­è¿›è¡Œ CASã€‚<strong>å¯èƒ½æœ‰é¥¥é¥¿å‘ç”Ÿ</strong>ã€‚</li><li>Wait-freeï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶åœ¨è¿›è¡Œæ“ä½œï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½èƒ½åœ¨ä¸€å®šæ­¥æ•°å†…å®Œæˆæ“ä½œã€‚</li></ol><p><a href=https://en.wikipedia.org/wiki/Non-blocking_algorithm title=https://en.wikipedia.org/wiki/Non-blocking_algorithm rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://en.wikipedia.org/wiki/Non-blocking_algorithm<i class="fa fa-external-link-alt"></i></a> ç»™å‡ºäº†æ›´ç²¾ç‚¼çš„æè¿°ï¼š</p><blockquote><p>A non-blocking algorithm isÂ <strong>lock-free</strong>Â if there is guaranteed system-wideÂ <a href=https://en.wikipedia.org/wiki/Resource_starvation title=progress rel="noopener external nofollow noreferrer" target=_blank class=exturl>progress<i class="fa fa-external-link-alt"></i></a>, andÂ <strong>wait-free</strong>Â if there is also guaranteed per-thread progress.</p></blockquote><p>æ ¹æ®ä»¥ä¸Šä¿¡æ¯ï¼Œ<strong>ç”¨æˆ·ç©ºé—´ä¸‹çš„</strong>è‡ªæ—‹é”ä¹Ÿä¸æ˜¯ obstruction-free çš„ã€‚2025 å¹´ 2 æœˆ 7 æ—¥ï¼š<strong>å¦‚æœæ²¡æœ‰ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå—è‡ªæ—‹é”ä¿æŠ¤çš„æ“ä½œåˆèƒ½åœ¨æœ‰ä¸Šç•Œçš„æ—¶é—´å†…å®Œæˆï¼Œé‚£ä¹ˆè‡ªæ—‹é”å½“ç„¶æ˜¯ lock-free çš„ï¼ˆæ¯”å¦‚åœ¨å†…æ ¸ä¸­</strong>ï¼‰ã€‚</p><p>ç”±äº obstruction-free çš„åº”ç”¨åœºæ™¯æœ‰é™ï¼Œè€Œ wait-free çš„ç®—æ³•ç›¸å½“éš¾å†™ï¼Œæ‰€ä»¥ lock-free çš„ç®—æ³•æ¯”è¾ƒå¸¸è§ã€‚Lock-free çš„ç®—æ³•ä¸ä»…æœ‰å¹¶å‘ä¼˜åŠ¿ï¼Œè€Œä¸”æ›´é²æ£’ï¼Œä¸ä¼šå‡ºç°æŒæœ‰é”çš„çº¿ç¨‹å¼‚å¸¸ç»ˆæ­¢ï¼Œå¯¼è‡´å…¶ä»–çº¿ç¨‹æ— æ³•ç»§ç»­å‰è¿›çš„æƒ…å†µã€‚Lock-free ç®—æ³•å¯èƒ½ä¼šå‡ºç°æ´»é”ï¼ˆlive lockï¼‰ï¼Œä½†æ˜¯è¿™ä¸ªè¿‡ç¨‹æ˜¯ç›¸å¯¹æ¥è¯´æ¯”è¾ƒçŸ­æš‚çš„ã€‚æ ¹æ®ç™¾åº¦ç™¾ç§‘ï¼Œæ´»é”å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ç§ç‰¹æ®Šçš„é¥¥é¥¿ã€‚</p><h1 id=æ— é”çš„çº¿ç¨‹å®‰å…¨æ ˆ>æ— é”çš„çº¿ç¨‹å®‰å…¨æ ˆ
<a class=header-anchor href=#%e6%97%a0%e9%94%81%e7%9a%84%e7%ba%bf%e7%a8%8b%e5%ae%89%e5%85%a8%e6%a0%88></a></h1><h2 id=push-å’Œ-pop-æ“ä½œ><code>push()</code> å’Œ <code>pop()</code> æ“ä½œ
<a class=header-anchor href=#push-%e5%92%8c-pop-%e6%93%8d%e4%bd%9c></a></h2><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#719e07>template</span><span style=color:#719e07>&lt;</span><span style=color:#719e07>typename</span> T<span style=color:#719e07>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#719e07>class</span> <span style=color:#268bd2>lock_free_stack</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#719e07>private</span><span style=color:#719e07>:</span>
</span></span><span style=display:flex><span>    <span style=color:#719e07>struct</span> <span style=color:#268bd2>node</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        std<span style=color:#719e07>::</span>shared_ptr<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> data;
</span></span><span style=display:flex><span>        node<span style=color:#719e07>*</span> next;
</span></span><span style=display:flex><span>        node(T <span style=color:#719e07>const</span><span style=color:#719e07>&amp;</span> data_)<span style=color:#719e07>:</span>
</span></span><span style=display:flex><span>            data(std<span style=color:#719e07>::</span>make_shared<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span>(data_))
</span></span><span style=display:flex><span>        {}
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span>atomic<span style=color:#719e07>&lt;</span>node<span style=color:#719e07>*&gt;</span> head;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#719e07>public</span><span style=color:#719e07>:</span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>void</span> push(T <span style=color:#719e07>const</span><span style=color:#719e07>&amp;</span> data)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        node<span style=color:#719e07>*</span> <span style=color:#719e07>const</span> new_node <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> node(data);
</span></span><span style=display:flex><span>        new_node<span style=color:#719e07>-&gt;</span>next <span style=color:#719e07>=</span> head.load();
</span></span><span style=display:flex><span>        <span style=color:#719e07>while</span> (<span style=color:#719e07>!</span>head.compare_exchange_weak(new_node<span style=color:#719e07>-&gt;</span>next, new_node));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span>shared_ptr<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> pop()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        node<span style=color:#719e07>*</span> old_head <span style=color:#719e07>=</span> head.load();
</span></span><span style=display:flex><span>        <span style=color:#719e07>while</span> (old_head <span style=color:#719e07>&amp;&amp;</span> <span style=color:#719e07>!</span>head.compare_exchange_weak(old_head, old_head<span style=color:#719e07>-&gt;</span>next));
</span></span><span style=display:flex><span>        <span style=color:#586e75>// è¿™é‡Œ old_head-&gt;data å…¶å®å¯ä»¥åŠ ä¸Š std::move
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>        <span style=color:#719e07>return</span> old_head <span style=color:#719e07>?</span> old_head<span style=color:#719e07>-&gt;</span>data : std<span style=color:#719e07>::</span>shared_ptr<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p><code>data</code> é€‰æ‹©ç”¨ <code>std::shared_ptr&lt;T></code> æ¥å­˜å‚¨è€Œä¸æ˜¯ <code>T</code> ç±»å‹ï¼Œæ˜¯å› ä¸ºå¦‚æœ <code>pop()</code> çš„æ¥å£ä¸º <code>pop(T &)</code>ï¼Œé‚£ä¹ˆåœ¨å–ä¸‹ç»“ç‚¹ï¼Œæœ€åä¸€æ­¥èµ‹å€¼çš„æ—¶å€™å¦‚æœæŠ›å‡ºå¼‚å¸¸ï¼Œé‚£ä¹ˆæ•°æ®ç»“æ„æ— æ³•æ¢å¤ï¼ˆå› ä¸ºç»“ç‚¹å·²ç»å–ä¸‹æ¥äº†ï¼‰ã€‚æ­£å› æ­¤ <code>pop()</code> çš„æ¥å£è¢«è®¾è®¡ä¸ºæ— å‚ä½†è¿”å› <code>std::shared_ptr&lt;T></code>ã€‚</p><p><code>push()</code> æ“ä½œï¼š</p><ol><li>Create a new node.</li><li>Set its <code>next</code> pointer to the current <code>head</code> node.</li><li>Set the <code>head</code> node to point to it.</li></ol><p>ç¬¬ 2 æ­¥å’Œç¬¬ 3 æ­¥åˆšå¥½å¯ä»¥ç”¨ä¸€ä¸ª CAS å®Œæˆã€‚å¦‚æœå¤±è´¥çš„è¯ CAS ä¼šå°†æœ€æ–°çš„ <code>head</code> å€¼åŠ è½½åˆ°ç»™å®šçš„ <code>expected</code> å‚æ•°ä¸­ï¼Œæ‰€ä»¥ <code>while</code> å¾ªç¯çš„å¾ªç¯ä½“ä¸éœ€è¦æ¸…ç†ä»£ç ã€‚</p><p><code>pop()</code> æ“ä½œï¼š</p><ol><li>Read the current value of head.</li><li>Read <code>head->next</code>.</li><li>Set <code>head</code> to <code>head->next</code>.</li><li>Return the data from the retrieved node.</li><li>Delete the retrieved node.</li></ol><p>ç¬¬ 5 æ­¥çš„é—®é¢˜æ¯”è¾ƒå¤§ï¼Œå‡è®¾çº¿ç¨‹ A å’Œ B éƒ½åœ¨æ‰§è¡Œ <code>pop()</code> æ“ä½œï¼Œçº¿ç¨‹ A åˆšåˆ é™¤å®Œæ—§ <code>head</code>ï¼Œä½†çº¿ç¨‹ B æ°å¥½è¿›è¡Œåˆ°äº†ç¬¬ 2 æ­¥ï¼Œå·²ç»è¯»åˆ°äº†æ—§ <code>head</code>ï¼Œæ­£è¦å»è¯»è¿™ä¸ªè¢«åˆ é™¤çš„ <code>head</code> ç»“ç‚¹çš„ <code>next</code> å­—æ®µï¼Œè¿™å°±ä¼šå¯¼è‡´å†…å­˜éæ³•è®¿é—®ã€‚<strong>ä¸Šé¢ç»™å‡ºçš„ä»£ç æ˜¯ç”¨å†…å­˜æ³„æ¼æ¥è§„é¿å†…å­˜éæ³•è®¿é—®</strong>ã€‚<code>push()</code> æ“ä½œä¸ä¼šå½±å“ <code>pop()</code> çš„å®‰å…¨æ€§ï¼Œå› ä¸º <code>push()</code> æ“ä½œåªä¼šè¯» <code>head</code> çš„åœ°å€ï¼Œä¸ä¼šè¯» <code>head</code> é‡Œé¢çš„å†…å®¹ã€‚</p><blockquote><p>å¦‚æœæ˜¯åƒåœ¾å›æ”¶è¯­è¨€ï¼Œè¿™é‡Œå°±å·²ç»æŠŠä»£ç å†™å®Œäº†ã€‚</p></blockquote><h2 id=è‡ªè¡Œå®ç°åƒåœ¾å›æ”¶>è‡ªè¡Œå®ç°åƒåœ¾å›æ”¶
<a class=header-anchor href=#%e8%87%aa%e8%a1%8c%e5%ae%9e%e7%8e%b0%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6></a></h2><h3 id=å›æ”¶é“¾è¡¨--pop-è®¿é—®è®¡æ•°>å›æ”¶é“¾è¡¨ + <code>pop()</code> è®¿é—®è®¡æ•°
<a class=header-anchor href=#%e5%9b%9e%e6%94%b6%e9%93%be%e8%a1%a8--pop-%e8%ae%bf%e9%97%ae%e8%ae%a1%e6%95%b0></a></h3><p>ä¸Šä¸€å°èŠ‚ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>push()</code> æ“ä½œæ²¡æœ‰é—®é¢˜ï¼Œ<code>pop()</code> æ“ä½œæœ‰å†…å­˜æ³„æ¼çš„é—®é¢˜ã€‚<code>pop()</code> æ“ä½œå†…å­˜æ³„æ¼æ˜¯å› ä¸ºæˆ‘ä»¬æ— æ³•å®‰å…¨åˆ é™¤å½“å‰çš„ç»“ç‚¹ã€‚<strong>æˆ‘ä»¬å¯ä»¥æŠŠå½“å‰çš„ç»“ç‚¹æš‚æ—¶åŠ å…¥åˆ°å¦å¤–ä¸€ä¸ªï¼ˆå›æ”¶ï¼‰é“¾è¡¨ä¸­ä»¥é˜²æ­¢å†…å­˜æ³„æ¼</strong>ï¼Œè¿™ä¸ªå›æ”¶é“¾è¡¨å’Œå·¥ä½œé“¾è¡¨çš„ç»“æ„ç›¸åŒï¼Œéƒ½æ˜¯ <code>std::atomic&lt;node *></code>ï¼Œå› ä¸ºç”¨çš„æ˜¯ <code>push()</code> æ“ä½œï¼Œæ‰€ä»¥ä¹Ÿæ²¡æœ‰é—®é¢˜ã€‚</p><p>äº‹å®ä¸Šï¼Œ<code>push()</code> æ“ä½œå¯¹äºä¸€æ®µé“¾è¡¨ï¼ˆä¸ä»…ä»…æ˜¯å•ä¸ªç»“ç‚¹ï¼‰ä¹Ÿæ˜¯å®‰å…¨çš„ï¼Œä¹¦ä¸Šå®ç°äº†è¿™æ ·çš„å‡½æ•°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#586e75>// first -&gt; ... -&gt; last -&gt; nullptr
</span></span></span><span style=display:flex><span><span style=color:#586e75></span><span style=color:#dc322f>void</span> <span style=color:#268bd2>chain_pending_nodes</span>(node<span style=color:#719e07>*</span> first, node<span style=color:#719e07>*</span> last) {
</span></span><span style=display:flex><span>    last<span style=color:#719e07>-&gt;</span>next <span style=color:#719e07>=</span> to_be_deleted;
</span></span><span style=display:flex><span>    <span style=color:#719e07>while</span> (<span style=color:#719e07>!</span>to_be_deleted.compare_exchange_weak(last<span style=color:#719e07>-&gt;</span>next, first));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#586e75>// å·¥å…·å‡½æ•°ï¼Œæ‰¾åˆ°é“¾è¡¨çš„å°¾ç»“ç‚¹å¹¶è°ƒç”¨å‰ä¸€ä¸ªé‡è½½
</span></span></span><span style=display:flex><span><span style=color:#586e75></span><span style=color:#dc322f>void</span> <span style=color:#268bd2>chain_pending_nodes</span>(node<span style=color:#719e07>*</span> nodes) {
</span></span><span style=display:flex><span>    node<span style=color:#719e07>*</span> last <span style=color:#719e07>=</span> nodes;
</span></span><span style=display:flex><span>    <span style=color:#719e07>while</span> (node<span style=color:#719e07>*</span> <span style=color:#719e07>const</span> next <span style=color:#719e07>=</span> last<span style=color:#719e07>-&gt;</span>next) {
</span></span><span style=display:flex><span>        last <span style=color:#719e07>=</span> next;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    chain_pending_nodes(nodes, last);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>åœ¨æœ‰äº†å›æ”¶é“¾è¡¨ä¸­çš„é€»è¾‘åï¼Œ<code>pop()</code> å˜æˆï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span>std<span style=color:#719e07>::</span>shared_ptr<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> pop()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    node<span style=color:#719e07>*</span> old_head <span style=color:#719e07>=</span> head.load();
</span></span><span style=display:flex><span>    <span style=color:#719e07>while</span> (old_head <span style=color:#719e07>&amp;&amp;</span> <span style=color:#719e07>!</span>head.compare_exchange_weak(old_head, old_head<span style=color:#719e07>-&gt;</span>next));
</span></span><span style=display:flex><span>    <span style=color:#719e07>auto</span> ret <span style=color:#719e07>=</span> old_head <span style=color:#719e07>?</span> std<span style=color:#719e07>::</span>move(old_head<span style=color:#719e07>-&gt;</span>data) <span style=color:#719e07>:</span> std<span style=color:#719e07>::</span>shared_ptr<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span>();
</span></span><span style=display:flex><span>    try_reclaim(old_head); <span style=color:#586e75>// å°è¯•å›æ”¶
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#719e07>return</span> ret;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å…¶ä¸­ <code>try_reclaim()</code> å°è¯•å¯¹ <code>old_head</code> è¿›è¡Œæ¸…ç†ï¼Œå¦‚æœä¸èƒ½å®‰å…¨æ¸…ç†ï¼Œåˆ™å°†å…¶æš‚æ—¶æ”¾åˆ°å›æ”¶é“¾è¡¨ä¸­ã€‚</p><p>ä»€ä¹ˆæ—¶å€™æ‰èƒ½å¯¹å›æ”¶é“¾è¡¨è¿›è¡Œæ¸…ç†å‘¢ï¼Ÿä¸ºäº†ç¡®è®¤ä»€ä¹ˆæ—¶å€™æˆ‘ä»¬èƒ½å®‰å…¨æ¸…ç†å›æ”¶é“¾è¡¨ä¸­çš„ç»“ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦å¢åŠ ä¸€ä¸ªè®¡æ•°å˜é‡ <code>threads_in_pop</code>ï¼Œç±»å‹æ˜¯ <code>std::atomic&lt;unsigned></code>ï¼Œç”¨æ¥è¿½è¸ªåœ¨ <code>pop()</code> å‡½æ•°ä¸­çš„çº¿ç¨‹æ•°ã€‚è¯¥å˜é‡åœ¨ <code>pop()</code> è¿›å…¥æ—¶è®¡æ•° +1ï¼Œé€€å‡ºæ—¶è®¡æ•° -1ï¼Œ<strong>è®¡æ•°å‡å°‘çš„é€»è¾‘åº”è¯¥æ”¾åœ¨ <code>try_reclaim</code> ä¸­åš</strong>ã€‚ç°åœ¨ <code>pop()</code> å˜æˆï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span>std<span style=color:#719e07>::</span>shared_ptr<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> pop()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#719e07>++</span>threads_in_pop;
</span></span><span style=display:flex><span>    node<span style=color:#719e07>*</span> old_head <span style=color:#719e07>=</span> head.load();
</span></span><span style=display:flex><span>    <span style=color:#719e07>while</span> (old_head <span style=color:#719e07>&amp;&amp;</span> <span style=color:#719e07>!</span>head.compare_exchange_weak(old_head, old_head<span style=color:#719e07>-&gt;</span>next));
</span></span><span style=display:flex><span>    <span style=color:#719e07>auto</span> ret <span style=color:#719e07>=</span> old_head <span style=color:#719e07>?</span> std<span style=color:#719e07>::</span>move(old_head<span style=color:#719e07>-&gt;</span>data) <span style=color:#719e07>:</span> std<span style=color:#719e07>::</span>shared_ptr<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span>();
</span></span><span style=display:flex><span>    try_reclaim(old_head); <span style=color:#586e75>// å°è¯•å›æ”¶ï¼Œ--threads_in_pop åœ¨è¿™é‡Œé¢åš
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#719e07>return</span> ret;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æ€ä¹ˆå®ç° <code>try_reclaim()</code> å‘¢ï¼Ÿå…ˆæ£€æŸ¥è®¡æ•°çš„å½“å‰å€¼ï¼Œå¦‚æœè®¡æ•°ä¸º 1ï¼Œè¯´æ˜å½“å‰åªæœ‰æœ¬çº¿ç¨‹åœ¨ <code>pop()</code> ä¸­ï¼Œåˆšå–ä¸‹æ¥çš„ç»“ç‚¹å¯ä»¥ç›´æ¥åˆ é™¤ï¼Œå¹¶ä¸”å¯ä»¥è€ƒè™‘çœ‹çœ‹å›æ”¶é“¾è¡¨ä¸­çš„å…¶ä»–ç»“ç‚¹æ˜¯ä¸æ˜¯å¯ä»¥å®‰å…¨åˆ é™¤çš„ã€‚å¦åˆ™ï¼Œå½“å‰ç»“ç‚¹ä¸èƒ½å®‰å…¨åˆ é™¤ï¼Œå°†å…¶æ”¾åˆ°å›æ”¶é“¾è¡¨ä¸­å»ã€‚</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#dc322f>void</span> <span style=color:#268bd2>try_reclaim</span>(node<span style=color:#719e07>*</span> old_head) {
</span></span><span style=display:flex><span>    <span style=color:#719e07>if</span> (threads_in_pop <span style=color:#719e07>==</span> <span style=color:#2aa198>1</span>) {
</span></span><span style=display:flex><span>        node<span style=color:#719e07>*</span> nodes_to_delete <span style=color:#719e07>=</span> to_be_deleted.exchange(<span style=color:#719e07>nullptr</span>);
</span></span><span style=display:flex><span>        <span style=color:#719e07>if</span> (<span style=color:#719e07>!--</span>threads_in_pop) {
</span></span><span style=display:flex><span>            <span style=color:#586e75>// è¿™é‡Œå¯ä»¥å®‰å…¨æ¸…ç†ç»“ç‚¹ï¼š
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>            <span style=color:#586e75>// è®¡æ•°å½’é›¶è¦ä¹ˆæ˜¯å…¶ä»–çº¿ç¨‹æ²¡æ¥è¿‡ï¼Œè¦ä¹ˆæ¥äº†åˆèµ°äº†ã€‚
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>            <span style=color:#586e75>// æ— è®ºå¦‚ä½•ï¼Œåªè¦å½“å‰åœ¨ pop() ä¸­çš„çº¿ç¨‹åªæœ‰æœ¬çº¿ç¨‹ï¼Œåˆ™è¯´æ˜å¯ä»¥å®‰å…¨å›æ”¶ã€‚
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>            <span style=color:#586e75>// è¿™é‡Œçš„æƒ…å½¢å’ŒåŒé‡æ ¡éªŒé”æœ‰ç‚¹ç›¸ä¼¼ï¼Œéœ€è¦æ£€æŸ¥ä¸¤æ¬¡ï¼
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>            <span style=color:#586e75>// delete_nodes å®ç°å¾ˆç®€å•ï¼Œå°±æ˜¯å¯¹ï¼ˆå¯èƒ½ä¸ºç©ºçš„ï¼‰é“¾è¡¨ä¸€ç›´åˆ åˆ°åº•ã€‚
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>            delete_nodes(nodes_to_delete);
</span></span><span style=display:flex><span>        } <span style=color:#719e07>else</span> <span style=color:#719e07>if</span> (nodes_to_delete) {
</span></span><span style=display:flex><span>            <span style=color:#586e75>// è¿™é‡Œæ¸…ç†ç»“ç‚¹ä¸å®‰å…¨ï¼Œéœ€è¦å°†ç»“ç‚¹æ”¾å›å»ï¼š
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>            <span style=color:#586e75>// threads_in_pop å‡å°‘åä»ä¸ä¸º 0ï¼Œè¿™è¯´æ˜æœ‰æ–°çš„çº¿ç¨‹è¿› pop() äº†ã€‚
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>            <span style=color:#586e75>// å…¶ä»–çº¿ç¨‹å¯èƒ½åœ¨ if åˆ¤æ–­ç»“æŸåã€exchange ä¹‹å‰æŠŠæ–°ç»“ç‚¹åŠ å…¥åˆ°äº†å›æ”¶é“¾è¡¨ä¸­ï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>            <span style=color:#586e75>// è¿™äº›ç»“ç‚¹å¯èƒ½è¿˜ä¼šè¢«å…¶ä»–çº¿ç¨‹è®¿é—®ï¼Œå› æ­¤åˆ é™¤ä¸å®‰å…¨ã€‚
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>            chain_pending_nodes(nodes_to_delete);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#586e75>// threads_in_pop == 1 æˆç«‹ï¼Œè¡¨æ˜å½“å‰ç»“ç‚¹å¯ä»¥å®‰å…¨åˆ é™¤ã€‚
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>        <span style=color:#586e75>// delete è¯­å¥æ”¾åˆ° if çš„ä¸‹ä¸€è¡Œä¼šæ›´å¥½ç†è§£ï¼Œä½† delete æ¯”è¾ƒè€—æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½æŠ“ä½
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>        <span style=color:#586e75>// threads_in_pop == 1 è¿™ä¸ªæ¡ä»¶è¿˜æˆç«‹çš„æœºä¼šï¼Œæ‰€ä»¥æŠŠ delete æ”¾åœ¨äº†æœ€åã€‚
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>        <span style=color:#719e07>delete</span> old_head; 
</span></span><span style=display:flex><span>    } <span style=color:#719e07>else</span> {
</span></span><span style=display:flex><span>        chain_pending_node(old_head); <span style=color:#586e75>// ä¸èƒ½å®‰å…¨åˆ é™¤ï¼Œæ”¾åˆ°å›æ”¶é“¾è¡¨ä¸­ã€‚
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>        <span style=color:#719e07>--</span>threads_in_pop;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿™æ ·è¿˜æ˜¯æœ‰ç‚¹é—®é¢˜ï¼š<strong>å¦‚æœæ€»æ˜¯æœ‰ä¸¤ä¸ªåŠä»¥ä¸Šçš„çº¿ç¨‹æ‰§è¡Œ <code>pop()</code> æ“ä½œï¼Œé‚£ä¹ˆä¸ä¼šæœ‰ç»“ç‚¹è¢«å›æ”¶</strong>ï¼</p><h3 id=hazard-pointers>Hazard pointers
<a class=header-anchor href=#hazard-pointers></a></h3><h4 id=æ€è·¯>æ€è·¯
<a class=header-anchor href=#%e6%80%9d%e8%b7%af></a></h4><p>åªç”¨ä¸€ä¸ª <code>pop()</code> è®¿é—®è®¡æ•°çš„é—®é¢˜æ˜¯ä¿¡æ¯å¤ªå°‘ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æ²¡æœ‰è¶³å¤Ÿçš„ä¿¡æ¯æ¥ç¡®å®šæ˜¯å¦å¯ä»¥å¯¹å›æ”¶é“¾è¡¨å®‰å…¨å›æ”¶ã€‚Hazard pointers çš„æ€è·¯æ˜¯ï¼šæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªåŸå­å˜é‡æ¥è¡¨ç¤ºå½“å‰æ­£åœ¨è®¿é—®çš„æŒ‡é’ˆï¼Œè€Œä¸”è¿™ä¸ªæŒ‡é’ˆæ˜¯å¯¹å…¨å±€å¯è§çš„ï¼Œ<strong>ä¸€ç§å®ç°æ–¹æ¡ˆæ˜¯æœ‰ä¸€ä¸ªæŒ‡é’ˆåŸå­å˜é‡çš„å…¨å±€æ•°ç»„ï¼Œè€Œæ¯ä¸ªçº¿ç¨‹çš„åŸå­å˜é‡æ˜¯å…¶ä¸­çš„ä¸€ä¸ªå…ƒç´ </strong>ã€‚å¦‚æœæŸä¸ªçº¿ç¨‹åœ¨ä½¿ç”¨å®Œä¸€ä¸ªç»“ç‚¹ï¼Œå°è¯•åˆ é™¤ä¹‹å‰ï¼Œå‘ç°å…¶ä»–çº¿ç¨‹éƒ½æ²¡æœ‰æ­£åœ¨è®¿é—®è¦åˆ é™¤çš„è¿™ä¸ªæŒ‡é’ˆï¼Œåˆ™è¯´æ˜è¿™ä¸ªæŒ‡é’ˆæ˜¯å¯ä»¥åˆ é™¤çš„ï¼Œå¦åˆ™å°†å…¶ <code>push()</code> åˆ°å›æ”¶é“¾è¡¨ã€‚é™¤äº†æ£€æŸ¥å½“å‰æŒ‡é’ˆä¹‹å¤–ï¼Œåœ¨ <code>pop()</code> é€€å‡ºä¹‹å‰è¿˜è¦æ£€æŸ¥å›æ”¶é“¾è¡¨çš„æ¯ä¸ªç»“ç‚¹æ˜¯å¦å¯ä»¥åˆ é™¤ï¼Œé€»è¾‘å’Œæ£€æŸ¥å½“å‰ç»“ç‚¹æ˜¯ä¸€æ ·çš„ã€‚å› æ­¤ï¼Œ<code>pop()</code> åœ¨æ¸…ç†é˜¶æ®µçš„æ—¶é—´å¤æ‚åº¦ä¸º $O(æœ€å¤§å·¥ä½œçº¿ç¨‹æ•° \times å›æ”¶é“¾è¡¨é•¿åº¦)$ã€‚ç”±äº $å›æ”¶é“¾è¡¨é•¿åº¦ \ge æœ€å¤§å·¥ä½œçº¿ç¨‹æ•°$ æ—¶ä¸€å®šæœ‰ç»“ç‚¹å¯ä»¥å›æ”¶ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶é—´å¤æ‚åº¦å¯ä»¥æ”¹å†™ä¸º $O(æœ€å¤§å·¥ä½œçº¿ç¨‹æ•°^2)$ã€‚</p><p>ä¸ºäº†è®©æ¯æ¬¡æœç´¢å…¨å±€é“¾è¡¨éƒ½èƒ½æ‰¾åˆ°å¯ä»¥å›æ”¶çš„ç»“ç‚¹ï¼Œå¯ä»¥ä»…åœ¨ $å›æ”¶é“¾è¡¨é•¿åº¦ \ge æœ€å¤§å·¥ä½œçº¿ç¨‹æ•° \times 2$ æ—¶è¿›è¡Œå›æ”¶ï¼Œè¿™æ ·è‡³å°‘å¯ä»¥å›æ”¶ä¸€åŠçš„ç»“ç‚¹ï¼Œè¿™æ˜¯ä¸€ç§ç©ºé—´æ¢æ—¶é—´çš„æ€è·¯ã€‚åœ¨è¿™ç§ä¼˜åŒ–ä¸‹ï¼Œæ¯æ¬¡å†…å­˜å›æ”¶çš„å¤æ‚åº¦ä¾ç„¶ä¸ä¼šæ”¹å˜ã€‚ä¸ºäº†å›æ”¶å’Œæœ€å¤§å·¥ä½œçº¿ç¨‹æ•°ç­‰é‡çš„ç»“ç‚¹ï¼Œéœ€è¦æ‰«æçš„å¤æ‚åº¦ä¸º $O(æœ€å¤§å·¥ä½œçº¿ç¨‹æ•°^2)$ï¼Œé‚£ä¹ˆæ¯æ¬¡ <code>pop()</code> çš„å‡æ‘Šå¤æ‚åº¦ä¸º $O(æœ€å¤§å·¥ä½œçº¿ç¨‹æ•°)$ã€‚</p><p>å…¨å±€å›æ”¶é“¾è¡¨ä¸Šçš„è®¿é—®æ˜¯åŸå­çš„ï¼Œå› è€Œå¼€é”€æ¯”è¾ƒå¤§ã€‚å¯ä»¥å¯¹æ¯ä¸ªå·¥ä½œçº¿ç¨‹å‡†å¤‡ä¸€ä¸ª <code>thread_local</code> å›æ”¶é“¾è¡¨ã€‚å·¥ä½œçº¿ç¨‹åªè´Ÿè´£å›æ”¶æœ¬åœ°é“¾è¡¨ä¸­çš„ç»“ç‚¹ã€‚å¦‚æœçº¿ç¨‹å³å°†é€€å‡ºï¼Œé‚£ä¹ˆæœ¬åœ°é“¾è¡¨åº”è¯¥åˆå¹¶åˆ°å…¨å±€é“¾è¡¨ä¸­å»ï¼Œè¿™ä¸€ç‚¹å¯ä»¥ç”± RAII ä¿è¯ã€‚å¯¹åº”åœ°ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹å‘ç°å…¨å±€é“¾è¡¨éç©ºï¼Œä¹Ÿè¦å°†å…¨å±€é“¾è¡¨å¹¶å…¥æœ¬åœ°é“¾è¡¨ã€‚</p><h4 id=å®ç°>å®ç°
<a class=header-anchor href=#%e5%ae%9e%e7%8e%b0></a></h4><p><code>pop()</code> å‡½æ•°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span>std<span style=color:#719e07>::</span>shared_ptr<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> pop()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span>atomic<span style=color:#719e07>&lt;</span><span style=color:#dc322f>void</span><span style=color:#719e07>*&gt;&amp;</span> hp <span style=color:#719e07>=</span> get_hazard_pointer_for_current_thread();
</span></span><span style=display:flex><span>    node<span style=color:#719e07>*</span> old_head <span style=color:#719e07>=</span> head.load();
</span></span><span style=display:flex><span>    <span style=color:#719e07>do</span> {
</span></span><span style=display:flex><span>        node<span style=color:#719e07>*</span> temp;
</span></span><span style=display:flex><span>        <span style=color:#719e07>do</span> {
</span></span><span style=display:flex><span>            temp <span style=color:#719e07>=</span> old_head;
</span></span><span style=display:flex><span>            hp.store(old_head);
</span></span><span style=display:flex><span>            old_head <span style=color:#719e07>=</span> head.load();
</span></span><span style=display:flex><span>        } <span style=color:#719e07>while</span> (old_head <span style=color:#719e07>!=</span> temp);
</span></span><span style=display:flex><span>        <span style=color:#586e75>// 1. å†…å¤–åŒå¾ªç¯çš„å¿…è¦æ€§ï¼š
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>        <span style=color:#586e75>// å¤–å¾ªç¯çš„ while è¯­å¥è¦è®¿é—® old_head-&gt;nextï¼Œå› æ­¤ old_head å¿…é¡»æ˜¯æœ‰æ•ˆæŒ‡é’ˆã€‚
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>        <span style=color:#586e75>// å†…å¾ªç¯çš„ while åˆ¤æ–­ old_head != temp æ˜¯ä¸ºäº†ä¿è¯å­˜å‚¨ hp çš„è¿‡ç¨‹ä¸­ head æ²¡æœ‰å˜åŒ–ã€‚
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>        <span style=color:#586e75>// ä¸€æ—¦ hp æˆåŠŸå­˜å‚¨ï¼Œè¿™ä¸ªæŒ‡é’ˆå°±è¢«ä¿æŠ¤äº†ï¼Œold_head ä¹Ÿå°±ä¸ä¼šè¢«åˆ«çš„çº¿ç¨‹åˆ é™¤ã€‚
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>        <span style=color:#586e75>// 2. åœ¨å¾ªç¯ä¸­ä¸€èˆ¬ä¼šç”¨ compare_exchange_weakï¼Œä½†æ˜¯è¿™é‡Œç”¨ compare_exchange_strong
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>        <span style=color:#586e75>// æ˜¯ä¸æƒ³è®©å‡æ€§å¤±è´¥å¯¼è‡´é«˜å¼€é”€çš„é‡è¯•ï¼ˆåœ¨å¾ªç¯ä¸­æœ‰å‡ ä¸ªåŸå­æ“ä½œï¼‰ã€‚
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    } <span style=color:#719e07>while</span> (old_head <span style=color:#719e07>&amp;&amp;</span> <span style=color:#719e07>!</span>head.compare_exchange_strong(old_head, old_head<span style=color:#719e07>-&gt;</span>next));
</span></span><span style=display:flex><span>    <span style=color:#586e75>// ä¸Šé¢æ˜¯åœ¨æœ‰ä¿æŠ¤çš„æƒ…å†µä¸‹å–èµ° head
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#586e75>// -------------------------------
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#586e75>// ä¸‹é¢æ˜¯å°è¯•å›æ”¶å½“å‰æŒ‡é’ˆå’Œå›æ”¶é“¾è¡¨ä¸­çš„å…¶ä»–æŒ‡é’ˆ
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    hp.store(<span style=color:#719e07>nullptr</span>);
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span>shared_ptr<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> res;
</span></span><span style=display:flex><span>    <span style=color:#719e07>if</span> (old_head) {
</span></span><span style=display:flex><span>        res.swap(old_head<span style=color:#719e07>-&gt;</span>data);
</span></span><span style=display:flex><span>        <span style=color:#586e75>// outstanding_hazard_pointers_for éå†å…¨å±€è®°å½•ï¼Œå¯¹æ¯ä¸ªè®°å½•ç®€å•è°ƒç”¨ load() æ¥æ£€æŸ¥
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>        <span style=color:#586e75>// æ˜¯å¦ old_head è¿˜åœ¨ä½¿ç”¨ä¸­ã€‚å¦‚æœæ‰«è¿‡å»ä¸€éæ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™ old_head ä¸å¯èƒ½è¢«ä½¿ç”¨ã€‚è¿™æ˜¯å› ä¸º
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>        <span style=color:#586e75>// æœ¬çº¿ç¨‹å·²ç»æŠŠ old_head å–ä¸‹æ¥äº†ï¼Œä¹‹å‰æ²¡æœ‰æ­£åœ¨ä½¿ç”¨å®ƒçš„çº¿ç¨‹ä¸å¯èƒ½å†è®¿é—®åˆ°å®ƒäº†ã€‚
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>        <span style=color:#586e75>// æ—¶é—´å¤æ‚åº¦ï¼šO(æœ€å¤§å·¥ä½œçº¿ç¨‹æ•°)
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>        <span style=color:#719e07>if</span> (outstanding_hazard_pointers_for(old_head)) {
</span></span><span style=display:flex><span>            <span style=color:#586e75>// å°†è¯¥ç»“ç‚¹åŠ å…¥å¾…åˆ é™¤åˆ—è¡¨ã€‚
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>            <span style=color:#586e75>// ä¹¦ä¸Šæ˜¯å°†è¯¥ç»“ç‚¹å†æ¬¡å°è£…åˆ°ä¸€ä¸ªæ–°çš„ç±»å‹ä¸­ï¼Œè¯¥ç±»å‹åœ¨ææ„å‡½æ•°ä¸­ä¼šå°†ç»“ç‚¹æŒ‡é’ˆè½¬æ¢å›åŸæ¥çš„
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>            <span style=color:#586e75>// T* ç±»å‹ï¼Œç„¶åè°ƒç”¨ delete æ“ä½œç¬¦ã€‚è¿™ä¸ªé€»è¾‘ä¹Ÿå¯ä»¥æ‰‹åŠ¨æ¥å†™ã€‚
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>            reclaim_later(old_head);
</span></span><span style=display:flex><span>        } <span style=color:#719e07>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#719e07>delete</span> old_head;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#586e75>// å°†å›æ”¶é“¾è¡¨å¤´å’Œ nullptr äº¤æ¢ï¼Œç„¶åéå†æ¯ä¸ªç»“ç‚¹ï¼Œå¯¹æ¯ä¸ªç»“ç‚¹è°ƒç”¨
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>        <span style=color:#586e75>// outstanding_hazard_pointers_forï¼Œèƒ½å›æ”¶å°±å›æ”¶ï¼Œä¸èƒ½å›æ”¶å°±å°†ç»“ç‚¹é‡æ–°æ”¾åˆ°å›æ”¶é“¾è¡¨ä¸­ã€‚
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>        <span style=color:#586e75>// æ—¶é—´å¤æ‚åº¦ï¼šO(æœ€å¤§å·¥ä½œçº¿ç¨‹æ•° * å›æ”¶é˜Ÿåˆ—é•¿åº¦) = O(æœ€å¤§å·¥ä½œçº¿ç¨‹æ•°^2)
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>        delete_nodes_with_no_hazards();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#719e07>return</span> res;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class="markdown-alert markdown-alert-tip"><p class=markdown-alert-title><svg class="octicon octicon-light-bulb mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M8 1.5c-2.363.0-4 1.69-4 3.75.0.984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75.0 01-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456.0 00-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863.0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751.0 01-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304.0-2.06-1.637-3.75-4-3.75zM5.75 12h4.5a.75.75.0 010 1.5h-4.5a.75.75.0 010-1.5zM6 15.25a.75.75.0 01.75-.75h2.5a.75.75.0 010 1.5h-2.5A.75.75.0 016 15.25z"/></svg>Tip</p><p>ä¹¦ä¸Šè¿™å¥è¯å¥½åƒæ˜¯åœ¨è¯´<strong>åªè¦ CAS å¾ªç¯é‡Œé¢æœ‰å®è´¨å·¥ä½œå°±é€‰ strong ç‰ˆæœ¬</strong>ï¼Œå¦‚æœåªæ˜¯å¤±è´¥åä¸æ–­å°è¯•ä½†æ˜¯å¾ªç¯å†…éƒ¨æ˜¯ç©ºçš„å°±é€‰ weak ç‰ˆæœ¬ï¼š</p><blockquote><p>Youâ€™re using <code>compare_exchange_strong()</code> here <strong>because youâ€™re doing work inside the while loop</strong>: a spurious failure <code>on compare_exchange_weak()</code> would result in resetting the hazard pointer unnecessarily.</p></blockquote></div><p>ä¸ºäº†è®©æ¯ä¸ªçº¿ç¨‹çš„é£é™©æŒ‡é’ˆå¯¹å…¶ä»–çº¿ç¨‹å¯è§ï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ªå…¨å±€é£é™©æŒ‡é’ˆè®°å½•æ•°ç»„ï¼Œæ¯ä¸ªçº¿ç¨‹çš„é£é™©æŒ‡é’ˆåˆ™æ˜¯å…¶ä¸­çš„å…ƒç´ ã€‚å…·ä½“è€Œè¨€ï¼Œå…¨å±€é£é™©æŒ‡é’ˆè®°å½•æ•°ç»„çš„æ¯ä¸ªå…ƒç´ ä¸æ˜¯ç®€å•çš„æŒ‡é’ˆï¼Œè€Œæ˜¯æ˜¯ä¸€ä¸ªå¸¦æœ‰<strong>çº¿ç¨‹ id åŸå­å˜é‡</strong>å’Œ<strong>æŒ‡é’ˆåŸå­å˜é‡</strong>çš„ç»“æ„ï¼Œçº¿ç¨‹ id é»˜è®¤åˆå§‹åŒ–è¡¨ç¤ºè¿™ä¸ªä½ç½®æ²¡æœ‰åˆ†é…ç»™ä»»ä½•çº¿ç¨‹ã€‚å…¨å±€é£é™©æŒ‡é’ˆè®°å½•æ•°ç»„çš„å¤§å°ä¹Ÿæ˜¯å›ºå®šåˆ†é…çš„ã€‚<code>get_hazard_pointer_for_current_thread()</code> ç›´æ¥è¿”å›ä¸€ä¸ª <code>thread_local</code> å˜é‡ä¸­çš„æŒ‡é’ˆéƒ¨åˆ†ï¼Œ<strong>è¯¥å˜é‡åœ¨åˆå§‹åŒ–æ—¶ä»å…¨å±€é£é™©æŒ‡é’ˆè®°å½•æ•°ç»„ä¸Šæœç´¢ä¸€ä¸ªç©ºçš„ä½ç½®åˆ†é…ç»™å½“å‰çº¿ç¨‹</strong>ã€‚ç”±äºè·å–é£é™©æŒ‡é’ˆçš„å‡½æ•°è¿”å›äº† <code>thread_local</code> å˜é‡ï¼Œå› æ­¤å°½ç®¡åˆ†é…æŒ‡é’ˆçš„æ“ä½œå¾ˆè€—æ—¶ï¼Œä½†æ¯ä¸ªçº¿ç¨‹åªéœ€è¦åˆ†é…ä¸€æ¬¡ã€‚åœ¨å·¥ä½œçº¿ç¨‹é€€å‡ºæ—¶ï¼Œç›¸å…³ææ„å‡½æ•°ä¼šå°†å¯¹åº”å…¨å±€è®°å½•æ¸…ç†ã€‚</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#dc322f>unsigned</span> <span style=color:#719e07>const</span> max_hazard_pointers<span style=color:#719e07>=</span><span style=color:#2aa198>100</span>;
</span></span><span style=display:flex><span><span style=color:#719e07>struct</span> <span style=color:#268bd2>hazard_pointer</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span>atomic<span style=color:#719e07>&lt;</span>std<span style=color:#719e07>::</span><span style=color:#268bd2>thread</span><span style=color:#719e07>::</span>id<span style=color:#719e07>&gt;</span> id;
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span>atomic<span style=color:#719e07>&lt;</span><span style=color:#dc322f>void</span><span style=color:#719e07>*&gt;</span> pointer; <span style=color:#586e75>// åªå…³å¿ƒæŒ‡é’ˆåœ°å€ï¼Œè¿™é‡Œçš„ pointer éšå»äº†ç±»å‹
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>};
</span></span><span style=display:flex><span>hazard_pointer hazard_pointers[max_hazard_pointers];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#719e07>class</span> <span style=color:#268bd2>hp_owner</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    hazard_pointer<span style=color:#719e07>*</span> hp;
</span></span><span style=display:flex><span><span style=color:#719e07>public</span><span style=color:#719e07>:</span>
</span></span><span style=display:flex><span>    hp_owner(hp_owner <span style=color:#719e07>const</span><span style=color:#719e07>&amp;</span>) <span style=color:#719e07>=</span> <span style=color:#719e07>delete</span>;
</span></span><span style=display:flex><span>    hp_owner <span style=color:#719e07>operator</span><span style=color:#719e07>=</span>(hp_owner <span style=color:#719e07>const</span><span style=color:#719e07>&amp;</span>) <span style=color:#719e07>=</span> <span style=color:#719e07>delete</span>;
</span></span><span style=display:flex><span>    hp_owner() <span style=color:#719e07>:</span> hp(<span style=color:#719e07>nullptr</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#719e07>for</span> (<span style=color:#dc322f>unsigned</span> i <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>; i <span style=color:#719e07>&lt;</span> max_hazard_pointers; <span style=color:#719e07>++</span>i) {
</span></span><span style=display:flex><span>            std<span style=color:#719e07>::</span><span style=color:#268bd2>thread</span><span style=color:#719e07>::</span>id old_id;
</span></span><span style=display:flex><span>            <span style=color:#719e07>if</span> (hazard_pointers[i].id.compare_exchange_strong(
</span></span><span style=display:flex><span>                old_id, std<span style=color:#719e07>::</span>this_thread<span style=color:#719e07>::</span>get_id()))
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                hp <span style=color:#719e07>=</span> <span style=color:#719e07>&amp;</span>hazard_pointers[i];
</span></span><span style=display:flex><span>                <span style=color:#719e07>break</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#719e07>if</span> (<span style=color:#719e07>!</span>hp) {
</span></span><span style=display:flex><span>            <span style=color:#719e07>throw</span> std<span style=color:#719e07>::</span>runtime_error(<span style=color:#2aa198>&#34;No hazard pointers available&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span>atomic<span style=color:#719e07>&lt;</span><span style=color:#dc322f>void</span><span style=color:#719e07>*&gt;&amp;</span> get_pointer()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#719e07>return</span> hp<span style=color:#719e07>-&gt;</span>pointer;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#719e07>~</span>hp_owner()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        hp<span style=color:#719e07>-&gt;</span>pointer.store(<span style=color:#719e07>nullptr</span>);
</span></span><span style=display:flex><span>        hp<span style=color:#719e07>-&gt;</span>id.store(std<span style=color:#719e07>::</span><span style=color:#268bd2>thread</span><span style=color:#719e07>::</span>id());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>std<span style=color:#719e07>::</span>atomic<span style=color:#719e07>&lt;</span><span style=color:#dc322f>void</span><span style=color:#719e07>*&gt;&amp;</span> get_hazard_pointer_for_current_thread()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#719e07>thread_local</span> <span style=color:#719e07>static</span> hp_owner hazard;
</span></span><span style=display:flex><span>    <span style=color:#719e07>return</span> hazard.get_pointer();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>delete_nodes_with_no_hazards()</code> æˆ‘è§‰å¾—å¯ä»¥ç»§ç»­ä¼˜åŒ–ï¼Œæ¯æ¬¡éƒ½æŠŠä¸å¯å›æ”¶çš„ç»“ç‚¹ç›´æ¥æ”¾å›å›æ”¶é“¾è¡¨ï¼Œä¼šæœ‰å¤§é‡çš„åŸå­æ“ä½œï¼Œæœ‰ç‚¹æ…¢ã€‚å¯ä»¥å°†ä¸èƒ½å›æ”¶çš„ç»“ç‚¹ç»„ç»‡æˆé“¾ï¼Œå†å¯¹æ•´ä¸ªé“¾è¡¨åªåšä¸€æ¬¡ <code>while (xx.compare_exchange_weak(...))</code> å¹¶å…¥å›æ”¶é“¾è¡¨ä¸­ã€‚</p><h2 id=å¼•ç”¨è®¡æ•°>å¼•ç”¨è®¡æ•°
<a class=header-anchor href=#%e5%bc%95%e7%94%a8%e8%ae%a1%e6%95%b0></a></h2><h3 id=stdshared_ptrt-ä¸Šçš„åŸå­æ“ä½œ><code>std::shared_ptr&lt;T></code> ä¸Šçš„åŸå­æ“ä½œ
<a class=header-anchor href=#stdshared_ptrt-%e4%b8%8a%e7%9a%84%e5%8e%9f%e5%ad%90%e6%93%8d%e4%bd%9c></a></h3><p>åŸºäºè®¿é—®è®¡æ•°çš„å›æ”¶ç®—æ³•åªèƒ½åœ¨æ²¡æœ‰å…¶ä»–çº¿ç¨‹è®¿é—® <code>pop()</code> æ—¶å›æ”¶ç»“ç‚¹ï¼Œå¯¼è‡´ç»“ç‚¹å †ç§¯ï¼Œåœ¨é‡è´Ÿè·ä¸‹ä»ç„¶æœ‰å†…å­˜æ³„æ¼ã€‚Hazard pointers è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚è¿˜æœ‰æ²¡æœ‰åˆ«çš„æ€è·¯å‘¢ï¼Ÿå¯ä»¥æƒ³åˆ°<strong>åŸå­å¼•ç”¨è®¡æ•°</strong>çš„å®ç°é€»è¾‘æ›´ç®€å•ã€‚</p><p>æˆä¹¦æ—¶é—´æ˜¯åœ¨ C++20 ä¹‹å‰ï¼Œæ²¡æœ‰ <code>std::atomic&lt;shared_ptr&lt;T>></code>ï¼Œå› æ­¤ä¹¦ä¸Šæ˜¯åœ¨ <code>std::shared_ptr&lt;T></code> ä¸Šåš <code>std::atomic_load()</code> æ“ä½œã€‚ä¹¦ P227 ç»™äº†ä¸€ä¸ªå¯ä¾›å‚è€ƒçš„å®ç°ã€‚</p><p><img src=/cpp-concurrency-in-action/assets/Pasted%20image%2020250124095558.webp width=700></p><p>æˆ‘ä¸ªäººè®¤ä¸ºä¸Šå›¾ä»£ç å†è·å– <code>old_head</code> åç«‹å³å°† <code>old_head->next</code> ç½®ç©ºåªæ˜¯ä¸€ä¸ªå–ä¸‹ç»“ç‚¹çš„å¥½ä¹ æƒ¯ï¼Œå®é™…ä¸Šä» <code>pop()</code> ä¸­è¿”å›æ—¶ï¼Œ<code>old_head</code> ä¼šææ„ï¼Œ<code>old_head->next</code> ä¹Ÿä¼šè‡ªåŠ¨è¢«ææ„ã€‚</p><p>ç„¶åä¹¦ä»‹ç»èµ·äº† <code>&lt;experimental/atomic></code> å¤´æ–‡ä»¶ï¼Œå®ƒæä¾›ä¸€ä¸ªæ–°çš„æ¨¡æ¿ç±» <code>std::experimental::atomic_shared_ptr&lt;T></code>ã€‚C++20 å·²ç»å°† <code>std::atomic&lt;std::shared_ptr&lt;T>></code> åç‰¹åŒ–åŠ å…¥æ ‡å‡†äº†ã€‚</p><p>ä¸è¿‡ <code>std::atomic&lt;std::shared_ptr&lt;T>></code> æ²¡æœ‰æ— é”ä¿è¯ï¼å³ä¾¿æ˜¯æœºå™¨æ”¯æŒ CX16ï¼Œå…±äº«æŒ‡é’ˆä¹Ÿä¸æ˜¯ä¸€ä¸ªå¹³å‡¡ç±»å‹ï¼Œå®ƒåœ¨æ‹·è´ã€èµ‹å€¼ã€ææ„çš„æ—¶å€™è¦ä¿®æ”¹æ§åˆ¶å—çš„å¼•ç”¨è®¡æ•°ï¼Œå¯¼è‡´å…¶å¯¹åº”åŸå­ç±»å‹å¾ˆéš¾å®ç°æ— é”ã€‚åœ¨ libstdc++ çš„å®ç°ä¸­ï¼Œæ— è®ºæ˜¯ <code>std::atomic_load()</code> å¯¹å…±äº«æŒ‡é’ˆçš„ç‰¹åŒ–ï¼Œè¿˜æ˜¯ <code>std::atomic&lt;std::shared_ptr&lt;T>></code>ï¼Œå‡æ˜¯æœ‰é”çš„ã€‚</p><h3 id=åˆ†è£‚å¼•ç”¨è®¡æ•°>åˆ†è£‚å¼•ç”¨è®¡æ•°
<a class=header-anchor href=#%e5%88%86%e8%a3%82%e5%bc%95%e7%94%a8%e8%ae%a1%e6%95%b0></a></h3><p>è¿™ä¸ªåº”è¯¥æ˜¯å¯¹åº”
<a href=/cppcon-talks/CppCon-2023-Lock-free-Atomic-Shared-Pointers-Without-a-Split-Reference-Count/ title="CppCon 2023 Lock-free Atomic Shared Pointers Without a Split Reference Count">CppCon 2023 Lock-free Atomic Shared Pointers Without a Split Reference Count</a> çš„ split reference-countingã€‚</p><ol><li><strong>å’Œå…±äº«æŒ‡é’ˆä¸Šçš„åŸå­æ“ä½œç›¸æ¯”</strong>ï¼Œåˆ†è£‚å¼•ç”¨è®¡æ•°çš„è®¡æ•°å€¼æ˜¯å®ç°è€…ç»´æŠ¤çš„ï¼Œè€Œä¸æ˜¯åœ¨æ‹·è´ã€èµ‹å€¼ã€ææ„æ—¶è‡ªåŠ¨ç»´æŠ¤çš„ã€‚å› æ­¤å¦‚æœç¡¬ä»¶æ”¯æŒç›¸åº”å¤§å°çš„ CAS æŒ‡ä»¤ï¼Œå°±å¯ä»¥å†™æˆæ— é”ä»£ç ã€‚</li><li><strong>å’Œæ‰‹åŠ¨ç»´æŠ¤çš„å•ä¸ªå†…éƒ¨å¼•ç”¨è®¡æ•°ç›¸æ¯”ï¼Œåˆ†è£‚å¼•ç”¨è®¡æ•°åœ¨å¼€å§‹ç»“ç‚¹è®¿é—®æ—¶ä¼šå…ˆæŠŠè®¡æ•°å€¼åŠ åˆ°å¤–éƒ¨è®¡æ•°ä¸Šï¼Œé˜²æ­¢ç›´æ¥æ“ä½œå†…éƒ¨è®¡æ•°æ—¶é­é‡ç»“ç‚¹è¢«åˆ é™¤çš„æœªå®šä¹‰è¡Œä¸º</strong>ã€‚</li></ol><p>åˆ†è£‚å¼•ç”¨è®¡æ•°ç»“æ„çš„å¤–å›´åŒ…å«ä¸€ä¸ªå¤–éƒ¨è®¡æ•°å’Œä¸€ä¸ªæŒ‡é’ˆï¼Œè¿™ä¸ªæŒ‡é’ˆæŒ‡å‘çš„ç»“æ„åŒ…å«æ•°æ®æœ¬èº«å’Œä¸€ä¸ªå†…éƒ¨è®¡æ•°ã€‚ä¸€ä¸ªæŒ‡é’ˆåŠ ä¸Šä¸€ä¸ªå¤–éƒ¨è®¡æ•°ä¹Ÿè¶…è¿‡äº†æœºå™¨å­—é•¿ï¼Œæ‰€ä»¥æ— é”æ“ä½œåŒæ ·ä¹Ÿä¸èƒ½åœ¨æ‰€æœ‰å¹³å°ä¸Šé¢ä¿è¯ã€‚å¦‚æœç¡¬ä»¶æ”¯æŒ CX16ï¼Œé‚£ä¹ˆ<strong>åˆ†è£‚å¼•ç”¨è®¡æ•°</strong>å°±æ˜¯æ— é”çš„ã€‚å¦åˆ™ï¼Œå¦‚æœæ˜¯åœ¨ x86 ä¸Šæˆ‘ä»¬è¿˜èƒ½åˆ©ç”¨è¿™æ ·çš„ç¡¬ä»¶ç‰¹æ€§ï¼šè™½ç„¶æŒ‡é’ˆæ˜¯ 64 ä½ï¼Œä½†å®é™…æœ‰ç”¨çš„è™šæ‹Ÿåœ°å€ä½æ•°å¯èƒ½åªæœ‰ 48 ä½ï¼Œå‰©ä¸‹çš„ 16 ä½å¯ä»¥ç”¨æ¥å­˜å‚¨å¼•ç”¨è®¡æ•°ï¼Œç¼ºç‚¹æ˜¯è®¡æ•°èŒƒå›´å—é™ã€‚å…¶ä»–ç¡¬ä»¶ä¸Šä¹Ÿæœ‰ç±»ä¼¼çš„ç‰¹æ€§å¯ä»¥æŒ–æ˜ã€‚</p><div class="markdown-alert markdown-alert-tip"><p class=markdown-alert-title><svg class="octicon octicon-light-bulb mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M8 1.5c-2.363.0-4 1.69-4 3.75.0.984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75.0 01-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456.0 00-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863.0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751.0 01-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304.0-2.06-1.637-3.75-4-3.75zM5.75 12h4.5a.75.75.0 010 1.5h-4.5a.75.75.0 010-1.5zM6 15.25a.75.75.0 01.75-.75h2.5a.75.75.0 010 1.5h-2.5A.75.75.0 016 15.25z"/></svg>Tip</p><p>ä¹¦ä¸Šå¼€å§‹ä»‹ç»<strong>åˆ†è£‚å¼•ç”¨è®¡æ•°</strong>è¿™ä¸ªæ–¹æ³•å°±æ˜¯å› ä¸ºå…±äº«æŒ‡é’ˆåŸå­å˜é‡çš„æ— é”æ€§è´¨ä¸èƒ½å¾—åˆ°ä¿è¯ï¼Œä½†æ˜¯åˆ†è£‚å¼•ç”¨è®¡æ•°æœ¬èº«ä¹Ÿä¸ä¸€å®šæ˜¯æ— é”çš„ã€‚ä¸è¿‡ï¼Œå› ä¸ºåˆ†è£‚å¼•ç”¨è®¡æ•°ç»“æ„æ˜¯å¹³å‡¡ç±»å‹ï¼Œåªè¦ç¡¬ä»¶æ”¯æŒå¯¹è¯¥å¤§å°çš„å˜é‡è¿›è¡ŒåŸå­æ“ä½œå°±å¯ä»¥æ— é”ã€‚ç›¸å½“äºæ˜¯æ”¾å®½äº†è¦æ±‚ã€‚</p></div><div class="markdown-alert markdown-alert-tip"><p class=markdown-alert-title><svg class="octicon octicon-light-bulb mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M8 1.5c-2.363.0-4 1.69-4 3.75.0.984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75.0 01-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456.0 00-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863.0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751.0 01-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304.0-2.06-1.637-3.75-4-3.75zM5.75 12h4.5a.75.75.0 010 1.5h-4.5a.75.75.0 010-1.5zM6 15.25a.75.75.0 01.75-.75h2.5a.75.75.0 010 1.5h-2.5A.75.75.0 016 15.25z"/></svg>Tip</p><p>å‰é¢è¯´åˆ°äº† x86-64 å¤„ç†å™¨ä¸Šè™šæ‹Ÿåœ°å€æœ€å¤§æ˜¯ 48 ä½ã€‚ä½†æ˜¯è¿™ä¸ªè¯´æ³•å¹¶ä¸å®Œå…¨å‡†ç¡®ã€‚æ ¹æ® <a href="https://wiki.osdev.org/Paging#:~:text=Intel%20has%20released%20documentation%20for,PiB%20of%20physical%20address%20space" title=wiki.osdev.org/Paging rel="noopener external nofollow noreferrer" target=_blank class=exturl>wiki.osdev.org/Paging<i class="fa fa-external-link-alt"></i></a>ï¼ŒIntel æä¾›äº†æ‰©å±•åˆ° 57 ä½è™šæ‹Ÿåœ°å€ã€5 çº§é¡µè¡¨çš„æ‰©å±•æ”¯æŒã€‚4 çº§é¡µè¡¨çš„ç»“æ„æ˜¯ 9ï¼ˆé¡¶çº§ / ä¸€çº§ï¼‰-9ï¼ˆäºŒçº§ï¼‰-9ï¼ˆä¸‰çº§ï¼‰-9ï¼ˆå››çº§ï¼‰-12ï¼ˆ4K é¡µé¢é¡µå†…åœ°å€ï¼‰ï¼Œ5 çº§é¡µè¡¨å¾ˆå®¹æ˜“æƒ³åˆ°æ˜¯åœ¨é¡¶å±‚å†æ¬¡æ‰©å±•äº† 9 ä½ã€‚<strong>å¦‚æœä½¿ç”¨äº†ä¾èµ– 48 ä½è™šæ‹Ÿåœ°å€çš„å‹ç¼©æŒ‡é’ˆï¼Œé‚£ä¹ˆè¿™æ ·çš„ä»£ç æ˜¯åœ¨ 5 çº§é¡µè¡¨ä¸‹ä¸å¯ç§»æ¤çš„</strong>ã€‚</p><p>æ‰©å±•é¡µè¡¨æ”¯æŒåªèƒ½åœ¨é 64 ä½ä¸‹æ¨¡å¼è®¾ç½®ï¼Œä¹Ÿå°±æ„å‘³ç€å¼€æœºåä¸èƒ½ä¿®æ”¹ã€‚åœ¨ Windows Server ä¸Šé¢çš„ä¿®æ”¹å¯ä»¥å‚è€ƒ <a href=https://lenovopress.lenovo.com/lp1911.pdf title=https://lenovopress.lenovo.com/lp1911.pdf rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://lenovopress.lenovo.com/lp1911.pdf<i class="fa fa-external-link-alt"></i></a> ã€‚</p><p>X86 ä¸åŒç¡¬ä»¶é…ç½®ä¸‹çš„é¡µè¡¨çº§æ•°å‚è€ƒ <a href=https://unix.stackexchange.com/a/379238/ title=https://unix.stackexchange.com/a/379238/ rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://unix.stackexchange.com/a/379238/<i class="fa fa-external-link-alt"></i></a> ã€‚</p></div><div class="markdown-alert markdown-alert-tip"><p class=markdown-alert-title><svg class="octicon octicon-light-bulb mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M8 1.5c-2.363.0-4 1.69-4 3.75.0.984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75.0 01-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456.0 00-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863.0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751.0 01-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304.0-2.06-1.637-3.75-4-3.75zM5.75 12h4.5a.75.75.0 010 1.5h-4.5a.75.75.0 010-1.5zM6 15.25a.75.75.0 01.75-.75h2.5a.75.75.0 010 1.5h-2.5A.75.75.0 016 15.25z"/></svg>Tip</p><p>ç‰©ç†åœ°å€çš„é•¿åº¦å’Œè™šæ‹Ÿåœ°å€ä¸ä¸€æ ·ï¼Œä¸åŒç¡¬ä»¶çš„ç‰©ç†åœ°å€é•¿åº¦å¯èƒ½ä¹Ÿä¸ä¸€æ ·ã€‚æˆ‘çš„ Intel ç¬”è®°æœ¬ä¸Šç‰©ç†åœ°å€å  46 ä½ï¼Œè€Œå®éªŒå®¤æœåŠ¡å™¨ä¸Š CPU ä¸º AMDï¼Œç‰©ç†åœ°å€å  43 ä½ã€‚ çœ‹äº†å…¶ä»–å‡ å° Intel çš„æœåŠ¡å™¨ï¼Œç‰©ç†åœ°å€ä¹Ÿæ˜¯ 46 ä½ã€‚</p></div><p>å®ç°æ€è·¯æ˜¯è¿™æ ·ï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#719e07>template</span><span style=color:#719e07>&lt;</span><span style=color:#719e07>typename</span> T<span style=color:#719e07>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#719e07>class</span> <span style=color:#268bd2>lock_free_stack</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#719e07>private</span><span style=color:#719e07>:</span>
</span></span><span style=display:flex><span>    <span style=color:#719e07>struct</span> <span style=color:#268bd2>node</span>;
</span></span><span style=display:flex><span>    <span style=color:#719e07>struct</span> <span style=color:#268bd2>counted_node_ptr</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#dc322f>int</span> external_count;
</span></span><span style=display:flex><span>        node<span style=color:#719e07>*</span> ptr;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#719e07>struct</span> <span style=color:#268bd2>node</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        std<span style=color:#719e07>::</span>shared_ptr<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> data;
</span></span><span style=display:flex><span>        std<span style=color:#719e07>::</span>atomic<span style=color:#719e07>&lt;</span><span style=color:#dc322f>int</span><span style=color:#719e07>&gt;</span> internal_count;
</span></span><span style=display:flex><span>        counted_node_ptr next;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        node(T <span style=color:#719e07>const</span><span style=color:#719e07>&amp;</span> data_)<span style=color:#719e07>:</span>
</span></span><span style=display:flex><span>            data(std<span style=color:#719e07>::</span>make_shared<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span>(data_)),
</span></span><span style=display:flex><span>            internal_count(<span style=color:#2aa198>0</span>)
</span></span><span style=display:flex><span>        {}
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span>atomic<span style=color:#719e07>&lt;</span>counted_node_ptr<span style=color:#719e07>&gt;</span> head; <span style=color:#586e75>// ä¸ä¸€å®šæ— é”
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>
</span></span><span style=display:flex><span><span style=color:#719e07>public</span><span style=color:#719e07>:</span>
</span></span><span style=display:flex><span>    <span style=color:#719e07>~</span>lock_free_stack()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#719e07>while</span>(pop());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>void</span> <span style=color:#268bd2>push</span>(T <span style=color:#719e07>const</span><span style=color:#719e07>&amp;</span> data)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        counted_node_ptr new_node;
</span></span><span style=display:flex><span>        new_node.ptr <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> node(data);
</span></span><span style=display:flex><span>        new_node.external_count <span style=color:#719e07>=</span> <span style=color:#2aa198>1</span>;
</span></span><span style=display:flex><span>        new_node.ptr<span style=color:#719e07>-&gt;</span>next <span style=color:#719e07>=</span> head.load();
</span></span><span style=display:flex><span>        <span style=color:#719e07>while</span>(<span style=color:#719e07>!</span>head.compare_exchange_weak(new_node.ptr<span style=color:#719e07>-&gt;</span>next, new_node));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>åœ¨ <code>pop()</code> çš„æ—¶å€™è¦è€ƒè™‘ä¿æŠ¤è¯»å‡ºæ¥çš„ <code>head</code>ï¼Œå°†å…¶å¤–éƒ¨å¼•ç”¨è®¡æ•°åŠ  1ï¼Œå¢åŠ å¤–éƒ¨å¼•ç”¨è®¡æ•°çš„è¿‡ç¨‹è¦ç”¨ CAS é‡è¯•ç›´åˆ°ä¿è¯â€œè¯»åˆ° headï¼Œä¸”å¢åŠ å®ƒçš„å¼•ç”¨è®¡æ•°â€è¿™ä¸ªæ“ä½œæ˜¯ä¸€ä¸ªä¸å¯æ‰“æ–­çš„æ•´ä½“ã€‚</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#719e07>template</span><span style=color:#719e07>&lt;</span><span style=color:#719e07>typename</span> T<span style=color:#719e07>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#719e07>class</span> <span style=color:#268bd2>lock_free_stack</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#719e07>private</span><span style=color:#719e07>:</span>
</span></span><span style=display:flex><span>    <span style=color:#586e75>// other parts as in listing 7.11
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#dc322f>void</span> increase_head_count(counted_node_ptr<span style=color:#719e07>&amp;</span> old_counter)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        counted_node_ptr new_counter;
</span></span><span style=display:flex><span>        <span style=color:#719e07>do</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            new_counter <span style=color:#719e07>=</span> old_counter;
</span></span><span style=display:flex><span>            <span style=color:#719e07>++</span>new_counter.external_count;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#586e75>// åœ¨å°†å¢åŠ äº†å¤–éƒ¨è®¡æ•°çš„ counter æ”¾å› head ä¹‹å‰è¦å…ˆæ£€æŸ¥ head æ˜¯å¦æ”¹å˜ã€‚
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>        <span style=color:#586e75>// å¦‚æœå¤±è´¥äº†é‚£ä¹ˆ head çš„å½“å‰å€¼å†™å›åˆ° old_counter ä¸­ï¼Œå†æ¬¡é‡è¯•ç›´åˆ°æˆåŠŸã€‚
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>        <span style=color:#719e07>while</span> (<span style=color:#719e07>!</span>head.compare_exchange_strong(old_counter, new_counter));
</span></span><span style=display:flex><span>        old_counter.external_count <span style=color:#719e07>=</span> new_counter.external_count;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#719e07>public</span><span style=color:#719e07>:</span>
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span>shared_ptr<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> pop()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        counted_node_ptr old_head <span style=color:#719e07>=</span> head.load();
</span></span><span style=display:flex><span>        <span style=color:#719e07>for</span> (;;)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            increase_head_count(old_head);
</span></span><span style=display:flex><span>            node<span style=color:#719e07>*</span> <span style=color:#719e07>const</span> ptr <span style=color:#719e07>=</span> old_head.ptr;
</span></span><span style=display:flex><span>            <span style=color:#719e07>if</span> (<span style=color:#719e07>!</span>ptr)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#719e07>return</span> std<span style=color:#719e07>::</span>shared_ptr<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span>();
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#586e75>// å¦‚æœå¤±è´¥äº†ï¼Œhead çš„å½“å‰å€¼ä¼šæ›´æ–°åˆ° old_head å½“ä¸­ï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>            <span style=color:#586e75>// è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ for å¾ªç¯å†…éƒ¨ä¸éœ€è¦åŠ è½½ head å€¼ã€‚
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>            <span style=color:#719e07>if</span> (head.compare_exchange_strong(old_head, ptr<span style=color:#719e07>-&gt;</span>next))
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                std<span style=color:#719e07>::</span>shared_ptr<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> res;
</span></span><span style=display:flex><span>                res.swap(ptr<span style=color:#719e07>-&gt;</span>data);
</span></span><span style=display:flex><span>                <span style=color:#586e75>// ä¿®æ”¹è®¡æ•°ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦å›æ”¶ç»“ç‚¹ã€‚
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>                <span style=color:#586e75>// å†…éƒ¨è®¡æ•°å’Œå¤–éƒ¨è®¡æ•°å…¶å®æ˜¯ä¸€ä¸ªæ•´ä½“ï¼Œå®ƒä»¬çš„æ€»å’Œè¡¨ç¤ºçœŸå®å¼•ç”¨ï¼Œè¿™é‡Œçš„
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>                <span style=color:#586e75>// internal_count + external_count + offset åº”è¯¥ç­‰äº 0ã€‚ä¸ºä»€ä¹ˆ
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>                <span style=color:#586e75>// è¿™ä¸ª offset è¦å– -2ï¼Ÿå› ä¸ºå¤–éƒ¨è®¡æ•°åˆå§‹å€¼æ˜¯ 1 è¡¨æ˜é“¾è¡¨å¯¹ç»“ç‚¹çš„å¼•ç”¨ï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>                <span style=color:#586e75>// å¦å¤–æ­¤çº¿ç¨‹åœ¨è¿›å…¥å¾ªç¯æ—¶å°±å°†å¤–éƒ¨è®¡æ•°åŠ  1 äº†ï¼Œè¡¨æ˜ pop() è¿‡ç¨‹å¯¹ç»“ç‚¹çš„
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>                <span style=color:#586e75>// å¼•ç”¨ï¼Œç°åœ¨è¦æŠŠè¿™ä¸¤éƒ¨åˆ†éƒ½å‡æ‰ã€‚
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>                <span style=color:#dc322f>int</span> <span style=color:#719e07>const</span> count_increase <span style=color:#719e07>=</span> old_head.external_count <span style=color:#719e07>-</span> <span style=color:#2aa198>2</span>;
</span></span><span style=display:flex><span>                <span style=color:#719e07>if</span> (ptr<span style=color:#719e07>-&gt;</span>internal_count.fetch_add(count_increase) <span style=color:#719e07>==</span> <span style=color:#719e07>-</span>count_increase)
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#719e07>delete</span> ptr;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#719e07>return</span> res;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#586e75>// å¦‚æœå¤±è´¥ï¼Œè¯´æ˜è¿™ä¸ª head è¢«å…¶ä»–ç»“ç‚¹å–ä¸‹äº†ï¼Œå¼€å§‹æ–°çš„å¾ªç¯é‡æ–°å–ä¸€ä¸ªç»“ç‚¹ã€‚
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>            <span style=color:#586e75>// ä¸è¿‡å› ä¸ºæœ¬èŠ‚ç‚¹å’Œå…¶ä»–èŠ‚ç‚¹è¯»åˆ°äº†åŒæ ·çš„ headï¼Œå¯èƒ½å¯¼è‡´è¿™ä¸ª head æ²¡æœ‰è¢«
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>            <span style=color:#586e75>// æ­£å¸¸å›æ”¶ï¼Œæ‰€ä»¥è¿™é‡Œå‡å°‘å†…éƒ¨è®¡æ•°çœ‹çœ‹ç»“ç‚¹æ˜¯å¦éœ€è¦å›æ”¶ã€‚
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>            <span style=color:#719e07>else</span> <span style=color:#268bd2>if</span> (ptr<span style=color:#719e07>-&gt;</span>internal_count.fetch_sub(<span style=color:#2aa198>1</span>) <span style=color:#719e07>==</span> <span style=color:#2aa198>1</span>)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#719e07>delete</span> ptr;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>å…³äºåˆ†è£‚å¼•ç”¨è®¡æ•°å¦‚ä½•ç­‰æ•ˆäºå•ä¸ªå¼•ç”¨è®¡æ•°ï¼Œå¯ä»¥å‚è€ƒ <a href=https://stackoverflow.com/a/68963769/ title=https://stackoverflow.com/a/68963769/ rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://stackoverflow.com/a/68963769/<i class="fa fa-external-link-alt"></i></a> ï¼š</p><blockquote><p>We can think about this as two phases: in the first phase our counter is split (into external_count and internal_count) and in the second phase our counter is merged into a single variable - internal_count. In the first phase we need to add external_count to internal_count to get real counter value. In the second phase we have to use internal_count only, because external_count has some old value that does not make any sense now (as the book says, now &ldquo;external counter is discarded&rdquo;).</p></blockquote><h2 id=ä»¥åˆ†è£‚å¼•ç”¨è®¡æ•°ä¸ºä¾‹è€ƒè™‘å†…å­˜åºè¦æ±‚>ä»¥åˆ†è£‚å¼•ç”¨è®¡æ•°ä¸ºä¾‹ï¼Œè€ƒè™‘å†…å­˜åºè¦æ±‚
<a class=header-anchor href=#%e4%bb%a5%e5%88%86%e8%a3%82%e5%bc%95%e7%94%a8%e8%ae%a1%e6%95%b0%e4%b8%ba%e4%be%8b%e8%80%83%e8%99%91%e5%86%85%e5%ad%98%e5%ba%8f%e8%a6%81%e6%b1%82></a></h2><p>ä¹‹å‰çš„ä»£ç éƒ½ä½¿ç”¨äº†é»˜è®¤çš„ã€ä¹Ÿæ˜¯æœ€ä¸¥æ ¼çš„ <code>std::memory_order_seq_cst</code> å†…å­˜åºã€‚</p><p>è€ƒè™‘åˆ†è£‚å¼•ç”¨è®¡æ•°çš„ <code>push()</code> å®ç°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#dc322f>void</span> <span style=color:#268bd2>push</span>(T <span style=color:#719e07>const</span><span style=color:#719e07>&amp;</span> data) {
</span></span><span style=display:flex><span>    counted_node_ptr new_node;
</span></span><span style=display:flex><span>    new_node.ptr <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> node(data);
</span></span><span style=display:flex><span>    new_node.external_count <span style=color:#719e07>=</span> <span style=color:#2aa198>1</span>;
</span></span><span style=display:flex><span>    new_node.ptr<span style=color:#719e07>-&gt;</span>next <span style=color:#719e07>=</span> head.load(std<span style=color:#719e07>::</span>memory_order_relaxed);     <span style=color:#586e75>// A
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#719e07>while</span> (<span style=color:#719e07>!</span>head.compare_exchange_weak(new_node.ptr<span style=color:#719e07>-&gt;</span>next, new_node,
</span></span><span style=display:flex><span>                                       std<span style=color:#719e07>::</span>memory_order_release,  <span style=color:#586e75>// B
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>                                       std<span style=color:#719e07>::</span>memory_order_relaxed));<span style=color:#586e75>// C
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>}
</span></span></code></pre></div><ol><li>A æ˜¯åœ¨åŠ è½½ <code>head</code> åœ°å€ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“è¿™ä¸ªå€¼æ˜¯ä»€ä¹ˆï¼Œå¹¶ä¸é€šè¿‡è¿™ä¸ªå€¼å»åšè®¡ç®—æˆ–è€…è®¿é—®æˆå‘˜ï¼Œä¹Ÿä¸éœ€è¦å…¶ä»–åŒæ­¥ä¿è¯ï¼Œæ‰€ä»¥ç”¨ relaxed è¯­ä¹‰å³å¯ã€‚</li><li>B æ˜¯å°† <code>new_node</code> å†™å…¥ <code>head</code>ï¼Œæˆ‘ä»¬å¸Œæœ›è¿™ä¸ªå€¼èƒ½è¢«å…¶ä»–çº¿ç¨‹å¯è§ï¼ˆè¾¾æˆåŒæ­¥ï¼‰ï¼Œæ‰€ä»¥ç”¨ release è¯­ä¹‰ã€‚</li><li>C æ˜¯åœ¨ CAS å¤±è´¥çš„æ—¶å€™å°†æœ€æ–°çš„èŠ‚ç‚¹å€¼åŠ è½½åˆ° <code>new_node.ptr->next</code> ä¸­ä»¥ä¾¿ä¸‹æ¬¡å°è¯•ã€‚è¿™ä¸ªå€¼åªæœ‰æœ¬çº¿ç¨‹èƒ½è®¿é—®ï¼Œä¸éœ€è¦åŒæ­¥ï¼Œæ‰€ä»¥ç”¨ relaxed è¯­ä¹‰ã€‚</li><li>æ³¨æ„è¿™é‡Œ CAS å¾ªç¯ä½“æ˜¯ç©ºçš„ï¼Œæ‰€ä»¥ç”¨ <code>compare_exchange_weak</code> å¯èƒ½æ¯” strong ç‰ˆæœ¬çš„æ›´é«˜æ•ˆã€‚</li></ol><p><code>pop()</code> ä¸­çš„ <code>increase_head_count()</code> å‡½æ•°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#dc322f>void</span> <span style=color:#268bd2>increase_head_count</span>(counted_node_ptr <span style=color:#719e07>&amp;</span> old_counter) {
</span></span><span style=display:flex><span>    counted_node_ptr new_counter;
</span></span><span style=display:flex><span>    <span style=color:#719e07>do</span> {
</span></span><span style=display:flex><span>        new_counter <span style=color:#719e07>=</span> old_counter;
</span></span><span style=display:flex><span>        <span style=color:#719e07>++</span>new_counter.external_count;
</span></span><span style=display:flex><span>    } <span style=color:#719e07>while</span> (<span style=color:#719e07>!</span>head.compare_exchange_strong(old_counter, new_counter,
</span></span><span style=display:flex><span>                                           std<span style=color:#719e07>::</span>memory_order_acquire,   <span style=color:#586e75>// A
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>                                           std<span style=color:#719e07>::</span>memory_order_relaxed)); <span style=color:#586e75>// B
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    old_counter.external_count <span style=color:#719e07>=</span> new_counter.external_count;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol><li>A æ˜¯ä¸€ä¸ª Read-Modify-Write æ“ä½œï¼Œä¸èƒ½ç®€å•åœ°è®¤ä¸ºå®ƒæ˜¯ store æ“ä½œã€‚è¿™é‡Œæƒ³å’Œ <code>push()</code> æ“ä½œåŒæ­¥ï¼ˆå› ä¸ºåé¢è¦è¯»æŒ‡é’ˆé‡Œé¢çš„å†…å®¹ï¼Œå³é€šè¿‡å°† <code>head</code> æ¢æˆ <code>head.ptr->next</code> æ¥å®ç°å–ä¸‹ç»“ç‚¹ï¼‰ï¼Œæ‰€ä»¥ç”¨ acquire è¯­ä¹‰ã€‚</li><li>B ç”¨ relaxed çš„åŸå› åŒ <code>push()</code>ã€‚</li></ol><p>ä¸‹é¢æ˜¯ <code>pop()</code> çš„å…¶ä»–éƒ¨åˆ†ï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span>std<span style=color:#719e07>::</span>shared_ptr<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> pop()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    counted_node_ptr old_head <span style=color:#719e07>=</span> head.load(std<span style=color:#719e07>::</span>memory_order_relaxed);
</span></span><span style=display:flex><span>    <span style=color:#719e07>for</span>(;;)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        increase_head_count(old_head);
</span></span><span style=display:flex><span>        node<span style=color:#719e07>*</span> <span style=color:#719e07>const</span> ptr <span style=color:#719e07>=</span> old_head.ptr;
</span></span><span style=display:flex><span>        <span style=color:#719e07>if</span> (<span style=color:#719e07>!</span>ptr)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#719e07>return</span> std<span style=color:#719e07>::</span>shared_ptr<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#719e07>if</span> (head.compare_exchange_strong(old_head, ptr<span style=color:#719e07>-&gt;</span>next,
</span></span><span style=display:flex><span>                                        std<span style=color:#719e07>::</span>memory_order_relaxed)) <span style=color:#586e75>// A
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>        {
</span></span><span style=display:flex><span>            std<span style=color:#719e07>::</span>shared_ptr<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> res;
</span></span><span style=display:flex><span>            res.swap(ptr<span style=color:#719e07>-&gt;</span>data);
</span></span><span style=display:flex><span>            <span style=color:#dc322f>int</span> <span style=color:#719e07>const</span> count_increase <span style=color:#719e07>=</span> old_head.external_count <span style=color:#719e07>-</span> <span style=color:#2aa198>2</span>;
</span></span><span style=display:flex><span>            <span style=color:#719e07>if</span>(ptr<span style=color:#719e07>-&gt;</span>internal_count.fetch_add(count_increase,
</span></span><span style=display:flex><span>                   std<span style=color:#719e07>::</span>memory_order_release) <span style=color:#719e07>==</span> <span style=color:#719e07>-</span>count_increase) <span style=color:#586e75>// B
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>            {
</span></span><span style=display:flex><span>                <span style=color:#719e07>delete</span> ptr;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#719e07>return</span> res;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#719e07>else</span> <span style=color:#268bd2>if</span> (ptr<span style=color:#719e07>-&gt;</span>internal_count.fetch_add(<span style=color:#719e07>-</span><span style=color:#2aa198>1</span>,
</span></span><span style=display:flex><span>                     std<span style=color:#719e07>::</span>memory_order_relaxed) <span style=color:#719e07>==</span> <span style=color:#2aa198>1</span>) <span style=color:#586e75>// C
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>        {
</span></span><span style=display:flex><span>            ptr<span style=color:#719e07>-&gt;</span>internal_count.load(std<span style=color:#719e07>::</span>memory_order_acquire); <span style=color:#586e75>// D
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>            <span style=color:#719e07>delete</span> ptr;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol><li>A åœ¨ <code>compare_exchange_strong</code> æˆåŠŸåä»£ç ä¼šè®¿é—® <code>ptr->internal_count</code>ï¼Œè¿™ä¸ªæ˜¯ <code>push()</code> æ“ä½œæ”¾è¿›å»çš„ã€‚ä½†æ˜¯æˆ‘ä»¬åœ¨ <code>increase_head_count()</code> æ“ä½œä¸­å·²ç»åšè¿‡å’Œ <code>push()</code> çš„åŒæ­¥äº†ï¼Œæ‰€ä»¥è¿™é‡Œç”¨ relaxed å°±è¡Œã€‚</li><li>å¦‚æœ A è¿™ä¸€æ­¥çš„ CAS å¤±è´¥äº†ï¼Œé™¤å» <code>push()</code> ä¹‹å¤–ï¼Œåªå¯èƒ½æ˜¯å…¶ä»–çº¿ç¨‹çš„ <code>pop()</code> æˆåŠŸäº†ã€‚æˆåŠŸæ—¶æˆ‘ä»¬è¿˜éœ€è¦è¿›è¡Œ <code>swap</code> æ“ä½œï¼Œè¦è¯»å– <code>ptr->data</code>ï¼Œå¸Œæœ›è¿™ä¸ªæ“ä½œæ’åœ¨å…¶ä»–çº¿ç¨‹åˆ é™¤è¿™ä¸ªæŒ‡é’ˆå‰é¢ï¼ˆå¦‚æœä¸æ˜¯æœ¬çº¿ç¨‹åˆ é™¤è¿™ä¸ªæŒ‡é’ˆï¼‰ã€‚å› æ­¤ B åœ¨ä¿®æ”¹å†…éƒ¨å¼•ç”¨è®¡æ•°çš„æ—¶å€™åš release æ“ä½œæ¥åšåŒæ­¥ã€‚</li><li>æ‰¿æ¥ 2ï¼Œå¦‚æœ CAS å¤±è´¥ï¼Œæˆ‘ä»¬åœ¨åˆ é™¤æŒ‡é’ˆä¹‹å‰è¦åšå¥½åŒæ­¥ã€‚å¯ä»¥åœ¨ C ä¸Šé¢é€‰æ‹© release è¯­ä¹‰ã€‚</li><li>åœ¨ C ä¸Šé¢é€‰æ‹© release å†…å­˜åºæ˜¯ overkillã€‚å› ä¸ºåªæœ‰æœ€å¤šä¸€ä¸ªçº¿ç¨‹èƒ½æˆåŠŸè¿›å…¥ C å¤„çš„ <code>if</code> çœŸæ­£è°ƒç”¨ <code>delete</code>ï¼Œå¯¹æ¯ä¸ªçº¿ç¨‹éƒ½ç”¨ release å†…å­˜åºæ˜¯ä¸å¿…è¦çš„ã€‚å› æ­¤ C å¯ä»¥æ”¹æˆ relaxed å†…å­˜åºï¼Œå¹¶ä¸”åœ¨åˆ é™¤æŒ‡é’ˆä¹‹å‰é¢å¤–å¢åŠ ä¸€ä¸ª acquire å†…å­˜åºçš„è¯»å–æ“ä½œæ¥è¾¾åˆ°åŒæ­¥æ•ˆæœã€‚</li></ol><p>è¿™é‡Œ 2~4 çš„åŒæ­¥è¿‡ç¨‹æ˜¯ä¸ºäº†ä¿è¯æŒ‡ä»¤çš„æ‰§è¡Œæ•ˆæœçœ‹ä¸Šå»æ˜¯æœ‰åºçš„ã€‚è®¾æƒ³æ²¡æœ‰åšåŒæ­¥ï¼Œå¯èƒ½ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼ˆ$t_0 < t_1 < t_2$ï¼‰ï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#586e75>// çº¿ç¨‹ 1
</span></span></span><span style=display:flex><span><span style=color:#586e75></span><span style=color:#719e07>if</span> (head.compare_exchange_strong(old_head, ptr<span style=color:#719e07>-&gt;</span>next,
</span></span><span style=display:flex><span>                                 std<span style=color:#719e07>::</span>memory_order_relaxed))
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#dc322f>int</span> <span style=color:#719e07>const</span> count_increase <span style=color:#719e07>=</span> old_head.external_count <span style=color:#719e07>-</span> <span style=color:#2aa198>2</span>;
</span></span><span style=display:flex><span>    <span style=color:#719e07>if</span>(ptr<span style=color:#719e07>-&gt;</span>internal_count.fetch_add(count_increase,
</span></span><span style=display:flex><span>           std<span style=color:#719e07>::</span>memory_order_release) <span style=color:#719e07>==</span> <span style=color:#719e07>-</span>count_increase) <span style=color:#586e75>// t0
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    {
</span></span><span style=display:flex><span>        <span style=color:#719e07>delete</span> ptr; <span style=color:#586e75>// è¿˜æœ‰å…¶ä»–çº¿ç¨‹åœ¨ä½¿ç”¨ï¼Œå› æ­¤æ²¡è¿›æ¥
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    }
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span>shared_ptr<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> res;
</span></span><span style=display:flex><span>    res.swap(ptr<span style=color:#719e07>-&gt;</span>data); <span style=color:#586e75>// t2: ptr-&gt;data å’Œä¸Šé¢çš„æŒ‡ä»¤æ²¡æœ‰ç›¸å…³æ€§ï¼Œå› æ­¤å¯ä»¥é‡æ’
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#719e07>return</span> res;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#586e75>// çº¿ç¨‹ 2
</span></span></span><span style=display:flex><span><span style=color:#586e75></span><span style=color:#719e07>else</span> <span style=color:#268bd2>if</span> (ptr<span style=color:#719e07>-&gt;</span>internal_count.fetch_add(<span style=color:#719e07>-</span><span style=color:#2aa198>1</span>,
</span></span><span style=display:flex><span>             std<span style=color:#719e07>::</span>memory_order_relaxed) <span style=color:#719e07>==</span> <span style=color:#2aa198>1</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#586e75>// ptr-&gt;internal_count.load(std::memory_order_acquire); // å‡è®¾æ²¡æœ‰åšåŒæ­¥
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#586e75>// åŒæ­¥æ˜¯éœ€è¦ä¸¤ä¸ªçº¿ç¨‹é…åˆçš„ï¼Œè¿™é‡Œæ³¨é‡Šæ‰ä¸€ä¸ªå°±èƒ½ç ´ååŒæ­¥
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#719e07>delete</span> ptr; <span style=color:#586e75>// t1
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>}
</span></span></code></pre></div><h2 id=æ¯”è¾ƒè¿™å‡ ç§å¤„ç†å†…å­˜å®‰å…¨é—®é¢˜çš„æ–¹å¼>æ¯”è¾ƒè¿™å‡ ç§å¤„ç†å†…å­˜å®‰å…¨é—®é¢˜çš„æ–¹å¼
<a class=header-anchor href=#%e6%af%94%e8%be%83%e8%bf%99%e5%87%a0%e7%a7%8d%e5%a4%84%e7%90%86%e5%86%85%e5%ad%98%e5%ae%89%e5%85%a8%e9%97%ae%e9%a2%98%e7%9a%84%e6%96%b9%e5%bc%8f></a></h2><ol><li><code>pop()</code> ç®€å•è®¿é—®è®¡æ•°ï¼šæœ‰ç»“ç‚¹å †ç§¯çš„å¯èƒ½æ€§ï¼Œå¯¼è‡´å†…å­˜æ°¸è¿œæ— æ³•å›æ”¶ã€‚</li><li>Hazard pointersï¼šæ€»æ˜¯èƒ½æ— é”ã€‚</li><li>å…±äº«æŒ‡é’ˆä¸Šçš„åŸå­æ“ä½œï¼šå®ç°ç®€å•ï¼Œä½†æ˜¯å—é™äºæ ‡å‡†åº“å®ç°ï¼Œåœ¨å¤§å¤šæ•°å®ç°ä¸Šåšä¸åˆ°æ— é”ã€‚</li><li>åˆ†è£‚å¼•ç”¨è®¡æ•°ï¼šæœ‰ CX16 åˆ™èƒ½æ— é”ï¼Œè®¾è®¡æˆå‹ç¼©æŒ‡é’ˆä¹Ÿèƒ½æ— é”ã€‚</li></ol><p>æœ€åï¼Œä¹¦ä¸Šè¿˜æåˆ°ï¼š</p><blockquote><p>As we move on to look at writing a lock-free queue, youâ€™ll see a similar pattern: lots of the complexity in lock-free code comes from managing memory.</p></blockquote><h1 id=æ— é”çš„çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—>æ— é”çš„çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—
<a class=header-anchor href=#%e6%97%a0%e9%94%81%e7%9a%84%e7%ba%bf%e7%a8%8b%e5%ae%89%e5%85%a8%e9%98%9f%e5%88%97></a></h1><p>è¿™ä¸€èŠ‚åœ¨åˆ†è£‚å¼•ç”¨è®¡æ•°çš„æ— é”æ ˆåŸºç¡€ä¸Šæ¥è€ƒè™‘æ€ä¹ˆå®ç°æ— é”é˜Ÿåˆ—ï¼Œå¾ˆå¤šåœ°æ–¹å¯ä»¥åšå¯¹æ¯”ã€‚</p><h2 id=æ–°å¢-tail-ç»“ç‚¹>æ–°å¢ <code>tail</code> ç»“ç‚¹
<a class=header-anchor href=#%e6%96%b0%e5%a2%9e-tail-%e7%bb%93%e7%82%b9></a></h2><p>é˜Ÿåˆ—æ›´å¤æ‚çš„åœ°æ–¹æ˜¯æ—¢æœ‰ <code>head</code> åˆæœ‰ <code>tail</code>ï¼ˆæ ˆåªæœ‰ <code>head</code>ï¼‰ã€‚ç»§ç»­æ²¿ç”¨<strong>åˆ†è£‚å¼•ç”¨è®¡æ•°</strong>çš„æ€è·¯ï¼Œå¹¶ä¸”<strong>æŠŠ <code>head</code> å’Œ <code>tail</code> éƒ½ä½¿ç”¨åŸå­å˜é‡æ¥å­˜å‚¨</strong>ã€‚</p><p>é‡æ–°è€ƒè™‘ç»“ç‚¹è®¡æ•°å€¼çš„åˆå§‹åŒ–ï¼š</p><ol><li>æ— é”æ ˆå¤–éƒ¨è®¡æ•°å™¨è¢«åˆå§‹åŒ–ä¸º 1ï¼ˆè¢« <code>head</code> å¼•ç”¨ï¼‰ï¼Œæ— é”é˜Ÿåˆ—å¤–éƒ¨è®¡æ•°å™¨è¢«åˆå§‹åŒ–ä¸º 2ï¼ˆè¢« <code>head</code> å’Œ <code>tail</code> å¼•ç”¨ï¼‰ã€‚è¢« <code>head</code> å¼•ç”¨è¡¨ç¤ºè¿˜åœ¨é“¾è¡¨ä¸Šï¼Œè¢« <code>tail</code> å¼•ç”¨è¡¨ç¤ºæ˜¯å°¾ç»“ç‚¹ï¼Œæ¯ä¸ªç»“ç‚¹åˆšè¢«åŠ å…¥æ—¶éƒ½æ˜¯å°¾ç»“ç‚¹ã€‚</li><li>æ— é”æ ˆçš„å†…éƒ¨è®¡æ•°å™¨è¢«åˆå§‹åŒ–ä¸º 0ï¼Œè¿™ä¸€ç‚¹åœ¨æ— é”é˜Ÿåˆ—ä¸Šä¿æŒä¸å˜ã€‚</li></ol><h2 id=å¤–éƒ¨è®¡æ•°å™¨çš„è®¡æ•°å™¨>å¤–éƒ¨è®¡æ•°å™¨çš„è®¡æ•°å™¨
<a class=header-anchor href=#%e5%a4%96%e9%83%a8%e8%ae%a1%e6%95%b0%e5%99%a8%e7%9a%84%e8%ae%a1%e6%95%b0%e5%99%a8></a></h2><p>åœ¨å½“å‰çš„å®ç°ä¸­ï¼ŒæŸä¸ªç»“ç‚¹å¯èƒ½åŒæ—¶è¢« <code>head</code> å’Œ <code>tail</code> å¼•ç”¨ï¼Œå› æ­¤ä»£ç å¼•å…¥äº†ä¸€ä¸ª<strong>å¤–éƒ¨è®¡æ•°å™¨çš„è®¡æ•°å™¨</strong>ï¼Œç§°ä¸º <code>external_counters</code>ã€‚è¿™ä¸ªè®¡æ•°å™¨å’Œå†…éƒ¨è®¡æ•°æ”¾åœ¨ä¸€èµ·ï¼Œç”¨ä½åŸŸå…±äº«ä¸€ä¸ª <code>int</code> ç±»å‹å­—æ®µçš„ç©ºé—´ã€‚</p><p><strong>ä¸ºä»€ä¹ˆéœ€è¦å¤–éƒ¨è®¡æ•°å™¨çš„è®¡æ•°å™¨</strong>ï¼Ÿ</p><p>åœ¨æ— é”æ ˆçš„å®ç°ä¸­ï¼Œæ¯æ¬¡ <code>pop()</code> æ“ä½œå¤±è´¥åéƒ½ä¼šå¯¹å†…éƒ¨è®¡æ•°å™¨å‡ 1ã€‚å½“å†…éƒ¨è®¡æ•°å™¨å‡åˆ° 0 æ—¶ï¼ˆä¹Ÿå°±æ˜¯å‡ 1 åçš„å€¼ä¸º 0ï¼‰ï¼Œæ„å‘³ç€å¯ä»¥å®‰å…¨åœ°åˆ é™¤è¯¥ç»“ç‚¹ã€‚è¿™è¦æ±‚åˆ é™¤ç»“ç‚¹çš„æ“ä½œå¿…é¡»è§‚å¯Ÿåˆ°å†…éƒ¨è®¡æ•°ä¸º 1ï¼Œè€Œè¿™åªèƒ½é€šè¿‡å›æ”¶<strong>å”¯ä¸€çš„å¤–éƒ¨è®¡æ•°å™¨</strong>å¹¶å°†å…¶å€¼ç´¯åŠ åˆ°å†…éƒ¨è®¡æ•°å™¨æ¥å®ç°ï¼Œå› ä¸ºå…¶ä»–æ“ä½œåªä¼šå‡å°å†…éƒ¨è®¡æ•°å™¨ã€‚<strong>ä½†æ˜¯</strong>ï¼Œåœ¨æ— é”é˜Ÿåˆ—ä¸­ï¼Œç”±äº <code>head</code> å’Œ <code>tail</code> éƒ½å¯èƒ½å¯¹åŒä¸€ä¸ªç»“ç‚¹ä¿ç•™å¤–éƒ¨å¼•ç”¨ï¼Œå› æ­¤å†…éƒ¨è®¡æ•°å™¨ä¸º 1 æ—¶åªèƒ½è¯´æ˜<strong>è‡³å°‘æœ‰ä¸€ä¸ªå¤–éƒ¨è®¡æ•°å™¨è¢«å›æ”¶</strong>ï¼Œä½†æ— æ³•ç¡®è®¤æ˜¯å¦<strong>æ‰€æœ‰å¤–éƒ¨è®¡æ•°å™¨éƒ½å·²å›æ”¶</strong>ã€‚è€ƒè™‘åˆ°ç»“ç‚¹çš„<strong>æ€»è®¡æ•°</strong>æ˜¯ç”±<strong>å¤–éƒ¨è®¡æ•°</strong>å’Œ<strong>å†…éƒ¨è®¡æ•°</strong>çš„æ€»å’Œå®šçš„ï¼Œå¦‚æœè¿˜æœ‰å¤–éƒ¨è®¡æ•°å™¨æ²¡æœ‰åŠ å›æ¥ï¼Œå°±ä¸èƒ½å¾—åˆ°çœŸæ­£çš„è®¡æ•°å€¼ã€‚</p><h2 id=pop><code>pop()</code>
<a class=header-anchor href=#pop></a></h2><p><code>pop()</code> æ“ä½œçš„å¾ªç¯é‡è¯•ä¸­ï¼Œå…ˆè¦å¢åŠ  <code>head</code> çš„å¤–éƒ¨è®¡æ•°ï¼Œå¦‚æœå‘ç°é˜Ÿåˆ—ä¸ºç©ºï¼ˆå¤´ç»“ç‚¹å’Œå°¾ç»“ç‚¹æŒ‡å‘åŒä¸€ä¸ªç»“ç‚¹ï¼‰æˆ–è€… CAS ä¿®æ”¹ <code>head</code> å¤±è´¥ï¼ˆæœ‰å…¶ä»–çº¿ç¨‹æŠ¢å…ˆ <code>pop()</code> æ‰äº†å¤´ç»“ç‚¹ï¼‰ï¼Œå°±è¦è¡¥å¿ä¹‹å‰å¢åŠ çš„å¤–éƒ¨è®¡æ•°ã€‚è¡¥å¿çš„æ–¹å¼ä¸æ˜¯ç›´æ¥æ’¤é”€å¤–éƒ¨è®¡æ•°ï¼Œè€Œæ˜¯å°†å†…éƒ¨è®¡æ•°å‡ 1ã€‚å°†å†…éƒ¨è®¡æ•°å‡ 1 ä¹‹åï¼Œè¦æ£€æŸ¥å†…éƒ¨è®¡æ•°æ˜¯å¦ä¸º 0ï¼ŒåŒæ—¶æ²¡æœ‰<strong>å…¶ä»–å¤–éƒ¨è®¡æ•°å™¨</strong>äº†ï¼Œå¦‚æœæ¡ä»¶æ»¡è¶³åˆ™ <code>delete</code> è¿™ä¸ªç»“ç‚¹ã€‚å¦‚æœé˜Ÿåˆ—éç©ºä¸” CAS æˆåŠŸï¼Œé‚£ä¹ˆç»“ç‚¹å°±ä»é“¾è¡¨ä¸ŠæˆåŠŸå–ä¸‹äº†ï¼Œéœ€è¦å°†å¤–éƒ¨è®¡æ•°å™¨æ•°é‡å‡ 1ï¼Œå¹¶å°†å®ƒçš„å€¼å åŠ åˆ°ç»“ç‚¹çš„å†…éƒ¨è®¡æ•°å™¨ä¸Šï¼Œæœ€åå–å‡ºç»“ç‚¹ä¸Šçš„æ•°æ®å¹¶è¿”å›ã€‚</p><p>è€ƒè™‘åˆ° <code>pop()</code> ä¿®æ”¹ <code>head</code> ä¸º <code>head->next</code> ä¹‹åè¦èƒ½ç›´æ¥å–å¾—æ•°æ®ï¼Œæ‰€ä»¥åœ¨ä»¥ä¸‹ A å’Œ B ä¸¤ç§æ¨¡å‹ä¸­åº”è¯¥é€‰æ‹© Aã€‚è¿™å¯ä»¥ä¿æŒ <code>pop()</code> ç®€å•ï¼Œå°½ç®¡ä¼šè®© <code>push()</code> çš„æ›´æ–°å˜å¾—å¤æ‚ä¸€ç‚¹ï¼šä¸èƒ½å°†ç»“ç‚¹åˆ›å»ºå¥½åä¸€æ¬¡æ€§ CAS åˆ° <code>next</code> å­—æ®µä¸Šï¼Œè€Œæ˜¯è¦åˆ†åˆ«ä¿®æ”¹ <code>data</code> å’Œ <code>next</code> å­—æ®µã€‚</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-txt data-lang=txt><span style=display:flex><span>P.S. x è¡¨ç¤ºç»“ç‚¹çš„ data éç©º
</span></span><span style=display:flex><span>A) âœ”
</span></span><span style=display:flex><span>head          head
</span></span><span style=display:flex><span>+---+         +---+   +---+
</span></span><span style=display:flex><span>|   |   ==&gt;   | x |--&gt;|   |
</span></span><span style=display:flex><span>+---+         +---+   +---+
</span></span><span style=display:flex><span>tail                   tail
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>B) âŒ
</span></span><span style=display:flex><span>head          head
</span></span><span style=display:flex><span>+---+         +---+   +---+
</span></span><span style=display:flex><span>|   |   ==&gt;   |   |--&gt;| x |
</span></span><span style=display:flex><span>+---+         +---+   +---+
</span></span><span style=display:flex><span>tail                   tail
</span></span></code></pre></div><h2 id=push><code>push()</code>
<a class=header-anchor href=#push></a></h2><p>æ— é”é˜Ÿåˆ—çš„ <code>push()</code> æ“ä½œæ¶‰åŠåˆ°å°†æ•°æ®æ”¾åˆ° <code>tail->data</code> ä¸­ï¼š</p><ol><li>ä¸€æ–¹é¢è¦å®ç°æ“ä½œçš„åŸå­åŒ–ï¼Œä¿è¯å¤šä¸ªçº¿ç¨‹å¯ä»¥å®‰å…¨è®¿é—®ã€‚ä¹‹å‰çš„æ— é”æ ˆçš„ä¾‹å­ä½¿ç”¨çš„ <code>data</code> å­—æ®µæ˜¯ <code>std::shared_ptr</code> ç±»å‹ï¼Œå¦‚æœæ”¹æˆ <code>std::atomic&lt;std::shared_ptr></code> å°±ä¸èƒ½ä¿è¯æ— é”ã€‚<strong>å› æ­¤éœ€è¦å°†å…¶æ”¹æˆ <code>std::atomic&lt;T*></code></strong>ï¼Œå¹¶åœ¨å¤„ç†è¿‡ç¨‹ä¸­å’Œå‡½æ•°çš„è¿”å›å€¼å¤„ç”¨ <code>std::unique_ptr</code> æ¥ç¡®ä¿å†…å­˜å®‰å…¨ã€‚</li><li>å¦ä¸€æ–¹é¢è¦å®‰å…¨è®¿é—® <code>tail->data</code> å°±è¦ç¡®ä¿ <code>tail</code> ä¸è¢«åˆ æ‰ã€‚å› æ­¤ push() åœ¨å¼€å§‹è®¿é—® <code>tail</code> æ—¶è¦å…ˆå¢åŠ å¤–éƒ¨è®¡æ•°ã€ç»“æŸè®¿é—®æ—¶è¦å‡å°‘æ—§ <code>tail</code> çš„å¤–éƒ¨è®¡æ•°ã€‚ä¹‹å‰æ— é”æ ˆçš„ <code>push()</code> æ“ä½œæ˜¯ä¸éœ€è¦è®¿é—®ç»“ç‚¹å†…éƒ¨å†…å®¹çš„ï¼Œå› æ­¤ä¸æ“ä½œè®¡æ•°å™¨ã€‚</li></ol><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#dc322f>void</span> <span style=color:#268bd2>push</span>(T new_value)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span>unique_ptr<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> new_data(<span style=color:#719e07>new</span> T(new_value));
</span></span><span style=display:flex><span>    counted_node_ptr new_next;
</span></span><span style=display:flex><span>    new_next.ptr<span style=color:#719e07>=</span><span style=color:#719e07>new</span> node;
</span></span><span style=display:flex><span>    new_next.external_count<span style=color:#719e07>=</span><span style=color:#2aa198>1</span>;
</span></span><span style=display:flex><span>    counted_node_ptr old_tail<span style=color:#719e07>=</span>tail.load();
</span></span><span style=display:flex><span>    <span style=color:#719e07>for</span>(;;)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        increase_external_count(tail,old_tail);    
</span></span><span style=display:flex><span>        T<span style=color:#719e07>*</span> old_data<span style=color:#719e07>=</span><span style=color:#719e07>nullptr</span>;
</span></span><span style=display:flex><span>        <span style=color:#719e07>if</span>(old_tail.ptr<span style=color:#719e07>-&gt;</span>data.compare_exchange_strong(   
</span></span><span style=display:flex><span>           old_data,new_data.get()))          <span style=color:#586e75>// A å…ˆå°è¯•æŠŠ data æ”¾ä¸Šå»
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>        {
</span></span><span style=display:flex><span>            old_tail.ptr<span style=color:#719e07>-&gt;</span>next<span style=color:#719e07>=</span>new_next;      <span style=color:#586e75>// æ”¾ä¸Šå»ä¹‹åæ‰ä¿®æ”¹ next
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>            old_tail<span style=color:#719e07>=</span>tail.exchange(new_next); <span style=color:#586e75>// B
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>            free_external_counter(old_tail);
</span></span><span style=display:flex><span>            new_data.release();
</span></span><span style=display:flex><span>            <span style=color:#719e07>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        old_tail.ptr<span style=color:#719e07>-&gt;</span>release_ref();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä¹¦ä¸Šé¦–å…ˆç»™çš„æ˜¯ä¸€ä¸ªæœ‰å¿™ç­‰å¾…çš„å®ç°ï¼Œè¿™ä¼šå¯¼è‡´é˜Ÿåˆ—æœ‰é”ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹ A æ“ä½œæˆåŠŸï¼Œä½†æ˜¯åœ¨ B æ“ä½œä¹‹å‰æ—¶é—´ç‰‡ç”¨å®Œäº†ï¼Œé‚£ä¹ˆå…¶ä»–çº¿ç¨‹å°±åªèƒ½å› ä¸º <code>data</code> å­—æ®µå·²ç»è¢«è®¾ç½®è€Œåœ¨ CAS ä¸Šä¸æ–­å¤±è´¥ã€‚è¿™ä¸ªé—®é¢˜ä¼šåœ¨ä¹‹åçš„å°èŠ‚ä¿®æ­£ã€‚</p><h2 id=é¿å…-push-ä¸­çš„å¿™ç­‰å¾…>é¿å… <code>push()</code> ä¸­çš„å¿™ç­‰å¾…
<a class=header-anchor href=#%e9%81%bf%e5%85%8d-push-%e4%b8%ad%e7%9a%84%e5%bf%99%e7%ad%89%e5%be%85></a></h2><p>ä¸Šä¸€å°èŠ‚ä¸­åªæœ‰æˆåŠŸå­˜å‚¨æ•°æ®çš„çº¿ç¨‹å¯ä»¥æ“ä½œ <code>tail</code>ï¼Œå¯¼è‡´å…¶ä»–çº¿ç¨‹åœ¨å¿™ç­‰å¾…ã€‚å¦‚æœå…¶ä»–çº¿ç¨‹åœ¨ç¢°åˆ°æ•°æ®å­—æ®µå·²ç»è¢«å†™å…¥æ—¶ï¼Œå¯ä»¥è‡ªè¡Œå¼€è¾Ÿæ–°çš„ dummy ç»“ç‚¹å¹¶å°†å…¶æŒ‚åœ¨ <code>next</code> å­—æ®µä¸Šï¼Œç„¶åé‡è¯•å†™å…¥ <code>data</code>ï¼Œå°±å¯ä»¥å®ç°æ— é”ã€‚è¿™æ„å‘³ç€ <code>push()</code> è¿˜è¦å¯¹ <code>tail->next</code> æŒ‡é’ˆåŸå­æ“ä½œï¼Œæ‰€ä»¥ <code>counted_node_ptr</code> ç±»å‹éœ€è¦æ”¹æˆ <code>std::atomic&lt;counted_node_ptr></code> ç±»å‹ã€‚ï¼ˆä¹¦ P245ï¼‰</p><p>å’Œæ— é”æ ˆç›¸æ¯”ï¼Œæ— é”é˜Ÿåˆ—åˆæœ‰ä¸¤ä¸ªå­—æ®µè¢«åŸå­åŒ–äº†ï¼Œç»“æœæ˜¯ï¼šæ¯ä¸ªå­—æ®µéƒ½æ˜¯åŸå­å˜é‡ã€‚</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#586e75>// æ— é”æ ˆï¼ˆåªå±•ç¤ºäº†æ•°æ®æˆå‘˜ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#586e75></span><span style=color:#719e07>struct</span> <span style=color:#268bd2>node</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span>shared_ptr<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> data;
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span>atomic<span style=color:#719e07>&lt;</span><span style=color:#dc322f>int</span><span style=color:#719e07>&gt;</span> internal_count;
</span></span><span style=display:flex><span>    counted_node_ptr next;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75>// æ— é”é˜Ÿåˆ—ï¼ˆåªå±•ç¤ºäº†æ•°æ®æˆå‘˜ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#586e75></span><span style=color:#719e07>struct</span> <span style=color:#268bd2>node</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span>atomic<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>*&gt;</span> data;               <span style=color:#586e75>// åŸå­åŒ–
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    std<span style=color:#719e07>::</span>atomic<span style=color:#719e07>&lt;</span>node_counter<span style=color:#719e07>&gt;</span> count;    <span style=color:#586e75>// int å˜æˆ node_counterï¼ŒåŒ…å«æ–°çš„å¤–éƒ¨è®¡æ•°å™¨è®¡æ•°
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    std<span style=color:#719e07>::</span>atomic<span style=color:#719e07>&lt;</span>counted_node_ptr<span style=color:#719e07>&gt;</span> next; <span style=color:#586e75>// åŸå­åŒ–
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>};
</span></span></code></pre></div><p>æ–°çš„ <code>push()</code> å®ç°å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#719e07>template</span><span style=color:#719e07>&lt;</span><span style=color:#719e07>typename</span> T<span style=color:#719e07>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#719e07>class</span> <span style=color:#268bd2>lock_free_queue</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#719e07>private</span><span style=color:#719e07>:</span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>void</span> set_new_tail(counted_node_ptr <span style=color:#719e07>&amp;</span>old_tail,
</span></span><span style=display:flex><span>                      counted_node_ptr <span style=color:#719e07>const</span> <span style=color:#719e07>&amp;</span>new_tail)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        node<span style=color:#719e07>*</span> <span style=color:#719e07>const</span> current_tail_ptr <span style=color:#719e07>=</span> old_tail.ptr;
</span></span><span style=display:flex><span>        <span style=color:#719e07>while</span> (<span style=color:#719e07>!</span>tail.compare_exchange_weak(old_tail, new_tail) <span style=color:#719e07>&amp;&amp;</span>
</span></span><span style=display:flex><span>               old_tail.ptr <span style=color:#719e07>==</span> current_tail_ptr);
</span></span><span style=display:flex><span>        <span style=color:#719e07>if</span> (old_tail.ptr <span style=color:#719e07>==</span> current_tail_ptr)
</span></span><span style=display:flex><span>            free_external_counter(old_tail);
</span></span><span style=display:flex><span>        <span style=color:#719e07>else</span>
</span></span><span style=display:flex><span>            current_tail_ptr<span style=color:#719e07>-&gt;</span>release_ref();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#719e07>public</span><span style=color:#719e07>:</span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>void</span> push(T new_value)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        std<span style=color:#719e07>::</span>unique_ptr<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> new_data(<span style=color:#719e07>new</span> T(new_value));
</span></span><span style=display:flex><span>        counted_node_ptr new_next;
</span></span><span style=display:flex><span>        new_next.ptr <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> node;
</span></span><span style=display:flex><span>        new_next.external_count <span style=color:#719e07>=</span> <span style=color:#2aa198>1</span>;
</span></span><span style=display:flex><span>        counted_node_ptr old_tail <span style=color:#719e07>=</span> tail.load();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#719e07>for</span> (;;)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            increase_external_count(tail, old_tail);
</span></span><span style=display:flex><span>            T<span style=color:#719e07>*</span> old_data <span style=color:#719e07>=</span> <span style=color:#719e07>nullptr</span>;
</span></span><span style=display:flex><span>            <span style=color:#719e07>if</span> (old_tail.ptr<span style=color:#719e07>-&gt;</span>data.compare_exchange_strong(old_data, new_data.get()))
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                counted_node_ptr old_next <span style=color:#719e07>=</span> {<span style=color:#2aa198>0</span>};
</span></span><span style=display:flex><span>                <span style=color:#719e07>if</span> (<span style=color:#719e07>!</span>old_tail.ptr<span style=color:#719e07>-&gt;</span>next.compare_exchange_strong(old_next, new_next))
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#719e07>delete</span> new_next.ptr;
</span></span><span style=display:flex><span>                    new_next <span style=color:#719e07>=</span> old_next;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#586e75>// set_new_tail å¯èƒ½ä¼šå¤±è´¥ï¼Œå¦‚æœå¤±è´¥è¯´æ˜å…¶ä»–çº¿ç¨‹æˆåŠŸäº†ã€‚ä»ç»“æœæ¥è¯´ tail
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>                <span style=color:#586e75>// ä¸€å®šä¼šè¢«æ›´æ–°ï¼Œå› æ­¤ old_tail ä¸å†è¢« tail å¼•ç”¨ã€‚åŒºåˆ«æ˜¯å¦‚æœæ˜¯æœ¬çº¿ç¨‹æˆåŠŸ
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>                <span style=color:#586e75>// æœ¬çº¿ç¨‹å°±è¦è´Ÿè´£æ¸…ç†å¤–éƒ¨è®¡æ•°ï¼Œå¦åˆ™åªå‡å°å†…éƒ¨è®¡æ•°ã€‚
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>                set_new_tail(old_tail, new_next);
</span></span><span style=display:flex><span>                new_data.release();
</span></span><span style=display:flex><span>                <span style=color:#719e07>break</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#719e07>else</span>
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                counted_node_ptr old_next <span style=color:#719e07>=</span> {<span style=color:#2aa198>0</span>};
</span></span><span style=display:flex><span>                <span style=color:#586e75>// å°½ç®¡æ”¾ data å¤±è´¥äº†ï¼Œè¿˜æ˜¯å¯ä»¥å°è¯•æŠŠ next æ”¾ä¸Šçš„ã€‚
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>                <span style=color:#586e75>// æ˜¯è°æ”¾çš„ next æ— æ‰€è°“ï¼Œå› ä¸ºç¨³å®šåçš„ tail ç»“ç‚¹æ˜¯ dummy çš„ï¼Œé‡Œé¢æ²¡æ”¾æ•°æ®ã€‚
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>                <span style=color:#719e07>if</span> (old_tail.ptr<span style=color:#719e07>-&gt;</span>next.compare_exchange_strong(old_next, new_next))
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    old_next <span style=color:#719e07>=</span> new_next;
</span></span><span style=display:flex><span>                    <span style=color:#586e75>// å¦‚æœå·²ç»æˆåŠŸæ”¾ä¸Šäº†ï¼Œå°±ç”³è¯·ä¸€ä¸ªæ–°çš„ç»“ç‚¹ï¼Œä¿è¯ new_next.ptr å¯ä»¥ç”¨äº
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>                    <span style=color:#586e75>// ä¸‹ä¸€è½®çš„é‡è¯•ã€‚
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>                    new_next.ptr <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> node;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                set_new_tail(old_tail, old_next);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>è¿™ä¸ªè¿‡ç¨‹æœ‰æ¯”è¾ƒå¤šçš„ <code>new</code> å’Œ <code>delete</code> æ“ä½œï¼Œå› æ­¤æœ€å¥½æ˜¯æœ‰ä¸ªä¸“é—¨çš„å†…å­˜åˆ†é…å™¨ã€‚</p><h1 id=aba-é—®é¢˜>ABA é—®é¢˜
<a class=header-anchor href=#aba-%e9%97%ae%e9%a2%98></a></h1><p>å¦‚æœä½¿ç”¨äº†ç»“ç‚¹å›æ”¶ç­‰æœºåˆ¶ï¼Œå°±å®¹æ˜“å‡ºç° ABA é—®é¢˜ã€‚ABA é—®é¢˜åœ¨åŸºäº compare/exchange çš„ç®—æ³•ä¸­å¸¸è§ï¼šä¸¤ä¸ªæŒ‡é’ˆçš„å€¼ç›¸ç­‰ï¼Œå¯èƒ½å®é™…ä¸Šæ˜¯æ—§ç»“ç‚¹å·²ç»è¢«å›æ”¶è¿‡ä¸€æ¬¡å†åˆ†é…å‡ºå»äº†ï¼Œå®ƒä»¬åº”è¯¥æ˜¯ä¸åŒçš„ç»“ç‚¹å´è¢« CAS è®¤ä¸ºå€¼ç›¸ç­‰ã€‚è¦é¿å…è¿™ç§é—®é¢˜å‡ºç°ï¼Œé¦–å…ˆä¼šæƒ³åˆ°çš„æ˜¯åœ¨æŒ‡é’ˆä»è¢«ä½¿ç”¨æ—¶ä¸å¯¹å…¶è¿›è¡Œå›æ”¶ã€‚</p><p>é™¤äº†æŒ‡é’ˆä¹‹å¤–ï¼ŒéæŒ‡é’ˆçš„å…¶ä»–ç±»å‹ä¹Ÿå¯èƒ½ä¼šå‡ºç°è¿™ç§æƒ…å†µã€‚æŸä¸ªçº¿ç¨‹åœ¨ä¸¤ä¸ªæ—¶é—´ç‚¹çœ‹åˆ°çš„å€¼ç›¸ç­‰ï¼Œå¯èƒ½æ˜¯å€¼å˜åŒ–ä¹‹ååˆå˜å›å»äº†ï¼Œå¹¶ä¸æ˜¯ä¸€ç›´æ²¡æœ‰å˜è¿‡ã€‚ä¸­é—´æœ‰åˆ«çš„çº¿ç¨‹çš„å¹²é¢„æ—¶ï¼ŒæŒ‰ç†æ¥è¯´æœ¬çº¿ç¨‹åº”è¯¥é‡è¯•ï¼Œä½†æ˜¯åœ¨è¿™ç§æƒ…å†µä¸‹æœ¬çº¿ç¨‹æ²¡åŠæ³•çŸ¥é“å˜é‡æ˜¯å¦è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹è¿‡ã€‚<strong>é€šè¿‡å°†å€¼å’Œç‰ˆæœ¬å·å­˜å‚¨åœ¨ä¸€èµ·åš CAS</strong>ï¼Œæ¯æ¬¡æ“ä½œåéƒ½å¢åŠ ç‰ˆæœ¬å·ï¼Œå°±å¯ä»¥è§£å†³ ABA é—®é¢˜ã€‚</p></div><footer class=post-footer><div class=post-tags><a href=/tags/cpp>cpp
</a><a href=/tags/cpp-concurrency-in-action>cpp-concurrency-in-action</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/cpp-concurrency-in-action/5.1-libstdc++-%E5%AF%B9%E5%85%B1%E4%BA%AB%E6%8C%87%E9%92%88%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C%E7%9A%84%E6%94%AF%E6%8C%81/ rel=next title="5.1 libstdc++ å¯¹å…±äº«æŒ‡é’ˆåŸå­æ“ä½œçš„æ”¯æŒ"><i class="fa fa-chevron-left"></i> 5.1 libstdc++ å¯¹å…±äº«æŒ‡é’ˆåŸå­æ“ä½œçš„æ”¯æŒ</a></div><div class="post-nav-prev post-nav-item"><a href=/cpp-concurrency-in-action/6.-%E8%AE%BE%E8%AE%A1%E5%9F%BA%E4%BA%8E%E9%94%81%E7%9A%84%E5%B9%B6%E5%8F%91%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/ rel=prev title="6. è®¾è®¡åŸºäºé”çš„å¹¶å‘æ•°æ®ç»“æ„">6. è®¾è®¡åŸºäºé”çš„å¹¶å‘æ•°æ®ç»“æ„
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2023 - 2025
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>ğŸ¤–</span></div><div class=powered-by>ç”± <a href=https://gohugo.io title=0.143.1 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.5.3 target=_blank>Hugo NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨</div></div></footer><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js defer></script><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":false,"save":"manual"},"copybtn":true,"darkmode":false,"hostname":"https://hxhue.github.io/","i18n":{"ds_day":" å¤©å‰","ds_days":" å¤© ","ds_hour":" å°æ—¶å‰","ds_hours":" å°æ—¶ ","ds_just":"åˆšåˆš","ds_min":" åˆ†é’Ÿå‰","ds_mins":" åˆ†é’Ÿ","ds_month":" ä¸ªæœˆå‰","ds_years":" å¹´ ","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","placeholder":"æœç´¢..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":false,"transition":{"collheader":"fadeInLeft","menu_item":"fadeInDown","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":false,"plugin":"waline"},"views":{"enable":false,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"cdnjs","router":"https://cdnjs.cloudflare.com/ajax/libs"},"version":"4.5.3"}</script><script type=text/javascript src=/js/main.min.37ba8b54f9d4d784d08028c45eea93b5d4e13eda8ee7fb0d2edd6f3fac66cfd2.js defer></script></body></html>