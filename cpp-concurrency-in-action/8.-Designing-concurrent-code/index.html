<!doctype html><html lang=zh-CN data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.143.1"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="8. Designing concurrent code"><meta itemprop=description content="ä¸ªäººåšå®¢ï¼Œä¸»è¦æ˜¯é›¶æ•£çš„ç¬”è®°ã€‚"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://hxhue.github.io/imgs/371907.jpg"><meta itemprop=keywords content="cpp,cpp-concurrency-in-action"><link type=text/css rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css><link rel=stylesheet href=/css/main.min.bea76f574a755574e17d42bea39502a74ca3ca4db65807b8c82d3e26dcec8420.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ æˆ‘å¯æ˜¯æœ‰åº•çº¿çš„å“Ÿ ~"}</style><link rel=stylesheet type=text/css href=/css/style.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/github-markdown-css@5.3.0/github-markdown-dark.css><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js></script><script>MathJax={tex:{displayMath:[["$$","$$"],["\\[","\\]"]],inlineMath:[["$","$"],["\\(","\\)"]]},svg:{fontCache:"global"}}</script><script type=module>
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: false });
  mermaid.mermaidAPI.initialize();
  window.mermaid = mermaid;
</script><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":false,"isPage":true,"path":"8.-Designing-concurrent-code","permalink":"https://hxhue.github.io/cpp-concurrency-in-action/8.-Designing-concurrent-code/","title":"8. Designing concurrent code","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>8. Designing concurrent code - Bluegill</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>Bluegill</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description></p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>é¦–é¡µ</a></li><li class="menu-item menu-item-about"><a href=/about/ class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>å…³äº</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>å½’æ¡£</a></li><li class="menu-item menu-item-categories"><a href=/categories/ class=hvr-icon-pulse rel=section><i class="fa fa-th hvr-icon"></i>åˆ†ç±»</a></li><li class="menu-item menu-item-tags"><a href=/tags/ class=hvr-icon-pulse rel=section><i class="fa fa-hashtag hvr-icon"></i>æ ‡ç­¾</a></li><li class="menu-item menu-item-daily"><a href=/daily/ class=hvr-icon-pulse rel=section><i class="fa fa-newspaper hvr-icon"></i>éšç¬”</a></li><li class="menu-item menu-item-discovery"><a href=https://rift-fear-f2c.notion.site/2025-1e354a33cfb1802c841bdf29f2f3dab3 class=hvr-icon-pulse rel=section><i class="fa fa-compass hvr-icon"></i>å‘ç°</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>æœç´¢</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=æœç´¢... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>æ–‡ç« ç›®å½•</li><li class=sidebar-nav-overview>ç«™ç‚¹æ¦‚è§ˆ</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#false-sharing>False sharing</a><ul><li><a href=#stdhardware_destructive_interference_sizehttpsencppreferencecomwcppthreadhardware_destructive_interference_size><a href=https://en.cppreference.com/w/cpp/thread/hardware_destructive_interference_size><code>std::hardware_destructive_interference_size</code></a></a></li></ul></li><li><a href=#ä¾‹å­çŸ©é˜µè®¡ç®—>ä¾‹å­ï¼šçŸ©é˜µè®¡ç®—</a></li><li><a href=#data-access-patterns-in-other-data-structures>Data access patterns in other data structures</a><ul><li><a href=#ä¾‹æ ‘çŠ¶ç»“æ„>ä¾‹ï¼šæ ‘çŠ¶ç»“æ„</a></li><li><a href=#ä¾‹mutex>ä¾‹ï¼šMutex</a></li></ul></li><li><a href=#exception-safety-in-parallel-algorithms>Exception safety in parallel algorithms</a><ul><li><a href=#stdterminate><code>std::terminate()</code></a></li><li><a href=#stdabort><code>std::abort</code></a></li><li><a href=#stdmem_fn><code>std::mem_fn</code></a></li></ul></li><li><a href=#å¹¶è¡ŒåŒ–-stdaccumulate>å¹¶è¡ŒåŒ– <code>std::accumulate</code></a><ul><li><a href=#ç”¨-stdpackaged_task-ä¿éšœå¼‚å¸¸å®‰å…¨>ç”¨ <code>std::packaged_task</code> ä¿éšœå¼‚å¸¸å®‰å…¨</a></li><li><a href=#ç”¨-stdasync-ä¿éšœå¼‚å¸¸å®‰å…¨>ç”¨ <code>std::async</code> ä¿éšœå¼‚å¸¸å®‰å…¨</a></li></ul></li><li><a href=#å¹¶è¡ŒåŒ–-stdfor_each>å¹¶è¡ŒåŒ– <code>std::for_each</code></a></li><li><a href=#å¹¶è¡ŒåŒ–-stdfind>å¹¶è¡ŒåŒ– <code>std::find</code></a><ul><li><a href=#ç”¨-stdthread--stdpromise-å®ç°>ç”¨ <code>std::thread</code> + <code>std::promise</code> å®ç°</a></li><li><a href=#ç”¨-stdasync-å®ç°>ç”¨ <code>std::async</code> å®ç°</a></li></ul></li><li><a href=#å¹¶è¡ŒåŒ–-stdpartial_sum>å¹¶è¡ŒåŒ– <code>std::partial_sum</code></a><ul><li><a href=#æ–¹æ³•ä¸€æ¯ä¸ªçº¿ç¨‹å„è‡ªè´Ÿè´£ä¸€ä¸ª-chunk>æ–¹æ³•ä¸€ï¼šæ¯ä¸ªçº¿ç¨‹å„è‡ªè´Ÿè´£ä¸€ä¸ª chunk</a></li><li><a href=#æ–¹æ³•äºŒthe-incremental-pairwise-algorithm>æ–¹æ³•äºŒï¼šThe incremental pairwise algorithm</a><ul><li><a href=#ä¸¤æœ¬ä¹¦é‡Œé¢ç”¨çš„æ˜¯ä»€ä¹ˆç®—æ³•>ä¸¤æœ¬ä¹¦é‡Œé¢ç”¨çš„æ˜¯ä»€ä¹ˆç®—æ³•ï¼Ÿ</a><ul><li><a href=#koggle-stone-ç®—æ³•>Koggle-Stone ç®—æ³•</a></li><li><a href=#brent-kung-ç®—æ³•>Brent-Kung ç®—æ³•</a></li></ul></li><li><a href=#åŒç¼“å†²>åŒç¼“å†²</a></li><li><a href=#barrier-çš„ä½¿ç”¨>Barrier çš„ä½¿ç”¨</a></li><li><a href=#çº¿ç¨‹çš„æå‰é€€å‡º>çº¿ç¨‹çš„æå‰é€€å‡º</a></li><li><a href=#segmented-scan-å’Œ-stream-based-scan>Segmented scan å’Œ stream-based scan</a></li></ul></li></ul></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=ğŸ¤– src=/imgs/371907.jpg><p class=site-author-name itemprop=name>ğŸ¤–</p><div class=site-description itemprop=description>ä¸ªäººåšå®¢ï¼Œä¸»è¦æ˜¯é›¶æ•£çš„ç¬”è®°ã€‚</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>433</span>
<span class=site-state-item-name>æ—¥å¿—</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>12</span>
<span class=site-state-item-name>åˆ†ç±»</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>86</span>
<span class=site-state-item-name>æ ‡ç­¾</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/hxhue title="Github â†’ https://github.com/hxhue" rel=noopener target=_blank><i class="fab fa-github fa-fw"></i>
Github
</a></span><span class=links-of-social-item><a href=/rss.xml title="RSS è®¢é˜… â†’ /rss.xml" rel=noopener target=_blank><i class="fa fa-rss fa-fw"></i>
RSS è®¢é˜…</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=å…±äº«çŸ¥è¯†><img src=/imgs/cc/big/by_nc_sa.svg alt=å…±äº«çŸ¥è¯†></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
å‹æƒ…é“¾æ¥</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://shuai.guru/ title=https://shuai.guru/ target=_blank>shuai.guru</a></li></ul></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=toggle-theme class=button title=æ·±æµ…æ¨¡å¼åˆ‡æ¢><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=è¿”å›é¡¶éƒ¨><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://hxhue.github.io/cpp-concurrency-in-action/8.-Designing-concurrent-code/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/371907.jpg"><meta itemprop=name content="ğŸ¤–"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="ğŸ¤–"><meta itemprop=description content="ä¸ªäººåšå®¢ï¼Œä¸»è¦æ˜¯é›¶æ•£çš„ç¬”è®°ã€‚"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="8. Designing concurrent code"><meta itemprop=description content="False sharing


Cache ping-pong

std::hardware_destructive_interference_size

è¿˜æœ‰ std::hardware_constructive_interference_sizeã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹è¿™ä¸¤ä¸ªå€¼ç›¸ç­‰ï¼Œè€Œä¸”éƒ½ç­‰äº cache line çš„å¤§å°ã€‚"></span><header class=post-header><h1 class=post-title itemprop="name headline">8. Designing concurrent code</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=å‘è¡¨äº>å‘è¡¨äºï¼š
</span><time title="åˆ›å»ºæ—¶é—´ï¼š2025-01-16 00:00:00 +0800 CST" itemprop="dateCreated datePublished" datetime="2025-01-16 00:00:00 +0800 CST">2025-01-16
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar-check"></i>
</span><span class=post-meta-item-text title=æ›´æ–°äº>æ›´æ–°äºï¼š
</span><time title=ä¿®æ”¹æ—¶é—´ï¼š2025-03-07T00:00:00+08:00 itemprop=dateModified datetime=2025-03-07T00:00:00+08:00>2025-03-07</time>
</span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i>
</span><span class=post-meta-item-text title=åˆ†ç±»äº>åˆ†ç±»äºï¼š
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/cpp-concurrency-in-action itemprop=url rel=index><span itemprop=name>cpp-concurrency-in-action</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=å­—æ•°><span class=post-meta-item-icon><i class="far fa-file-word"></i>
</span><span class=post-meta-item-text>å­—æ•°ï¼š</span>
<span>6011</span>
</span><span class=post-meta-item title=é˜…è¯»><span class=post-meta-item-icon><i class="far fa-clock"></i>
</span><span class=post-meta-item-text>é˜…è¯»ï¼š&ap;</span>
<span>12åˆ†é’Ÿ</span></span></div></div></header><div class=post-body itemprop=articleBody><h1 id=false-sharing>False sharing
<a class=header-anchor href=#false-sharing></a></h1><ul><li>Cache ping-pong</li></ul><h2 id=stdhardware_destructive_interference_sizehttpsencppreferencecomwcppthreadhardware_destructive_interference_size><a href=https://en.cppreference.com/w/cpp/thread/hardware_destructive_interference_size title=std::hardware_destructive_interference_size rel="noopener external nofollow noreferrer" target=_blank class=exturl><code>std::hardware_destructive_interference_size</code><i class="fa fa-external-link-alt"></i></a>
<a class=header-anchor href=#stdhardware_destructive_interference_sizehttpsencppreferencecomwcppthreadhardware_destructive_interference_size></a></h2><p>è¿˜æœ‰ <code>std::hardware_constructive_interference_size</code>ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹è¿™ä¸¤ä¸ªå€¼ç›¸ç­‰ï¼Œè€Œä¸”éƒ½ç­‰äº cache line çš„å¤§å°ã€‚</p><p><a href=https://stackoverflow.com/questions/39680206/understanding-stdhardware-destructive-interference-size-and-stdhardware-cons title=https://stackoverflow.com/questions/39680206/understanding-stdhardware-destructive-interference-size-and-stdhardware-cons rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://stackoverflow.com/questions/39680206/understanding-stdhardware-destructive-interference-size-and-stdhardware-cons<i class="fa fa-external-link-alt"></i></a> ç¬¬ä¸€ä¸ªå›ç­”çš„è¯„è®ºé‡Œé¢æŒ‡å‡ºå¦‚æœç›®æ ‡å¹³å°æœ‰å¤šä¸ªï¼Œé‚£ä¹ˆä¸ºäº†å…¼å®¹æ€§ï¼Œè¿™ä¸¤ä¸ªå¸¸é‡å¯èƒ½æ˜¯ä¸åŒçš„ã€‚åœ¨ç‰¹å®šæ¶æ„ä¸Šè¿™ä¸¤ä¸ªå¸¸é‡åº”è¯¥æ˜¯ç›¸åŒçš„ã€‚</p><h1 id=ä¾‹å­çŸ©é˜µè®¡ç®—>ä¾‹å­ï¼šçŸ©é˜µè®¡ç®—
<a class=header-anchor href=#%e4%be%8b%e5%ad%90%e7%9f%a9%e9%98%b5%e8%ae%a1%e7%ae%97></a></h1><p><img src=/cpp-concurrency-in-action/assets/Pasted%20image%2020250116084034.webp></p><ol><li>æ¯ä¸ªçº¿ç¨‹è®¡ç®—ä¸€ç»„åˆ—ã€‚åˆ—å¯ä»¥å…ˆåŠ è½½åˆ°å½“å‰çº¿ç¨‹ï¼Œæ¯æ¬¡éƒ½è¯»ä¸€æ•´è¡Œï¼Œå¯¹ cache å‹å¥½ã€‚</li><li>æ¯ä¸ªçº¿ç¨‹è®¡ç®—ä¸€ç»„è¡Œã€‚ç›¸æ¯”äºæ–¹æ¡ˆ 1ï¼Œè¯»çš„ false sharing æ›´å¤šï¼Œä½†æ˜¯<strong>å†™æ“ä½œ</strong>çš„ false sharing ä¼šæ›´å°‘ã€‚</li><li>åˆ†å—çŸ©é˜µã€‚<strong>è®¿é—®è¾“å…¥çŸ©é˜µå…ƒç´ çš„æ•°é‡å‡å°‘äº†</strong>ï¼ŒåŒæ—¶ä¿æŒè®¡ç®—å‡ºæ¥çš„å…ƒç´ æ•°ç›¸åŒï¼Œå› è€Œæ•ˆç‡æ›´é«˜ã€‚</li></ol><h1 id=data-access-patterns-in-other-data-structures>Data access patterns in other data structures
<a class=header-anchor href=#data-access-patterns-in-other-data-structures></a></h1><h2 id=ä¾‹æ ‘çŠ¶ç»“æ„>ä¾‹ï¼šæ ‘çŠ¶ç»“æ„
<a class=header-anchor href=#%e4%be%8b%e6%a0%91%e7%8a%b6%e7%bb%93%e6%9e%84></a></h2><p>æ ‘çŠ¶ç»“æ„ç»“ç‚¹å°ï¼Œä¸åŒçº¿ç¨‹å¦‚æœè®¿é—®ä¸åŒç»“ç‚¹ï¼Œcache line é‡å æ¦‚ç‡å°ï¼Œå¯¹ false sharing æœ‰åˆ©ã€‚</p><h2 id=ä¾‹mutex>ä¾‹ï¼šMutex
<a class=header-anchor href=#%e4%be%8bmutex></a></h2><p>Mutex å’Œå—ä¿æŠ¤æ•°æ®åœ¨åŒä¸€ä¸ª cache line æ—¶ï¼Œå…¶ä»–çº¿ç¨‹å°è¯•ä¸Šé”å¯¹æŒæœ‰é”çš„çº¿ç¨‹æ€§èƒ½æœ‰å½±å“ã€‚</p><blockquote><p>Mutex locks are typically implemented as a read-modify-write atomic operation on a memory location within the mutex to try to acquire the mutex, followed by a call to the operating system kernel if the mutex is already locked.</p></blockquote><p>å½“ mutex å’Œå—ä¿æŠ¤æ•°æ®è¦å­˜åœ¨ä¸€èµ·æ—¶ï¼Œå¯ä»¥åœ¨æ•°æ®ç»“æ„ä¸­å¢åŠ  padding ä»¥éš”å¼€ä¸¤è€…ã€‚</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#719e07>struct</span> <span style=color:#268bd2>protected_data</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    std<span style=color:#719e07>::</span>mutex m;
</span></span><span style=display:flex><span>    <span style=color:#dc322f>char</span> padding[std<span style=color:#719e07>::</span>hardware_destructive_interference_size];
</span></span><span style=display:flex><span>    my_data data_to_protect;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>æˆ–è€…åƒ cppreference è¿™æ ·å¯¹è¦åŒºåˆ†çš„ä¸¤æ®µæ•°æ®ç”¨ <code>alignas</code>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#719e07>struct</span> <span style=color:#268bd2>keep_apart</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#719e07>alignas</span>(std<span style=color:#719e07>::</span>hardware_destructive_interference_size) std<span style=color:#719e07>::</span>atomic<span style=color:#719e07>&lt;</span><span style=color:#dc322f>int</span><span style=color:#719e07>&gt;</span> cat;
</span></span><span style=display:flex><span>    <span style=color:#719e07>alignas</span>(std<span style=color:#719e07>::</span>hardware_destructive_interference_size) std<span style=color:#719e07>::</span>atomic<span style=color:#719e07>&lt;</span><span style=color:#dc322f>int</span><span style=color:#719e07>&gt;</span> dog;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><div class="markdown-alert markdown-alert-tip"><p class=markdown-alert-title><svg class="octicon octicon-light-bulb mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M8 1.5c-2.363.0-4 1.69-4 3.75.0.984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75.0 01-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456.0 00-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863.0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751.0 01-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304.0-2.06-1.637-3.75-4-3.75zM5.75 12h4.5a.75.75.0 010 1.5h-4.5a.75.75.0 010-1.5zM6 15.25a.75.75.0 01.75-.75h2.5a.75.75.0 010 1.5h-2.5A.75.75.0 016 15.25z"/></svg>Tip</p><p><code>std::hardware_destructive_interference_size</code> è¡¨ç¤ºé¿å… false sharing çš„æœ€å°å¤§å°ã€‚<code>std::hardware_constructive_interference_size</code> è¡¨ç¤ºç§¯æä½¿ç”¨ true sharing çš„æœ€å¤§å¤§å°ã€‚</p></div><p>é™¤äº† <code>hardware_destructive_interference_size</code> å’Œ <code>hardware_constructive_interference_size</code> æš—ç¤ºäº† cache line çš„å¤§å°ä¹‹å¤–ï¼Œåœ¨ Linux ä¸‹æˆ‘ä»¬è¿˜èƒ½ç”¨ /sys æ–‡ä»¶ç³»ç»Ÿä¸‹çš„ä¿¡æ¯å¾—åˆ° cache line å¤§å°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#719e07>(</span>base<span style=color:#719e07>)</span> âœ  main cat /sys/devices/system/cpu/cpu0/cache/index0/coherency_line_size
</span></span><span style=display:flex><span><span style=color:#2aa198>64</span>
</span></span></code></pre></div><h1 id=exception-safety-in-parallel-algorithms>Exception safety in parallel algorithms
<a class=header-anchor href=#exception-safety-in-parallel-algorithms></a></h1><h2 id=stdterminate><code>std::terminate()</code>
<a class=header-anchor href=#stdterminate></a></h2><blockquote><p>By contrast, in a parallel algorithm many of the operations will be running on separate threads. In this case, the exception canâ€™t be allowed to propagate because itâ€™s on the wrong call stack.</p></blockquote><p>å¦‚æœä¸æ­£ç¡®å¤„ç†å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„å¼‚å¸¸ï¼Œä»»ä½•çº¿ç¨‹æŠ›å‡ºæœªå¤„ç†çš„å¼‚å¸¸éƒ½ä¼šå¯¼è‡´ <code>std::terminate()</code> è¢«è°ƒç”¨ï¼Œæ•´ä¸ªè¿›ç¨‹è¢«ç»ˆæ­¢ï¼Œè§ <a href=https://godbolt.org/z/czPe8dbe8 title=https://godbolt.org/z/czPe8dbe8 rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://godbolt.org/z/czPe8dbe8<i class="fa fa-external-link-alt"></i></a> ã€‚è¾“å‡ºå¯èƒ½åƒè¿™æ ·ï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-txt data-lang=txt><span style=display:flex><span>terminate called after throwing an instance of &#39;std::runtime_error&#39;
</span></span><span style=display:flex><span>  what():  Exception from Thread B
</span></span><span style=display:flex><span>Program terminated with signal: SIGSEGV
</span></span></code></pre></div><p><code>std::terminate()</code> ä¼šå…ˆæ‰“å°å½“å‰çš„å¼‚å¸¸ï¼Œå†é€€å‡ºç¨‹åºã€‚å¦‚æœå½“å‰æ²¡æœ‰å¼‚å¸¸ï¼Œæ§åˆ¶å°è¾“å‡ºå¯èƒ½ä¸ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-txt data-lang=txt><span style=display:flex><span>terminate called without an active exception
</span></span><span style=display:flex><span>Program terminated with signal: SIGSEGV
</span></span></code></pre></div><p><strong>è¿™å…¶å®æ˜¯é»˜è®¤çš„ terminate handler åšçš„äº‹æƒ…</strong>ï¼Œå®ƒå…ˆæ‰“å°å¼‚å¸¸å†è°ƒç”¨ <code>std::abort()</code>ï¼Œä»£ç å¯å‚è€ƒ GCC æºç çš„ libstdc++-v3/libsupc++/vterminate.ccã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥ä¿®æ”¹ terminate handlerï¼Œå®ƒæ˜¯ä¸€ä¸ªå…¨å±€çš„ handlerï¼Œè€Œä¸” <code>set_terminate</code> å’Œ <code>get_terminate</code> éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p><blockquote><p>In any case,Â <code>std::terminate</code>Â calls the currently installedÂ <a href=https://en.cppreference.com/w/cpp/error/terminate_handler title=std::terminate_handler rel="noopener external nofollow noreferrer" target=_blank class=exturl>std::terminate_handler<i class="fa fa-external-link-alt"></i></a>. The defaultÂ <a href=https://en.cppreference.com/w/cpp/error/terminate_handler title=std::terminate_handler rel="noopener external nofollow noreferrer" target=_blank class=exturl>std::terminate_handler<i class="fa fa-external-link-alt"></i></a>Â callsÂ <a href=https://en.cppreference.com/w/cpp/utility/program/abort title=std::abort rel="noopener external nofollow noreferrer" target=_blank class=exturl>std::abort<i class="fa fa-external-link-alt"></i></a>. &ndash; <a href=https://en.cppreference.com/w/cpp/error/terminate title=https://en.cppreference.com/w/cpp/error/terminate rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://en.cppreference.com/w/cpp/error/terminate<i class="fa fa-external-link-alt"></i></a></p></blockquote><p>å°½ç®¡èƒ½ç”¨ <code>std::set_terminate</code> æ¥ä¿®æ”¹ <code>std::terminate_handler</code>ï¼Œä½†æ ‡å‡†è§„å®š handler ä¸èƒ½è¿”å›åˆ° callerï¼Œå¦åˆ™<strong>æœªå®šä¹‰</strong>ï¼Œæ‰€ä»¥ä¸€èˆ¬åªèƒ½åšä¸€äº›æ—¥å¿—æˆ–æ¸…ç†æ“ä½œï¼Œç„¶åç»ˆæ­¢ç¨‹åºã€‚</p><blockquote><p>fÂ shall terminate execution of the program without returning to its caller, otherwise the behavior is undefined. &ndash; <a href=https://en.cppreference.com/w/cpp/error/set_terminate title=https://en.cppreference.com/w/cpp/error/set_terminate rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://en.cppreference.com/w/cpp/error/set_terminate<i class="fa fa-external-link-alt"></i></a></p></blockquote><h2 id=stdabort><code>std::abort</code>
<a class=header-anchor href=#stdabort></a></h2><p><code>std::abort</code>ï¼ˆæ¥è‡ª cstdlibï¼‰é€šè¿‡ SIGABRT ä¿¡å·ç»ˆæ­¢ç¨‹åºï¼Œä¸ä¼šæ¸…ç†èµ„æºï¼š</p><ol><li>ææ„å‡½æ•°ä¸ä¼šè¢«è°ƒç”¨ã€‚</li><li><code>std::atexit()</code> å’Œ <code>std::at_quick_exit()</code> æ³¨å†Œçš„å‡½æ•°ä¸ä¼šè¢«è°ƒç”¨ã€‚</li><li>æ–‡ä»¶ç­‰è¢«æ‰“å¼€çš„èµ„æºæ˜¯å¦è¢«å…³é—­ç”±å®ç°å®šä¹‰ã€‚</li></ol><p><del>è™½ç„¶ C++ æ ‡å‡†æ²¡æœ‰è¯´æ˜å¦‚æœ SIGABRT ä¿¡å·è¢«æ•è·æ˜¯å¦è¿˜èƒ½ç»ˆæ­¢ç¨‹åº</del>ï¼ŒPOSIX æ ‡å‡†è¯´æ˜äº† <code>abort()</code> ä¼š override å¯¹ä¿¡å·çš„é˜»å¡æˆ–è€…å¿½ç•¥ã€‚C++ æ ‡å‡†è¯´çš„æ˜¯ï¼ˆC è¯­è¨€æ ‡å‡†ç±»ä¼¼ï¼‰ï¼š</p><blockquote><p>Causes abnormal program termination unlessÂ <a href=https://en.cppreference.com/w/cpp/utility/program/SIG_types title=SIGABRT rel="noopener external nofollow noreferrer" target=_blank class=exturl>SIGABRT<i class="fa fa-external-link-alt"></i></a>Â is being caught by a signal handler passed toÂ <a href=https://en.cppreference.com/w/cpp/utility/program/signal title=std::signal rel="noopener external nofollow noreferrer" target=_blank class=exturl>std::signal<i class="fa fa-external-link-alt"></i></a>Â and the handler does not return.</p></blockquote><p>å³å¦‚æœ SIGABRT è¢«æ•è·äº†è€Œä¸”è¯¥ä¿¡å·å¤„ç†å™¨è¿”å›äº†ï¼Œé‚£ä¹ˆè¿˜æ˜¯ä¼šå¼ºåˆ¶ç»ˆæ­¢ç¨‹åºã€‚</p><p>ä» <a href=https://en.cppreference.com/w/cpp/utility/program/abort title="C++ æ ‡å‡†" rel="noopener external nofollow noreferrer" target=_blank class=exturl>C++ æ ‡å‡†<i class="fa fa-external-link-alt"></i></a> æ¥çœ‹ <code>std::abort</code> ä½¿ç”¨çš„ä¿¡å·æ˜¯ SIGABRTï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆé€€å‡ºæ—¶æ˜¾ç¤ºçš„ä¿¡å·æ˜¯ SIGSEGV å‘¢ï¼Ÿ<a href=https://www.reddit.com/r/Cplusplus/comments/14n0kh3/why_do_my_unhandledexceptionprogram_result_in/ title="Reddit å¸–å­" rel="noopener external nofollow noreferrer" target=_blank class=exturl>Reddit å¸–å­<i class="fa fa-external-link-alt"></i></a> è¯´è¿™ä¸ªæ˜¯ compiler explorer æ²™ç›’çš„é—®é¢˜ï¼Œæˆ‘åœ¨ WSL ä¸­é‡æ–°å°è¯•å°±ç¡®å®çœ‹åˆ°äº†ç¨‹åºä»¥ 134 é€€å‡ºç ç»“æŸï¼ˆ$128 + 6 = 134$ï¼Œä» <code>kill -l</code> ä¸­å¯ä»¥çœ‹åˆ° 6 å·ä¿¡å·å°±æ˜¯ SIGABRTï¼‰ã€‚</p><h2 id=stdmem_fn><code>std::mem_fn</code>
<a class=header-anchor href=#stdmem_fn></a></h2><p><a href=https://en.cppreference.com/w/cpp/utility/functional/mem_fn title=https://en.cppreference.com/w/cpp/utility/functional/mem_fn rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://en.cppreference.com/w/cpp/utility/functional/mem_fn<i class="fa fa-external-link-alt"></i></a> ç»™äººä¸€ç§å¯ä»¥æŠŠæˆå‘˜å‡½æ•°è½¬æ¢æˆ UFCS çš„æ„Ÿè§‰ã€‚å¦‚æœä¸€ä¸ªæ¨¡æ¿å‡½æ•°æœŸæœ›æ™®é€š unary å‡½æ•°ï¼Œè€Œä¸ä¼šä¸“é—¨å¤„ç†æ— å‚<strong>æˆå‘˜å‡½æ•°</strong>ï¼Œé‚£ä¹ˆå¯ä»¥å°†æ— å‚æˆå‘˜å‡½æ•°è½¬æ¢æˆæ™®é€š unary å‡½æ•°ï¼Œæ¯”å¦‚ï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span>for_each(v.begin(), v.end(), mem_fn(<span style=color:#719e07>&amp;</span>Item<span style=color:#719e07>::</span>Foo));
</span></span></code></pre></div><p>è¿™æ ·æ¯”è‡ªå·±å†™ä¸€ä¸ª lambda æ›´åŠ ç®€æ´ã€‚</p><h1 id=å¹¶è¡ŒåŒ–-stdaccumulate>å¹¶è¡ŒåŒ– <code>std::accumulate</code>
<a class=header-anchor href=#%e5%b9%b6%e8%a1%8c%e5%8c%96-stdaccumulate></a></h1><div class="markdown-alert markdown-alert-important"><p class=markdown-alert-title><svg class="octicon octicon-report mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 1.75C0 .784.784.0 1.75.0h12.5C15.216.0 16 .784 16 1.75v9.5A1.75 1.75.0 0114.25 13H8.06l-2.573 2.573A1.458 1.458.0 013 14.543V13H1.75A1.75 1.75.0 010 11.25zm1.75-.25a.25.25.0 00-.25.25v9.5c0 .138.112.25.25.25h2a.75.75.0 01.75.75v2.19l2.72-2.72a.749.749.0 01.53-.22h6.5a.25.25.0 00.25-.25v-9.5a.25.25.0 00-.25-.25zm7 2.25v2.5a.75.75.0 01-1.5.0v-2.5a.75.75.0 011.5.0zM9 9A1 1 0 117 9a1 1 0 012 0z"/></svg>Important</p><p>ä¹¦ä¸Šçš„å®ç°æ²¡æœ‰ä¿è¯ç»“åˆé¡ºåºï¼Œä½†æ˜¯ <code>std::accumulate</code> æ˜¯è¦æ±‚ä¿è¯ç»“åˆé¡ºåºæ˜¯ä»å·¦åˆ°å³çš„ï¼Œæ‰€ä»¥ä¹¦ä¸Šå®ç°çš„æ›´æ¥è¿‘ <code>std::reduce</code>ã€‚</p></div><div class="markdown-alert markdown-alert-note"><p class=markdown-alert-title><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1116 0A8 8 0 010 8zm8-6.5a6.5 6.5.0 100 13 6.5 6.5.0 000-13zM6.5 7.75A.75.75.0 017.25 7h1a.75.75.0 01.75.75v2.75h.25a.75.75.0 010 1.5h-2a.75.75.0 010-1.5h.25v-2h-.25a.75.75.0 01-.75-.75zM8 6a1 1 0 110-2 1 1 0 010 2z"/></svg>Note</p><p><code>std::accumulate</code> å¹¶ä¸åœ¨ <code>&lt;algorithm></code> å¤´æ–‡ä»¶ä¸­ï¼Œè€Œåœ¨ <code>&lt;numeric></code> å¤´æ–‡ä»¶ä¸­ã€‚å®ƒä¹Ÿæ²¡æœ‰æ¥å— ExecutionPolicy å‚æ•°çš„é‡è½½ã€‚ï¼ˆä¸å¯ä»¥è®¤ä¸ºæ‰€æœ‰ <code>&lt;numeric></code> å¤´æ–‡ä»¶ä¸­çš„ç®—æ³•éƒ½ä¸æ¥å—æ‰§è¡Œç­–ç•¥ï¼Œæœ‰äº›æ˜¯æ¥å—çš„ï¼Œæ¯”å¦‚ <code>std::reduce</code> / <code>std::inclusive_scan</code> / <code>std::transform_exclusive_scan</code> / <code>std::transform_reduce</code> ç­‰ã€‚ï¼‰</p></div><h2 id=ç”¨-stdpackaged_task-ä¿éšœå¼‚å¸¸å®‰å…¨>ç”¨ <code>std::packaged_task</code> ä¿éšœå¼‚å¸¸å®‰å…¨
<a class=header-anchor href=#%e7%94%a8-stdpackaged_task-%e4%bf%9d%e9%9a%9c%e5%bc%82%e5%b8%b8%e5%ae%89%e5%85%a8></a></h2><p><code>std::packaged_task</code> åˆ›å»ºçš„çº¿ç¨‹ä¼šå®‰å…¨åœ°å¤„ç†å¼‚å¸¸ï¼Œå¹¶å°†å¼‚å¸¸è®°å½•åœ¨ <code>std::future</code> ä¸­ï¼Œç”± <code>std::future</code> çš„è·å–è¿™æ¥å¤„ç†ã€‚</p><blockquote><p>The key thing to note for exception safety is that if you destroy the future without waiting for it, the destructor will wait for the thread to complete. This neatly avoids the problem of leaked threads that are still executing and holding references to the data.</p></blockquote><p>ä¹¦é‡Œé¢ç”¨äº† <code>join_threads</code> è¿™ä¸ªè‡ªå®šä¹‰çš„ç±»ï¼Œç”¨æ¥åœ¨ç¦»å¼€ä½œç”¨åŸŸæ—¶æ£€æŸ¥ç»™å®š <code>vector</code> ä¸­çš„ threads æ˜¯å¦ <code>joinable()</code>ï¼Œå¦‚æœæ˜¯çš„è¯åˆ™å‘èµ· <code>join()</code>ã€‚è¿™æ ·å¯ä»¥é˜²æ­¢åœ¨åé¢çš„ä»£ç ç”¨ <code>std::future</code> è·å–ç»“æœæ—¶æŠ›å‡ºå¼‚å¸¸ï¼Œè€Œæœ‰ <code>std::thread</code> ç¦»å¼€ä½œç”¨åŸŸè¿˜æ²¡æœ‰ <code>join()</code> æˆ– <code>detach()</code>ï¼Œå¯¼è‡´ <code>std::terminate</code> è¢«è°ƒç”¨ã€ç¨‹åºç»ˆæ­¢ã€‚<strong>åœ¨ C++20 ä¸­å¯ä»¥ç”¨ <code>std::jthread</code> æ¥æ›¿ä»£è¿™ç§å†™æ³•</strong>ã€‚</p><h2 id=ç”¨-stdasync-ä¿éšœå¼‚å¸¸å®‰å…¨>ç”¨ <code>std::async</code> ä¿éšœå¼‚å¸¸å®‰å…¨
<a class=header-anchor href=#%e7%94%a8-stdasync-%e4%bf%9d%e9%9a%9c%e5%bc%82%e5%b8%b8%e5%ae%89%e5%85%a8></a></h2><p>ç”¨ <code>std::async</code> æ¥ä»£æ›¿å‰é¢çš„ <code>std::packaged_task</code> å’Œ <code>std::thread</code> çš„å†™æ³•ä¼šæ›´ç®€å•ï¼Œè€Œä¸”å¯ä»¥é¿å…å¿˜è®°åœ¨å‘ç”Ÿå¼‚å¸¸ç¦»å¼€å½“å‰ä½œç”¨åŸŸæ—¶å¯¹ <code>std::thread</code> è¿›è¡Œ <code>join()</code> çš„é—®é¢˜ï¼ˆæˆä¹¦æ—¶è¿˜æ²¡æœ‰ <code>std::jthread</code>ï¼‰ã€‚</p><p>ä½¿ç”¨ <code>std::packaged_task</code> æ—¶ï¼Œä¹¦ä¸Šæ˜¯é¢„å…ˆåˆ’åˆ†äº†å¤šä¸ª chunkï¼›åœ¨ä½¿ç”¨ <code>std::async</code> æ—¶ï¼Œä¹¦ä¸Šæ˜¯äºŒåˆ†é€’å½’è°ƒç”¨ <code>std::async</code>ï¼Œå› æ­¤ä»£ç è¿›ä¸€æ­¥å˜å¾—ç®€æ´ã€‚ä¸æ˜¯è¯´ <code>std::packaged_task</code> ä¸èƒ½äºŒåˆ†ï¼Œåªæ˜¯ä¹¦ä¸Šåªå±•ç¤ºäº†è¿™æ ·çš„å†™æ³•ã€‚</p><h1 id=å¹¶è¡ŒåŒ–-stdfor_each>å¹¶è¡ŒåŒ– <code>std::for_each</code>
<a class=header-anchor href=#%e5%b9%b6%e8%a1%8c%e5%8c%96-stdfor_each></a></h1><p>ç•¥ã€‚</p><h1 id=å¹¶è¡ŒåŒ–-stdfind>å¹¶è¡ŒåŒ– <code>std::find</code>
<a class=header-anchor href=#%e5%b9%b6%e8%a1%8c%e5%8c%96-stdfind></a></h1><h2 id=ç”¨-stdthread--stdpromise-å®ç°>ç”¨ <code>std::thread</code> + <code>std::promise</code> å®ç°
<a class=header-anchor href=#%e7%94%a8-stdthread--stdpromise-%e5%ae%9e%e7%8e%b0></a></h2><div class="markdown-alert markdown-alert-important"><p class=markdown-alert-title><svg class="octicon octicon-report mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 1.75C0 .784.784.0 1.75.0h12.5C15.216.0 16 .784 16 1.75v9.5A1.75 1.75.0 0114.25 13H8.06l-2.573 2.573A1.458 1.458.0 013 14.543V13H1.75A1.75 1.75.0 010 11.25zm1.75-.25a.25.25.0 00-.25.25v9.5c0 .138.112.25.25.25h2a.75.75.0 01.75.75v2.19l2.72-2.72a.749.749.0 01.53-.22h6.5a.25.25.0 00.25-.25v-9.5a.25.25.0 00-.25-.25zm7 2.25v2.5a.75.75.0 01-1.5.0v-2.5a.75.75.0 011.5.0zM9 9A1 1 0 117 9a1 1 0 012 0z"/></svg>Important</p><p>ä¹¦ä¸Šå®ç°çš„ <code>find</code> å‡½æ•°æ˜¯æ‰¾åˆ°ä»»ä½•ä¸€ä¸ªå’Œç»™å®šå‚æ•°ç›¸ç­‰çš„å…ƒç´ ï¼Œä½†æ˜¯ <code>std::find</code> æ‰¾åˆ°çš„æ˜¯èŒƒå›´ä¸­çš„ç¬¬ä¸€ä¸ªå’Œå‚æ•°ç›¸ç­‰çš„å…ƒç´ ï¼Œå«ä¹‰æ˜¯ä¸åŒçš„ã€‚</p></div><p>ä¸ºäº†å’Œæ ‡å‡†åº“çš„æ¥å£ä¸€è‡´ï¼Œ<code>find</code> å‡½æ•°åªéœ€è¦ä¸€ä¸ªç»“æœï¼Œå› æ­¤ä¹¦ä¸Šé€‰æ‹©ä½¿ç”¨ <code>std::promise</code> è€Œä¸æ˜¯ <code>std::packaged_task</code>ã€‚åŒæ ·æ˜¯åˆ›å»ºä¸€ç»„çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹æ‰§è¡Œå„è‡ªçš„æœç´¢ä»»åŠ¡ï¼Œä½†æ˜¯<strong>ç°åœ¨ä¸éœ€è¦ä¸ºæ¯ä¸ªçº¿ç¨‹éƒ½åˆ›å»ºä¸€ä¸ª future</strong>ï¼Œåªéœ€è¦ä½¿ç”¨åŒä¸€ä¸ª promise ä¸å’Œå®ƒå…³è”çš„ä¸€ä¸ª futureã€‚</p><div class="markdown-alert markdown-alert-note"><p class=markdown-alert-title><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1116 0A8 8 0 010 8zm8-6.5a6.5 6.5.0 100 13 6.5 6.5.0 000-13zM6.5 7.75A.75.75.0 017.25 7h1a.75.75.0 01.75.75v2.75h.25a.75.75.0 010 1.5h-2a.75.75.0 010-1.5h.25v-2h-.25a.75.75.0 01-.75-.75zM8 6a1 1 0 110-2 1 1 0 010 2z"/></svg>Note</p><p>ä¹¦ä¸Šç”¨ <code>std::vector&lt;std::threads></code> + è‡ªå®šä¹‰çš„ <code>join_threads</code> æ¥å¤„ç†å¼‚å¸¸ï¼Œå¦‚æœæœ‰ <code>std::jthreads</code>ï¼ˆC++20ï¼‰å°±æ›´ç®€å•äº†ã€‚</p></div><p>ä¹¦ä¸Šæ˜¯æ¯ä¸ªå…ƒç´ éå†å‰éƒ½æ£€æŸ¥ä¸€ä¸‹æ‰€æœ‰çº¿ç¨‹å¯è§çš„åŸå­æ ‡å¿— <code>done_flag</code>ï¼Œå¦‚æœè¯¥æ ‡å¿—ä¸ºçœŸåˆ™ä¸å†ç»§ç»­æœç´¢ã€‚å¦‚æœæœ‰çº¿ç¨‹å…ˆæ‰¾åˆ°äº†å…ƒç´ æˆ–è€…å‡ºç°äº†å¼‚å¸¸ï¼Œè¿™ä¸ª <code>done_flag</code> éƒ½ä¼šè¢«è®¾ç½®ä¸ºçœŸã€‚æˆ‘ä¸ªäººè®¤ä¸ºè¿™ä¸ªæ£€æŸ¥é¢‘ç‡åº”è¯¥å˜å°ä¸€ç‚¹ï¼Œä¸ç„¶å®¹æ˜“å½±å“æœç´¢æ€§èƒ½ã€‚</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#719e07>struct</span> <span style=color:#268bd2>find_element</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#dc322f>void</span> <span style=color:#268bd2>operator</span>()(Iterator begin, Iterator end,
</span></span><span style=display:flex><span>                    MatchType match,
</span></span><span style=display:flex><span>                    std<span style=color:#719e07>::</span>promise<span style=color:#719e07>&lt;</span>Iterator<span style=color:#719e07>&gt;*</span> result,
</span></span><span style=display:flex><span>                    std<span style=color:#719e07>::</span>atomic<span style=color:#719e07>&lt;</span><span style=color:#dc322f>bool</span><span style=color:#719e07>&gt;*</span> done_flag)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#719e07>try</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#719e07>for</span> (; (begin <span style=color:#719e07>!=</span> end) <span style=color:#719e07>&amp;&amp;</span> <span style=color:#719e07>!</span>done_flag<span style=color:#719e07>-&gt;</span>load(); <span style=color:#719e07>++</span>begin)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#719e07>if</span> (<span style=color:#719e07>*</span>begin <span style=color:#719e07>==</span> match)
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    result<span style=color:#719e07>-&gt;</span>set_value(begin);
</span></span><span style=display:flex><span>                    done_flag<span style=color:#719e07>-&gt;</span>store(<span style=color:#b58900>true</span>);
</span></span><span style=display:flex><span>                    <span style=color:#719e07>return</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#719e07>catch</span> (...)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#719e07>try</span> <span style=color:#586e75>// æ³¨æ„è¿™é‡Œ
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>            {
</span></span><span style=display:flex><span>                result<span style=color:#719e07>-&gt;</span>set_exception(std<span style=color:#719e07>::</span>current_exception());
</span></span><span style=display:flex><span>                done_flag<span style=color:#719e07>-&gt;</span>store(<span style=color:#b58900>true</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#719e07>catch</span> (...)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>æ¯ä¸ªçº¿ç¨‹æ‰¾åˆ°ç»“æœæˆ–è€…å‘ç”Ÿå¼‚å¸¸ä¹‹åéƒ½ä¼šå°è¯•å°†ç»“æœå†™å…¥ futureï¼Œä½†æ˜¯åªæœ‰ç¬¬ä¸€ä¸ªçº¿ç¨‹èƒ½æˆåŠŸï¼Œå…¶ä»–çº¿ç¨‹ä¼šé‡åˆ°å¼‚å¸¸ã€‚å°¤å…¶æ˜¯å°è¯• <code>set_value()</code> çš„çº¿ç¨‹ä¼šé‡åˆ°å¼‚å¸¸ï¼Œä»è€Œè¿›å…¥ä¸‹é¢ catch å—ä¸­å¹¶è°ƒç”¨ <code>set_exception()</code>ï¼Œä½†æ˜¯è¿™ä¸ªè°ƒç”¨ä¾ç„¶ä¼šå‘ç”Ÿå¼‚å¸¸ï¼Œå› æ­¤å¤–é¢è¿˜è¦åŒ…ä¸€å±‚ try-catchã€‚<strong>ä¹¦ä¸Šçš„ä»£ç é€šè¿‡åŒé‡ try-catch ç®€å•å¤„ç†äº†çº¿ç¨‹è®¾ç½®ç»“æœçš„æ•°æ®ç«äº‰é—®é¢˜</strong>ã€‚</p><h2 id=ç”¨-stdasync-å®ç°>ç”¨ <code>std::async</code> å®ç°
<a class=header-anchor href=#%e7%94%a8-stdasync-%e5%ae%9e%e7%8e%b0></a></h2><p>å‰é¢ç”¨ <code>std::thread</code> + <code>std::promise</code> å®ç°æ˜¯ä¸ºäº†æ›¿ä»£ <code>std::thread</code> + <code>std::packaged_task</code>ã€‚ç°åœ¨æ¢æˆ <code>std::async</code>ï¼Œä¸ç”¨ä¸“é—¨ä½¿ç”¨ <code>std::promise</code>ã€‚æ¯æ¬¡è¿›è¡ŒäºŒåˆ†åå…ˆæ£€æŸ¥å‰ä¸€åŠçš„ç»“æœï¼ˆåœ¨æœ¬çº¿ç¨‹è¿›è¡Œæœç´¢ï¼‰ï¼Œå¦‚æœå‰ä¸€åŠæ²¡æœ‰æ‰¾åˆ°æ‰å»æ£€æŸ¥åä¸€åŠçš„ç»“æœã€‚</p><h1 id=å¹¶è¡ŒåŒ–-stdpartial_sum>å¹¶è¡ŒåŒ– <code>std::partial_sum</code>
<a class=header-anchor href=#%e5%b9%b6%e8%a1%8c%e5%8c%96-stdpartial_sum></a></h1><div class="markdown-alert markdown-alert-important"><p class=markdown-alert-title><svg class="octicon octicon-report mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 1.75C0 .784.784.0 1.75.0h12.5C15.216.0 16 .784 16 1.75v9.5A1.75 1.75.0 0114.25 13H8.06l-2.573 2.573A1.458 1.458.0 013 14.543V13H1.75A1.75 1.75.0 010 11.25zm1.75-.25a.25.25.0 00-.25.25v9.5c0 .138.112.25.25.25h2a.75.75.0 01.75.75v2.19l2.72-2.72a.749.749.0 01.53-.22h6.5a.25.25.0 00.25-.25v-9.5a.25.25.0 00-.25-.25zm7 2.25v2.5a.75.75.0 01-1.5.0v-2.5a.75.75.0 011.5.0zM9 9A1 1 0 117 9a1 1 0 012 0z"/></svg>Important</p><p><code>std::partial_sum</code> è¿˜ä¿è¯äº†ç»“åˆé¡ºåºï¼Œæ‰€ä»¥ä¹¦ä¸Šå®ç°çš„å…¶å®æ˜¯ <code>std::inclusive_scan</code>ã€‚</p></div><div class="markdown-alert markdown-alert-note"><p class=markdown-alert-title><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1116 0A8 8 0 010 8zm8-6.5a6.5 6.5.0 100 13 6.5 6.5.0 000-13zM6.5 7.75A.75.75.0 017.25 7h1a.75.75.0 01.75.75v2.75h.25a.75.75.0 010 1.5h-2a.75.75.0 010-1.5h.25v-2h-.25a.75.75.0 01-.75-.75zM8 6a1 1 0 110-2 1 1 0 010 2z"/></svg>Note</p><p><code>std::partial_sum</code> å¹¶ä¸åœ¨ <code>&lt;algorithm></code> å¤´æ–‡ä»¶ä¸­ï¼Œè€Œåœ¨ <code>&lt;numeric></code> å¤´æ–‡ä»¶ä¸­ã€‚å®ƒä¹Ÿæ²¡æœ‰æ¥å— ExecutionPolicy å‚æ•°çš„é‡è½½ã€‚</p></div><h2 id=æ–¹æ³•ä¸€æ¯ä¸ªçº¿ç¨‹å„è‡ªè´Ÿè´£ä¸€ä¸ª-chunk>æ–¹æ³•ä¸€ï¼šæ¯ä¸ªçº¿ç¨‹å„è‡ªè´Ÿè´£ä¸€ä¸ª chunk
<a class=header-anchor href=#%e6%96%b9%e6%b3%95%e4%b8%80%e6%af%8f%e4%b8%aa%e7%ba%bf%e7%a8%8b%e5%90%84%e8%87%aa%e8%b4%9f%e8%b4%a3%e4%b8%80%e4%b8%aa-chunk></a></h2><p>æŠŠæ•°ç»„åˆ†æˆ chunkï¼Œæ¯ä¸ªçº¿ç¨‹ä¸ºä¸€ä¸ª chunk è®¡ç®— partial sumï¼ˆå¹¶è¡Œï¼‰ï¼Œç„¶åä¸åŒçº¿ç¨‹é€šä¿¡å¾—åˆ°ä¸Šä¸€ chunk æœ«å°¾çš„å€¼ $x_{i-1}$ï¼ˆä¸²è¡Œï¼‰ï¼Œæœ€åæ¯ä¸ªçº¿ç¨‹å„è‡ªç»™æ•´ä¸ª chunk åŠ ä¸Š $x_{i-1}$ï¼ˆå¹¶è¡Œï¼‰ã€‚</p><p><img src=/cpp-concurrency-in-action/assets/6059ec33aa14ad75d98444e1e443cf40.webp width=600></p><p>è¿™ä¸ªæ–¹æ³•ä¸­ç›¸é‚» chunk é€šä¿¡æ˜¯ä½¿ç”¨ <code>std::promise</code> å’Œ <code>std::future</code> æ¥å®Œæˆçš„ã€‚<strong>å›¾ä¸­æœ‰ä¸€ç‚¹æ²¡æœ‰åæ˜ çœŸå®æƒ…å†µçš„æ˜¯ï¼šåªè¦å½“å‰çº¿ç¨‹å°†ç»“æœä¼ ç»™åé¢çš„çº¿ç¨‹äº†ï¼Œå°±å¯ä»¥ç»™è‡ªå·±è´Ÿè´£çš„ chunk ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ åŠ ä¸Šåç§»ï¼Œä¸éœ€è¦æ•´æ¡é“¾è·¯çš„åŒæ­¥å®Œæˆ</strong>ã€‚</p><h2 id=æ–¹æ³•äºŒthe-incremental-pairwise-algorithm>æ–¹æ³•äºŒï¼šThe incremental pairwise algorithm
<a class=header-anchor href=#%e6%96%b9%e6%b3%95%e4%ba%8cthe-incremental-pairwise-algorithm></a></h2><blockquote><p>This second approach to calculating the partial sums by adding elements increasingly further away works best where your processors can execute the additions in lockstep.</p></blockquote><p>æˆ‘è®°å¾— <em>Programming Massively Parallel Processors</em> é‡Œé¢ä¹Ÿè®²è¿‡å¯¹æŠ˜è¿­ä»£ï¼Œ<em>C++ Concurrency in Action</em> è¿™é‡Œè¦åœ¨ CPU ä¸Šå®ç°ç±»ä¼¼çš„ç®—æ³•ã€‚æ¥ä¸‹æ¥æŠŠä¸¤æœ¬ä¹¦ä»‹ç»çš„ç®—æ³•è¿›è¡Œæ¯”è¾ƒã€‚</p><h3 id=ä¸¤æœ¬ä¹¦é‡Œé¢ç”¨çš„æ˜¯ä»€ä¹ˆç®—æ³•>ä¸¤æœ¬ä¹¦é‡Œé¢ç”¨çš„æ˜¯ä»€ä¹ˆç®—æ³•ï¼Ÿ
<a class=header-anchor href=#%e4%b8%a4%e6%9c%ac%e4%b9%a6%e9%87%8c%e9%9d%a2%e7%94%a8%e7%9a%84%e6%98%af%e4%bb%80%e4%b9%88%e7%ae%97%e6%b3%95></a></h3><p><em>Programming Massively Parallel Processors</em> å…ˆä»‹ç»äº† <strong>Kogge-Stone</strong> ç®—æ³•ï¼Œç„¶åä»‹ç»äº†æ›´åŠ é«˜æ•ˆçš„ <strong>Brent-Kung</strong> ç®—æ³•ã€‚ä¹¦ä¸Šä¹Ÿæåˆ°äº†å­˜åœ¨åŸºäº warp shuffle çš„æ›´é«˜æ•ˆçš„ç®—æ³•ï¼Œä½†æ˜¯æ²¡æœ‰åšè¯¦ç»†ä»‹ç»ã€‚</p><p><em>C++ Concurrency in Action</em> ä¸­çš„ç®—æ³•æ˜¯ Kogge-Stone ç®—æ³•ã€‚</p><h4 id=koggle-stone-ç®—æ³•>Koggle-Stone ç®—æ³•
<a class=header-anchor href=#koggle-stone-%e7%ae%97%e6%b3%95></a></h4><p>åœ¨ Koggle-Stone ç®—æ³•ä¸­ï¼Œç¬¬ä¸€æ¬¡è¿­ä»£åå‰ 2 ä¸ªå…ƒç´ çš„ partial sum å·²ç»ç®—å¥½ï¼Œç¬¬äºŒæ¬¡è¿­ä»£åå‰ 4 ä¸ªå…ƒç´ çš„ partial sum å·²ç»ç®—å¥½ï¼Œç¬¬ä¸‰æ¬¡è¿­ä»£åå‰ 8 ä¸ªå…ƒç´ çš„ partial sum å·²ç»ç®—å¥½â€¦â€¦Koggle-Stone ç®—æ³•çš„æ€»æ“ä½œæ•°ä¸º $N \mathit{log}_{2}(N) - (N - 1)$ã€‚å› ä¸ºåœ¨ä¸€ä¸ªè¿­ä»£ä¸­è¦è¯»ä¸€æ¬¡ã€å†™ä¸€æ¬¡ï¼Œæ‰€ä»¥åœ¨æ²¡æœ‰åŒç¼“å†²çš„æƒ…å†µä¸‹ä¸€ä¸ªè¿­ä»£éœ€è¦åšä¸¤æ¬¡åŒæ­¥ã€‚</p><p><img src=/cpp-concurrency-in-action/assets/Pasted%20image%2020250118220105.webp width=600></p><h4 id=brent-kung-ç®—æ³•>Brent-Kung ç®—æ³•
<a class=header-anchor href=#brent-kung-%e7%ae%97%e6%b3%95></a></h4><p>åœ¨ Brent-Kung ç®—æ³•ä¸­ï¼Œreduction tree æ“ä½œæ•°ä¸º $N-1$ï¼Œreverse tree æ“ä½œæ•°ä¸º $N-1-\mathit{log}_2(N)$ï¼Œæ€»æ“ä½œæ•°ä¸º $2N-2-\mathit{log}_2(N)$ã€‚</p><p><img src=/cpp-concurrency-in-action/assets/Pasted%20image%2020250118220441.webp width=600></p><p><strong>Reduction tree</strong>: ï¼ˆä» 1 å¼€å§‹è®¡æ•°ï¼‰2 çš„å¹‚çš„ä½ç½®çš„å…ƒç´ åœ¨ reduction tree ç»“æŸåå¯ä»¥å¾—åˆ°æœ€ç»ˆçš„ partial sumã€‚ä»ä¸‹å›¾ä¸­è¯»å†™ç¤ºæ„å›¾æ¥çœ‹ï¼Œè¯»çš„ä½ç½®å’Œå†™çš„ä½ç½®å¹¶æ²¡æœ‰ç›¸äº’äº¤é”™ï¼Œæ‰€ä»¥<strong>ä¸€ä¸ªè¿­ä»£ä¸­åªéœ€è¦è¿›è¡Œä¸€æ¬¡åŒæ­¥</strong>ã€‚</p><div class="markdown-alert markdown-alert-tip"><p class=markdown-alert-title><svg class="octicon octicon-light-bulb mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M8 1.5c-2.363.0-4 1.69-4 3.75.0.984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75.0 01-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456.0 00-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863.0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751.0 01-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304.0-2.06-1.637-3.75-4-3.75zM5.75 12h4.5a.75.75.0 010 1.5h-4.5a.75.75.0 010-1.5zM6 15.25a.75.75.0 01.75-.75h2.5a.75.75.0 010 1.5h-2.5A.75.75.0 016 15.25z"/></svg>Tip</p><p>Reduction tree é˜¶æ®µæ˜¯å½¢æˆ <a href=https://oi-wiki.org/ds/fenwick/ title=æ ‘çŠ¶æ•°ç»„ rel="noopener external nofollow noreferrer" target=_blank class=exturl>æ ‘çŠ¶æ•°ç»„<i class="fa fa-external-link-alt"></i></a>ã€‚è‹¥ä¸‹æ ‡ä» 1 å¼€å§‹ï¼Œåªæœ‰ä¸‹æ ‡ä¸º $2^i$ çš„å…ƒç´ å®Œæˆäº†è®¡ç®—ã€‚</p></div><p>ä¸€ç§åšæ³•æ˜¯è®©æ¯ä¸ªçº¿ç¨‹éƒ½å¤„ç†å¯¹åº”ä½ç½®ä¸Šçš„å…ƒç´ ï¼Œä¸ºå…¶åˆ¤æ–­æ˜¯å¦éœ€è¦å°† <code>XY[i-stride]</code> çš„å€¼åŠ åˆ° <code>XY[i]</code> ä¸Šé¢æ¥ã€‚ä½†æ˜¯æ¯ä¸ª warp ä¸­æœ‰çš„çº¿ç¨‹ä¸è¿› ifï¼Œæœ‰çš„çº¿ç¨‹è¿› ifï¼Œcontrol divergence æ¯”è¾ƒå¤šã€‚</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#586e75>// blockDim.x æ˜¯åˆ†æ®µæ‰«æçš„æ•°ç»„æ®µå¤§å°çš„ä¸€åŠï¼Œä¹Ÿå°±æ˜¯è¯´åªè¦ä¸€åŠçš„çº¿ç¨‹å°±èƒ½è®¡ç®—è¯¥æ•°ç»„æ®µ
</span></span></span><span style=display:flex><span><span style=color:#586e75></span><span style=color:#719e07>for</span>(<span style=color:#dc322f>unsigned</span> <span style=color:#dc322f>int</span> stride <span style=color:#719e07>=</span> <span style=color:#2aa198>1</span>; stride <span style=color:#719e07>&lt;=</span> blockDim.x; stride <span style=color:#719e07>*=</span> <span style=color:#2aa198>2</span>) {
</span></span><span style=display:flex><span>    __syncthreads();
</span></span><span style=display:flex><span>    <span style=color:#586e75>// è¿™é‡Œå¯¹ (2 * stride) å–æ¨¡è€Œä¸æ˜¯å¯¹ stride å–æ¨¡ï¼Œæ˜¯å› ä¸ºç®—çš„æ˜¯ inclusive scanï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#586e75>// 0 å·å…ƒç´ å¹¶ä¸éœ€è¦è¿›è¡Œå åŠ æ“ä½œã€‚
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#719e07>if</span> ((threadIdx.x <span style=color:#719e07>+</span> <span style=color:#2aa198>1</span>) <span style=color:#719e07>%</span> (<span style=color:#2aa198>2</span> <span style=color:#719e07>*</span> stride) <span style=color:#719e07>==</span> <span style=color:#2aa198>0</span>) {
</span></span><span style=display:flex><span>        XY[threadIdx.x] <span style=color:#719e07>+=</span> XY[threadIdx.x <span style=color:#719e07>-</span> stride];
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å¦ä¸€ç§åšæ³•æ˜¯å°†å·¥ä½œçº¿ç¨‹é›†ä¸­åˆ° block å¤´éƒ¨çš„è‹¥å¹² warp ä¸­ï¼Œçº¿ç¨‹å·ï¼ˆ<code>threadIdx.x</code> å¹¶ä¸å¯¹åº”è¦å¤„ç†çš„å…ƒç´ çš„ä¸‹æ ‡å·ï¼‰ï¼Œè¿™æ ·åšå‡å°‘äº†æ§åˆ¶åˆ†æ­§ï¼Œæ€§èƒ½æ›´å¥½ã€‚è§‚å¯Ÿä¸Šå›¾ï¼Œå¦‚æœä¸‹æ ‡ä» 1 å¼€å§‹ï¼Œæ¯ä¸€è½®åˆ†åˆ«æ˜¯ 2 çš„å€æ•°ã€4 çš„å€æ•°ã€8 çš„å€æ•°â€¦â€¦ ä¸‹æ ‡å¤„çš„å…ƒç´ å‚ä¸è®¡ç®—ã€‚å› æ­¤å¯ä»¥ç›´æ¥ç®—å‡ºæ¥ç¬¬ $i$ ä¸ªä¼šå‚ä¸è®¡ç®—çš„ä¸‹æ ‡æ˜¯ $i * (2 * \mathit{stride})$ï¼Œå®é™…ä¸Šæ•°ç»„ä¸‹æ ‡ä» 0 è®¡ç®—ã€çº¿ç¨‹ IDï¼ˆ$i$ï¼‰ä¹Ÿä» 0 å¼€å§‹ï¼Œé‚£ä¹ˆè¡¨è¾¾å¼å°±å˜æˆäº† $(i+1) * (2 * \mathit{stride})-1$ã€‚æœ€ååšä¸€ä¸‹æ•°ç»„è¶Šç•Œæ£€æŸ¥ã€‚</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#719e07>for</span>(<span style=color:#dc322f>unsigned</span> <span style=color:#dc322f>int</span> stride <span style=color:#719e07>=</span> <span style=color:#2aa198>1</span>; stride <span style=color:#719e07>&lt;=</span> blockDim.x; stride <span style=color:#719e07>*=</span> <span style=color:#2aa198>2</span>) {
</span></span><span style=display:flex><span>    __syncthreads();
</span></span><span style=display:flex><span>    <span style=color:#dc322f>int</span> index <span style=color:#719e07>=</span> (threadIdx.x <span style=color:#719e07>+</span> <span style=color:#2aa198>1</span>) <span style=color:#719e07>*</span> <span style=color:#2aa198>2</span> <span style=color:#719e07>*</span> stride <span style=color:#719e07>-</span> <span style=color:#2aa198>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#719e07>if</span>(index <span style=color:#719e07>&lt;</span> SECTION_SIZE) { <span style=color:#586e75>// ä¹¦ä¸­çš„ SECTION_SIZE æ˜¯å¯¹åˆ†æ®µæ•°ç»„å¤§å°
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>        XY[index] <span style=color:#719e07>+=</span> XY[index <span style=color:#719e07>-</span> stride];
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Reduction tree ç»“æŸä¹‹åï¼Œ$\mathit{lowbit}(i+1)$ èƒ½è®¡ç®—å‡º $XY[i]$ å·²ç»åŒ…å«äº†å‰é¢ï¼ˆå«è‡ªå·±ï¼‰å‡ ä¸ªæ•°çš„å’Œã€‚ä»¤ $sum[-1] = 0$ï¼Œæœ‰ï¼š</p>$$XY[i] = sum[i] - sum[i-\mathit{lowbit}(i+1)]$$<ul><li>ä¾‹å­ 1ï¼šå¦‚å›¾ï¼Œ$XY[11]$ æ˜¯åŸ $XY[8...11]$ çš„å’Œã€‚</li><li>ä¾‹å­ 2ï¼šæŒ‰ç…§å…¬å¼ï¼Œæ‰€æœ‰ä» 1 è®¡æ•°çš„ 2 çš„å¹‚çš„ä½ç½®éƒ½å·²ç»å¾—åˆ°äº†æœ€ç»ˆ sumã€‚</li></ul><p>è¿™å…¶å®å®Œæˆäº†ä¸€ä¸ªæ ‘çŠ¶æ•°ç»„ã€‚</p><p><strong>Reverse tree</strong>: å¯¹äº $XY[i]$ï¼Œæˆ‘ä»¬å¸Œæœ›æŠŠ $sum[i-\mathit{lowbit}(i+1)]$ åŠ å›æ¥ã€‚åˆšå¼€å§‹æ—¶åªæœ‰æ»¡è¶³ $i = 2^n-1(n=0,1,2...)$ çš„ $XY[i]$ å’Œ $sum[i]$ ç›¸ç­‰ï¼Œæ‰€ä»¥åªèƒ½æŠŠè¿™äº›æ•°ä½œä¸ºåŠ æ•°å¾€ååŠ ã€‚ï¼ˆ$XY[i]$ æ˜¯æœ€ç»ˆè®¡ç®—ç›®æ ‡ï¼Œè€Œ $sum[i]$ æ˜¯å½“å‰è®¡ç®—ç»“æœã€‚ï¼‰</p><div class="markdown-alert markdown-alert-tip"><p class=markdown-alert-title><svg class="octicon octicon-light-bulb mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M8 1.5c-2.363.0-4 1.69-4 3.75.0.984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75.0 01-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456.0 00-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863.0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751.0 01-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304.0-2.06-1.637-3.75-4-3.75zM5.75 12h4.5a.75.75.0 010 1.5h-4.5a.75.75.0 010-1.5zM6 15.25a.75.75.0 01.75-.75h2.5a.75.75.0 010 1.5h-2.5A.75.75.0 016 15.25z"/></svg>Tip</p><p>Reverse tree é˜¶æ®µæ˜¯æŠŠæ ‘çŠ¶æ•°ç»„è½¬æ¢æˆéƒ¨åˆ†å’Œï¼ˆpartial sumï¼‰ã€‚</p></div><p>æœ‰ä¸€ç§æ–¹æ¡ˆå¯ä»¥æ»¡è¶³æ‰€æœ‰å…ƒç´ çš„ä¾èµ–å…³ç³»ï¼š<strong>é¦–å…ˆè®¡ç®— $popcount(i+1)$ å°çš„é‚£äº›å…ƒç´  $XY[i]$</strong>ï¼Œå…¶ä¸­ popcount æ“ä½œè¡¨ç¤ºå¯¹æ•´æ•°äºŒè¿›åˆ¶è¡¨ç¤ºä¸­çš„ 1 è®¡æ•°ã€‚å›¾ä¸­ $XY[11]$ å’Œ $XY[5]$ åˆ†åˆ«å¯¹åº” 12 å·å’Œ 6 å·ï¼Œä»–ä»¬éƒ½åªæœ‰ 6 ä½ï¼Œè®¡ç®—æ˜¯å¯ä»¥åŒæ—¶è¿›è¡Œçš„ã€‚è¿™ç§æ–¹æ³•è¿˜æ˜¯ä»çº¿ç¨‹ $i$ å¯¹åº”ä¸‹æ ‡ $i$ çš„è§’åº¦æ¥æ€è€ƒçš„ï¼Œä¸ä»…éœ€è¦è°ƒç”¨ $popcount()$ å‡½æ•°ï¼Œè¿˜æœ‰æ§åˆ¶åˆ†æ­§ã€‚ä¹¦ä¸Šç»™å‡ºäº†ä¸€ç§æ•ˆç‡æ›´é«˜çš„ã€åŸºäº stride å€å‡çš„å‘åå åŠ ç®—æ³•ï¼Œåœ¨æ»¡è¶³è®¡ç®—ä¾èµ–çš„æƒ…å†µä¸‹ä¿æŒäº†ä»£ç ç®€å•ã€‚</p><p><strong>æœ€ç»ˆä»£ç </strong>ã€‚ä¹¦ä¸Šè¿˜è¿›è¡Œäº†â€œçº¿ç¨‹å‡åŠâ€çš„ä¼˜åŒ–ï¼šè™½ç„¶æ¯ä¸ªå—å¤„ç†äº†ä¸€å—å¤§å°ä¸º <code>SECTION_SIZE</code> çš„å†…å­˜åŒºåŸŸï¼Œä½†æ˜¯å®é™…ä¸Šä½¿ç”¨çš„çº¿ç¨‹æ•°æœ€å¤šä¸º <code>SECTION_SIZE/2</code>ï¼ˆå¯ä»¥çœ‹ä¸Šé¢çš„å›¾ï¼Œæ–œçº¿è¡¨ç¤ºæ•°æ®æ“ä½œï¼Œæ¯ä¸€è¡Œæ–œçº¿éƒ½ä¸è¶…è¿‡å…ƒç´ æ€»æ•°çš„ä¸€åŠï¼‰ï¼Œæ‰€ä»¥åœ¨å¯åŠ¨ kernel çš„æ—¶å€™ç»™çš„å—å†…çº¿ç¨‹æ•°åªè¦ <code>SECTION_SIZE/2</code> å°±è¡Œã€‚æ¢å¥è¯è¯´ï¼Œå¦‚æœæƒ³è¦å‡å°‘æ®µæ•°ï¼ˆå¢å¤§æ®µå¤§å°ï¼‰ï¼Œå¯ä»¥å°†å—å†…çº¿ç¨‹æ•°å¼€æ»¡ï¼Œå¹¶å°† <code>SECTION_SIZE</code> è®¾ç½®ä¸ºå®ƒçš„ 2 å€ã€‚</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span>__global__ <span style=color:#dc322f>void</span> <span style=color:#268bd2>Brent_Kung_scan_kernel</span>(<span style=color:#dc322f>float</span> <span style=color:#719e07>*</span>X, <span style=color:#dc322f>float</span> <span style=color:#719e07>*</span>Y, <span style=color:#dc322f>unsigned</span> <span style=color:#dc322f>int</span> N) {
</span></span><span style=display:flex><span>    __shared__ <span style=color:#dc322f>float</span> XY[SECTION_SIZE];
</span></span><span style=display:flex><span>    <span style=color:#dc322f>unsigned</span> <span style=color:#dc322f>int</span> i <span style=color:#719e07>=</span> <span style=color:#2aa198>2</span><span style=color:#719e07>*</span>blockIdx.x<span style=color:#719e07>*</span>blockDim.x <span style=color:#719e07>+</span> threadIdx.x;
</span></span><span style=display:flex><span>    <span style=color:#586e75>// æœ‰ SECTION_SIZE == 2 * blockDim.xã€‚
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#586e75>// ä¸‹é¢å°† X çš„æ•°æ®åŠ è½½åˆ°å…±äº«å†…å­˜ä¸­ä»¥åŠ å¿«è®¿é—®ã€‚çœ‹ä¸Šå»å¤æ‚äº†ä¸€ç‚¹ï¼Œå®é™…ä¸Šåªæ˜¯å› ä¸º
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#586e75>// ç°åœ¨ä¸€ä¸ª SECTION_SIZE ç­‰äºä¸¤å€å—å†…çº¿ç¨‹æ•°ï¼Œæ‰€ä»¥éœ€è¦å¤šåšä¸€äº›å¤„ç†ã€‚
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#719e07>if</span>(i <span style=color:#719e07>&lt;</span> N) XY[threadIdx.x] <span style=color:#719e07>=</span> X[i];
</span></span><span style=display:flex><span>    <span style=color:#719e07>if</span>(i <span style=color:#719e07>+</span> blockDim.x <span style=color:#719e07>&lt;</span> N) XY[threadIdx.x <span style=color:#719e07>+</span> blockDim.x] <span style=color:#719e07>=</span> X[i <span style=color:#719e07>+</span> blockDim.x];
</span></span><span style=display:flex><span>    <span style=color:#586e75>// Reduction tree.
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#719e07>for</span>(<span style=color:#dc322f>unsigned</span> <span style=color:#dc322f>int</span> stride <span style=color:#719e07>=</span> <span style=color:#2aa198>1</span>; stride <span style=color:#719e07>&lt;=</span> blockDim.x; stride <span style=color:#719e07>*=</span> <span style=color:#2aa198>2</span>) {
</span></span><span style=display:flex><span>        __syncthreads();
</span></span><span style=display:flex><span>        <span style=color:#dc322f>unsigned</span> <span style=color:#dc322f>int</span> index <span style=color:#719e07>=</span> (threadIdx.x <span style=color:#719e07>+</span> <span style=color:#2aa198>1</span>)<span style=color:#719e07>*</span><span style=color:#2aa198>2</span><span style=color:#719e07>*</span>stride <span style=color:#719e07>-</span> <span style=color:#2aa198>1</span>;
</span></span><span style=display:flex><span>        <span style=color:#719e07>if</span>(index <span style=color:#719e07>&lt;</span> SECTION_SIZE) {
</span></span><span style=display:flex><span>            XY[index] <span style=color:#719e07>+=</span> XY[index <span style=color:#719e07>-</span> stride];
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#586e75>// Reverse tree.
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#719e07>for</span> (<span style=color:#dc322f>int</span> stride <span style=color:#719e07>=</span> SECTION_SIZE<span style=color:#719e07>/</span><span style=color:#2aa198>4</span>; stride <span style=color:#719e07>&gt;</span> <span style=color:#2aa198>0</span>; stride <span style=color:#719e07>/=</span> <span style=color:#2aa198>2</span>) {
</span></span><span style=display:flex><span>        __syncthreads();
</span></span><span style=display:flex><span>        <span style=color:#dc322f>unsigned</span> <span style=color:#dc322f>int</span> index <span style=color:#719e07>=</span> (threadIdx.x <span style=color:#719e07>+</span> <span style=color:#2aa198>1</span>)<span style=color:#719e07>*</span>stride<span style=color:#719e07>*</span><span style=color:#2aa198>2</span> <span style=color:#719e07>-</span> <span style=color:#2aa198>1</span>;
</span></span><span style=display:flex><span>        <span style=color:#719e07>if</span>(index <span style=color:#719e07>+</span> stride <span style=color:#719e07>&lt;</span> SECTION_SIZE) {
</span></span><span style=display:flex><span>            XY[index <span style=color:#719e07>+</span> stride] <span style=color:#719e07>+=</span> XY[index];
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    __syncthreads();
</span></span><span style=display:flex><span>    <span style=color:#586e75>// å°†å…±äº«ç¼“å­˜ä¸Šçš„ç»“æœå†™å›ç»“æœæ•°ç»„ã€‚
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#719e07>if</span> (i <span style=color:#719e07>&lt;</span> N) Y[i] <span style=color:#719e07>=</span> XY[threadIdx.x];
</span></span><span style=display:flex><span>    <span style=color:#719e07>if</span> (i <span style=color:#719e07>+</span> blockDim.x <span style=color:#719e07>&lt;</span> N) Y[i <span style=color:#719e07>+</span> blockDim.x] <span style=color:#719e07>=</span> XY[threadIdx.x <span style=color:#719e07>+</span> blockDim.x];
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æ³¨æ„åˆ° Brent-Kung ç®—æ³•æ¯ä¸ªè¿­ä»£åªåŒæ­¥ä¸€æ¬¡ã€‚</p><h3 id=åŒç¼“å†²>åŒç¼“å†²
<a class=header-anchor href=#%e5%8f%8c%e7%bc%93%e5%86%b2></a></h3><p>ä½¿ç”¨ Kogge-Stone ç®—æ³•æ—¶ï¼ŒGPU å’Œ CPU éƒ½èƒ½ä½¿ç”¨åŒç¼“å†²æé«˜æ•ˆç‡ã€‚<em>C++ Concurrency in Action</em> ç¤ºä¾‹ä½¿ç”¨äº†ä¸€ä¸ªè¾“å…¥åŒºé—´ä¸€æ ·å¤§çš„å·¥ä½œåŒºï¼Œç„¶åå’Œè¾“å…¥åŒºé—´è½®æ›¿ä¿å­˜æ¯æ¬¡è¿­ä»£çš„ç»“æœã€‚çº¿ç¨‹ä»¬é€šè¿‡<strong>å…¨å±€åŒç¼“å†²åŒº</strong>å…±äº«æ•°æ®ï¼Œè€Œä¸æ˜¯å„è‡ªç”¨å˜é‡æš‚å­˜è¦å†™å…¥çš„ç»“æœï¼Œå°†æ¯ä¸ªè¿­ä»£è¦åŒæ­¥çš„æ¬¡æ•°ä» 2 æ¬¡å‡å°‘åˆ°äº† 1 æ¬¡ã€‚</p><p>ä½¿ç”¨ Brent-Kung ç®—æ³•æ—¶ï¼Œä¸éœ€è¦åŒç¼“å†²ï¼Œæ¯ä¸ªè¿­ä»£åªåŒæ­¥ 1 æ¬¡ã€‚</p><h3 id=barrier-çš„ä½¿ç”¨>Barrier çš„ä½¿ç”¨
<a class=header-anchor href=#barrier-%e7%9a%84%e4%bd%bf%e7%94%a8></a></h3><p>æ— è®ºæ˜¯ GPU ä¸Šçš„è®¡ç®—è¿˜æ˜¯ CPU ä¸Šçš„è®¡ç®—ï¼Œéƒ½è¦ç”¨ barrier æ¥åŒæ­¥ã€‚CUDA ä¸­ç›´æ¥ä½¿ç”¨ <code>__syncthreads()</code> å°±å¥½ï¼Œè€Œ CPU ç®—æ³•è¦ä½¿ç”¨ <code>std::barrier</code>ã€‚ç”±äº <code>std::barrier</code> åœ¨ C++20 æ‰è¢«åŠ å…¥ï¼Œä¹¦ä¸Šç»™äº†ä¸€ä¸ªç®€å•çš„åŸºäºåŸå­å˜é‡çš„å¿™ç­‰å¾…çš„å®ç°ã€‚</p><h3 id=çº¿ç¨‹çš„æå‰é€€å‡º>çº¿ç¨‹çš„æå‰é€€å‡º
<a class=header-anchor href=#%e7%ba%bf%e7%a8%8b%e7%9a%84%e6%8f%90%e5%89%8d%e9%80%80%e5%87%ba></a></h3><p>CUDA ä¸­ <code>__syncthreads()</code> ä¸ä¼šè®©å‚ä¸åŒæ­¥çš„ GPU çº¿ç¨‹é€€å‡ºï¼Œè€Œ C++ <code>std::barrier</code> å…è®¸å½“å‰çº¿ç¨‹ç”¨ <code>arrive_and_drop()</code> æ¥é€€å‡ºåŒæ­¥ï¼Œè¿™ä¸€æ–¹é¢æ˜¯å› ä¸ºåœ¨ CPU ä¸Šè®¡ç®—å¯ä»¥æ§åˆ¶æ›´åŠ ç²¾ç»†ï¼Œå¦ä¸€æ–¹é¢æ˜¯å› ä¸ºæ“ä½œç³»ç»Ÿçš„çº¿ç¨‹èµ„æºå¾ˆå®è´µï¼Œæœ‰å¿…è¦åŠæ—¶é‡Šæ”¾ã€‚å‚è€ƒä¸‹é¢ä¸¤ä»½ä»£ç ï¼ˆå¿½ç•¥æ˜¯å¦ä½¿ç”¨åŒç¼“å†²è¿™ä¸€ç‚¹çš„å·®å¼‚ï¼‰ï¼š</p><p>CUDA ä¸­çš„ Koggle Stone ç®—æ³•ï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span>__global__ <span style=color:#dc322f>void</span> <span style=color:#268bd2>Kogge_Stone_scan_kernel</span>(<span style=color:#dc322f>float</span> <span style=color:#719e07>*</span>X, <span style=color:#dc322f>float</span> <span style=color:#719e07>*</span>Y, <span style=color:#dc322f>unsigned</span> <span style=color:#dc322f>int</span> N) {
</span></span><span style=display:flex><span>    __shared__ <span style=color:#dc322f>float</span> XY[SECTION_SIZE];
</span></span><span style=display:flex><span>    <span style=color:#dc322f>unsigned</span> <span style=color:#dc322f>int</span> i <span style=color:#719e07>=</span> blockIdx.x <span style=color:#719e07>*</span> blockDim.x <span style=color:#719e07>+</span> threadIdx.x;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#719e07>if</span> (i <span style=color:#719e07>&lt;</span> N) {
</span></span><span style=display:flex><span>        XY[threadIdx.x] <span style=color:#719e07>=</span> X[i];
</span></span><span style=display:flex><span>    } <span style=color:#719e07>else</span> {
</span></span><span style=display:flex><span>        XY[threadIdx.x] <span style=color:#719e07>=</span> <span style=color:#2aa198>0.0f</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#586e75>// æ³¨æ„ stride &lt; blockDim.x ä¿è¯äº†æ‰€æœ‰çº¿ç¨‹è¦ç»å†ç›¸åŒçš„è¿­ä»£æ¬¡æ•°
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#719e07>for</span> (<span style=color:#dc322f>unsigned</span> <span style=color:#dc322f>int</span> stride <span style=color:#719e07>=</span> <span style=color:#2aa198>1</span>; stride <span style=color:#719e07>&lt;</span> blockDim.x; stride <span style=color:#719e07>*=</span> <span style=color:#2aa198>2</span>) {
</span></span><span style=display:flex><span>        __syncthreads();
</span></span><span style=display:flex><span>        <span style=color:#dc322f>float</span> temp;
</span></span><span style=display:flex><span>        <span style=color:#719e07>if</span> (threadIdx.x <span style=color:#719e07>&gt;=</span> stride) {
</span></span><span style=display:flex><span>            temp <span style=color:#719e07>=</span> XY[threadIdx.x] <span style=color:#719e07>+</span> XY[threadIdx.x <span style=color:#719e07>-</span> stride];
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        __syncthreads();
</span></span><span style=display:flex><span>        <span style=color:#719e07>if</span> (threadIdx.x <span style=color:#719e07>&gt;=</span> stride) {
</span></span><span style=display:flex><span>            XY[threadIdx.x] <span style=color:#719e07>=</span> temp;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#719e07>if</span> (i <span style=color:#719e07>&lt;</span> N) {
</span></span><span style=display:flex><span>        Y[i] <span style=color:#719e07>=</span> XY[threadIdx.x];
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>C++ ä¸­çš„ Koggle Stone ç®—æ³•ï¼ˆæœ‰çº¿ç¨‹æå‰é€€å‡º barrierï¼‰ï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#dc322f>void</span> <span style=color:#268bd2>operator</span>()(Iterator first, Iterator last, 
</span></span><span style=display:flex><span>                std<span style=color:#719e07>::</span>vector<span style=color:#719e07>&lt;</span>value_type<span style=color:#719e07>&gt;&amp;</span> buffer, <span style=color:#dc322f>unsigned</span> i, barrier<span style=color:#719e07>&amp;</span> b) {
</span></span><span style=display:flex><span>    value_type<span style=color:#719e07>&amp;</span> ith_element <span style=color:#719e07>=</span> <span style=color:#719e07>*</span>(first <span style=color:#719e07>+</span> i);
</span></span><span style=display:flex><span>    <span style=color:#dc322f>bool</span> update_source <span style=color:#719e07>=</span> <span style=color:#b58900>false</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#586e75>// stride &lt;= i è€Œä¸æ˜¯ stride &lt; std::distance(first, last)
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#586e75>// ä½¿å¾—ä¸åŒçº¿ç¨‹çš„è¿­ä»£æ¬¡æ•°ä¸åŒï¼Œæœ‰äº›çº¿ç¨‹æ¯”å…¶ä»–çº¿ç¨‹æ›´æ—©ç¦»å¼€å¾ªç¯
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#719e07>for</span> (<span style=color:#dc322f>unsigned</span> step <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>, stride <span style=color:#719e07>=</span> <span style=color:#2aa198>1</span>; stride <span style=color:#719e07>&lt;=</span> i; <span style=color:#719e07>++</span>step, stride <span style=color:#719e07>*=</span> <span style=color:#2aa198>2</span>) {
</span></span><span style=display:flex><span>        value_type <span style=color:#719e07>const</span><span style=color:#719e07>&amp;</span> source <span style=color:#719e07>=</span> (step <span style=color:#719e07>%</span> <span style=color:#2aa198>2</span>) <span style=color:#719e07>?</span> buffer[i] <span style=color:#719e07>:</span> ith_element;
</span></span><span style=display:flex><span>        value_type<span style=color:#719e07>&amp;</span> dest <span style=color:#719e07>=</span> (step <span style=color:#719e07>%</span> <span style=color:#2aa198>2</span>) <span style=color:#719e07>?</span> ith_element : buffer[i];
</span></span><span style=display:flex><span>        value_type <span style=color:#719e07>const</span><span style=color:#719e07>&amp;</span> addend <span style=color:#719e07>=</span> (step <span style=color:#719e07>%</span> <span style=color:#2aa198>2</span>) <span style=color:#719e07>?</span> buffer[i <span style=color:#719e07>-</span> stride] <span style=color:#719e07>:</span> <span style=color:#719e07>*</span>(first <span style=color:#719e07>+</span> i <span style=color:#719e07>-</span> stride);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        dest <span style=color:#719e07>=</span> source <span style=color:#719e07>+</span> addend;
</span></span><span style=display:flex><span>        update_source <span style=color:#719e07>=</span> <span style=color:#719e07>!</span>(step <span style=color:#719e07>%</span> <span style=color:#2aa198>2</span>);
</span></span><span style=display:flex><span>        b.wait(); <span style=color:#586e75>// ç›¸å½“äº std::barrier::arrive_and_wait
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#719e07>if</span> (update_source) {
</span></span><span style=display:flex><span>        ith_element <span style=color:#719e07>=</span> buffer[i];
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#586e75>// å¿…é¡»ç¦»å¼€çº¿ç¨‹ç»„ï¼Œå¦åˆ™å…¶ä»–çº¿ç¨‹ä¼šå¡åœ¨ lockstep ä¸­
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    b.done_waiting(); <span style=color:#586e75>// ç›¸å½“äº std::barrier::arrive_and_drop
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>}
</span></span></code></pre></div><h3 id=segmented-scan-å’Œ-stream-based-scan>Segmented scan å’Œ stream-based scan
<a class=header-anchor href=#segmented-scan-%e5%92%8c-stream-based-scan></a></h3><p><em>C++ Concurrency in Action</em> ç¤ºä¾‹å¯¹æ¯ä¸ªå…ƒç´ ä¸“é—¨åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹ï¼ˆä»£ç ç®€å•ä½†æ•ˆç‡ä½ï¼‰ï¼Œå°½ç®¡ç³»ç»Ÿå†…çš„çº¿ç¨‹æ•°æœ‰ä¸Šé™ï¼ˆåœ¨æˆ‘çš„ wsl2 ä¸­ï¼Œ<code>cat /proc/sys/kernel/threads-max</code> ç»“æœä¸º <code>125610</code>ï¼‰ï¼Œä½†è¿™ä»ç„¶æ¯” CUDA ä¸­å…è®¸çš„ä¸€ä¸ª block ä¸­çš„æœ€å¤§çº¿ç¨‹æ•° 1024 è¦å¤šï¼Œå› æ­¤å®ç°çš„æ˜¯ä¸€ä¸ªä¸åˆ†æ®µçš„ scan ç®—æ³•ï¼Œæˆ–è€…è¯´æ²¡æœ‰å¯¹æ•°æ®é‡æå¤§çš„æƒ…å†µåšåˆ†æ®µå¤„ç†ã€‚</p><p>åœ¨ GPU ä¸Šï¼Œå› ä¸ºä¸€ä¸ª block ä¸­çº¿ç¨‹æ•°é‡æœ‰é™ï¼Œå¯ä»¥ï¼šâ‘ å…ˆåšåˆ†æ®µçš„ scanï¼ˆæ— è®ºæ˜¯ inclusive è¿˜æ˜¯ exclusiveï¼‰ï¼Œåœ¨æœ€åä¸€æ­¥ä¸­å°†æ¯ä¸ªæ®µçš„å…ƒç´ æ€»å’Œï¼ˆblock sumsï¼‰å†™å›åˆ°ä¸€ä¸ªè¾…åŠ©æ•°ç»„ä¸­ï¼›â‘¡å¯¹ block sums åš exclusive scanï¼Œå¾—åˆ°æ¯ä¸ª block ä¸Šåº”è¯¥åŠ å¤šå°‘å€¼ä½œä¸ºè¡¥å¿ï¼›â‘¢å°†è¿™äº›å€¼åŠ å›åˆ°ç¬¬ â‘  æ­¥ç®—å‡ºæ¥çš„ç»“æœä¸Šã€‚</p><p>å¦‚æœè¦åœ¨ GPU ä¸Šé¿å…åˆ†æ®µï¼Œå¯ä»¥å€Ÿç”¨â€œChunks ä¹‹é—´é€šä¿¡â€çš„æ€è·¯å®ç°ä¸€è¶Ÿçš„ç®—æ³•ã€‚<strong>è¿™æ ·å¯ä»¥é¿å…å…ˆå°†ä¸­é—´ç»“æœå†™åˆ°å…¨å±€å†…å­˜å†è¯»å–çš„å¼€é”€</strong>ã€‚è¿™è¢«ç§°ä¸º stream-based scan algorithmã€‚<em>Programming Massively Parallel Processors</em> ä¸­ä»‹ç»äº†ä»¥åŸå­å˜é‡æ¥åŒæ­¥çš„æ–¹æ³•ï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span>__shared__ <span style=color:#dc322f>float</span> previous_sum;
</span></span><span style=display:flex><span><span style=color:#719e07>if</span> (threadIdx.x <span style=color:#719e07>==</span> <span style=color:#2aa198>0</span>){
</span></span><span style=display:flex><span>    <span style=color:#586e75>// Wait for previous flag
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#719e07>while</span>(atomicAdd(<span style=color:#719e07>&amp;</span>flags[bid], <span style=color:#2aa198>0</span>) <span style=color:#719e07>==</span> <span style=color:#2aa198>0</span>) { }
</span></span><span style=display:flex><span>    <span style=color:#586e75>// Read previous partial sum
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    previous_sum <span style=color:#719e07>=</span> scan_value[bid];
</span></span><span style=display:flex><span>    <span style=color:#586e75>// Propagate partial sum
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    scan_value[bid <span style=color:#719e07>+</span> <span style=color:#2aa198>1</span>] <span style=color:#719e07>=</span> previous_sum <span style=color:#719e07>+</span> local_sum;
</span></span><span style=display:flex><span>    <span style=color:#586e75>// Memory fence
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    __threadfence();
</span></span><span style=display:flex><span>    <span style=color:#586e75>// Set flag
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    atomicAdd(<span style=color:#719e07>&amp;</span>flags[bid <span style=color:#719e07>+</span> <span style=color:#2aa198>1</span>], <span style=color:#2aa198>1</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>__syncthreads();
</span></span></code></pre></div><p>ä¸Šé¢è¿™ç§æ–¹æ³•æœ‰ä¸ªé—®é¢˜æ˜¯ï¼šGPU ä¸Šå—å¹¶ä¸æ˜¯ï¼ˆæŒ‰ç…§ <code>blockIdx.x</code>ï¼‰å…ˆåæ‰§è¡Œçš„ï¼Œæœ‰å¯èƒ½å‰ä¸€ä¸ªå—æ²¡æœ‰è¢«æ‰§è¡Œï¼Œè€Œåä¸€ä¸ªå—å¼€å§‹æ‰§è¡Œäº†ã€‚è¿™æ ·å¯èƒ½å¯¼è‡´æ€§èƒ½ä¸‹é™æˆ–è€…æ­»é”ã€‚ä¹¦ä¸Šè¯´å¦‚æœ block i åˆ° i+N å ç”¨äº†æ‰€æœ‰çš„ SMï¼Œé‚£ä¹ˆ block i-1 ä¸èƒ½å¾—åˆ°è°ƒåº¦ï¼Œblock i åˆ° i+N åªèƒ½æ— é™ç­‰å¾…ä¸‹å»ã€‚</p><p>ä¸€ç§è¡¥æ•‘çš„åŠæ³•æ˜¯ dynamic block index assignmentï¼Œä¹Ÿå°±æ˜¯ä¸ä½¿ç”¨ <code>blockIdx.x</code>ï¼Œè€Œæ˜¯é€šè¿‡åŸå­å˜é‡æ¥åŠ¨æ€è·å– block ç¼–å·ï¼š</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span>__shared__ <span style=color:#dc322f>unsigned</span> <span style=color:#dc322f>int</span> bid_s;
</span></span><span style=display:flex><span><span style=color:#719e07>if</span> (threadIdx.x <span style=color:#719e07>==</span> <span style=color:#2aa198>0</span>) {
</span></span><span style=display:flex><span>    bid_s <span style=color:#719e07>=</span> atomicAdd(blockCounter, <span style=color:#2aa198>1</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>__syncthreads();
</span></span><span style=display:flex><span><span style=color:#dc322f>unsigned</span> <span style=color:#dc322f>int</span> bid <span style=color:#719e07>=</span> bid_s;
</span></span></code></pre></div></div><footer class=post-footer><div class=post-tags><a href=/tags/cpp>cpp
</a><a href=/tags/cpp-concurrency-in-action>cpp-concurrency-in-action</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/cpp-concurrency-in-action/9.-Advanced-thread-management/ rel=next title="9. Advanced thread management"><i class="fa fa-chevron-left"></i> 9. Advanced thread management</a></div><div class="post-nav-prev post-nav-item"><a href=/cpp-concurrency-in-action/5.1-libstdc++-%E5%AF%B9%E5%85%B1%E4%BA%AB%E6%8C%87%E9%92%88%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C%E7%9A%84%E6%94%AF%E6%8C%81/ rel=prev title="5.1 libstdc++ å¯¹å…±äº«æŒ‡é’ˆåŸå­æ“ä½œçš„æ”¯æŒ">5.1 libstdc++ å¯¹å…±äº«æŒ‡é’ˆåŸå­æ“ä½œçš„æ”¯æŒ
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2023 - 2025
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>ğŸ¤–</span></div><div class=powered-by>ç”± <a href=https://gohugo.io title=0.143.1 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.5.3 target=_blank>Hugo NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨</div></div></footer><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js defer></script><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":false,"save":"manual"},"copybtn":true,"darkmode":false,"hostname":"https://hxhue.github.io/","i18n":{"ds_day":" å¤©å‰","ds_days":" å¤© ","ds_hour":" å°æ—¶å‰","ds_hours":" å°æ—¶ ","ds_just":"åˆšåˆš","ds_min":" åˆ†é’Ÿå‰","ds_mins":" åˆ†é’Ÿ","ds_month":" ä¸ªæœˆå‰","ds_years":" å¹´ ","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","placeholder":"æœç´¢..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":false,"transition":{"collheader":"fadeInLeft","menu_item":"fadeInDown","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":false,"plugin":"waline"},"views":{"enable":false,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"cdnjs","router":"https://cdnjs.cloudflare.com/ajax/libs"},"version":"4.5.3"}</script><script type=text/javascript src=/js/main.min.37ba8b54f9d4d784d08028c45eea93b5d4e13eda8ee7fb0d2edd6f3fac66cfd2.js defer></script></body></html>