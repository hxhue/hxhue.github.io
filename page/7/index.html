<!doctype html><html lang=zh-CN data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.143.1"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="Bluegill"><meta itemprop=description content="个人博客，主要是零散的笔记。"><meta itemprop=image content="https://hxhue.github.io/imgs/371907.jpg"><meta itemprop=keywords content><meta name=google-site-verification content="hwfud_ndcnJHe2Jz7ClToP1nuUA3k7FqZv-0VpFAHjg"><link type=text/css rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css><link rel=stylesheet href=/css/main.min.bea76f574a755574e17d42bea39502a74ca3ca4db65807b8c82d3e26dcec8420.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><link rel=stylesheet type=text/css href=/css/style.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/github-markdown-css@5.3.0/github-markdown-dark.css><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js></script><script>MathJax={tex:{displayMath:[["$$","$$"],["\\[","\\]"]],inlineMath:[["$","$"],["\\(","\\)"]]},svg:{fontCache:"global"}}</script><script type=module>
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: false });
  mermaid.mermaidAPI.initialize();
  window.mermaid = mermaid;
</script><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":true,"isPage":false,"path":"hxhue.github.io","permalink":"https://hxhue.github.io/","title":"Bluegill","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>Bluegill</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>Bluegill</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description></p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class="hvr-icon-pulse menu-item-active" rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about/ class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档</a></li><li class="menu-item menu-item-categories"><a href=/categories/ class=hvr-icon-pulse rel=section><i class="fa fa-th hvr-icon"></i>分类</a></li><li class="menu-item menu-item-tags"><a href=/tags/ class=hvr-icon-pulse rel=section><i class="fa fa-hashtag hvr-icon"></i>标签</a></li><li class="menu-item menu-item-daily"><a href=/daily/ class=hvr-icon-pulse rel=section><i class="fa fa-newspaper hvr-icon"></i>随笔</a></li><li class="menu-item menu-item-discovery"><a href=https://rift-fear-f2c.notion.site/2025-1e354a33cfb1802c841bdf29f2f3dab3 class=hvr-icon-pulse rel=section><i class="fa fa-compass hvr-icon"></i>发现</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-overview-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=🤖 src=/imgs/371907.jpg><p class=site-author-name itemprop=name>🤖</p><div class=site-description itemprop=description>个人博客，主要是零散的笔记。</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>433</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>12</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>86</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/hxhue title="Github → https://github.com/hxhue" rel=noopener target=_blank><i class="fab fa-github fa-fw"></i>
Github
</a></span><span class=links-of-social-item><a href=/rss.xml title="RSS 订阅 → /rss.xml" rel=noopener target=_blank><i class="fa fa-rss fa-fw"></i>
RSS 订阅</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://shuai.guru/ title=https://shuai.guru/ target=_blank>shuai.guru</a></li></ul></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner index posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://hxhue.github.io/posts/programming/python/PyTorch-optimizer.step-%E5%BD%B1%E5%93%8D-BatchNorm2d-%E6%9D%83%E9%87%8D%E7%9A%84%E6%A2%AF%E5%BA%A6/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/371907.jpg"><meta itemprop=name content="🤖"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="🤖"><meta itemprop=description content="个人博客，主要是零散的笔记。"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="PyTorch `optimizer.step()` 影响 BatchNorm2d 权重的梯度"><meta itemprop=description content="我发现 optimizer.step() 这一步会改变 torch.nn.BatchNorm2d 层的 weight 和 bias 的梯度（看上去是每个元素按照相同的比例进行了缩放）。如果想要比较梯度，应该在 optimizer.step() 之前来对比，想要对比更新后的权重，要在 optimizer.step() 之后对比。"></span><header class=post-header><h2 class=post-title itemprop="name headline"><a href=/posts/programming/python/PyTorch-optimizer.step-%E5%BD%B1%E5%93%8D-BatchNorm2d-%E6%9D%83%E9%87%8D%E7%9A%84%E6%A2%AF%E5%BA%A6/ itemprop=url class=post-title-link>PyTorch `optimizer.step()` 影响 BatchNorm2d 权重的梯度</a></h2><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2024-11-06 00:00:00 +0800 CST" itemprop="dateCreated datePublished" datetime="2024-11-06 00:00:00 +0800 CST">2024-11-06
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar-check"></i>
</span><span class=post-meta-item-text title=更新于>更新于：
</span><time title=修改时间：2024-11-29T00:00:00+08:00 itemprop=dateModified datetime=2024-11-29T00:00:00+08:00>2024-11-29</time></span></div></div></header><div class=post-body itemprop=articleBody><p>我发现 <code>optimizer.step()</code> 这一步会改变 <code>torch.nn.BatchNorm2d</code> 层的 weight 和 bias 的梯度（看上去是每个元素按照相同的比例进行了缩放）。如果想要比较梯度，应该在 <code>optimizer.step()</code> 之前来对比，想要对比更新后的权重，要在 <code>optimizer.step()</code> 之后对比。</p><p>这很不应该啊？</p><p>版本 2.4.1 + CUDA 11.7（自行构建）上和版本 2.2.2 + CUDA 11.8 上都验证过会出现这种情况。</p></div><footer class=post-footer><div readmore=false><div class=readmore-overlay><div class=readmore-overlay-center><div class=post-button><a class=btn href=/posts/programming/python/PyTorch-optimizer.step-%E5%BD%B1%E5%93%8D-BatchNorm2d-%E6%9D%83%E9%87%8D%E7%9A%84%E6%A2%AF%E5%BA%A6/#more rel=contents>阅读全文 &#187;</a></div></div></div><div class=no-more-to-read><hr><center>没有啦~</center></div></div><div class=post-eof></div></footer></article></div><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://hxhue.github.io/posts/programming/python/%E5%9C%A8-VS-Code-%E4%B8%AD%E4%BB%8E-C++-%E8%B0%83%E8%AF%95-pybind/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/371907.jpg"><meta itemprop=name content="🤖"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="🤖"><meta itemprop=description content="个人博客，主要是零散的笔记。"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="在 VS Code 中从 C++ 调试 pybind"><meta itemprop=description content="使用 debugpy 调试

在被 C++ 调用的 python 文件中加上这样的内容（端口可以随便选）：
import debugpy
debugpy.listen(5678)
debugpy.wait_for_client()
这样在第一次加载这个 python 模块的时候，这行代码就会暂停等待调试器连接。我们可以创建这样的 Python 调试配置，随后连接正在监听端口的 python 程序。"></span><header class=post-header><h2 class=post-title itemprop="name headline"><a href=/posts/programming/python/%E5%9C%A8-VS-Code-%E4%B8%AD%E4%BB%8E-C++-%E8%B0%83%E8%AF%95-pybind/ itemprop=url class=post-title-link>在 VS Code 中从 C++ 调试 pybind</a></h2><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2024-11-05 00:00:00 +0800 CST" itemprop="dateCreated datePublished" datetime="2024-11-05 00:00:00 +0800 CST">2024-11-05
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar-check"></i>
</span><span class=post-meta-item-text title=更新于>更新于：
</span><time title=修改时间：2024-12-06T00:00:00+08:00 itemprop=dateModified datetime=2024-12-06T00:00:00+08:00>2024-12-06</time></span></div></div></header><div class=post-body itemprop=articleBody><h1 id=使用-debugpy-调试>使用 debugpy 调试
<a class=header-anchor href=#%e4%bd%bf%e7%94%a8-debugpy-%e8%b0%83%e8%af%95></a></h1><p>在被 C++ 调用的 python 文件中加上这样的内容（端口可以随便选）：</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#719e07>import</span> debugpy
</span></span><span style=display:flex><span>debugpy<span style=color:#719e07>.</span>listen(<span style=color:#2aa198>5678</span>)
</span></span><span style=display:flex><span>debugpy<span style=color:#719e07>.</span>wait_for_client()
</span></span></code></pre></div><p>这样在第一次加载这个 python 模块的时候，这行代码就会暂停等待调试器连接。我们可以创建这样的 Python 调试配置，随后连接正在监听端口的 python 程序。</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#268bd2>&#34;version&#34;</span>: <span style=color:#2aa198>&#34;0.2.0&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#268bd2>&#34;configurations&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#268bd2>&#34;name&#34;</span>: <span style=color:#2aa198>&#34;Python attach&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#268bd2>&#34;type&#34;</span>: <span style=color:#2aa198>&#34;debugpy&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#268bd2>&#34;request&#34;</span>: <span style=color:#2aa198>&#34;attach&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#268bd2>&#34;connect&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#268bd2>&#34;host&#34;</span>: <span style=color:#2aa198>&#34;127.0.0.1&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#268bd2>&#34;port&#34;</span>: <span style=color:#2aa198>5678</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>如果 C++ 程序的调试器还开着，工作区就会同时存在两个调试器。通过切换调试会话可以对 C++ 和 Python 同时调试。</p></div><footer class=post-footer><div readmore=true><div class=readmore-overlay><div class=readmore-overlay-center><div class=post-button><a class=btn href=/posts/programming/python/%E5%9C%A8-VS-Code-%E4%B8%AD%E4%BB%8E-C++-%E8%B0%83%E8%AF%95-pybind/#more rel=contents>阅读全文 &#187;</a></div></div></div><div class=no-more-to-read><hr><center>没有啦~</center></div></div><div class=post-eof></div></footer></article></div><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://hxhue.github.io/posts/programming/python/PyTorch-%E6%B3%A8%E5%86%8C%E5%8F%8D%E5%90%91%E4%BC%A0%E6%92%AD%E7%9A%84%E9%92%A9%E5%AD%90/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/371907.jpg"><meta itemprop=name content="🤖"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="🤖"><meta itemprop=description content="个人博客，主要是零散的笔记。"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="PyTorch 注册反向传播的钩子"><meta itemprop=description content="注册钩子

通过注册钩子，收集模型运行时的输出，可以对每一层的输出值进行调试。
假设模型是 model，我们可以把每一层的输入的梯度和输出的梯度保存在字典中："></span><header class=post-header><h2 class=post-title itemprop="name headline"><a href=/posts/programming/python/PyTorch-%E6%B3%A8%E5%86%8C%E5%8F%8D%E5%90%91%E4%BC%A0%E6%92%AD%E7%9A%84%E9%92%A9%E5%AD%90/ itemprop=url class=post-title-link>PyTorch 注册反向传播的钩子</a></h2><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2024-10-30 00:00:00 +0800 CST" itemprop="dateCreated datePublished" datetime="2024-10-30 00:00:00 +0800 CST">2024-10-30
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar-check"></i>
</span><span class=post-meta-item-text title=更新于>更新于：
</span><time title=修改时间：2024-11-06T00:00:00+08:00 itemprop=dateModified datetime=2024-11-06T00:00:00+08:00>2024-11-06</time></span></div></div></header><div class=post-body itemprop=articleBody><h1 id=注册钩子>注册钩子
<a class=header-anchor href=#%e6%b3%a8%e5%86%8c%e9%92%a9%e5%ad%90></a></h1><p>通过注册钩子，收集模型运行时的输出，可以对每一层的输出值进行调试。</p><p>假设模型是 <code>model</code>，我们可以把每一层的输入的梯度和输出的梯度保存在字典中：</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>module_names <span style=color:#719e07>=</span> {v: k <span style=color:#719e07>for</span> k, v <span style=color:#719e07>in</span> model<span style=color:#719e07>.</span>named_modules()}
</span></span><span style=display:flex><span>grad_inputs <span style=color:#719e07>=</span> {}
</span></span><span style=display:flex><span>grad_outputs <span style=color:#719e07>=</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#719e07>def</span> <span style=color:#268bd2>hook</span>(m, grad_input, grad_output) <span style=color:#719e07>-&gt;</span> Tuple[torch<span style=color:#719e07>.</span>Tensor] <span style=color:#719e07>|</span> <span style=color:#cb4b16>None</span>:
</span></span><span style=display:flex><span>    <span style=color:#719e07>nonlocal</span> module_names, grad_inputs, grad_outputs
</span></span><span style=display:flex><span>    name <span style=color:#719e07>=</span> module_names[m]
</span></span><span style=display:flex><span>    grad_inputs[name] <span style=color:#719e07>=</span> grad_input
</span></span><span style=display:flex><span>    grad_outputs[name] <span style=color:#719e07>=</span> grad_output
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#719e07>for</span> m <span style=color:#719e07>in</span> model<span style=color:#719e07>.</span>modules(): <span style=color:#586e75># 或者在这里遍历 named_modules() 并记录名称和模型的对应关系</span>
</span></span><span style=display:flex><span>    m<span style=color:#719e07>.</span>register_full_backward_hook(hook)
</span></span></code></pre></div><p>注意 <code>grad_input</code> 的含义是输入的梯度，<code>grad_output</code> 的含义是输出的梯度。假设一个 module 的 <code>forward()</code> 函数负责计算 <code>y = 2 * x</code>，那么 <code>grad_input</code> 相当于 <code>retain_grad()</code> 之后的 <code>x.grad</code>，<code>grad_output</code> 相当于 <code>retain_grad()</code> 之后的 <code>y.grad</code>。</p><p>另外还要注意：</p></div><footer class=post-footer><div readmore=true><div class=readmore-overlay><div class=readmore-overlay-center><div class=post-button><a class=btn href=/posts/programming/python/PyTorch-%E6%B3%A8%E5%86%8C%E5%8F%8D%E5%90%91%E4%BC%A0%E6%92%AD%E7%9A%84%E9%92%A9%E5%AD%90/#more rel=contents>阅读全文 &#187;</a></div></div></div><div class=no-more-to-read><hr><center>没有啦~</center></div></div><div class=post-eof></div></footer></article></div><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://hxhue.github.io/posts/programming/python/%E7%94%A8%E7%89%B9%E5%AE%9A%E7%9A%84-CUDA-%E7%89%88%E6%9C%AC%E6%9E%84%E5%BB%BA-PyTorch-%E5%B9%B6%E6%89%93%E5%8C%85-Conda-%E7%8E%AF%E5%A2%83/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/371907.jpg"><meta itemprop=name content="🤖"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="🤖"><meta itemprop=description content="个人博客，主要是零散的笔记。"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="用特定的 CUDA 版本构建 PyTorch"><meta itemprop=description content="说明

文章是按照我解决问题的过程来写的，不是一个一步式的教程，所以显得有点凌乱。如果要操作请务必先看完全文，以免跟着中间过程走了同样的弯路。如果不想看前面的内容可以直接跳到 conda 打包这一节。"></span><header class=post-header><h2 class=post-title itemprop="name headline"><a href=/posts/programming/python/%E7%94%A8%E7%89%B9%E5%AE%9A%E7%9A%84-CUDA-%E7%89%88%E6%9C%AC%E6%9E%84%E5%BB%BA-PyTorch-%E5%B9%B6%E6%89%93%E5%8C%85-Conda-%E7%8E%AF%E5%A2%83/ itemprop=url class=post-title-link>用特定的 CUDA 版本构建 PyTorch</a></h2><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2024-10-15 00:00:00 +0800 CST" itemprop="dateCreated datePublished" datetime="2024-10-15 00:00:00 +0800 CST">2024-10-15
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar-check"></i>
</span><span class=post-meta-item-text title=更新于>更新于：
</span><time title=修改时间：2025-01-17T00:00:00+08:00 itemprop=dateModified datetime=2025-01-17T00:00:00+08:00>2025-01-17</time></span></div></div></header><div class=post-body itemprop=articleBody><h1 id=说明>说明
<a class=header-anchor href=#%e8%af%b4%e6%98%8e></a></h1><p>文章是按照我解决问题的过程来写的，不是一个一步式的教程，所以显得有点凌乱。如果要操作请务必先看完全文，以免跟着中间过程走了同样的弯路。<strong>如果不想看前面的内容可以直接跳到 conda 打包这一节</strong>。</p><h1 id=编译和安装-pytorchegg-格式>编译和安装 PyTorch（egg 格式）
<a class=header-anchor href=#%e7%bc%96%e8%af%91%e5%92%8c%e5%ae%89%e8%a3%85-pytorchegg-%e6%a0%bc%e5%bc%8f></a></h1><p>PyTorch 官方只为每个 PyTorch 版本准备了几个可选的 CUDA 版本，如果需要对 PyTorch 使用不同的 CUDA 就需要自己从源码中编译。我们想要用 PyTorch 2.4.1 源码构建支持 CUDA 11.7 的包。</p><p>参考官方的说明 <a href=https://github.com/pytorch/pytorch#from-source title=https://github.com/pytorch/pytorch#from-source rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://github.com/pytorch/pytorch#from-source<i class="fa fa-external-link-alt"></i></a> ，过程非常简单，如果下载顺畅，在 32 核服务器上需要近一个小时编译完成。我下载的版本是 <a href=https://github.com/pytorch/pytorch/releases/download/v2.4.1/pytorch-v2.4.1.tar.gz title=v2.4.1 rel="noopener external nofollow noreferrer" target=_blank class=exturl>v2.4.1<i class="fa fa-external-link-alt"></i></a>。总体流程是先准备好一个 conda 环境，只安装好 python 即可。然后根据说明安装各种东西，最后用 <code>python setup.py install</code> 或者 <code>python setup.py develop</code> 来安装 PyTorch。</p><div class="markdown-alert markdown-alert-note"><p class=markdown-alert-title><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1116 0A8 8 0 010 8zm8-6.5a6.5 6.5.0 100 13 6.5 6.5.0 000-13zM6.5 7.75A.75.75.0 017.25 7h1a.75.75.0 01.75.75v2.75h.25a.75.75.0 010 1.5h-2a.75.75.0 010-1.5h.25v-2h-.25a.75.75.0 01-.75-.75zM8 6a1 1 0 110-2 1 1 0 010 2z"/></svg>Note</p><p>如何选择 <a href=https://github.com/pypa/setuptools/blob/main/setuptools/command/install.py title=install rel="noopener external nofollow noreferrer" target=_blank class=exturl><code>install</code><i class="fa fa-external-link-alt"></i></a> 和 <a href=https://github.com/pypa/setuptools/blob/main/setuptools/command/develop.py title=develop rel="noopener external nofollow noreferrer" target=_blank class=exturl><code>develop</code><i class="fa fa-external-link-alt"></i></a>？</p><ul><li>根据 <a href=https://stackoverflow.com/a/26588871/ title=https://stackoverflow.com/a/26588871/ rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://stackoverflow.com/a/26588871/<i class="fa fa-external-link-alt"></i></a> ，<code>develop</code> 会在 site-packages 中创建一个 .egg-link 文件，将包的路径指向工作区，这样就可以通过在工作区修改代码来影响系统中安装的 Python 包。</li><li>根据 <a href=https://github.com/pypa/setuptools/blob/main/setuptools/command/install.py title=setuptools/command/install.py rel="noopener external nofollow noreferrer" target=_blank class=exturl>setuptools/command/install.py<i class="fa fa-external-link-alt"></i></a>，<code>install</code> 会调用命令 <code>bdist_egg</code>，会生成一个 egg 格式的发布包并安装，在 site-packages 对应的 egg 文件夹中确实有源码的一份副本。</li></ul><p>注意 .egg 和 .egg-link 有区别！</p></div><p>然后 conda 环境中就会出现 PyTorch，而且用的 CUDA 版本也是系统里面的版本（如果用的镜像基于 NVIDIA 的 CUDA 镜像就肯定没问题），可以用 <code>python -c "import torch; print(torch.version.cuda)"</code> 来验证一下。<strong>不过，这时如果下载其他的 pip 包，pip 就会认为 torch 没有被安装，并且帮你去下载一个新的</strong>，下载完成之后 CUDA 的版本就变了！</p></div><footer class=post-footer><div readmore=true><div class=readmore-overlay><div class=readmore-overlay-center><div class=post-button><a class=btn href=/posts/programming/python/%E7%94%A8%E7%89%B9%E5%AE%9A%E7%9A%84-CUDA-%E7%89%88%E6%9C%AC%E6%9E%84%E5%BB%BA-PyTorch-%E5%B9%B6%E6%89%93%E5%8C%85-Conda-%E7%8E%AF%E5%A2%83/#more rel=contents>阅读全文 &#187;</a></div></div></div><div class=no-more-to-read><hr><center>没有啦~</center></div></div><div class=post-eof></div></footer></article></div><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://hxhue.github.io/posts/programming/cuda/fma-%E6%8C%87%E4%BB%A4/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/371907.jpg"><meta itemprop=name content="🤖"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="🤖"><meta itemprop=description content="个人博客，主要是零散的笔记。"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="fma 指令"><meta itemprop=description content="今天写 atan 反向传播的 CUDA kernel 发现和 torch 算出来的不一样。核心代码如下：
__global__ void elementwise_atan_backward(float* in, float* din, float* dout, int N) {
  for (int i = blockIdx.x * blockDim.x + threadIdx.x; i < (N); i += blockDim.x * gridDim.x) {
    // din[i] = dout[i] / (in[i] * in[i] + 1.f);
    //
    // pytorch/tools/autograd/derivatives.yaml
    // - name: atan(Tensor self) -> Tensor
    //   self: grad / (self * self + 1).conj()
    //   result: auto_element_wise
    //
    float square = in[i] * in[i] + 0.f; // disable fma so we can align with torch
    din[i] = dout[i] / (square + 1.f);
  }
}
PyTorch 是用规则文件生成自动梯度求导的，torch.atan 的求导规则为 grad / (self * self + 1).conj()，其中 grad 和 self 都是张量，conj() 在实数张量的场景下是可以不管的。我按照同样的方法写 kernel，发现和 torch 算出来的结果有极小的差异。"></span><header class=post-header><h2 class=post-title itemprop="name headline"><a href=/posts/programming/cuda/fma-%E6%8C%87%E4%BB%A4/ itemprop=url class=post-title-link>fma 指令</a></h2><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2024-10-14 00:00:00 +0800 CST" itemprop="dateCreated datePublished" datetime="2024-10-14 00:00:00 +0800 CST">2024-10-14
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar-check"></i>
</span><span class=post-meta-item-text title=更新于>更新于：
</span><time title=修改时间：2024-10-17T00:00:00+08:00 itemprop=dateModified datetime=2024-10-17T00:00:00+08:00>2024-10-17</time></span></div></div></header><div class=post-body itemprop=articleBody><p>今天写 atan 反向传播的 CUDA kernel 发现和 torch 算出来的不一样。核心代码如下：</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c data-lang=c><span style=display:flex><span>__global__ <span style=color:#dc322f>void</span> <span style=color:#268bd2>elementwise_atan_backward</span>(<span style=color:#dc322f>float</span><span style=color:#719e07>*</span> in, <span style=color:#dc322f>float</span><span style=color:#719e07>*</span> din, <span style=color:#dc322f>float</span><span style=color:#719e07>*</span> dout, <span style=color:#dc322f>int</span> N) {
</span></span><span style=display:flex><span>  <span style=color:#719e07>for</span> (<span style=color:#dc322f>int</span> i <span style=color:#719e07>=</span> blockIdx.x <span style=color:#719e07>*</span> blockDim.x <span style=color:#719e07>+</span> threadIdx.x; i <span style=color:#719e07>&lt;</span> (N); i <span style=color:#719e07>+=</span> blockDim.x <span style=color:#719e07>*</span> gridDim.x) {
</span></span><span style=display:flex><span>    <span style=color:#586e75>// din[i] = dout[i] / (in[i] * in[i] + 1.f);
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#586e75>//
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#586e75>// pytorch/tools/autograd/derivatives.yaml
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#586e75>// - name: atan(Tensor self) -&gt; Tensor
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#586e75>//   self: grad / (self * self + 1).conj()
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#586e75>//   result: auto_element_wise
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#586e75>//
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#dc322f>float</span> square <span style=color:#719e07>=</span> in[i] <span style=color:#719e07>*</span> in[i] <span style=color:#719e07>+</span> <span style=color:#2aa198>0.f</span>; <span style=color:#586e75>// disable fma so we can align with torch
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    din[i] <span style=color:#719e07>=</span> dout[i] <span style=color:#719e07>/</span> (square <span style=color:#719e07>+</span> <span style=color:#2aa198>1.f</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>PyTorch 是用规则文件生成自动梯度求导的，<code>torch.atan</code> 的求导规则为 <code>grad / (self * self + 1).conj()</code>，其中 <code>grad</code> 和 <code>self</code> 都是张量，<code>conj()</code> 在实数张量的场景下是可以不管的。我按照同样的方法写 kernel，发现和 torch 算出来的结果有极小的差异。</p><p><a href=https://godbolt.org/z/qx4h6roe7 title=上面的代码 rel="noopener external nofollow noreferrer" target=_blank class=exturl>上面的代码<i class="fa fa-external-link-alt"></i></a> 我也放在 Compiler Explorer 了，从汇编来看，<code>in[i] * in[i] + 1.f</code> 被优化成了一条指令，这样不仅更快，而且精度更高（从网上的资料来看，nvcc 默认会进行不少优化，fma 就是其中一种）。PyTorch 生成梯度求导规则的方法将乘法和加法放在了两个不同的 kernel 里面，导致编译器无法使用 fma 优化。</p><p>我尝试把乘法和加法拆开，但是编译器太聪明了，还是使用了 fma 优化：</p></div><footer class=post-footer><div readmore=true><div class=readmore-overlay><div class=readmore-overlay-center><div class=post-button><a class=btn href=/posts/programming/cuda/fma-%E6%8C%87%E4%BB%A4/#more rel=contents>阅读全文 &#187;</a></div></div></div><div class=no-more-to-read><hr><center>没有啦~</center></div></div><div class=post-eof></div></footer></article></div><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://hxhue.github.io/posts/cli/docker/%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7%E5%88%B0-docker-%E7%BB%84/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/371907.jpg"><meta itemprop=name content="🤖"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="🤖"><meta itemprop=description content="个人博客，主要是零散的笔记。"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="添加用户到 docker 组"><meta itemprop=description content="通过 sudo usermod -aG docker xx 把 xx 加到 docker 组之后，需要先退出当前登录才能生效。"></span><header class=post-header><h2 class=post-title itemprop="name headline"><a href=/posts/cli/docker/%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7%E5%88%B0-docker-%E7%BB%84/ itemprop=url class=post-title-link>添加用户到 docker 组</a></h2><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2024-10-13 00:00:00 +0800 CST" itemprop="dateCreated datePublished" datetime="2024-10-13 00:00:00 +0800 CST">2024-10-13
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar-check"></i>
</span><span class=post-meta-item-text title=更新于>更新于：
</span><time title=修改时间：2024-10-17T00:00:00+08:00 itemprop=dateModified datetime=2024-10-17T00:00:00+08:00>2024-10-17</time></span></div></div></header><div class=post-body itemprop=articleBody><p>通过 <code>sudo usermod -aG docker xx</code> 把 xx 加到 docker 组之后，需要先退出当前登录才能生效。</p></div><footer class=post-footer><div readmore=false><div class=readmore-overlay><div class=readmore-overlay-center><div class=post-button><a class=btn href=/posts/cli/docker/%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7%E5%88%B0-docker-%E7%BB%84/#more rel=contents>阅读全文 &#187;</a></div></div></div><div class=no-more-to-read><hr><center>没有啦~</center></div></div><div class=post-eof></div></footer></article></div><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://hxhue.github.io/posts/programming/python/%E5%AE%89%E8%A3%85-cv2-Python-%E5%8C%85/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/371907.jpg"><meta itemprop=name content="🤖"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="🤖"><meta itemprop=description content="个人博客，主要是零散的笔记。"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="安装 cv2 Python 包"><meta itemprop=description content="通过 mamba/conda 安装

mamba install -c mempo opencv
通过 pip 安装

pip install opencv-python opencv-python-headless
可能需要安装 opencv-contrib-python-headless，但是我这里不安装也成功了。
注意

两种安装方式不能混合使用。尤其是在通过 pip 安装 opencv-python 之后，发现不生效，是不能通过 conda 安装 opencv 来补救的。只能继续安装 opencv-python-headless。"></span><header class=post-header><h2 class=post-title itemprop="name headline"><a href=/posts/programming/python/%E5%AE%89%E8%A3%85-cv2-Python-%E5%8C%85/ itemprop=url class=post-title-link>安装 cv2 Python 包</a></h2><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2024-10-11 00:00:00 +0800 CST" itemprop="dateCreated datePublished" datetime="2024-10-11 00:00:00 +0800 CST">2024-10-11
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar-check"></i>
</span><span class=post-meta-item-text title=更新于>更新于：
</span><time title=修改时间：2024-10-17T00:00:00+08:00 itemprop=dateModified datetime=2024-10-17T00:00:00+08:00>2024-10-17</time></span></div></div></header><div class=post-body itemprop=articleBody><h1 id=通过-mambaconda-安装>通过 mamba/conda 安装
<a class=header-anchor href=#%e9%80%9a%e8%bf%87-mambaconda-%e5%ae%89%e8%a3%85></a></h1><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>mamba install -c mempo opencv
</span></span></code></pre></div><h1 id=通过-pip-安装>通过 pip 安装
<a class=header-anchor href=#%e9%80%9a%e8%bf%87-pip-%e5%ae%89%e8%a3%85></a></h1><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>pip install opencv-python opencv-python-headless
</span></span></code></pre></div><p>可能需要安装 opencv-contrib-python-headless，但是我这里不安装也成功了。</p><h1 id=注意>注意
<a class=header-anchor href=#%e6%b3%a8%e6%84%8f></a></h1><p>两种安装方式不能混合使用。尤其是在通过 <code>pip</code> 安装 opencv-python 之后，发现不生效，是不能通过 conda 安装 opencv 来补救的。只能继续安装 opencv-python-headless。</p></div><footer class=post-footer><div readmore=false><div class=readmore-overlay><div class=readmore-overlay-center><div class=post-button><a class=btn href=/posts/programming/python/%E5%AE%89%E8%A3%85-cv2-Python-%E5%8C%85/#more rel=contents>阅读全文 &#187;</a></div></div></div><div class=no-more-to-read><hr><center>没有啦~</center></div></div><div class=post-eof></div></footer></article></div><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://hxhue.github.io/posts/programming/cpp/%E5%9C%A8-C++-%E9%A1%B9%E7%9B%AE%E4%B8%AD%E4%BD%BF%E7%94%A8-Pybind11/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/371907.jpg"><meta itemprop=name content="🤖"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="🤖"><meta itemprop=description content="个人博客，主要是零散的笔记。"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="在 C++ 项目中使用 Pybind11"><meta itemprop=description content="安装 pybind11：
pip install 'pybind11[global]'
# add your executable
set(PYTHON_EXECUTABLE /opt/miniforge3/bin/python)
find_package(pybind11 REQUIRED)
target_link_libraries(your_executable PRIVATE pybind11::pybind11 pybind11::embed)
设置 PYTHON_EXECUTABLE 可以确保 pybind11 使用正确的 python 版本，这样才能在里面找到你安装好的其他的包。"></span><header class=post-header><h2 class=post-title itemprop="name headline"><a href=/posts/programming/cpp/%E5%9C%A8-C++-%E9%A1%B9%E7%9B%AE%E4%B8%AD%E4%BD%BF%E7%94%A8-Pybind11/ itemprop=url class=post-title-link>在 C++ 项目中使用 Pybind11</a></h2><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2024-10-11 00:00:00 +0800 CST" itemprop="dateCreated datePublished" datetime="2024-10-11 00:00:00 +0800 CST">2024-10-11
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar-check"></i>
</span><span class=post-meta-item-text title=更新于>更新于：
</span><time title=修改时间：2024-10-17T00:00:00+08:00 itemprop=dateModified datetime=2024-10-17T00:00:00+08:00>2024-10-17</time></span></div></div></header><div class=post-body itemprop=articleBody><p>安装 pybind11：</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>pip install <span style=color:#2aa198>&#39;pybind11[global]&#39;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cmake data-lang=cmake><span style=display:flex><span><span style=color:#586e75># add your executable
</span></span></span><span style=display:flex><span><span style=color:#586e75></span><span style=color:#b58900>set</span>(<span style=color:#2aa198>PYTHON_EXECUTABLE</span> <span style=color:#2aa198>/opt/miniforge3/bin/python</span>)
</span></span><span style=display:flex><span><span style=color:#b58900>find_package</span>(<span style=color:#2aa198>pybind11</span> <span style=color:#2aa198>REQUIRED</span>)
</span></span><span style=display:flex><span><span style=color:#b58900>target_link_libraries</span>(<span style=color:#2aa198>your_executable</span> <span style=color:#2aa198>PRIVATE</span> <span style=color:#2aa198>pybind11::pybind11</span> <span style=color:#2aa198>pybind11::embed</span>)
</span></span></code></pre></div><p>设置 <code>PYTHON_EXECUTABLE</code> 可以确保 pybind11 使用正确的 python 版本，这样才能在里面找到你安装好的其他的包。</p></div><footer class=post-footer><div readmore=false><div class=readmore-overlay><div class=readmore-overlay-center><div class=post-button><a class=btn href=/posts/programming/cpp/%E5%9C%A8-C++-%E9%A1%B9%E7%9B%AE%E4%B8%AD%E4%BD%BF%E7%94%A8-Pybind11/#more rel=contents>阅读全文 &#187;</a></div></div></div><div class=no-more-to-read><hr><center>没有啦~</center></div></div><div class=post-eof></div></footer></article></div><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://hxhue.github.io/posts/systems/Windows/Windows-%E9%87%8A%E6%94%BE-NAT-%E6%9C%8D%E5%8A%A1%E5%8D%A0%E7%94%A8%E7%9A%84%E7%AB%AF%E5%8F%A3/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/371907.jpg"><meta itemprop=name content="🤖"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="🤖"><meta itemprop=description content="个人博客，主要是零散的笔记。"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="Windows 释放 NAT 服务占用的端口"><meta itemprop=description content="释放 NAT 服务占用的端口

查看被占用的 TCP 端口，检查自己所用的服务端口是否被包含在结果中：
netsh interface ipv4 show excludedportrange protocol=tcp
重启 winnat 服务来释放大多数端口（需要管理员权限），验证 TCP 端口是否被释放："></span><header class=post-header><h2 class=post-title itemprop="name headline"><a href=/posts/systems/Windows/Windows-%E9%87%8A%E6%94%BE-NAT-%E6%9C%8D%E5%8A%A1%E5%8D%A0%E7%94%A8%E7%9A%84%E7%AB%AF%E5%8F%A3/ itemprop=url class=post-title-link>Windows 释放 NAT 服务占用的端口</a></h2><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2024-10-04 00:00:00 +0800 CST" itemprop="dateCreated datePublished" datetime="2024-10-04 00:00:00 +0800 CST">2024-10-04</time></span></div></div></header><div class=post-body itemprop=articleBody><h1 id=释放-nat-服务占用的端口>释放 NAT 服务占用的端口
<a class=header-anchor href=#%e9%87%8a%e6%94%be-nat-%e6%9c%8d%e5%8a%a1%e5%8d%a0%e7%94%a8%e7%9a%84%e7%ab%af%e5%8f%a3></a></h1><p>查看被占用的 TCP 端口，检查自己所用的服务端口是否被包含在结果中：</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-txt data-lang=txt><span style=display:flex><span>netsh interface ipv4 show excludedportrange protocol=tcp
</span></span></code></pre></div><p>重启 winnat 服务来释放大多数端口（需要管理员权限），验证 TCP 端口是否被释放：</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-txt data-lang=txt><span style=display:flex><span>net stop winnnat &amp;&amp; net start winnat
</span></span></code></pre></div><h1 id=设置动态端口号范围>设置动态端口号范围
<a class=header-anchor href=#%e8%ae%be%e7%bd%ae%e5%8a%a8%e6%80%81%e7%ab%af%e5%8f%a3%e5%8f%b7%e8%8c%83%e5%9b%b4></a></h1><p>看看应用程序的动态端口范围：</p></div><footer class=post-footer><div readmore=true><div class=readmore-overlay><div class=readmore-overlay-center><div class=post-button><a class=btn href=/posts/systems/Windows/Windows-%E9%87%8A%E6%94%BE-NAT-%E6%9C%8D%E5%8A%A1%E5%8D%A0%E7%94%A8%E7%9A%84%E7%AB%AF%E5%8F%A3/#more rel=contents>阅读全文 &#187;</a></div></div></div><div class=no-more-to-read><hr><center>没有啦~</center></div></div><div class=post-eof></div></footer></article></div><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://hxhue.github.io/posts/systems/%E8%B6%85%E7%BA%BF%E7%A8%8B/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/371907.jpg"><meta itemprop=name content="🤖"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="🤖"><meta itemprop=description content="个人博客，主要是零散的笔记。"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="超线程"><meta itemprop=description content='分类

我们平时说的超线程可能指同时多线程（SMT），也可能指 Intel 的超线程（HT）。

flowchart TD
    SMT("Simultaneous multithreading (SMT)")
    HT("Hyper-threading (HT)")
    TMT("Temporal multithreading, or super-threading")
    SMT -->|Intel&#39;s implementation| HT
    TMT <-->|SMT 同一条流水线能执行来自多个线程的指令，另外一个不能| SMT
	HT -.-> HT_note("两个逻辑线程共享包括 TLB 和 cache 等资源，但 CR3 等资源独立")
也存在一个物理核心对应超过 2 个逻辑线程的 SMT 实现，比如 IBM Power8: 12 cores, 8T each, (32 FX + 32 FP) registers per thread，FX 是定点数，FP 是浮点数。'></span><header class=post-header><h2 class=post-title itemprop="name headline"><a href=/posts/systems/%E8%B6%85%E7%BA%BF%E7%A8%8B/ itemprop=url class=post-title-link>超线程</a></h2><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2024-10-04 00:00:00 +0800 CST" itemprop="dateCreated datePublished" datetime="2024-10-04 00:00:00 +0800 CST">2024-10-04
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar-check"></i>
</span><span class=post-meta-item-text title=更新于>更新于：
</span><time title=修改时间：2025-01-03T00:00:00+08:00 itemprop=dateModified datetime=2025-01-03T00:00:00+08:00>2025-01-03</time></span></div></div></header><div class=post-body itemprop=articleBody><h1 id=分类>分类
<a class=header-anchor href=#%e5%88%86%e7%b1%bb></a></h1><p>我们平时说的超线程可能指同时多线程（SMT），也可能指 Intel 的超线程（HT）。</p><div class=highlight><pre tabindex=0><code class=language-mermaid data-lang=mermaid>flowchart TD
    SMT(&#34;Simultaneous multithreading (SMT)&#34;)
    HT(&#34;Hyper-threading (HT)&#34;)
    TMT(&#34;Temporal multithreading, or super-threading&#34;)
    SMT --&gt;|Intel&#39;s implementation| HT
    TMT &lt;--&gt;|SMT 同一条流水线能执行来自多个线程的指令，另外一个不能| SMT
	HT -.-&gt; HT_note(&#34;两个逻辑线程共享包括 TLB 和 cache 等资源，但 CR3 等资源独立&#34;)</code></pre></div><p>也存在一个物理核心对应超过 2 个逻辑线程的 SMT 实现，比如 IBM Power8: 12 cores, 8T each, (32 FX + 32 FP) registers per thread，FX 是定点数，FP 是浮点数。</p><p>更完整的分类：</p><blockquote><p>We can consider that Super-Threading the same as Temporal multithreading (coarse-grain). I.e. types of multithreading is vary as follows - from shared anything to shared nothing in CPU-core between threads: <strong>None</strong> (fully software multithreading), <strong>TM (fine-grained)</strong> in barrel processors, <strong>TM (coarse-grained) - Super Threading</strong>, <strong>SMT</strong> - Hyper Threading, <strong>CMT</strong> (Chip Multithreading) - multicore with shared expensive resource (single FPU on some cores), <strong>CMP</strong> (Chip Multiprocessors) - multicore with shared Last Level Cache & interconnect.</p></blockquote></div><footer class=post-footer><div readmore=true><div class=readmore-overlay><div class=readmore-overlay-center><div class=post-button><a class=btn href=/posts/systems/%E8%B6%85%E7%BA%BF%E7%A8%8B/#more rel=contents>阅读全文 &#187;</a></div></div></div><div class=no-more-to-read><hr><center>没有啦~</center></div></div><div class=post-eof></div></footer></article></div><nav class=pagination><a class="extend prev" rel=prev href=/page/6/><i class="fa fa-angle-left"></i>
</a><a class=page-number href=/page/3/>3</a>
<a class=page-number href=/page/4/>4</a>
<a class=page-number href=/page/5/>5</a>
<a class=page-number href=/page/6/>6</a>
<span class="page-number current">7</span>
<a class=page-number href=/page/8/>8</a>
<a class=page-number href=/page/9/>9</a>
<a class=page-number href=/page/10/>10</a>
<a class=page-number href=/page/11/>11</a>
<a class="extend next" rel=next href=/page/8/><i class="fa fa-angle-right"></i></a></nav></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2023 - 2025
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>🤖</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.143.1 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.5.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div></div></footer><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js defer></script><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":false,"save":"manual"},"copybtn":true,"darkmode":false,"hostname":"https://hxhue.github.io/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":false,"transition":{"collheader":"fadeInLeft","menu_item":"fadeInDown","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":false,"plugin":"waline"},"views":{"enable":false,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"cdnjs","router":"https://cdnjs.cloudflare.com/ajax/libs"},"version":"4.5.3"}</script><script type=text/javascript src=/js/main.min.37ba8b54f9d4d784d08028c45eea93b5d4e13eda8ee7fb0d2edd6f3fac66cfd2.js defer></script></body></html>