<!doctype html><html lang=zh-CN data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.143.1"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="17 ACL setfacl getfacl"><meta itemprop=description content="个人博客，主要是零散的笔记。"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://hxhue.github.io/imgs/371907.jpg"><meta itemprop=keywords content="the-linux-programming-interface"><link type=text/css rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css><link rel=stylesheet href=/css/main.min.bea76f574a755574e17d42bea39502a74ca3ca4db65807b8c82d3e26dcec8420.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><link rel=stylesheet type=text/css href=/css/style.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/github-markdown-css@5.3.0/github-markdown-dark.css><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js></script><script>MathJax={tex:{displayMath:[["$$","$$"],["\\[","\\]"]],inlineMath:[["$","$"],["\\(","\\)"]]},svg:{fontCache:"global"}}</script><script type=module>
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: false });
  mermaid.mermaidAPI.initialize();
  window.mermaid = mermaid;
</script><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":false,"isPage":true,"path":"17-ACL-setfacl-getfacl","permalink":"https://hxhue.github.io/the-linux-programming-interface/17-ACL-setfacl-getfacl/","title":"17 ACL setfacl getfacl","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>17 ACL setfacl getfacl - Bluegill</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>Bluegill</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description></p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about/ class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档</a></li><li class="menu-item menu-item-categories"><a href=/categories/ class=hvr-icon-pulse rel=section><i class="fa fa-th hvr-icon"></i>分类</a></li><li class="menu-item menu-item-tags"><a href=/tags/ class=hvr-icon-pulse rel=section><i class="fa fa-hashtag hvr-icon"></i>标签</a></li><li class="menu-item menu-item-daily"><a href=/daily/ class=hvr-icon-pulse rel=section><i class="fa fa-newspaper hvr-icon"></i>随笔</a></li><li class="menu-item menu-item-discovery"><a href=https://rift-fear-f2c.notion.site/2025-1e354a33cfb1802c841bdf29f2f3dab3 class=hvr-icon-pulse rel=section><i class="fa fa-compass hvr-icon"></i>发现</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#acl-介绍>ACL 介绍</a></li><li><a href=#acl-权限匹配算法>ACL 权限匹配算法</a></li><li><a href=#acl-的文本格式>ACL 的文本格式</a></li><li><a href=#命令-setfacl-和-getfacl>命令 <code>setfacl</code> 和 <code>getfacl</code></a></li><li><a href=#acl_mask-的意义以及传统权限与-acl-的同步><code>ACL_MASK</code> 的意义以及传统权限与 ACL 的同步</a></li><li><a href=#默认型-acl相当于-umask>默认型 ACL（相当于 umask）</a></li><li><a href=#acl-的数量限制>ACL 的数量限制</a></li><li><a href=#acl-api>ACL API</a></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=🤖 src=/imgs/371907.jpg><p class=site-author-name itemprop=name>🤖</p><div class=site-description itemprop=description>个人博客，主要是零散的笔记。</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>433</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>12</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>86</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/hxhue title="Github → https://github.com/hxhue" rel=noopener target=_blank><i class="fab fa-github fa-fw"></i>
Github
</a></span><span class=links-of-social-item><a href=/rss.xml title="RSS 订阅 → /rss.xml" rel=noopener target=_blank><i class="fa fa-rss fa-fw"></i>
RSS 订阅</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://shuai.guru/ title=https://shuai.guru/ target=_blank>shuai.guru</a></li></ul></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://hxhue.github.io/the-linux-programming-interface/17-ACL-setfacl-getfacl/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/371907.jpg"><meta itemprop=name content="🤖"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="🤖"><meta itemprop=description content="个人博客，主要是零散的笔记。"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="17 ACL setfacl getfacl"><meta itemprop=description content="ACL 介绍

ACL 在 Linux 内核 2.6 被支持，是用文件的 
  
  
    
    
    
    
    
    
    
    
    
    
    
    扩展属性 实现的，扩展属性名为 system.posix_acl_access。

  要想在 ext2、ext3、ext4 或 reiserfs 文件系统上创建 ACL，装配相应的文件系统时需要带 mount –o acl 选项。"></span><header class=post-header><h1 class=post-title itemprop="name headline">17 ACL setfacl getfacl</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2024-05-29 00:00:00 +0800 CST" itemprop="dateCreated datePublished" datetime="2024-05-29 00:00:00 +0800 CST">2024-05-29
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar-check"></i>
</span><span class=post-meta-item-text title=更新于>更新于：
</span><time title=修改时间：2024-09-14T00:00:00+08:00 itemprop=dateModified datetime=2024-09-14T00:00:00+08:00>2024-09-14</time>
</span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i>
</span><span class=post-meta-item-text title=分类于>分类于：
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/the-linux-programming-interface itemprop=url rel=index><span itemprop=name>the-linux-programming-interface</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="far fa-file-word"></i>
</span><span class=post-meta-item-text>字数：</span>
<span>3219</span>
</span><span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="far fa-clock"></i>
</span><span class=post-meta-item-text>阅读：&ap;</span>
<span>7分钟</span></span></div></div></header><div class=post-body itemprop=articleBody><h1 id=acl-介绍>ACL 介绍
<a class=header-anchor href=#acl-%e4%bb%8b%e7%bb%8d></a></h1><p>ACL 在 Linux 内核 2.6 被支持，是用文件的
<a href=/the-linux-programming-interface/16.01-%E6%96%87%E4%BB%B6%E6%89%A9%E5%B1%95%E5%B1%9E%E6%80%A7-EA-getfattr-setfattr/ title=扩展属性>扩展属性</a> 实现的，扩展属性名为 <code>system.posix_acl_access</code>。</p><blockquote><p>要想在 ext2、ext3、ext4 或 reiserfs 文件系统上创建 ACL，装配相应的文件系统时需要带 <code>mount –o acl</code> 选项。</p></blockquote><p>ACL 的功能是传统访问权限的超集，<strong>优先于传统访问权限生效</strong>。每个 ACL 项目（Access Control Entry，即 ACE）指定一个 rwx（3 个二进制位）的权限。其中：</p><ol><li><code>ACL_USER_OBJ</code>、<code>ACL_GROUP_OBJ</code> 和 <code>ACL_OTHER</code>（在没有指定其他项目时）相当于传统权限，这个时候 ACL 被称为<strong>最小 ACL</strong>。</li><li>支持对特定用户（<code>ACL_USER</code>）或者特定组（<code>ACL_GRUOP</code>）指定权限。</li><li>支持掩码。<code>ACL_MASK</code> 记录了可由 <code>ACL_USER</code>、<code>ACL_GROUP_OBJ</code> 以及 <code>ACL_GROUP</code> 型 ACE 所能授予的最高权限。但如果 ACL 含有标记类型为 <code>ACL_USER</code> 或 <code>ACL_GROUP</code> 的记录，那么就必须包含一条 <code>ACL_MASK</code> 型的 ACE。如果包含了掩码项目，ACL 就成为<strong>扩展 ACL</strong>。</li><li><code>ACL_USER_OBJ</code>、<code>ACL_GROUP_OBJ</code>、<code>ACL_OTHER</code> 和 <code>ACL_MASK</code> 都只能出现一次。</li></ol><h1 id=acl-权限匹配算法>ACL 权限匹配算法
<a class=header-anchor href=#acl-%e6%9d%83%e9%99%90%e5%8c%b9%e9%85%8d%e7%ae%97%e6%b3%95></a></h1><p>ACL 的权限检查同样是具有短路特性的。</p><ol><li>如果是特权进程，则放行。（实际实现的时候可能会把这一步放在最后作为 fallback，因为系统审计程序只应该记录进程真正需要使用到特权的情况。）</li><li>按照用户检查，如果进程有效用户 ID 和 <code>ACL_USER_OBJ</code> 匹配，则按照这一项检查权限。</li><li>否则，如果进程有效用户 ID 和某个 <code>ACL_USER</code> 匹配，则将它和 <code>ACL_MASK</code> 求与作为权限结果。</li><li>否则，如果进程的有效组 ID 或者辅助组 ID 之一满足<strong>全部权限检查</strong>，则放行。<ol><li>如果组 ID 匹配 <code>ACL_GROUP_OBJ</code>，则将其和 <code>ACL_MASK</code> 求与（如果没有 <code>ACL_MASK</code> 则跳过这一步）。</li><li>如果组 ID 匹配 <code>ACL_GRUOP</code>，则将其和 <code>ACL_MASK</code> 求与（此时 <code>ACL_MASK</code> 必定存在）。</li></ol></li><li>否则，按照 <code>ACL_OTHER</code> 检查权限（<code>ACL_MASK</code> 不会影响这一项）。</li></ol><p>第 4 点的<strong>全部权限检查</strong>举例：如果有一个进程对应了两个组 A 和 B，且在 ACL 中，A 对文件有读权限，B 对文件有写权限，那么进程单独申请读权限或者单独申请写权限都是能够通过检查的，但是进程申请读写权限时会失败。</p><h1 id=acl-的文本格式>ACL 的文本格式
<a class=header-anchor href=#acl-%e7%9a%84%e6%96%87%e6%9c%ac%e6%a0%bc%e5%bc%8f></a></h1><p>ACL 具有长文本格式和短文本格式。长文本格式是 ACE 用换行符连接，并且可以包含 <code>#</code> 开头的注释；短文本格式是 ACE 用逗号连接。</p><p>ACL 的组成是 <code>tag:[tag-qualifier]:permissions</code>（标记类型、标记限定符、权限集合）。当 tag 为用户或者组时，不提供限定符则表示文件所属用户或者所属组，提供限定符（用户名或者组名）则表示给定的用户或者组。一些例子：</p><p><img src=/the-linux-programming-interface/tlpi-assets/17%20ACL%20setfacl%20getfacl-20240530120641065.webp width=300></p><p><img src=/the-linux-programming-interface/tlpi-assets/17%20ACL%20setfacl%20getfacl-20240530120725214.webp width=700></p><h1 id=命令-setfacl-和-getfacl>命令 <code>setfacl</code> 和 <code>getfacl</code>
<a class=header-anchor href=#%e5%91%bd%e4%bb%a4-setfacl-%e5%92%8c-getfacl></a></h1><p>Debian 需要额外安装 acl 包。</p><p>每次用 <code>setfacl</code> 操作 ACL 但是又没有指明 mask 规则时，mask 会被自动调整成 <code>ACL_USER</code>、<code>ACL_GROUP_OBJ</code> 以及 <code>ACL_GROUP</code> 型 ACE 的并集。想要禁用这个行为，需要传入参数 <code>-n</code> / <code>--no-mask</code>。</p><h1 id=acl_mask-的意义以及传统权限与-acl-的同步><code>ACL_MASK</code> 的意义以及传统权限与 ACL 的同步
<a class=header-anchor href=#acl_mask-%e7%9a%84%e6%84%8f%e4%b9%89%e4%bb%a5%e5%8f%8a%e4%bc%a0%e7%bb%9f%e6%9d%83%e9%99%90%e4%b8%8e-acl-%e7%9a%84%e5%90%8c%e6%ad%a5></a></h1><p>很多应用不知道 ACL 的存在，会使用 <code>chmod</code> 等系统调用来修改权限，比如用 <code>chmod</code> 修改权限为 0700（开头的 0 表示是八进制数），表示除了文件主人之外都没有访问权限，这个时候如果没有 <code>ACL_MASK</code>，就需要把所有特定用户和特定组的权限都改成 0 以阻止它们访问。但是这样做又有一个问题，将来用 <code>chmod</code> 改权限为 0777 的时候，以前设置的特定用户、特定组的规则都丢失了，难道还要给它们都设置成 0777 吗？</p><p>在有 <code>ACL_MASK</code> 的时候（回忆第一节的内容，一旦有特定用户规则或者特定组规则，这个掩码就一定存在）：</p><ol><li>对传统的<strong>组权限</strong>（就是 user/group/other 的 group）的修改会反映在 <code>ACL_MASK</code> 而不是 <code>ACL_GROUP_OBJ</code> 上。</li><li><code>stat</code> 系统调用返回的 <code>st_mode</code> 中的 group 对应位置替换为 <code>ACL_MASK</code> 的二进制表示，而不是 inode 中存储的组权限。如果用 <code>ls -l</code> 去显示文件权限，权限串会以 <code>+</code> 结尾，表示当前 ACL 是扩展 ACL，而且 group 权限显示的是 <code>ACL_MASK</code>（因为 <code>stat</code> 返回的数据就是这样）。</li><li>可以用 <code>getxattr</code> 去获得文件的 <code>system.posix_acl_access</code> 扩展属性。（如果没有 <code>ACL_MASK</code>，那么 ACL 是最小 ACL，这个时候去访问会出现 no data available 的错误。）<em>但是因为我不知道如何反序列化它，拿到数据之后也不知道怎么解读，可能得看内核源码去寻找答案</em>。</li></ol><p>传统权限与 ACL 的同步方式如下：</p><ol><li>无 <code>ACL_MASK</code> 时 ，ACL 是最小 ACL，user 权限对应 <code>ACL_USER_OBJ</code>，group 权限对应 <code>ACL_GROUP_OBJ</code>，other 权限对应 <code>ACL_OTHER</code>，<code>chmod</code> 和 <code>setfacl</code> 操作以上权限都只会修改 inode 文件权限，而扩展属性不存在、也不会被创建。</li><li>有 <code>ACL_MASK</code> 时，ACL 是扩展 ACL，inode 文件权限和文件扩展属性中的 ACL 信息是两份独立数据，但是 <code>chmod</code> 和 <code>setfacl</code> 在更新 user 和 other 权限时会相互同步。Group 权限比较特殊，它对应于 <code>ACL_MASK</code>，<code>chmod</code> 对组权限的修改会直接修改这个，而不影响 inode 模式（<code>st_mode</code>）中的权限，由于操作对象是同一个所以不需要同步。<code>setfacl</code> 对 <code>ACL_GROUP_OBJ</code> 的修改还是会同步到 inode 模式的组权限上。</li></ol><p>有个小问题：假设文件的 ACL 是 <code>user::rw-,group::---,mask::---,other::r--</code>，对该文件使用 <code>chmod g+rw</code>，ACL 会变成 <code>user::rw-,group::---,mask::rw-,other::r--</code>，由于不能真正改变组权限且 ACL 的优先级高于 inode 模式位，此时文件同组不同用户仍然无法访问文件。要访问文件只能用 <code>setfacl</code> 修改组权限，或者删除掩码（这个时候没有特定用户或特定组的规则，可以删除掩码）。</p><hr><p>用以下操作证明文件的 ACL 是扩展 ACL 时，EA 中会 user 权限和 group 权限的冗余数据并保持同步，而不是直接透明修改 inode 模式位：</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#719e07>(</span>py310<span style=color:#719e07>)</span> xxx /data/ $ diff &lt;<span style=color:#719e07>(</span>./build/main &lt; A.txt<span style=color:#719e07>)</span> &lt;<span style=color:#719e07>(</span>./build/main &lt; B.txt<span style=color:#719e07>)</span>
</span></span><span style=display:flex><span><span style=color:#586e75># 此时刚刚用 setfacl -m m::rwx 给 A.txt 和 B.txt 分别创建了 ACL_MASK 类型的 ACE</span>
</span></span><span style=display:flex><span><span style=color:#719e07>(</span>py310<span style=color:#719e07>)</span> xxx /data/ $ getfacl A.txt 
</span></span><span style=display:flex><span><span style=color:#586e75># file: A.txt</span>
</span></span><span style=display:flex><span><span style=color:#586e75># owner: simon</span>
</span></span><span style=display:flex><span><span style=color:#586e75># group: simon</span>
</span></span><span style=display:flex><span>user::rw-
</span></span><span style=display:flex><span>group::r--
</span></span><span style=display:flex><span>mask::rwx
</span></span><span style=display:flex><span>other::r--
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#719e07>(</span>py310<span style=color:#719e07>)</span> xxx /data/ $ setfacl -m u::rw A.txt 
</span></span><span style=display:flex><span><span style=color:#719e07>(</span>py310<span style=color:#719e07>)</span> xxx /data/ $ diff &lt;<span style=color:#719e07>(</span>./build/main &lt; A.txt<span style=color:#719e07>)</span> &lt;<span style=color:#719e07>(</span>./build/main &lt; B.txt<span style=color:#719e07>)</span>
</span></span><span style=display:flex><span>Binary files /dev/fd/63 and /dev/fd/62 differ
</span></span></code></pre></div><p>A.txt 的用户权限已经是 rw，现在用 <code>setfacl</code> 设置同样的权限，A、B 两个文件的扩展属性有差异，说明 <code>setfacl</code> 本身是存储了一份信息的，而不是透明映射到 inode 文件权限中去。</p><p>build/main 的代码如下，它直接以二进制形式输出标准输入流对应文件的扩展属性：</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;stdio.h&gt;</span><span style=color:#719e07>
</span></span></span><span style=display:flex><span><span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;sys/xattr.h&gt;</span><span style=color:#719e07>
</span></span></span><span style=display:flex><span><span style=color:#719e07></span>
</span></span><span style=display:flex><span><span style=color:#dc322f>int</span> <span style=color:#268bd2>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#dc322f>char</span> buf[<span style=color:#2aa198>256</span>] <span style=color:#719e07>=</span> {<span style=color:#2aa198>0</span>};
</span></span><span style=display:flex><span>    <span style=color:#dc322f>ssize_t</span> sz <span style=color:#719e07>=</span> <span style=color:#268bd2>getxattr</span>(<span style=color:#2aa198>&#34;/proc/self/fd/0&#34;</span>, <span style=color:#2aa198>&#34;system.posix_acl_access&#34;</span>, buf, <span style=color:#719e07>sizeof</span>(buf));
</span></span><span style=display:flex><span>    <span style=color:#719e07>if</span> (sz <span style=color:#719e07>==</span> <span style=color:#719e07>-</span><span style=color:#2aa198>1</span>) {
</span></span><span style=display:flex><span>        <span style=color:#268bd2>perror</span>(<span style=color:#2aa198>&#34;getxattr&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#719e07>return</span> <span style=color:#2aa198>1</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#719e07>for</span> (<span style=color:#dc322f>ssize_t</span> i <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>; i <span style=color:#719e07>&lt;</span> sz; <span style=color:#719e07>++</span>i) {
</span></span><span style=display:flex><span>        <span style=color:#268bd2>putchar</span>(buf[i]);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=默认型-acl相当于-umask>默认型 ACL（相当于 umask）
<a class=header-anchor href=#%e9%bb%98%e8%ae%a4%e5%9e%8b-acl%e7%9b%b8%e5%bd%93%e4%ba%8e-umask></a></h1><p>之前介绍的 ACL 都是访问型的（从 EA 名的命名方式可以看出来），其实还有一种 ACL，即默认型 ACL，对应的 EA 名为 <code>system.posix_acl_default</code>。这种 ACL 只能针对目录设置，且目录下新创建的子目录会继承默认型 ACL，目录下新创建的子目录和子文件会将默认型 ACL 作为自己的访问型 ACL。默认型 ACL 的作用有点相当于进程的 umask，而且它存在时 umask 会被忽略。</p><p>如果目录有默认型 ACL，其下用 <code>mkdir</code> 或者 <code>open</code> 等系统调用创建的新的文件会和默认型 ACL 发生按位与操作：</p><ol><li><code>ACL_USER_OBJ</code> 对应 umask 的 user 部分。</li><li><code>ACL_MASK</code>（若不含 <code>ACL_MASK</code>，则为 <code>ACL_GROUP_OBJ</code>）对应 umask 的 group 部分。</li><li><code>ACL_OTHER</code> 对应 umask 的 other 部分。</li></ol><p>想要用 <code>getfacl</code> 和 <code>setfacl</code> 来查看 / 修改默认型 ACL，需要加 <code>-d</code> 参数；想要用 <code>setfacl</code> 删除默认型 ACL，需要加 <code>-k</code> 参数。</p><h1 id=acl-的数量限制>ACL 的数量限制
<a class=header-anchor href=#acl-%e7%9a%84%e6%95%b0%e9%87%8f%e9%99%90%e5%88%b6></a></h1><p>单个文件的 ACL 记录长度受制于
<a href=/the-linux-programming-interface/16.01-%E6%96%87%E4%BB%B6%E6%89%A9%E5%B1%95%E5%B1%9E%E6%80%A7-EA-getfattr-setfattr/#%e4%b8%80%e4%ba%9b%e9%99%90%e5%88%b6 title=文件系统扩展属性的长度>文件系统扩展属性的长度</a>。在 ext2、ext3 以及 ext4 文件系统中，由于单个文件扩展属性的所有信息不能超过一个逻辑磁盘块大小，因此 ACL 的数量还是很有限的。有些文件系统比如 JFS 限制就要宽松很多。</p><p>TLPI 作者的观点是：ACL 数量非常有限，而且内容长了也不便于维护，最好用组的形式去管理权限，而少用特定用户的 ACL 项（ACE）。</p><h1 id=acl-api>ACL API
<a class=header-anchor href=#acl-api></a></h1><p>ACL 的 API 非常多，使用前需要包含 <code>&lt;sys/acl.h></code>。如果还用到了 POSIX.1e 标准草案中的各种 Linux 扩展（acl(5) 手册页罗列了一系列 Linux 扩展），程序可能还需要包含 <code>&lt;acl/libacl.h></code>，此时还需要加上 <code>-lacl</code> 选项以完成链接。为了能在 man pages 看到 acl 相关 API 的说明，需要先安装 libacl（在 Debian 上是 libacl1-dev）。</p><p>最核心的两个类型是 <code>acl_t</code> 和 <code>acl_entry_t</code>，其中前者被实现为指针类型。</p><p><img src=/the-linux-programming-interface/tlpi-assets/17%20ACL%20setfacl%20getfacl-20240602221343379.webp width=700></p><p>还有一些 ACL 相关的调用没有在图中出现。比如：</p><ul><li><code>acl_calc_mask(&amp;acl)</code> 用来给 <code>acl_t</code> 类型的 <code>acl</code> 重新计算 <code>ACL_MASK</code> 型记录（如果必要）为 <code>ACL_USER</code>、
<code>ACL_GROUP</code> 以及 <code>ACL_GROUP_OBJ</code> 型记录的权限并集。</li><li><code>acl_valid(acl)</code> 用来检查 <code>acl</code> 的有效性。</li><li><code>acl_delete_def_file(pathname)</code> 用来删除目录的默认 ACL。</li><li><code>acl_init(count)</code> 创建一个空的 ACL 结构。</li><li><code>acl_dup(acl)</code> 为 <code>acl</code> 创建副本。</li><li><code>acl_free(handle)</code> 释放 ACL 相关 API 分配的内存。</li></ul></div><footer class=post-footer><div class=post-tags><a href=/tags/the-linux-programming-interface>the-linux-programming-interface</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/the-linux-programming-interface/18-%E7%9B%AE%E5%BD%95%E5%92%8C%E9%93%BE%E6%8E%A5/ rel=next title="18.1-2 i-node 和链接"><i class="fa fa-chevron-left"></i> 18.1-2 i-node 和链接</a></div><div class="post-nav-prev post-nav-item"><a href=/the-linux-programming-interface/16.01-%E6%96%87%E4%BB%B6%E6%89%A9%E5%B1%95%E5%B1%9E%E6%80%A7-EA-getfattr-setfattr/ rel=prev title="16.01 文件扩展属性 EA getfattr setfattr">16.01 文件扩展属性 EA getfattr setfattr
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2023 - 2025
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>🤖</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.143.1 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.5.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div></div></footer><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js defer></script><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":false,"save":"manual"},"copybtn":true,"darkmode":false,"hostname":"https://hxhue.github.io/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":false,"transition":{"collheader":"fadeInLeft","menu_item":"fadeInDown","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":false,"plugin":"waline"},"views":{"enable":false,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"cdnjs","router":"https://cdnjs.cloudflare.com/ajax/libs"},"version":"4.5.3"}</script><script type=text/javascript src=/js/main.min.37ba8b54f9d4d784d08028c45eea93b5d4e13eda8ee7fb0d2edd6f3fac66cfd2.js defer></script></body></html>